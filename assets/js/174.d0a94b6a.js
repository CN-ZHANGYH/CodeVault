(window.webpackJsonp=window.webpackJsonp||[]).push([[174],{488:function(t,a,s){"use strict";s.r(a);var n=s(7),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab-gitlab-ci-harbor-kubernetes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-gitlab-ci-harbor-kubernetes"}},[t._v("#")]),t._v(" GitLab + GitLab CI + Harbor + Kubernetes")]),t._v(" "),a("h2",{attrs:{id:"项目要求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目要求"}},[t._v("#")]),t._v(" 项目要求")]),t._v(" "),a("p",[t._v("该公司决定采用"),a("code",[t._v("GitLab + GitLab CI + Harbor + Kubernetes")]),t._v("架构来构建CICD环境，以缩短新功能开发上线周期，及时满足客户的需求，实现DevOps的部分流程，来减轻部署运维的负担，实现可视化容器生命周期管理、应用发布和版本迭代更新，请完成CICD环境部署。CICD应用系统架构如下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250851345.png",alt:"image-20220425085103011"}})]),t._v(" "),a("h2",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[t._v("#")]),t._v(" 环境准备")]),t._v(" "),a("p",[t._v("这里使用项目为2048游戏")]),t._v(" "),a("p",[a("strong",[t._v("项目地址：")]),t._v("  https://gitee.com/cn-zhangyh/demo-2048.git")]),t._v(" "),a("h3",{attrs:{id:"_1-节点规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-节点规划"}},[t._v("#")]),t._v(" 1.节点规划")]),t._v(" "),a("p",[t._v("使用Docker或者使用Kubernetes集群环境，这里使用的是Kubernetes集群环境。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("IP地址")]),t._v(" "),a("th",[t._v("主机名称")]),t._v(" "),a("th",[t._v("主机资源")]),t._v(" "),a("th",[t._v("节点名称")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("10.11.121.111")]),t._v(" "),a("td",[t._v("k8s-master")]),t._v(" "),a("td",[t._v("12G/6VCPU")]),t._v(" "),a("td",[t._v("GitLab+GitLab-Runner")])]),t._v(" "),a("tr",[a("td",[t._v("10.11.121.112")]),t._v(" "),a("td",[t._v("k8s-node1")]),t._v(" "),a("td",[t._v("8G/6VCPU")]),t._v(" "),a("td",[t._v("Harbor")])]),t._v(" "),a("tr",[a("td",[t._v("10.11.121.113")]),t._v(" "),a("td",[t._v("k8s-node2")]),t._v(" "),a("td",[t._v("8G/6VCPU")]),t._v(" "),a("td",[t._v("node")])])])]),t._v(" "),a("h3",{attrs:{id:"_2-查看集群状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-查看集群状态"}},[t._v("#")]),t._v(" 2.查看集群状态")]),t._v(" "),a("p",[t._v("可以通过"),a("code",[t._v("kubectl cluster-info")]),t._v("命令查看当前的集群信息。 通过 "),a("code",[t._v("kubectl get node")]),t._v("查看当前节点数量。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl cluster-info ")]),t._v("\nKubernetes control plane is running at https://10.11.121.111:6443\nKubeDNS is running at https://10.11.121.111:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubectl cluster-info dump'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get node ")]),t._v("\nNAME         STATUS   ROLES                  AGE   VERSION\nk8s-master   Ready    control-plane,master   25h   v1.20.0\nk8s-node1    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("                 25h   v1.20.0\nk8s-node2    Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("                 25h   v1.20.0\n")])])]),a("h2",{attrs:{id:"部署gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署gitlab"}},[t._v("#")]),t._v(" 部署GitLab")]),t._v(" "),a("h3",{attrs:{id:"_1-gitlab概述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-gitlab概述"}},[t._v("#")]),t._v(" 1.GitLab概述")]),t._v(" "),a("p",[t._v("GitLab 是利用 Ruby on Rails 一个开源的版本管理系统，实现一个自托管的 Git 项目仓库，可通过 Web 界面进行访问公开的或者私人项目。它拥有与 Github 类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序 (Wall) 进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。")]),t._v(" "),a("h3",{attrs:{id:"_2-gitlab部署方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-gitlab部署方式"}},[t._v("#")]),t._v(" 2.GitLab部署方式")]),t._v(" "),a("p",[t._v("GitLab 可以安装在大多数 GNU/Linux 发行版中，并与多个云提供商一起安装。要从 GitLab 获得最佳体验，您必须平衡性能、可靠性、易于管理（备份、升级和故障排除）以及托管成本。")]),t._v(" "),a("p",[t._v("目前比较常见的部署方式有如下三种：")]),t._v(" "),a("ul",[a("li",[t._v("直接安装在操作系统上，例如： "),a("code",[t._v("Mac/Windows/Linux")])]),t._v(" "),a("li",[t._v("通过容器的方式安装，例如： "),a("code",[t._v("Docker、Kubernetes")])]),t._v(" "),a("li",[t._v("使用Helm包安装： "),a("code",[t._v("Chart包的方式")])])]),t._v(" "),a("h3",{attrs:{id:"_3-docker部署gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-docker部署gitlab"}},[t._v("#")]),t._v(" 3.Docker部署GitLab")]),t._v(" "),a("p",[t._v("1.使用Docker命令部署Gitlab，由于Gitlab的镜像大概有几个G，所以需要等待很久的时间，直到完全启动。")]),t._v(" "),a("p",[t._v("参数解析：")]),t._v(" "),a("p",[a("code",[t._v("hostname")]),t._v("  \t\t\t  域名 或 ip")]),t._v(" "),a("p",[a("code",[t._v("publish 、-p")]),t._v(" \t\t端口映射")]),t._v(" "),a("p",[a("code",[t._v("restart")]),t._v(" \t\t\t\t重启方式")]),t._v(" "),a("p",[a("code",[t._v("volume、-v")]),t._v(" \t\t   目录挂载")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d \\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--hostname")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.111 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(":443 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("222")]),t._v(":22 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" gitlab "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),t._v(" always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /srv/gitlab/config:/etc/gitlab "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /srv/gitlab/logs:/var/log/gitlab "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /srv/gitlab/data:/var/opt/gitlab "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  gitlab/gitlab-ce:latest\n")])])]),a("p",[t._v("2.查看当前的Docker进程。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker ps | grep  gitlab ")]),t._v("\n686f123b649c   gitlab/gitlab-ce:latest                             "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/assets/wrapper"')]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),t._v(" hours ago   Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" hours "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:80-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, :::80-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/tcp, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:443-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp, :::443-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/tcp, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:222-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v("/tcp, :::222-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v("/tcp   gitlab\n")])])]),a("p",[t._v("3.通过浏览器访问GitLab的页面： http://10.11.121.111")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204242235534.png",alt:"image-20220424223532525"}})]),t._v(" "),a("p",[t._v("4.这里默认的用户是 "),a("code",[t._v("root")]),t._v(" ，默认的密码只有24h有效，所以我们需要更改一下密码。")]),t._v(" "),a("p",[t._v("先查出用户的id，例如下面用户是root id=1")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker exec -it gitlab /bin/bash")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),t._v(":1,"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Administrator"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"root"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"state"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"active"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"avatar_url"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=80'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\u0026"}},[t._v("\\u0026")]),t._v('d=identicon"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"web_url"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.0.173/root"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nroot@10:/"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gitlab-rails console -e production")]),t._v("\n--------------------------------------------------------------------------------\n Ruby:         ruby "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.7")]),t._v(".4p191 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v("-07-07 revision a21a3b7d23"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("x86_64-linux"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n GitLab:       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14.4")]),t._v(".1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("1a23d731c9f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" FOSS\n GitLab Shell: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13.21")]),t._v(".1\n PostgreSQL:   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12.7")]),t._v("\n--------------------------------------------------------------------------------\nLoading production environment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Rails "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6.1")]),t._v(".4.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nirb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":001:"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("User.where"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id:1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".first\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#<User id:1 @root>")]),t._v("\nirb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":002:"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'00000000'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"00000000"')]),t._v("\nirb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":003:"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password_confirmation")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'00000000'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"00000000"')]),t._v("\nirb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":004:"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" u.save"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\nEnqueued ActionMailer::MailDeliveryJob "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Job ID: d7bc1e90-4941-4125-bf90-b018c92b5d73"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" to Sidekiq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("mailers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" with arguments: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DeviseMailer"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password_change"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deliver_now"')]),t._v(", "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(":args"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#<GlobalID:0x00007f0b99fbc3a8 @uri=#<URI::GID gid://gitlab/User/1>>]}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\nirb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("main"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":005:"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),a("h3",{attrs:{id:"_4-创建项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-创建项目"}},[t._v("#")]),t._v(" 4.创建项目")]),t._v(" "),a("p",[t._v("2.登录Gitlab之后，需要创建一个项目名称叫做"),a("code",[t._v("demo")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204242237733.png",alt:"image-20220424223745243"}})]),t._v(" "),a("p",[t._v("2.选择"),a("code",[t._v("public")]),t._v("，也是上市的意思，不需要初始化存储库。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204242240317.png",alt:"image-20220424224043845"}})]),t._v(" "),a("p",[t._v("3.首先我们拉取gitee上的源码到本地，再推送到Gitlab源码托管demo仓库的Master分支。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git clone https://gitee.com/cn-zhangyh/demo-2048.git ")]),t._v("\nCloning into "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'demo-2048'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nUsername "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://gitee.com'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" cn-zhangyh\nPassword "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://cn-zhangyh@gitee.com'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" \nremote: Enumerating objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v(", done.\nremote: Counting objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v("/71"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", done.\nremote: Compressing objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("59")]),t._v("/59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", done.\nremote: Total "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", reused "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", pack-reused "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nUnpacking objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v("/71"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", done.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd demo-2048/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll")]),t._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":28 Dockerfiles\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1491")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":28 pom.xml\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("315")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":28 README.md\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":28 src\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":06 template\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# git config --global user.name "Administrator"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# git config --global user.email "admin@example.com"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git init")]),t._v("\nReinitialized existing Git repository "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /opt/demo-2048/.git/\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git remote rename origin old-origin")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git remote add origin http://10.11.121.111/root/demo.git")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git add .")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# git commit -m "Initial commit"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# On branch master")]),t._v("\nnothing to commit, working directory clean\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master demo-2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git push -u origin --all")]),t._v("\nUsername "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://10.11.121.111'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" root\nPassword "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://root@10.11.121.111'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" \nCounting objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v(", done.\nDelta compression using up to "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(" threads.\nCompressing objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("59")]),t._v("/59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", done.\nWriting objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("% "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v("/71"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("82.04")]),t._v(" KiB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" bytes/s, done.\nTotal "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("71")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", reused "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("delta "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nTo http://10.11.121.111/root/demo2.git\n * "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("new branch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("      master -"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" master\nBranch master "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" up to track remote branch master from origin.\n")])])]),a("p",[t._v("4.再次刷新仓库查看，源码已经推送成功。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204242249037.png",alt:"image-20220424224925906"}})]),t._v(" "),a("p",[t._v("5.需要记住这里的Runner的"),a("code",[t._v("URL和Token")]),t._v("，因为后面的GitLab—Runner连接GitLab需要使用到。")]),t._v(" "),a("p",[t._v("此处我的URL: "),a("code",[t._v("http://10.11.121.111/")])]),t._v(" "),a("p",[t._v("此处我的Token："),a("code",[t._v("o4_NCTZvpnViRE7iGxoi")])]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250847343.png",alt:"image-20220424225358742"}})]),t._v(" "),a("h2",{attrs:{id:"部署gitlab-runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署gitlab-runner"}},[t._v("#")]),t._v(" 部署GitLab-Runner")]),t._v(" "),a("h3",{attrs:{id:"_1-gitlab-ci介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-gitlab-ci介绍"}},[t._v("#")]),t._v(" 1.GitLab-CI介绍")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250847312.webp",alt:"img"}})]),t._v(" "),a("p",[t._v("GitLab Runner是一个"),a("a",{attrs:{href:"https://so.csdn.net/so/search?q=%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE&spm=1001.2101.3001.7020",target:"_blank",rel:"noopener noreferrer"}},[t._v("开源项目"),a("OutboundLink")],1),t._v("，用于运行您的作业并将结果发送回GitLab。它与GitLab CI一起使用，GitLab CI是GitLab随附的开源持续集成服务，用于协调作业。")]),t._v(" "),a("p",[t._v("一般来说，gitlab上已由负责人配置好了"),a("code",[t._v("gitlab-runner")]),t._v("，我们只需要编写好"),a("code",[t._v(".gitlab.yml")]),t._v("文件提交代码即可触发runner进行工作。但对于初学者来说，你可能想能不能在提交代码前在本地先执行"),a("code",[t._v(".gitlab.yml")]),t._v("文件的job，本地调试成功检查没有问题后再进行最终代码的提交，触发服务端的CI流程。答案当然也是可以的。"),a("code",[t._v(".gitlab.yml")]),t._v("文件中定义的job其实是某个服务器中的"),a("code",[t._v("gitlab-runner")]),t._v("在运行，那我们也可以在本地安装好"),a("code",[t._v("gitlab-runner")]),t._v("手动的来执行本地"),a("code",[t._v(".gitlab.yml")]),t._v("中的"),a("code",[t._v("job")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"_2-gitlab-runner部署方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-gitlab-runner部署方式"}},[t._v("#")]),t._v(" 2.GitLab-Runner部署方式")]),t._v(" "),a("p",[t._v("你几乎可以在任何机器上安装"),a("code",[t._v("gitlab-runner")]),t._v("，安装的方式这里推荐如下几种：")]),t._v(" "),a("ul",[a("li",[t._v("Linux使用二进制的方式")]),t._v(" "),a("li",[t._v("Docker中使用容器的方式启动Gitlab—Runner")]),t._v(" "),a("li",[t._v("Helm包的方式安装Gitlab-Runner")])]),t._v(" "),a("p",[a("code",[t._v("如下我分别使用了两种不同的方式部署Gitlab-Runner，可以选择其中一种。")])]),t._v(" "),a("h3",{attrs:{id:"_3-docker部署runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-docker部署runner"}},[t._v("#")]),t._v(" 3.Docker部署Runner")]),t._v(" "),a("p",[a("strong",[t._v("1.安装gitlab runner")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d --name gitlab-runner --restart always \\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /srv/gitlab-runner/config:/etc/gitlab-runner "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /var/run/docker.sock:/var/run/docker.sock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  gitlab/gitlab-runner:latest\n")])])]),a("p",[a("strong",[t._v("2.注册gitlab runner")])]),t._v(" "),a("p",[t._v("参数解析：")]),t._v(" "),a("ol",[a("li",[t._v("gitlab-runner register 是启动register的命令")]),t._v(" "),a("li",[t._v("GitLab的Runner显示的URL地址： "),a("code",[t._v("--url")])]),t._v(" "),a("li",[t._v("GitLab的Runner显示的Token值：  "),a("code",[t._v("--registration-token")])]),t._v(" "),a("li",[t._v("设置Runner的标签： "),a("code",[t._v("--tag-list")])]),t._v(" "),a("li",[t._v("设置CICD构建时可以不启用Tag："),a("code",[t._v("--run-untagged")])])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run --rm -v /srv/gitlab-runner/config:/etc/gitlab-runner gitlab/gitlab-runner register \\")]),t._v("\n  --non-interactive "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--executor")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --docker-image alpine:latest "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--url")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://10.11.121.111/"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --registration-token "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o4_NCTZvpnViRE7iGxoi"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--description")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"first-register-runner"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --tag-list "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"k8s"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --run-untagged"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--locked")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --access-level"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"not_protected"')]),t._v(" \n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker ps | grep gitlab-runner ")]),t._v("\n3e0a02917540   gitlab/gitlab-runner:latest                         "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/dumb-init …"')]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" hours ago   Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" hours                                                                                                                             gitlab-runner\n")])])]),a("p",[a("strong",[t._v("2.查看Gitlab连接情况")])]),t._v(" "),a("p",[t._v("1.进入Gitlab的CICD配置中，找到Runner配置，刷新此页面。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848483.png",alt:"image-20220424231601423"}})]),t._v(" "),a("p",[t._v("2.或者在Menu的菜单栏中，找到 "),a("code",[t._v("Admin")]),t._v(", 然后选择 "),a("code",[t._v("Runner")]),t._v("，可以查看到当前的Runner连接情况。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848560.png",alt:"image-20220424231816380"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848031.png",alt:"image-20220424232117034"}})]),t._v(" "),a("h3",{attrs:{id:"_4-helm部署runner"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-helm部署runner"}},[t._v("#")]),t._v(" 4.Helm部署Runner")]),t._v(" "),a("p",[a("strong",[t._v("什么是Helm？")])]),t._v(" "),a("p",[t._v("就像 Java 使用 maven；node 使用 npm；python 使用 pip；Linux 使用 yum 或 Apt 一样，不管是什么样的工作，技术人员都会希望有一种资源管理器/包管理器，以此来方便得查找、下载、安装、使用和分发软件包。")]),t._v(" "),a("p",[t._v("Helm 使用的包格式称为 "),a("code",[t._v("chart")]),t._v("，它是一个描述 Kubernetes 相关资源对象的文件集合。它的技术特点类似 jinja模版，以渲染模版的方式，生成运行一个服务实例所需的一系列资源对象文件，并以此进行服务的发布。通过这种方式，我们也可以十分简单的制作自定义的 chart。")]),t._v(" "),a("p",[t._v("所以 Helm 即可以说是 "),a("code",[t._v("K8S的包管理器")]),t._v("，它使得我们对于 K8S 的操作不再需要细化到资源对象，而是可以作为一个实例进行管理。不再需要去写 "),a("code",[t._v("deployment")]),t._v(" 、"),a("code",[t._v("service")]),t._v(" 、"),a("code",[t._v("ingress")]),t._v(" 的 yaml，而是可以直接通过 "),a("code",[t._v("install")]),t._v(" 命令实现服务实例的安装。")]),t._v(" "),a("p",[a("strong",[t._v("1.拉取Gitlab-Runner的Chart包")])]),t._v(" "),a("p",[t._v("项目地址："),a("a",{attrs:{href:"https://links.jianshu.com/go?to=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fcharts%2Fgitlab-runner",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://gitlab.com/gitlab-org/charts/gitlab-runner"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master gitlab-runner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll")]),t._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("369")]),t._v(" Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(" 03:39 Chart.yaml\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" root root  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("236")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" 05:48 templates\n-rw-r--r-- "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6452")]),t._v(" Apr "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("24")]),t._v(" 05:47 values.yaml\n")])])]),a("p",[a("strong",[t._v("2.配置Chart的模板")])]),t._v(" "),a("p",[t._v("修改Chart包的values.yaml配置如下：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("gitlabUrl:")]),t._v(" \t配置Gitlab的URL")]),t._v(" "),a("li",[a("code",[t._v("runnerRegistrationToken:")]),t._v("      配置Gitlab的Runner的Token")]),t._v(" "),a("li",[a("code",[t._v("namespace:")]),t._v("     配置命名空间")]),t._v(" "),a("li",[a("code",[t._v("tags:")]),t._v("              配置标签")]),t._v(" "),a("li",[a("code",[t._v("cachePath:")]),t._v("     配置缓存路径")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlab/gitlab"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("v11.7.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlabUrl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://10.11.121.111"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runnerRegistrationToken")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"o4_NCTZvpnViRE7iGxoi"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("unregisterRunners")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("concurrent")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("checkInterval")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rbac")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterWideAccess")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metrics")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16.04")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"k8s"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cachePath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/opt/cache"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("builds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("helpers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),a("p",[a("strong",[t._v("3.Helm部署Gitlab-Runner")])]),t._v(" "),a("p",[t._v("使用"),a("code",[t._v("helm install")]),t._v("命令创建安装Gitlab—Runner。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master gitlab-cicd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm install k8s-runner gitlab-runner/ -n demo")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master gitlab-cicd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm list -n demo ")]),t._v("\nNAME      \tNAMESPACE\tREVISION\tUPDATED                                \tSTATUS  \tCHART               \tAPP VERSION\nk8s-runner\tdemo     \t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("       \t"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("-04-24 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("13")]),t._v(":13:11.742949709 +0000 UTC\tdeployed\tgitlab-runner-0.1.37\t\n")])])]),a("p",[a("strong",[t._v("4.查看Gitlab连接情况")])]),t._v(" "),a("p",[t._v("1.查看当前的资源是否创建成功。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get -n demo all")]),t._v("\nNAME                                            READY   STATUS    RESTARTS   AGE\npod/k8s-runner-gitlab-runner-544f469c44-9m7zw   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          155m\n\nNAME                                       READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/k8s-runner-gitlab-runner   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("           155m\n\nNAME                                                  DESIRED   CURRENT   READY   AGE\nreplicaset.apps/k8s-runner-gitlab-runner-544f469c44   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("       155m\n")])])]),a("p",[t._v("2.回到Gitlab刷新CICD的Runner的配置，新的Gitlab-Runner连接成功。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848984.png",alt:"image-20220424235055148"}})]),t._v(" "),a("p",[a("strong",[t._v("3.测试GitLab的CICD流水线")])]),t._v(" "),a("p",[t._v("1.进入demo的项目,点击 "),a("code",[t._v("CI/CD")]),t._v("，然后找到"),a("code",[t._v("Editor")]),t._v(" ，编写一个流水线脚本，运行job1，输出Hello Word。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848184.png",alt:"image-20220425000049979"}})]),t._v(" "),a("p",[t._v("如上的.gitlab-ci.yaml文件如下：")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" .pre\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy \n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" .pre\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "Hello Word"\n\n'),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "This is build"\n\n'),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "This is test"\n\n'),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "This is deploy"\n')])])]),a("p",[t._v("2.点击 "),a("code",[t._v("Commit changes")]),t._v(" 提交流水线脚本。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848169.png",alt:"image-20220425000312131"}})]),t._v(" "),a("p",[t._v("3.构建完成之后，查看当前的部署情况，可以发现四个阶段的任务都正常部署，所以说明Gitlab-CI已经可以正常运行。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848335.png",alt:"image-20220425000806089"}})]),t._v(" "),a("p",[t._v("4.点击Job1，查看当前的Job1输出的日志，是否为Hello Word。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848471.png",alt:"image-20220425001000417"}})]),t._v(" "),a("p",[t._v("如上图可以看到Job1任务输出的内容正常。")]),t._v(" "),a("h2",{attrs:{id:"部署harbor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署harbor"}},[t._v("#")]),t._v(" 部署Harbor")]),t._v(" "),a("h3",{attrs:{id:"_1-harbor介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-harbor介绍"}},[t._v("#")]),t._v(" 1.Harbor介绍")]),t._v(" "),a("p",[t._v("Harbor 源于 2014 年 VMware中国研发中心云原生实验室的一个内部项目，旨在为容器的开发人员解决镜像管理的问题。随着 Kubernetes 和容器技术的流行，该项目于 2016 年开源，2018 年 7 月捐赠给 CNCF，在同年 11 月被正式接受为孵化项目，并在云原生技术路线与生态中演进。")]),t._v(" "),a("p",[t._v("2020年5月 Harbor 2.0 正式发布，增加了对 OCI 制品的支持，能够存储大量云原生制品，例如容器镜像、Helm Chart、CNAB、OPA 和 Singularity 等等。开发人员可依照 OCI 规范，通过 OCI 索引和 OCI 制品功能开拓更广泛的应用场景，包括策略、远程复制和基于角色的访问控制等。")]),t._v(" "),a("h3",{attrs:{id:"_2-harbor部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-harbor部署"}},[t._v("#")]),t._v(" 2.Harbor部署")]),t._v(" "),a("ul",[a("li",[t._v("首选必须安装docker-compose的插件，这里我已经安装了docker-compose")]),t._v(" "),a("li",[t._v("禁用https策略，使用http策略")]),t._v(" "),a("li",[t._v("将hostname修改为10.11.121.112")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose version ")]),t._v("\nDocker Compose version v2.2.1\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar zxvf harbor-offline.tar.gz ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd harbor/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 opt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim harbor.yaml ")]),t._v("\nhostname: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.112\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http related config")]),t._v("\nhttp:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# port for http, default is 80. If https enabled, this port will redirect to https port")]),t._v("\n  port: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# https related config")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#https:")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# https port for harbor, default is 443")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  port: 443")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The path of cert and key files for nginx")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  certificate: /your/certificate/path")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  private_key: /your/private/key/path")]),t._v("\n")])])]),a("p",[t._v("执行命令安装Harbor，查看harbor的进程。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ./install.sh ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Step "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": checking "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" is installed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nNote: "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" version: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20.10")]),t._v(".14\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Step "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": checking "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" is installed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nNote: "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" version: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.2")]),t._v(".1\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Step "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": loading Harbor images "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n···\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Step "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": starting Harbor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Running "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("/10\n ⠿ Network harbor_harbor        Created                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(".1s\n ⠿ Container harbor-log         Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".6s\n ⠿ Container harbor-db          Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".6s\n ⠿ Container registryctl        Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(".2s\n ⠿ Container harbor-portal      Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".8s\n ⠿ Container registry           Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(".2s\n ⠿ Container redis              Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(".2s\n ⠿ Container harbor-core        Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(".0s\n ⠿ Container nginx              Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(".3s\n ⠿ Container harbor-jobservice  Started                                                                                                 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(".3s\n✔ ----Harbor has been installed and started successfully.----\n\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 harbor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose  ps ")]),t._v("\nNAME                COMMAND                  SERVICE             STATUS              PORTS\nharbor-core         "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/harbor/entrypoint.…"')]),t._v("   core                running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nharbor-db           "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/docker-entrypoint.…"')]),t._v("   postgresql          running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nharbor-jobservice   "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/harbor/entrypoint.…"')]),t._v("   jobservice          running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nharbor-log          "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/sh -c /usr/loc…"')]),t._v("   log                 running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1:1514-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10514")]),t._v("/tcp\nharbor-portal       "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon of…"')]),t._v("   portal              running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nnginx               "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx -g \'daemon of…"')]),t._v("   proxy               running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:80-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/tcp, :::80-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("/tcp\nredis               "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"redis-server /etc/r…"')]),t._v("   redis               running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nregistry            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/home/harbor/entryp…"')]),t._v("   registry            running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   \nregistryctl         "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/home/harbor/start.…"')]),t._v("   registryctl         running "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("healthy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n")])])]),a("p",[t._v("访问Harbor地址： http://10.11.121.112")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848345.png",alt:"image-20220425001823055"}})]),t._v(" "),a("h3",{attrs:{id:"_3-添加镜像仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-添加镜像仓库"}},[t._v("#")]),t._v(" 3.添加镜像仓库")]),t._v(" "),a("p",[t._v("点击 "),a("code",[t._v("新建项目")]),t._v(" ，创建项目名称为 "),a("code",[t._v("demo")]),t._v("，访问级别设置为 "),a("code",[t._v("公开")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848880.png",alt:"image-20220425002022377"}})]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848072.png",alt:"image-20220425002121911"}})]),t._v(" "),a("h2",{attrs:{id:"配置cicd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置cicd"}},[t._v("#")]),t._v(" 配置CICD")]),t._v(" "),a("h3",{attrs:{id:"_1-配置-gitlab-ci-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置-gitlab-ci-yml"}},[t._v("#")]),t._v(" 1.配置.gitlab-ci.yml")]),t._v(" "),a("p",[t._v("配置.gitlab-ci.yaml的流水线配置文件内容如下：")]),t._v(" "),a("ul",[a("li",[t._v("使用"),a("code",[t._v("docker:v1.0")]),t._v("的镜像作为基础镜像")]),t._v(" "),a("li",[t._v("需要构建三个步骤："),a("code",[t._v("maven-build、docker-build、deploy")])]),t._v(" "),a("li",[t._v("使用"),a("code",[t._v("maven镜像")]),t._v("构建编译demo-2048项目")]),t._v(" "),a("li",[t._v("使用"),a("code",[t._v("docker镜像")]),t._v("build新的镜像，推送到Harbor仓库中")]),t._v(" "),a("li",[t._v("使用"),a("code",[t._v("kubelet镜像")]),t._v("部署demo-2048的yaml文件")])]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" maven"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这是定义的变量，是Harbor仓库登录的验证信息。")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("USERNAME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" admin\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PASSWORD")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Harbor12345\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("HARBORIP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.11.121.112\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("maven-build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" maven"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("jdk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" maven"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p /root/.m2/repository\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rvf /opt/repository/*  /root/.m2/repository/\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mvn clean install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("Dmaven.test.sktip=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rvf /root/demo/target/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048  /opt/cache\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("docker_build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mv /opt/cache/* /root/demo/Dockerfiles/\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cd /root/demo/Dockerfiles/ "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" ls\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $HARBORIP/demo/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f /root/demo/Dockerfiles/Dockerfile . \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker login "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u $USERNAME "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p $PASSWORD $HARBORIP \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $HARBORIP/demo/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 这里的kubectl是做的镜像，是在本地仓库，使用config连接Kubernetes集群")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.16.6\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mkdir $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" cat $K8S_CONFIG "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" $HOME/.kube/config\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cd $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" pwd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i 's/10.24.2.3/10.11.121.112/g' /root/demo/template/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048.yaml \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i 's/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("build_tag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/v1.0/g' /root/demo/template/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048.yaml \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i 's/8889/30003/g' /root/demo/template/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048.yaml \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl apply "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("f /root/demo/template/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("2048.yaml\n")])])]),a("h3",{attrs:{id:"_2-开始构建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-开始构建"}},[t._v("#")]),t._v(" 2.开始构建")]),t._v(" "),a("p",[t._v("点击 "),a("code",[t._v("提交完成")]),t._v(" 构建CICD。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848856.png",alt:"image-20220425003143807"}})]),t._v(" "),a("p",[t._v("等待结果：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848288.png",alt:"image-20220425003438600"}})]),t._v(" "),a("h3",{attrs:{id:"_3-查看gitlab-ci"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-查看gitlab-ci"}},[t._v("#")]),t._v(" 3.查看Gitlab-CI")]),t._v(" "),a("p",[t._v("查看构建的输出日志内容。")]),t._v(" "),a("p",[t._v("如下是maven-build的输出内容：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848151.png",alt:"image-20220425003531697"}})]),t._v(" "),a("p",[t._v("如下是docker-build的输出内容：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848855.png",alt:"image-20220425003550405"}})]),t._v(" "),a("p",[t._v("如下是deploy的输出内容：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250848591.png",alt:"image-20220425003605898"}})]),t._v(" "),a("h3",{attrs:{id:"_4-访问项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-访问项目"}},[t._v("#")]),t._v(" 4.访问项目")]),t._v(" "),a("p",[t._v("查看当前的demo命名空间下的资源，demo-2048应用程序部署完成。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get  pods -n demo")]),t._v("\nNAME                                        READY   STATUS    RESTARTS   AGE\ndemo-2048-6858bb9f8d-522rn                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          3m19s\nk8s-runner-gitlab-runner-544f469c44-9m7zw   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          3h23m\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get svc -n demo ")]),t._v("\nNAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("          AGE\ndemo30003   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".113.92   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(":30003/TCP   3m24s\n")])])]),a("p",[t._v("访问页面： http://10.11.121.112:30003")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204250849199.png",alt:"image-20220425003906131"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);