(window.webpackJsonp=window.webpackJsonp||[]).push([[199],{512:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"ansible的roles"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ansible的roles"}},[t._v("#")]),t._v(" "),s("strong",[t._v("Ansible的roles")])]),t._v(" "),s("h2",{attrs:{id:"roles的介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles的介绍"}},[t._v("#")]),t._v(" roles的介绍")]),t._v(" "),s("h3",{attrs:{id:"roles的解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles的解析"}},[t._v("#")]),t._v(" roles的解析")]),t._v(" "),s("p",[t._v("​    ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。\n​    "),s("code",[t._v("roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。")]),t._v("\n​    "),s("code",[t._v("要使用roles只需要在playbook中使用include指令即可。")]),t._v("\n​    "),s("code",[t._v("简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，")]),t._v("\n​    并可以便捷地include它们的一种机制。\n​    角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中")]),t._v(" "),s("p",[t._v("​\t复杂场景：建议使用roles，代码复用度高\n​    变更指定主机或主机组\n​    如命名不规范维护和传承成本大\n​    某些功能需多个Playbook，通过includes即可实现")]),t._v(" "),s("h3",{attrs:{id:"roles"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles"}},[t._v("#")]),t._v(" "),s("strong",[t._v("Roles")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("角色"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("roles"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("：角色集合\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n└── roles\n    ├── httpd\n    ├── memcache\n    ├── mysql\n    └── nginx\n    \n可以互相调用\n")])])]),s("h3",{attrs:{id:"roles各目录作用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles各目录作用"}},[t._v("#")]),t._v(" Roles各目录作用")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/roles/project/ :项目名称,有以下子目录\n    files/ ：存放由copy或script模块等调用的文件\n    templates/：template模块查找所需要模板文件的目录\n    tasks/：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；\n            其它的文件需要在此文件中通过include进行包含\n    handlers/：至少应该包含一个名为main.yml的文件；\n               其它的文件需要在此文件中通过include进行包含\n    vars/：定义变量，至少应该包含一个名为main.yml的文件；\n           其它的文件需要在此文件中通过include进行包含\n    meta/：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，\n           其它文件需在此文件中通过include进行包含\n    default/：设定默认变量时使用此目录中的main.yml文件\n    \nroles/appname 目录结构\n    tasks目录：至少应该包含一个名为main.yml的文件，其定义了此角色的任务列表；\n               此文件可以使用include包含其它的位于此目录中的task文件\n    files目录：存放由copy或script等模块调用的文件；\n    templates目录：template模块会自动在此目录中寻找Jinja2模板文件\n    handlers目录：此目录中应当包含一个main.yml文件，用于定义此角色用到的各handler；\n                  在handler中使用include包含的其它的handler文件也应该位于此目录中；\n    vars目录：应当包含一个main.yml文件，用于定义此角色用到的变量；\n    meta目录：应当包含一个main.yml文件，用于定义此角色的特殊设定及其依赖关系；\n              ansible1.3及其以后的版本才支持；\n    default目录：为当前角色设定默认变量时使用此目录；应当包含一个main.yml文件\n\nroles/example_role/files/             所有文件，都将可存放在这里\nroles/example_role/templates/         所有模板都存放在这里\nroles/example_role/tasks/main.yml：   主函数，包括在其中的所有任务将被执行\nroles/example_role/handlers/main.yml：所有包括其中的 handlers 将被执行\nroles/example_role/vars/main.yml：    所有包括在其中的变量将在roles中生效\nroles/example_role/meta/main.yml：    roles所有依赖将被正常登入\n\n")])])]),s("h3",{attrs:{id:"创建role"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建role"}},[t._v("#")]),t._v(" 创建role")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("创建role的步骤\n(1) 创建以roles命名的目录\n(2) 在roles目录中分别创建以各角色名称命名的目录，如webservers等\n(3) 在每个角色命名的目录中分别创建files、handlers、meta、tasks、templates和vars目录；\n    用不到的目录可以创建为空目录，也可以不创建\n(4) 在playbook文件中，调用各角色\n")])])]),s("h3",{attrs:{id:"实验-创建nginx角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实验-创建nginx角色"}},[t._v("#")]),t._v(" 实验: 创建nginx角色")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".创建roles目录\n   "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" roles/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("httpd,mysql,redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/tasks "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-pv")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v("  roles/httpd/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("handlers,files"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n   \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".查看目录结构\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree  roles/")]),t._v("\nroles/\n└── nginx\n    ├── tasks\n    └── templates\n        \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(".创建目标文件\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#touch group.yaml user.yaml yum.yaml templates.yaml start.yaml")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim group.yaml ")]),t._v("\n- name: create group \n  group: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim  user.yaml ")]),t._v("\n- name: create user \n  user: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/sbin/nologin\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim  yum.yaml ")]),t._v("\n- name: copy "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" \n  copy: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/yum.repos.d/CentOS-Base.repo "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/yum.repos.d/CentOS-Base.repo\n- name: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" packages \n  yum: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim templates.yaml ")]),t._v("\n- name:  copy conf \n  template: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx.conf.j2 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/nginx/nginx.conf \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim start.yaml ")]),t._v("\n- name: start "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" \n  service: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("state")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("started "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("yes\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(".创建main.yml主控文件,调用以上单独的yml文件,main.yml定义了谁先执行谁后执行的顺序\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim main.yaml ")]),t._v("\n- include: group.yaml \n- include: user.yaml \n- include: yum.yaml \n- include: templates.yaml\n- include: start.yaml \n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v(".创建好j2的nginx配置文件\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim templates/nginx.conf.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# For more information on configuration, see:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   * Official English Documentation: http://nginx.org/en/docs/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   * Official Russian Documentation: http://nginx.org/ru/docs/")]),t._v("\n\nuser nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_processes "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ansible_processor_vcpus+2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#改个CPU数量")]),t._v("\nerror_log /var/log/nginx/error.log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\npid /run/nginx.pid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(".在roles同级的情况下创建使用角色role的yaml文件。\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim nginx_role.yaml  ")]),t._v("\n- hosts: server \n  remote_user: root \n  roles: \n    - role: nginx  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#调用角色")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(".查看完整的目录结构\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree  roles ")]),t._v("\nroles\n├── httpd\n├── memcache\n├── mysql\n└── nginx\n    ├── tasks\n    │   ├── group.yaml\n    │   ├── main.yaml\n    │   ├── start.yaml\n    │   ├── templates.yaml\n    │   ├── user.yaml\n    │   └── yum.yaml\n    └── templates\n        └── nginx.conf.j2\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(".运行role的剧本\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ansible-playbook nginx_role.yaml ")]),t._v("\n\nPLAY "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" **********************************************************************************************************\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Gathering Facts"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" *************************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" create group"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" ********************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" create user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" *********************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" copy file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" ***********************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" packages"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" ****************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" copy conf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" ***********************************************************************************************\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nok: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nTASK "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" start service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" *******************************************************************************************\nchanged: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nchanged: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nchanged: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nPLAY RECAP *************************************************************************************************************\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.105              "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ok")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("changed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("unreachable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("failed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("skipped")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("rescued")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ignored")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("   \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.106              "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ok")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("changed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("unreachable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("failed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("skipped")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("rescued")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ignored")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("   \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".1.107              "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ok")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("changed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("unreachable")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("failed")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("skipped")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("rescued")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ignored")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \n\n")])])]),s("h3",{attrs:{id:"roles多角色调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles多角色调用"}},[t._v("#")]),t._v(" roles多角色调用")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#调用角色方法1：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim web.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" server \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("remote_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root \n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" httpd \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#调用角色方法2")]),t._v("\n传递变量给角色\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("remote_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mysql\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#不同的角色调用不同的变量  ")]),t._v("\n    键role用于指定角色名称\n    后续的k/v用于传递变量给角色\n\n调用角色方法3：还可基于条件测试实现角色调用\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ansible_distribution_major_version == '7' "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"通过roles传递变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过roles传递变量"}},[t._v("#")]),t._v(" 通过roles传递变量")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("通过roles传递变量\n当给一个主机应用角色的时候可以传递变量，然后在角色内使用这些变量\n示例：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" webservers\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" common\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" foo_app_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/web/htdocs/a.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"向roles传递参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#向roles传递参数"}},[t._v("#")]),t._v(" 向roles传递参数")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("而在playbook中，可以这样使用roles：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" webservers\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" common\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" webservers\n\n也可以向roles传递参数\n示例：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" webservers\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" common\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" foo_app_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/opt/a'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" foo_app_instance"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/opt/b'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5001")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"条件式地使用roles"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#条件式地使用roles"}},[t._v("#")]),t._v(" 条件式地使用roles")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("甚至也可以条件式地使用roles\n示例：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" webservers\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" some_role"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"ansible_os_family == 'RedHat'\"")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"roles条件及变量等案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles条件及变量等案例"}},[t._v("#")]),t._v(" Roles条件及变量等案例")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("When条件\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"ansible_distribution_major_version == '7' \"")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n变量调用\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" zabbix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("proxy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("sudo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" yes\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" geerlingguy.php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" dj"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("wasabi.zabbix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("proxy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("zabbix_server_host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.37.167 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"完整的roles架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#完整的roles架构"}},[t._v("#")]),t._v(" 完整的roles架构")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("// nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role.yml 顶层任务调用yml文件\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" testweb\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("remote_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" httpd 可执行多个role\n\ncat roles/nginx/tasks/main.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" groupadd.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" useradd.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" restart.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" filecp.yml\n\n// roles/nginx/tasks/groupadd.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" add group nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name=nginx state=present\n\ncat roles/nginx/tasks/filecp.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" file copy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=tom.conf dest=/tmp/tom.conf\n\n以下文件格式类似：\nuseradd.yml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("install.yml"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("restart.yml\n\nls roles/nginx/files/\ntom.conf\n")])])]),s("h3",{attrs:{id:"roles-playbook-tags使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#roles-playbook-tags使用"}},[t._v("#")]),t._v(" roles playbook tags使用")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("roles playbook tags使用\n    ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("playbook "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('tags="nginx'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("httpd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('mysql" nginx'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role.yml  对标签进行挑选执行\n\n// nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role.yml\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" testweb\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("remote_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'web'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_distribution_major_version == "6“ '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" httpd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'httpd'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'web'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'db'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" marridb "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'db'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" php "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h3",{attrs:{id:"实验-创建角色memcached"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#实验-创建角色memcached"}},[t._v("#")]),t._v(" 实验: 创建角色memcached")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[t._v("memcacched 当做缓存用"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v('会在内存中开启一块空间充当缓存\ncat /etc/sysconfig/memcached \n    PORT="11211"\n    USER="memcached"\n    MAXCONN="1024"\n    CACHESIZE="64"    '),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 缓存空间默认64M ")]),t._v('\n    OPTIONS=""\n\n1'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" 创建对用目录\n   cd /app/ansible\n   mkdir roles/memcached/"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("tasks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("templates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pv\n   \n2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(' 拷贝memcached配置文件模板\n   cp /etc/sysconfig/memcached  templates/memcached.j2\n   vim templates/memcached.j2\n   CACHESIZE="'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("ansible_memtotal_mb//4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"   '),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#物理内存的1/4用做缓存")]),t._v("\n   \n3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" 创建对应yml文件"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("并做相应配置\n   cd tasks/\n   touch install.yml config.yml service.yml\n   创建main.yml文件定义任务执行顺序\n   vim main.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" service.yml  \n   \n   vim install.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install \n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name=memcached\n     \n   vim config.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config file\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=memcached.j2 dets=/etc/sysconfig/memcached\n\n   vim service.yml\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" service\n     "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name=memcached state=started enabled=yes\n\n4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" 创建调用角色文件\n   cd /app/ansible/roles/\n   vim role_memcached.yml\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" appsrvs\n    \n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("role")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" memcached\n\n5"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" 安装\n   ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("playbook  role_memcached.yml \n   memcached端口号11211\n")])])]),s("h3",{attrs:{id:"其它功能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其它功能"}},[t._v("#")]),t._v(" 其它功能")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('委任（指定某一台机器做某一个task）\n    delegate_to\n    local_action (专指针对ansible命令执行的机器做的变更操作)\n交互提示\n    prompt\n*暂停（java）\n    wait_for\nDebug\n    debug: msg="This always executes."\nInclude\nTemplate 多值合并\nTemplate 动态变量配置\n')])])])])}),[],!1,null,null,null);s.default=e.exports}}]);