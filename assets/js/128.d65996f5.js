(window.webpackJsonp=window.webpackJsonp||[]).push([[128],{442:function(s,t,a){"use strict";a.r(t);var e=a(7),r=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"istio安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#istio安装"}},[s._v("#")]),s._v(" Istio安装")]),s._v(" "),t("h2",{attrs:{id:"使用istioctl安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用istioctl安装"}},[s._v("#")]),s._v(" 使用Istioctl安装")]),s._v(" "),t("h3",{attrs:{id:"_1-拉取istio的安装包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-拉取istio的安装包"}},[s._v("#")]),s._v(" 1.拉取Istio的安装包")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-O")]),s._v(" http://192.168.1.110/file/istio-1.9.5-linux-amd64.tar.gz\n\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" \nistio-1.9.5-linux-amd64.tar.gz\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-zxvf")]),s._v(" istio-1.9.5-linux-amd64.tar.gz\n")])])]),t("h3",{attrs:{id:"_2-复制istioctl工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-复制istioctl工具"}},[s._v("#")]),s._v(" 2.复制istioctl工具")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" istio-1.9.5/\n$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" bin/istioctl  /usr/local/bin/\n")])])]),t("h3",{attrs:{id:"_3-使用默认配置文件安装-istio"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-使用默认配置文件安装-istio"}},[s._v("#")]),s._v(" 3.使用默认配置文件安装 Istio")]),s._v(" "),t("p",[s._v("最简单的选择是 使用以下命令安装"),t("code",[s._v("default")]),s._v("Istio "),t("a",{attrs:{href:"https://istio.io/latest/docs/setup/additional-setup/config-profiles/",target:"_blank",rel:"noopener noreferrer"}},[s._v("配置文件"),t("OutboundLink")],1),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ istioctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\n")])])]),t("h3",{attrs:{id:"_4-安装不同的配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装不同的配置文件"}},[s._v("#")]),s._v(" 4.安装不同的配置文件")]),s._v(" "),t("p",[s._v("通过在命令行上传递配置文件名称，可以将其他 Istio 配置文件安装到集群中。例如，以下命令可用于安装"),t("code",[s._v("demo")]),s._v("配置文件：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl  create  ns istio-system\n$ istioctl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("profile")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("demo "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n✔ Istio core installed                                                   \n✔ Istiod installed                                                  \n✔ Egress gateways installed                                                        \n✔ Ingress gateways installed                                                        \n✔ Installation complete    \n")])])]),t("h3",{attrs:{id:"_5-检查安装了什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-检查安装了什么"}},[s._v("#")]),s._v(" 5.检查安装了什么")]),s._v(" "),t("p",[s._v("该"),t("code",[s._v("istioctl")]),s._v("命令将"),t("code",[s._v("IstioOperator")]),s._v("用于安装 Istio的CR保存在名为"),t("code",[s._v("installed-state")]),s._v(". 而不是检查 Istio 安装的部署、pod、服务和其他资源，例如：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" istio-system get deploy\nNAME                   READY   UP-TO-DATE   AVAILABLE   AGE\nistio-egressgateway    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           25s\nistio-ingressgateway   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           24s\nistiod                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("           20s\n")])])]),t("h3",{attrs:{id:"_6-注入默认变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-注入默认变量"}},[s._v("#")]),s._v(" 6.注入默认变量")]),s._v(" "),t("p",[s._v("将目录更改为 Istio 安装的根目录。\n默认的 Istio 安装使用"),t("a",{attrs:{href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",target:"_blank",rel:"noopener noreferrer"}},[s._v("自动边车注入"),t("OutboundLink")],1),s._v("。标记将托管应用程序的命名空间"),t("code",[s._v("istio-injection=enabled")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl label namespace default istio-injection"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("enabled \n")])])]),t("h3",{attrs:{id:"卸载-istio"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#卸载-istio"}},[s._v("#")]),s._v(" 卸载 Istio")]),s._v(" "),t("p",[s._v("要从集群中完全卸载 Istio，请运行以下命令：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ istioctl x uninstall "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--purge")]),s._v("\n")])])]),t("p",[s._v("可选"),t("code",[s._v("--purge")]),s._v("标志将删除所有 Istio 资源，包括可能与其他 Istio 控制平面共享的集群范围的资源。")]),s._v(" "),t("h2",{attrs:{id:"测试一个实例"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试一个实例"}},[s._v("#")]),s._v(" 测试一个实例")]),s._v(" "),t("h3",{attrs:{id:"bookinfo"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#bookinfo"}},[s._v("#")]),s._v(" Bookinfo")]),s._v(" "),t("p",[t("strong",[s._v("Bookinfo 应用程序分为四个独立的微服务：")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("productpage")]),s._v(". 该"),t("code",[s._v("productpage")]),s._v("微服务调用"),t("code",[s._v("details")]),s._v("和"),t("code",[s._v("reviews")]),s._v("微服务来填充页面。")]),s._v(" "),t("li",[t("code",[s._v("details")]),s._v(". 该"),t("code",[s._v("details")]),s._v("微服务包含图书信息。")]),s._v(" "),t("li",[t("code",[s._v("reviews")]),s._v(". 该"),t("code",[s._v("reviews")]),s._v("微服务包含了书评。它还调用"),t("code",[s._v("ratings")]),s._v("微服务。")]),s._v(" "),t("li",[t("code",[s._v("ratings")]),s._v(". 该"),t("code",[s._v("ratings")]),s._v("微服务包含预定伴随书评排名信息。")])]),s._v(" "),t("p",[t("strong",[t("code",[s._v("reviews")]),s._v("微服务有 3 个版本：")])]),s._v(" "),t("ul",[t("li",[s._v("版本 v1 不调用该"),t("code",[s._v("ratings")]),s._v("服务。")]),s._v(" "),t("li",[s._v("版本 v2 调用该"),t("code",[s._v("ratings")]),s._v("服务，并将每个评级显示为 1 到 5 颗黑星。")]),s._v(" "),t("li",[s._v("版本 v3 调用该"),t("code",[s._v("ratings")]),s._v("服务，并将每个评级显示为 1 到 5 颗红星。")])]),s._v(" "),t("p",[s._v("该应用程序的端到端架构如下所示。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://pic.imgdb.cn/item/61ec02b22ab3f51d91299fc2.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"使用istio部署应用程序"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用istio部署应用程序"}},[s._v("#")]),s._v(" 使用Istio部署应用程序")]),s._v(" "),t("p",[s._v("使用 Istio 运行示例不需要更改应用程序本身。相反，您只需要在支持 Istio 的环境中配置和运行服务，并在每个服务旁边注入 Envoy sidecar。生成的部署将如下所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://pic.imgdb.cn/item/61ec02b22ab3f51d91299fca.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"启动应用服务🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动应用服务🚀"}},[s._v("#")]),s._v(" 启动应用服务🚀")]),s._v(" "),t("p",[s._v("使用以下"),t("code",[s._v("kubectl")]),s._v("命令部署您的应用程序：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" samples/bookinfo/platform/kube/bookinfo.yaml\n")])])]),t("h4",{attrs:{id:"查看所有服务🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看所有服务🚀"}},[s._v("#")]),s._v(" 查看所有服务🚀")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc ")]),s._v("\nNAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    AGE\ndetails       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.104")]),s._v(".17.202    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9080")]),s._v("/TCP   21m\nkubernetes    ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.1        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP    41m\nproductpage   ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.110")]),s._v(".235.179   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9080")]),s._v("/TCP   21m\nratings       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.104")]),s._v(".53.51     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9080")]),s._v("/TCP   21m\nreviews       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".21.63     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9080")]),s._v("/TCP   21m\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods ")]),s._v("\nNAME                              READY   STATUS    RESTARTS   AGE\ndetails-v1-79f774bdb9-gwhkf       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\nproductpage-v1-6b746f74dc-6dtg8   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\nratings-v1-b6994bb9-9h2wn         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\nreviews-v1-545db77b95-6cmmv       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\nreviews-v2-7bf8c9648f-m2k9d       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\nreviews-v3-84779c7bbc-vd86b       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\n")])])]),t("h4",{attrs:{id:"通过curl请求测试🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#通过curl请求测试🚀"}},[s._v("#")]),s._v(" 通过Curl请求测试🚀")]),s._v(" "),t("p",[s._v("要确认 Bookinfo 应用程序正在运行，请通过"),t("code",[s._v("curl")]),s._v("来自某个 pod的命令向其发送请求，例如来自"),t("code",[s._v("ratings")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath=\'{.items[0].metadata.name}\')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("title"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("Simple Bookstore App"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("/title"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),t("h4",{attrs:{id:"确定入口ip和端口🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#确定入口ip和端口🚀"}},[s._v("#")]),s._v(" 确定入口IP和端口🚀")]),s._v(" "),t("p",[s._v("现在 Bookinfo 服务已启动并运行，您需要使应用程序可从 Kubernetes 集群外部访问，例如从浏览器访问。一个"),t("a",{attrs:{href:"https://istio.io/latest/docs/concepts/traffic-management/#gateways",target:"_blank",rel:"noopener noreferrer"}},[s._v("Istio网关"),t("OutboundLink")],1),s._v(" 用于此目的。")]),s._v(" "),t("ol",[t("li",[t("strong",[t("code",[s._v("为应用定义入口网关")])])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml ")]),s._v("\ngateway.networking.istio.io/bookinfo-gateway created\nvirtualservice.networking.istio.io/bookinfo created\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[t("strong",[t("code",[s._v("确认网关已创建")])])])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get gateway ")]),s._v("\nNAME               AGE\nbookinfo-gateway   61s\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[t("strong",[t("code",[s._v("改为NodePort")])]),s._v("\n此处我们并没有外部负载，所以要将svc修改成NodePort的方式。")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n istio-system ")]),s._v("\nNAME                   TYPE         CLUSTER-IP      EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                                                                      AGE\nistio-egressgateway    ClusterIP    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.102")]),s._v(".197.30   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP,443/TCP,15443/TCP                                                     89m\nistio-ingressgateway   LoadBalancer "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.109")]),s._v(".71.35    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15021")]),s._v(":31964/TCP,80:31467/TCP,443:31845/TCP,31400:31077/TCP,15443:30757/TCP   89m\nistiod                 ClusterIP    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.111")]),s._v(".156.86   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15010")]),s._v("/TCP,15012/TCP,443/TCP,15014/TCP                                        90m\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#访问masterIP+80端口对应暴露的31962")]),s._v("\n")])])]),t("p",[t("code",[s._v("注意： 如果 EXTERNAL-IP 设置了该值，则要求您的环境具有可用于 Ingress 网关的外部负载均衡器。如果 EXTERNAL-IP 值是 <none>（或一直是 <pending> ），则说明可能您的环境不支持为 ingress 网关提供外部负载均衡器的功能。在这种情况下，您可以使用 Service 的 node port 方式访问网关。")])]),s._v(" "),t("p",[s._v("使用 kubectl patch 更新 istio-ingressgateway 服务网关类型")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master istio-1.9.5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# kubectl patch service istio-ingressgateway -n istio-system -p \'{"spec":{"type":"NodePort"}}\'')]),s._v("\n")])])]),t("p",[s._v("设置入口端口")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INGRESS_PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" istio-system get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" istio-ingressgateway "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.spec.ports[?(@.name==\"http2\")].nodePort}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("SECURE_INGRESS_PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" istio-system get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" istio-ingressgateway "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.spec.ports[?(@.name==\"https\")].nodePort}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TCP_INGRESS_PORT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" istio-system get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" istio-ingressgateway "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.spec.ports[?(@.name==\"tcp\")].nodePort}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])])]),t("p",[s._v("获取ingress ip地址")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("INGRESS_HOST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("kubectl get po "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("istio")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ingressgateway "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" istio-system "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{.items[0].status.hostIP}'")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])])]),t("p",[t("img",{attrs:{src:"https://pic.imgdb.cn/item/61ec02cb2ab3f51d9129b8c9.png",alt:""}})]),s._v(" "),t("h4",{attrs:{id:"应用默认目标规则🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应用默认目标规则🚀"}},[s._v("#")]),s._v(" 应用默认目标规则🚀")]),s._v(" "),t("p",[s._v("在使用 Istio 控制 Bookinfo 版本路由之前，您需要在"),t("a",{attrs:{href:"https://istio.io/latest/docs/concepts/traffic-management/#destination-rules",target:"_blank",rel:"noopener noreferrer"}},[s._v("目标规则中"),t("OutboundLink")],1),s._v("定义可用版本，称为"),t("em",[s._v("子集")]),s._v("。")]),s._v(" "),t("p",[s._v("运行以下命令为 Bookinfo 服务创建默认目标规则：")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" samples/bookinfo/networking/destination-rule-all.yaml\n")])])]),t("blockquote",[t("p",[s._v("在"),t("code",[s._v("default")]),s._v("与"),t("code",[s._v("demo")]),s._v(" "),t("a",{attrs:{href:"https://istio.io/latest/docs/setup/additional-setup/config-profiles/",target:"_blank",rel:"noopener noreferrer"}},[s._v("配置轮廓"),t("OutboundLink")],1),s._v("具有"),t("a",{attrs:{href:"https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#auto-mutual-tls",target:"_blank",rel:"noopener noreferrer"}},[s._v("自动相互TLS"),t("OutboundLink")],1),s._v("启用默认情况下。要强制实施双向 TLS，请使用"),t("code",[s._v("samples/bookinfo/networking/destination-rule-all-mtls.yaml")]),s._v(".")])]),s._v(" "),t("h4",{attrs:{id:"清理🚀"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#清理🚀"}},[s._v("#")]),s._v(" 清理🚀")]),s._v(" "),t("p",[s._v("当您完成 Bookinfo 示例的试验后，请按照以下说明卸载并清理它：\n删除路由规则并终止应用程序 Pod")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ samples/bookinfo/platform/kube/cleanup.sh\n")])])]),t("p",[s._v("确认关机")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl get virtualservices   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#-- there should be no virtual services")]),s._v("\n$ kubectl get destinationrules  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#-- there should be no destination rules")]),s._v("\n$ kubectl get gateway           "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#-- there should be no gateway")]),s._v("\n$ kubectl get pods              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#-- the Bookinfo pods should be deleted")]),s._v("\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);