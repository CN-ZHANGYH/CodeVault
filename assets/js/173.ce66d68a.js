(window.webpackJsonp=window.webpackJsonp||[]).push([[173],{484:function(t,a,s){"use strict";s.r(a);var n=s(7),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab-runner-k8s-实现自动部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-runner-k8s-实现自动部署"}},[t._v("#")]),t._v(" Gitlab-Runner + k8s 实现自动部署")]),t._v(" "),a("h2",{attrs:{id:"过程说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#过程说明"}},[t._v("#")]),t._v(" 过程说明")]),t._v(" "),a("ol",[a("li",[t._v("想要实现自动部署，就要借助工具"),a("code",[t._v("kubectl")]),t._v("安装文档 https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-linux")]),t._v(" "),a("li",[t._v("将该工具集成到 alpine 镜像里面，当然也可以去 docker 仓库找个现成的")]),t._v(" "),a("li",[t._v("准备好 k8s 配置文件，使得"),a("code",[t._v("kubectl")]),t._v("工具能连接上 k8s 集群")]),t._v(" "),a("li",[t._v("准备部署的命令，这里又分两种情况，一种是删掉 deployment 重新部署 ，另一种是更新 deployment 以重启 pod。第一种需要准备 deployment 的配置文件，而每次更新只是拉取新的镜像而已，因此这里选择第二种。第二种实现的方式是添加一个时间变量，触发 pod 更新，以免系统认为配置文件不变而没有更新 pod")])]),t._v(" "),a("h2",{attrs:{id:"准备kubectl镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备kubectl镜像"}},[t._v("#")]),t._v(" 准备kubectl镜像")]),t._v(" "),a("h3",{attrs:{id:"_1-编排dockerfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-编排dockerfile"}},[t._v("#")]),t._v(" 1.编排Dockerfile")]),t._v(" "),a("p",[t._v("因为Kubelet是作为一个工具，所以我们需要将"),a("code",[t._v("kubelet")]),t._v("工具安装到"),a("code",[t._v("alpine")]),t._v("镜像中。")]),t._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[t._v("[root@k8s-master ~]# cat Dockerfile\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" alpine:latest")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ARG")]),t._v(" KUBE_LATEST_VERSION=v1.15.3")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RUN apk add --update ca-certificates")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" apk add --update -t deps curl")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" curl -L https://storage.googleapis.com/kubernetes-release/release/"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${KUBE_LATEST_VERSION}")]),t._v("/bin/linux/amd64/kubectl -o /usr/local/bin/kubectl")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" chmod +x /usr/local/bin/kubectl")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" apk del --purge deps")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" rm /var/cache/apk/*")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-构建镜像"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-构建镜像"}},[t._v("#")]),t._v(" 2.构建镜像")]),t._v(" "),a("p",[t._v("通过Docker build构建镜像")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# docker build --build-arg KUBE_LATEST_VERSION="v1.16.6" -t kubectl:v1.16.6 .')]),t._v("\n")])])]),a("h2",{attrs:{id:"准备k8s配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备k8s配置文件"}},[t._v("#")]),t._v(" 准备k8s配置文件")]),t._v(" "),a("ol",[a("li",[t._v("配置文件也可以集成在镜像里面，但是不太灵活，一旦配置有变或者有多个集群，镜像就得修改或者准备多个版本，因此通过 gitlab ci/cd 环境变量传递")]),t._v(" "),a("li",[t._v("首先取得配置信息，通过命令"),a("code",[t._v("kubectl config view --raw -o yaml")]),t._v("得到配置信息，复制到 gitlab 的 ci/cd 环境变量中")]),t._v(" "),a("li",[t._v("这里要注意的是，命令必须带参数"),a("code",[t._v("--raw")]),t._v("，为了将 certificate-authority-data 的值输出，否则只能看到 DATA+OMITTED。另外，环境变量必须选择文件类型，否则最后输出格式不对，导致"),a("code",[t._v("mapping values are not allowed in this context")]),t._v("错误，当然选择"),a("code",[t._v("-o json")]),t._v("，使用 json 格式，就不用担心格式问题")])]),t._v(" "),a("h3",{attrs:{id:"_1-复制config"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-复制config"}},[t._v("#")]),t._v(" 1.复制config")]),t._v(" "),a("p",[t._v("通过"),a("code",[t._v("kubectl config")]),t._v("命令查看也可以直接"),a("code",[t._v("cat ~/.kube/config")]),t._v(" 查看。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config view --raw -o yaml")]),t._v("\n")])])]),a("h3",{attrs:{id:"_2-在gitlab添加变量"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-在gitlab添加变量"}},[t._v("#")]),t._v(" 2.在GitLab添加变量")]),t._v(" "),a("p",[t._v("在"),a("code",[t._v('"Settings"')]),t._v("选择中找到"),a("code",[t._v("“CI/CD”")]),t._v("，点击"),a("code",[t._v("“Variables”")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204240956975.png",alt:"image-20220423231346639"}})]),t._v(" "),a("p",[t._v("点击"),a("code",[t._v("“Add variable”")]),t._v(" 添加变量。添加"),a("code",[t._v("K8S_CONFIG")]),t._v("对应的值是"),a("code",[t._v("config")]),t._v("内容。")]),t._v(" "),a("p",[t._v("变量"),a("code",[t._v("$KUBE_CONFIG")]),t._v(" 实际上是个地址，因为 "),a("code",[t._v("gitlab ci/cd")]),t._v(" 环境变量类型设置为 "),a("code",[t._v("file")]),t._v("。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204240956911.png",alt:"image-20220423231824145"}})]),t._v(" "),a("h3",{attrs:{id:"_3-gitlab其他细节"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-gitlab其他细节"}},[t._v("#")]),t._v(" 3. Gitlab其他细节")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("还有个就是网络问题。gitlab-runner 创建的这个基于"),a("code",[t._v("kubectl:v1.16.6")]),t._v("镜像的容器，是访问不到 k8s 集群的，因为不是在同一个网络，而 k8s 集群又没设置通过外网访问。这里的简单处理方法是在 gitlab-runner 配置中，将网络模式设置为 host，因为这里是 microk8s 创建的单节点集群，总之只要达到使他们处于同一个网络或者可以访问即可。")])]),t._v(" "),a("li",[a("p",[t._v("Gitlab Runner每次执行都会拉取docker镜像的问题。找到搭建Gitlab Runner时创建的"),a("code",[t._v("config.toml")]),t._v("文件，加上："),a("code",[t._v("pull_policy = “if-not-present”")])])]),t._v(" "),a("li",[a("p",[t._v("配置的两个参数：")]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v("pull_policy")]),t._v(" = "),a("strong",[t._v('"if-not-present"')])])]),t._v(" "),a("li",[a("p",[a("code",[t._v("network_mode")]),t._v(" = "),a("strong",[t._v('"host"')])])])])])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /srv/gitlab-runner/config/")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat config.toml")]),t._v("\nconcurrent = 1\ncheck_interval = 0\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("session_server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  session_timeout = 1800\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('\n  name = "first'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("register"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('runner"\n  url = "http'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('//10.11.121.111/"\n  token = "'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('qu5oc3WSLxUbGd7hQri"\n  executor = "docker"\n  '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.custom_build_dir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.cache"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.cache.s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.cache.gcs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.cache.azure"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("runners.docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('\n    tls_verify = false\n    image = "alpine'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v('latest"\n    privileged = false\n    disable_entrypoint_overwrite = false\n    oom_kill_disable = false\n    disable_cache = false\n    volumes = '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v('\n    shm_size = 0\n    pull_policy = "if'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("not"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('present"\t'),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加镜像策略")]),t._v('\n    network_mode = "host"\t\t\t'),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加网络模式为host")]),t._v("\n")])])]),a("h2",{attrs:{id:"配置cicd流水线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置cicd流水线"}},[t._v("#")]),t._v(" 配置CICD流水线")]),t._v(" "),a("h3",{attrs:{id:"_1-添加配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-添加配置"}},[t._v("#")]),t._v(" 1.添加配置")]),t._v(" "),a("p",[t._v("这里在CICD的流水线中添加如下配置，配置使用镜像"),a("code",[t._v("kubelet:1.16.6")]),t._v(",将变量输出到"),a("code",[t._v("config")]),t._v("的文件中，访问K8s集群测试。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubectl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.16.6\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mkdir $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" cat $K8S_CONFIG "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" $HOME/.kube/config\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" cd $HOME/.kube "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" pwd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubectl get pods "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("A \n")])])]),a("h3",{attrs:{id:"_2-测试流水线脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-测试流水线脚本"}},[t._v("#")]),t._v(" 2.测试流水线脚本")]),t._v(" "),a("p",[t._v("提交本次的流水线修改。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204240956264.png",alt:"image-20220423232659395"}})]),t._v(" "),a("p",[t._v("查看Jobs的情况，输出的日志可以看出当前配置的连接K8S正常。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204240956733.png",alt:"image-20220423232819797"}})])])}),[],!1,null,null,null);a.default=e.exports}}]);