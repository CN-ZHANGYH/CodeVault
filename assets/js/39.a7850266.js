(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{351:function(t,s,a){"use strict";a.r(s);var e=a(7),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"rancher多混合云平台管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rancher多混合云平台管理"}},[t._v("#")]),t._v(" Rancher多混合云平台管理")]),t._v(" "),s("h2",{attrs:{id:"如下是rancher的架构图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如下是rancher的架构图"}},[t._v("#")]),t._v(" 如下是Rancher的架构图")]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111156786.png",alt:"image-20211129083856224"}}),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("IP地址")]),t._v(" "),s("th",[t._v("主机名")]),t._v(" "),s("th",[t._v("节点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("10.18.5.10")]),t._v(" "),s("td",[t._v("master01")]),t._v(" "),s("td",[t._v("Rancher master、K8S master、K8S worker")])]),t._v(" "),s("tr",[s("td",[t._v("10.18.5.11")]),t._v(" "),s("td",[t._v("master02")]),t._v(" "),s("td",[t._v("Rancher master、K8S master、K8S worker")])]),t._v(" "),s("tr",[s("td",[t._v("10.18.5.12")]),t._v(" "),s("td",[t._v("master03")]),t._v(" "),s("td",[t._v("Rancher master、K8S master、K8S worker")])]),t._v(" "),s("tr",[s("td",[t._v("10.18.5.13")]),t._v(" "),s("td",[t._v("nginx")]),t._v(" "),s("td",[t._v("Nginx")])]),t._v(" "),s("tr",[s("td",[t._v("10.18.5.14")]),t._v(" "),s("td",[t._v("cicd")]),t._v(" "),s("td",[t._v("GitLab、Harbor、Jenkins")])])])]),t._v(" "),s("h2",{attrs:{id:"部署harbor仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署harbor仓库"}},[t._v("#")]),t._v(" 部署Harbor仓库")]),t._v(" "),s("blockquote",[s("p",[s("strong",[s("code",[t._v("使用操作系统均为CentOS7.5-1804的")])])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("使用rancher_offline_installation_package.tar软件包")])])])]),t._v(" "),s("h3",{attrs:{id:"基础环境配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基础环境配置"}},[t._v("#")]),t._v(" 基础环境配置")]),t._v(" "),s("blockquote",[s("h4",{attrs:{id:"在所有节点执行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在所有节点执行"}},[t._v("#")]),t._v(" "),s("code",[t._v("在所有节点执行")])])]),t._v(" "),s("h4",{attrs:{id:"_1-配置yum源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置yum源"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（1）配置Yum源")])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("所有节点上传离线包rancher_offline_installation_package.tar,gz 至/root目录，解压安装包")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar -zxvf rancher_offline_installation_package.tar")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd offline_installation_package/yum/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar -zxvf rancher_yum.tar -C /opt/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mv /etc/yum.repos.d/* /media/ ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/yum.repos.d/rancher.repo ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("rancher"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rancher\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("baseurl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("file:///opt/rancher/\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gpgcheck")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("centos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("centos\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("baseurl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://10.18.5.15/file/centos\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gpgcheck")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-配置主机映射"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置主机映射"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（2）配置主机映射")])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("修改主机名后配置主机映射")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/hosts")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1 localhost localhost.localdomain localhost6 localhost6.localdomain6\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.10 master01\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.11 master02\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.12 master03\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.13 nginx\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14 cicd\n")])])]),s("h4",{attrs:{id:"_3-配置防火墙及selinux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置防火墙及selinux"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（3）配置防火墙及SELinux")])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("清除所有的iptables规则以及关闭selinux")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl stop firewalld && systemctl disable firewalld")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -F \t\t\t\t\t\t# 清除所有制订的规则")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -X\t\t\t\t\t\t# 清除所有用户“自定义”的 chain")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables -Z \t\t\t\t\t\t# 将所有 chain 的计数与流量统计都归零")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# iptables-save")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config")]),t._v("\n")])])]),s("h4",{attrs:{id:"_4-关闭swap分区"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-关闭swap分区"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（4）关闭Swap分区")])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("永久禁用虚拟内存")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# swapoff -a ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sed -i 's/.*swap.*/#&/' /etc/fstab")]),t._v("\n")])])]),s("h4",{attrs:{id:"_5-配置路由转发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-配置路由转发"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（5）配置路由转发")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat << EOF | tee /etc/sysctl.d/k8s.conf")]),t._v("\nnet.ipv4.ip_forward "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-ip6tables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-iptables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nEOF\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# modprobe br_netfilter")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sysctl -p /etc/sysctl.d/k8s.conf")]),t._v("\n")])])]),s("h4",{attrs:{id:"_6-安装-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-安装-docker"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（6）安装 Docker")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum -y install yum-utils device-mapper-persistent-data lvm2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /opt/rancher/base/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y containerd.io-1.2.13-3.1.el7.x86_64.rpm docker-ce-19.03.8-3.el7.x86_64.rpm docker-ce-cli-19.03.8-3.el7.x86_64.rpm")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl start docker && systemctl enable docker")]),t._v("\n")])])]),s("h4",{attrs:{id:"_7-daemon-json文件配置如下"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-daemon-json文件配置如下"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（7）daemon.json文件配置如下")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat > /etc/docker/daemon.json <<EOF")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"insecure-registries"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0.0.0.0/0"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"registry-mirrors"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://7bezldxe.mirror.aliyuncs.com/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"exec-opts"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"native.cgroupdriver=cgroupfs"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log-driver"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"json-file"')]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"log-opts"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-size"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"100m"')]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"max-file"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"storage-driver"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"overlay2"')]),t._v(",\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"storage-opts"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"overlay2.override_kernel_check=true"')]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl daemon-reload && systemctl  restart docker")]),t._v("\n")])])]),s("h3",{attrs:{id:"部署harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署harbor"}},[t._v("#")]),t._v(" 部署Harbor")]),t._v(" "),s("blockquote",[s("h4",{attrs:{id:"在cicd节点安装harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在cicd节点安装harbor"}},[t._v("#")]),t._v(" 在cicd节点安装Harbor")])]),t._v(" "),s("h4",{attrs:{id:"_1-安装docker-compose"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装docker-compose"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（1）安装docker-compose")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod +x offline_installation_package/docker-compose/v1.25.5-docker-compose-Linux-x86_64")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp offline_installation_package/docker-compose/v1.25.5-docker-compose-Linux-x86_64 /usr/local/bin/docker-compose")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose version")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" version "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.25")]),t._v(".5, build 8a1c60f6\ndocker-py version: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.1")]),t._v(".0\nCPython version: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.7")]),t._v(".5\nOpenSSL version: OpenSSL "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),t._v(".0l "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" Sep "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-部署harbor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署harbor"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（2）部署Harbor")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("修改Harbor配置信息（关于https的注释）")])]),t._v(" "),s("li",[s("strong",[t._v("解决Harbor报错问题（shadow文件的值）")])]),t._v(" "),s("li",[s("strong",[t._v("配置"),s("code",[t._v("rancher")]),t._v("用户密码"),s("code",[t._v("Rancher@123")]),t._v("以及创建两个仓库"),s("code",[t._v("rancher和cnrancher")])])]),t._v(" "),s("li",[s("strong",[t._v("导入需要上传的镜像（执行脚本push镜像）")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd offline_installation_package/harbor/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker load -i harbor.tar")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar -zxvf harbor-online-installer-v1.10.2.tgz ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd harbor")]),t._v("\n")])])]),s("ol",[s("li",[s("strong",[t._v("此处需要修改配置文件")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi harbor.yml")]),t._v("\nhostname: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14 \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将域名修改为本机 IP")]),t._v("\nharbor_admin_password: Harbor12345\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#https: \t\t\t\t\t# 禁用 https")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# https port for harbor, default is 443")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# port: 443")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The path of cert and key files for nginx")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# certificate: /your/certificate/path")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# private_key: /your/private/key/path")]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("启动Harbor（这里将会出现报错）")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ./install.sh --with-clair")]),t._v("\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[t._v("导出harbor-log容器")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir -p /tmp/harbor-log")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /tmp/harbor-log")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker export harbor-log -o harbor-log.tar")]),t._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[t._v("解压tar包，修改 shadow 文件的值")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar xvfp harbor-log.tar")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sed -i 's/:90:/:99999:/g' /tmp/harbor-log/etc/shadow")]),t._v("\n")])])]),s("ol",{attrs:{start:"5"}},[s("li",[s("strong",[t._v("将修改后的shadow文件挂载到harbor-log容器内")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir -p /opt/harbor-log-etc/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp /tmp/harbor-log/etc/shadow /opt/harbor-log-etc/shadow")]),t._v("\n")])])]),s("ol",{attrs:{start:"6"}},[s("li",[s("strong",[t._v("修改docker-composr.yml文件，配置harbor-log容器的volumes")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor-log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/harbor/harbor/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi docker-compose.yml")]),t._v("\n volumes:\n   - /data/registry:/storage:z\n   - ./common/config/registry/:/etc/registry/:z\n   - type: "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("bind")]),t._v("\n     source: /data/secret/registry/root.crt\n     target: /etc/registry/root.crt\n   - type: "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("bind")]),t._v(" \t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#添加这一段，挂载刚刚修改的shadow")]),t._v("\n     source: /opt/harbor-log-etc/shadow\n     target: /etc/shadow\n")])])]),s("ol",{attrs:{start:"7"}},[s("li",[s("strong",[t._v("重启Harbor")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose down ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd harbor"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker-compose up -d ")]),t._v("\nCreating network "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"harbor_harbor"')]),t._v(" with the default driver\nCreating network "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"harbor_harbor-clair"')]),t._v(" with the default driver\nCreating harbor-log "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating redis         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating harbor-db     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating harbor-portal "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating registryctl   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating registry      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating harbor-core   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating clair         "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating nginx             "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating harbor-jobservice "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\nCreating clair-adapter     "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("done")]),t._v("\n")])])]),s("h4",{attrs:{id:"_3-上传镜像至harbor仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-上传镜像至harbor仓库"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（3）上传镜像至Harbor仓库")])]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("启动Harbor成功后，Web端登录Harbor（http://10.18.5.14），用户名为admin，密码为Harbor12345。")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111156799.png",alt:"image-20211129091737666"}}),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("在左侧导航栏选择“系统管理→用户管理→创建用户”菜单命令，创建rancher用户，密码为Rancher@123。")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111156437.png",alt:"image-20211129091827630"}}),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[t._v("Harbor切换为rancher用户登录，登录后创建项目（镜像仓库）rancher和cnrancher，访问级别为公开")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111156519.png",alt:"image-20211129092003723"}}),t._v(" "),s("h4",{attrs:{id:"_4-导入镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-导入镜像"}},[t._v("#")]),t._v(" "),s("strong",[t._v("（4）导入镜像")])]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("使用rancher用户登录Harbor仓库")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker login 10.18.5.14")]),t._v("\nUsername: rancher\nPassword: \nWARNING"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" Your password will be stored unencrypted "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#credentials-store")]),t._v("\n\nLogin Succeeded\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("导入镜像")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/rancher-offline-images/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd rancher-offline-images"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker load -i rancher.tar")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd rancher-offline-images"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod +x *.sh")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd rancher-offline-images"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ./rancher-push-images.sh")]),t._v("\n\n输入镜像仓库地址"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("不加 http/https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14\n输入镜像仓库用户名: rancher\n输入镜像仓库用户密码: Rancher@123\n设置的仓库地址为: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14，用户名: rancher，密码: xxx\n是否确认"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Y/N"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": y\nWARNING"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" Using "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--password")]),t._v(" via the CLI is insecure. Use --password-stdin.\nWARNING"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" Your password will be stored unencrypted "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" \n/root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#credentials-store")]),t._v("\n镜像仓库 Login Succeeded\nThe push refers to repository "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14/rancher/calico-cni"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[t._v("推送完成后，登录 Harbor并进入rancher项目")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111156531.png",alt:"image-20211129092634734"}}),t._v(" "),s("h2",{attrs:{id:"部署k8s-ha集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署k8s-ha集群"}},[t._v("#")]),t._v(" 部署K8S HA集群")]),t._v(" "),s("blockquote",[s("p",[s("strong",[s("code",[t._v("部署Nginx反向代理")])])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("部署Kubernetes HA集群")])])])]),t._v(" "),s("h3",{attrs:{id:"nginx节点部署反向代理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx节点部署反向代理"}},[t._v("#")]),t._v(" Nginx节点部署反向代理")]),t._v(" "),s("blockquote",[s("h4",{attrs:{id:"使用nginx节点部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用nginx节点部署"}},[t._v("#")]),t._v(" "),s("code",[t._v("使用Nginx节点部署")])])]),t._v(" "),s("h4",{attrs:{id:"_1-编写配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写配置文件"}},[t._v("#")]),t._v(" （1）编写配置文件")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("在nginx节点编写nginx.conf文件")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@nginx ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir /etc/nginx")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@nginx ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/nginx/nginx.conf")]),t._v("\nworker_processes "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nworker_rlimit_nofile "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("40000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nevents "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n worker_connections "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("8192")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nstream "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n upstream rancher_servers_https "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n \tleast_conn"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \tserver "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.10:30001 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("max_fails")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("fail_timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("5s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \tserver "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.11:30001 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("max_fails")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("fail_timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("5s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \tserver "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.12:30001 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("max_fails")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("fail_timeout")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("5s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n \tlisten "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n \tproxy_pass rancher_servers_https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-启动nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-启动nginx"}},[t._v("#")]),t._v(" （2）启动Nginx")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("使用编辑好的配置文件/etc/nginx.conf，以容器的形式运行Nginx服务，而不需要将其安装在宿主机上。")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@nginx ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker login 10.18.5.14 -u rancher -p Rancher@123")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@nginx ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run --name lb-nginx -d --restart=unless-stopped \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(":443 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /etc/nginx/nginx.conf:/etc/nginx/nginx.conf "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14/rancher/nginx:1.14\n\n20ee0cf1e14c21552c912ce9fe8783e4a4fe1c129142680bfc4601d1718455f8\n")])])]),s("h3",{attrs:{id:"部署kubernetes-ha集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署kubernetes-ha集群"}},[t._v("#")]),t._v(" 部署Kubernetes HA集群")]),t._v(" "),s("blockquote",[s("h4",{attrs:{id:"在所有master节点创建用户配置免密-master01作为主要工具节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在所有master节点创建用户配置免密-master01作为主要工具节点"}},[t._v("#")]),t._v(" "),s("code",[t._v("在所有Master节点创建用户配置免密，master01作为主要工具节点")])])]),t._v(" "),s("h4",{attrs:{id:"_1-创建用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建用户"}},[t._v("#")]),t._v(" （1）创建用户")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("因为CentOS的安全限制，无法使用root账户通过RKE安装K8S集群。所以无论是通过RKE还是Custom安装K8S，建议CentOS用户使用非root用户来运行Docker。")])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[s("code",[t._v("所有master节点需要创建rancher用户，设置从属组为docker")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# useradd -G docker rancher")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo -n rancher | passwd --stdin rancher")]),t._v("\nChanging password "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" user rancher.\npasswd: all authentication tokens updated successfully.\n")])])]),s("h4",{attrs:{id:"_2-配置免密"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置免密"}},[t._v("#")]),t._v(" （2）配置免密")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("所有master节点配置rancher用户SSH无密钥访问（密码为 rancher）")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ssh-keygen")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# for i in master01 master02 master03;do ssh-copy-id -i ~/.ssh/id_rsa.pub rancher@$i;done")]),t._v("\n")])])]),s("h4",{attrs:{id:"_3-安装rke工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-安装rke工具"}},[t._v("#")]),t._v(" （3）安装RKE工具")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp offline_installation_package/rke/v1.1.0-rke_linux-amd64 /usr/local/bin/rke")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod +x /usr/local/bin/rke")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rke -v")]),t._v("\nrke version v1.1.0\n")])])]),s("h4",{attrs:{id:"_4-编写yaml文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-编写yaml文件"}},[t._v("#")]),t._v(" （4）编写YAML文件")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("在任意master节点编写rancher-cluster.yml文件，以master01为例")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi rancher-cluster.yaml")]),t._v("\nnodes:\n  - address: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.10\n    user: rancher\n    role: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("controlplane,worker,etcd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  - address: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.11\n    user: rancher\n    role: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("controlplane,worker,etcd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  - address: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.12\n    user: rancher\n    role: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("controlplane,worker,etcd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置 Harbor 私有仓库")]),t._v("\nprivate_registries:\n  - url: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14\n    user: rancher\n    password: Rancher@123\n    is_default: "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n    \nservices:\n  etcd:\n    extra_args:\n      auto-compaction-retention: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("240")]),t._v("\n      quota-backend-bytes: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'6442450944'")]),t._v("\n\t\t\t\t\t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改空间配额为$((6*1024*1024*1024))，默认 2G，最大 8G")]),t._v("\n    backup_config:\n      enabled: "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置 true 启用 etcd 自动备份，设置 false 禁用；")]),t._v("\n      interval_hours: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 快照创建间隔时间，不加此参数，默认 5 分钟；")]),t._v("\n      retention: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" \t\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# etcd 备份保留份数；")]),t._v("\n  ingress:\n    provider: none\n\n")])])]),s("h4",{attrs:{id:"_5-格式转换"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-格式转换"}},[t._v("#")]),t._v(" （5）格式转换")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("安装dos2unix工具并转换格式")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum -y install dos2unix")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dos2unix rancher-cluster.yaml")]),t._v("\ndos2unix: converting "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" rancher-cluster.yaml to Unix "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),s("h4",{attrs:{id:"_6-部署k8s集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-部署k8s集群"}},[t._v("#")]),t._v(" （6）部署K8S集群")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("所有master节点登录Harbor仓库：")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker login 10.18.5.14")]),t._v("\nUsername: rancher\nPassword: \n\nWARNING"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" Your password will be stored unencrypted "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" \n/root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#credentials-store")]),t._v("\n\nLogin Succeeded\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("在master01节点使用RKE启动集群")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rke up --config rancher-cluster.yaml")]),t._v("\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Running RKE version: v1.1.0\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Initiating Kubernetes cluster\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("dialer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Setup tunnel "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.12"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("dialer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Setup tunnel "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.10"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("dialer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Setup tunnel "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("\nINFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0234"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Finished building Kubernetes cluster successfully\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("p",[s("strong",[t._v("安装 kubectl工具")])]),t._v(" "),s("p",[s("strong",[t._v("K8S集群部署成功后会生成一个文件"),s("code",[t._v("kube_config_rancher-rancher-cluster.yaml")]),t._v("，这个文件包含kubectl和Helm访问K8S集群的凭据。")])])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("创建 kube 目录：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir ~/.kube")]),t._v("\n\n将文件拷贝到.kube/下并重命名为 config：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp kube_config_rancher-cluster.yaml ~/.kube/config")]),t._v("\n\n安装 kubectl 工具：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/kubectl/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 kubectl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp linux-amd64-v1.18.1-kubectl kubectl")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 kubectl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod +x ./kubectl")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 kubectl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp kubectl /usr/local/bin/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 kubectl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl version --client")]),t._v("\nClient Version: version.Info"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Major:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1"')]),t._v(", Minor:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"18"')]),t._v(", GitVersion:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1.18.0"')]),t._v(", GitCommit:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9e991415386e4cf155a24b1da15becaa390438d8"')]),t._v(", GitTreeState:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clean"')]),t._v(", BuildDate:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2020-03-25T14:58:59Z"')]),t._v(", GoVersion:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"go1.13.8"')]),t._v(", Compiler:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gc"')]),t._v(", Platform:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"linux/amd64"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[t._v("查看集群状态")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get cs")]),t._v("\nNAME \t\t\t\tSTATUS \t\tMESSAGE \tERROR\ncontroller-manager \tHealthy \t\tok\nscheduler \t\t\tHealthy \t\tok\netcd-0 Healthy "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\netcd-1 Healthy "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\netcd-2 Healthy "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"_7-自动补全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-自动补全"}},[t._v("#")]),t._v(" （7）自动补全")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("安装bash-completion开启Tab键自动补全功能")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('[root@master01 ~]# yum install -y bash-completion\n[root@master01 ~]# source  /usr/share/bash-completion/bash_completion\n[root@master01 ~]# source <(kubectl completion bash)\n\n将kubectl自动补全添加到配置文件中，可以在以后的shell中自动加载:\n[root@master01 ~]# echo "source <(kubectl completion bash)" >> ~/.bashrc\n')])])]),s("h2",{attrs:{id:"部署rancher-ha集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署rancher-ha集群"}},[t._v("#")]),t._v(" 部署Rancher HA集群")]),t._v(" "),s("blockquote",[s("p",[s("strong",[s("code",[t._v("需要安装helm然后作为Kubernetes体系的包管理工具")])])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("helm作为应用打包交付方式")])])])]),t._v(" "),s("h4",{attrs:{id:"_1-安装helm工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装helm工具"}},[t._v("#")]),t._v(" （1）安装Helm工具")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("在master01节点安装Helm")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/helm/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 helm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar -xf helm-v3.0.3-linux-amd64.tar.gz")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 helm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp linux-amd64/helm /usr/local/bin/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm version")]),t._v("\nversion.BuildInfo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Version:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v3.0.3"')]),t._v(", GitCommit:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ac925eb7279f4a6955df663a0128044a8a6b7593"')]),t._v(", GitTreeState:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"clean"')]),t._v(", GoVersion:"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"go1.13.6"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[s("strong",[t._v("Helm的常用命令如下")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm version \t\t\t\t\t\t查看版本")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm repo (add|index|list|remove|update) Helm 仓库的管理")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm search 查询 Chart 包，查询命令分为 helm search hub 和 helm search repo")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm pull \t\t\t\t\t\t将 Chart 包下载到本地，缺省下载最新的 Chart 版本，并且是 tgz包")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm install \t\t\t\t\t\t安装应用")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm list \t\t\t\t\t\t列出 default 命名空间的 Release 列表")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm uninstall \t\t\t\t\t卸载应用")]),t._v("\n")])])]),s("h4",{attrs:{id:"_2-生成证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成证书"}},[t._v("#")]),t._v(" （2）生成证书")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("要保证Web浏览器到服务器的安全连接，HTTPS几乎是唯一选择。"),s("code",[t._v("在 master01 节点使用提供的脚本生成自签名证书")])])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("参数含义如下：")])]),t._v(" "),s("li",[s("strong",[s("code",[t._v("--ssl-domain: 生成 SSL证书需要的主域名，如不指定则默认为localhost，如果是IP访问服务，则可忽略；")])])]),t._v(" "),s("li",[s("strong",[s("code",[t._v("--ssl-date: SSL有效期，默认10年；")])])]),t._v(" "),s("li",[s("strong",[s("code",[t._v("--ca-date: CA有效期，默认10年。")])])])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[root@master01 ~]# cd /root/offline_installation_package/cert/\n[root@master01 cert]# chmod +x create_self-signed-cert.sh\n[root@master01 cert]# ./create_self-signed-cert.sh \\\n--ssl-trusted-ip=10.18.5.10,10.18.5.11,10.18.5.12,10.18.5.13 \\\n--ssl-size=2048 \\\n--ssl-date=3650\n")])])]),s("h4",{attrs:{id:"_3-部署rancher"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-部署rancher"}},[t._v("#")]),t._v(" （3）部署Rancher")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("在master01节点创建Rancher Server的命名空间")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 cert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create namespace cattle-system")]),t._v("\nnamespace/cattle-system created\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("使用自签名证书部署Rancher，需要创建证书secret和CA证书secret。在Rancher Server的命名空间创建服务证书和私钥密文")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 cert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=./tls.crt --key=./tls.key")]),t._v("\nsecret/tls-rancher-ingress created\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[t._v("在Rancher Server的命名空间创建CA证书密文")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 cert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl -n cattle-system create secret generic tls-ca --from-file=cacerts.pem")]),t._v("\nsecret/tls-ca created\n")])])]),s("blockquote",[s("h4",{attrs:{id:"helm安装rancher的语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#helm安装rancher的语法"}},[t._v("#")]),t._v(" Helm安装Rancher的语法")]),t._v(" "),s("p",[t._v("很多场景需要使用IP去直接访问Rancher Server。"),s("code",[t._v("因为ingress默认不支持IP访问，所以这里禁用ingress，需要通过NodePort把Rancher Server容器443端口映射到宿主机上。")]),t._v("这个时候Rancher Server容器将作为SSL终止并配置SSL证书，将请求流量转发到Rancher Server容器的443端口，然后通过任意master节点IP+NodePort端口即可访问Rancher。")]),t._v(" "),s("p",[s("strong",[t._v("此安装方式语法如下：")])]),t._v(" "),s("p",[t._v("[root@master01 rancher-charts]# helm install rancher rancher/ --namespace  cattle-system \\")]),t._v(" "),s("p",[t._v("--set rancherImage=  \\ \t\t\t  # 指定镜像名称，不要指定镜像版本")]),t._v(" "),s("p",[t._v("--set busyboxImage=  \\")]),t._v(" "),s("p",[t._v("--set service.type=NodePort \\")]),t._v(" "),s("p",[t._v("--set service.ports.nodePort= \\ \t # 指定映射端口")]),t._v(" "),s("p",[t._v("--set privateCA=true \\")]),t._v(" "),s("p",[t._v("--set useBundledSystemChart=true \\")]),t._v(" "),s("p",[t._v("--set privateRegistry=true \\ \t\t# 设置使用私有仓库")]),t._v(" "),s("p",[t._v("--set systemDefaultRegistry= \t\t# 设置私有仓库地址，注意不要添加 协议头")])]),t._v(" "),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[t._v("使用helm部署rancher")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 cert"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/rancher-charts/server-chart/")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 server-chart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm install rancher rancher/ --namespace cattle-system \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("service.type")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("NodePort "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("service.ports.nodePort")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30001")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("tls")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("internal "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ingress.tls.source")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("secret "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("privateCA")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("rancherImage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14/rancher/rancher "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("busyboxImage")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.14/rancher/busybox\n\n\nNAME: rancher\nLAST DEPLOYED: Mon May "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(":18:55 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v("\nNAMESPACE: cattle-system\nSTATUS: deployed\nREVISION: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nTEST SUITE: None\nNOTES:\nRancher Server has been installed.\nNOTE: Rancher may take several minutes to fully initialize. Please standby \n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" Certificates are being issued and Ingress comes up.\nCheck out our docs at https://rancher.com/docs/rancher/v2.x/en/\n\nBrowse to https://\nHappy Containering"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),s("ol",{attrs:{start:"5"}},[s("li",[s("strong",[t._v("如果Rancher Server部署过程中有问题，可以删除再重新执行helm install，删除命令如下")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# helm uninstall -n cattle-system rancher")]),t._v("\n")])])]),s("ol",{attrs:{start:"6"}},[s("li",[s("strong",[t._v("查看Pod状态")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 server-chart"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pod -n cattle-system")]),t._v("\nNAME \t\t\t\t\tREADY STATUS  RESTARTS \tAGE\nrancher-7957bfd9f4-kj64g "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2 Running  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \t\t2m24s\nrancher-7957bfd9f4-mcj7q "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2 Running  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \t\t2m24s\nrancher-7957bfd9f4-pstc2 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2 Running  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \t\t2m24s\n")])])]),s("h4",{attrs:{id:"_4-访问rancher"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-访问rancher"}},[t._v("#")]),t._v(" （4）访问Rancher")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("在Web端通过https://10.18.5.13访问Rancher")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157359.png",alt:"image-20211129103822165"}}),t._v(" "),s("p",[s("strong",[t._v("单击“Continue”按钮，设置 URL。此 URL 地址可以是 IP 也可以是域名，集群所有节点将使用该URL注册到Rancher，所以需要保证 所有节点能访问该地址。"),s("code",[t._v("如果Rancher Server是多节点HA运行，请勿设置Rancher Server URL为某一个节点的IP地址，避免因某一个节点出现故障影响整个集群")]),t._v("。如果Rancher Server URL使用域名，"),s("code",[t._v("需把域名解析到所有Rancher Server节点IP或者VIP上。")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157014.png",alt:"image-20211129104039899"}}),t._v(" "),s("p",[s("strong",[t._v("保存URL后进入Rancher全局页面，切换语言为中文简体。 在local集群中单击“┆”按钮，在下拉菜单中选择“升级”菜单命令，在跳转 页面直接单击“保存”按钮即可。")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157372.png",alt:"image-20211129104150465"}}),t._v(" "),s("p",[s("strong",[t._v("单击集群名称local进入集群仪表盘界面")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157808.png",alt:"image-20211129104249420"}}),t._v(" "),s("h4",{attrs:{id:"_5-安装rancher-cli"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-安装rancher-cli"}},[t._v("#")]),t._v(" （5）安装Rancher CLI")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("Rancher CLI是一个统一的工具，可用于与Rancher进行交互。借助于此工具，可以操作Rancher并管理其下的资源。在master01节点解压安装包并移至/usr/bin目录下")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /root/offline_installation_package/rancher-cli/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar xf rancher-linux-amd64-v2.4.0.tar.gz -C /usr/local/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# echo "export PATH=$PATH:/usr/local/rancher-v2.4.0" >> /etc/profile')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# source /etc/profile")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rancher -v")]),t._v("\nrancher version v2.4.0\n")])])]),s("p",[s("strong",[t._v("登录Rancher 全局页面，单击右上角的用户图标，在用户 "),s("code",[t._v("下拉菜单中选择“API & Keys”命令进入 API &Key 管理界面。")])])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157496.png",alt:"image-20211129104454541"}}),t._v(" "),s("p",[s("strong",[t._v("在右上角的“"),s("code",[t._v("添加 Key”按钮")]),t._v("跳转到“"),s("code",[t._v("添加 API Key")]),t._v("”页面，选择永不过期和作用于所有集群")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157642.png",alt:"image-20211129104605779"}}),t._v(" "),s("p",[s("strong",[t._v("单击"),s("code",[t._v("“创建”")]),t._v("按钮后可"),s("code",[t._v("查看 Token 详细信息")]),t._v("，API Key ， "),s("code",[t._v("注意保存相关信息")]),t._v("，后期配置 CLI 会用到。")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157020.png",alt:"image-20211129104934229"}}),t._v(" "),s("p",[s("strong",[t._v("API KEY 由 4 个组件组成：")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("Endpoint：")]),t._v("这是其他应用程序用于向 Rancher API 发送请求的地址。")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("Access Key：")]),t._v("Token 的用户名。")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("Secret Key：")]),t._v("Token 的密码。用于提示用户使用 API 身份验证的应用程序， 通常会将两个密钥一起输入。")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("Bearer Token：")]),t._v("Token 的用户名和密码连接在一起。将此字符串用于提示 用户输入一个验证字符串的应用程序。")])]),t._v(" "),s("p",[s("strong",[t._v("登录K8S集群，过程中需要输入yes确认")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rancher login https://10.18.5.13/v3 --token token-cp2jx:cn2d8dp298tncj9bvk6mwk7ppjcbp6tsl2wrb7z7qccm4p7s9r5kfk")]),t._v("\n")])])]),s("p",[s("strong",[t._v("验证CLI工具是否对接成功")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 rancher-cli"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rancher kubectl get nodes")]),t._v("\nNAME STATUS ROLES AGE VERSION\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.10 Ready controlplane,etcd,worker 7h12m v1.17.4\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.11 Ready controlplane,etcd,worker 7h12m v1.17.4\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.18")]),t._v(".5.12 Ready controlplane,etcd,worker 7h12m v1.17.4\n")])])]),s("h4",{attrs:{id:"_6-启用监控"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-启用监控"}},[t._v("#")]),t._v(" （6）启用监控")]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("进入Rancher集群仪表盘界面")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157027.png",alt:"image-20211129105119364"}}),t._v(" "),s("p",[s("strong",[t._v("选择左侧导航栏选择“系统设置”菜单命令，"),s("code",[t._v("在 system-default-registry中添加harbor节点IP地址")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157806.png",alt:"image-20211129105152040"}}),t._v(" "),s("p",[s("strong",[t._v("选择左侧导航栏“"),s("code",[t._v("工具→监控")]),t._v("”菜单命令，根据需要修改监控配置，如图")])]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157158.png",alt:"image-20211129105253881"}}),t._v(" "),s("p",[s("strong",[t._v("单击"),s("code",[t._v("“启用监控”")]),t._v("按钮，系统会自动生成命名空间 "),s("code",[t._v("cattle-prometheus")]),t._v("，查看 该命名空间下Pod状态")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods -n cattle-prometheus ")]),t._v("\nNAME                                                       READY   STATUS    RESTARTS   AGE\nexporter-kube-state-cluster-monitoring-6cb8fd84bc-zk7rc    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\nexporter-node-cluster-monitoring-dsdbv                     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\nexporter-node-cluster-monitoring-vhbc4                     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\nexporter-node-cluster-monitoring-xvbhn                     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\ngrafana-cluster-monitoring-c8988fbdb-9ctpd                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\nprometheus-cluster-monitoring-0                            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v("/6     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          12h\nprometheus-operator-monitoring-operator-7b88c6ff66-td5zf   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          12h\n")])])]),s("p",[s("strong",[t._v("待所有 Pod 启动成功后返回集群仪表盘界面")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157423.png",alt:"image-20211129105419190"}}),t._v(" "),s("p",[s("strong",[t._v("可以看到，监控已成功启动。在仪表盘下方即可查看集群实时负载信息")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157817.png",alt:"image-20211129105447721"}}),t._v(" "),s("p",[s("strong",[t._v("此时grafana监控也启动了，可以查看集群监控")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157380.png",alt:"image-20211129105600375"}}),t._v(" "),s("h4",{attrs:{id:"_7-开启日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-开启日志"}},[t._v("#")]),t._v(" （7）开启日志")]),t._v(" "),s("p",[s("strong",[t._v("Rancher 支持两种层面的应用日志收集：")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("① 集群层面：")]),t._v("在集群层面对接日志系统后，它将收集整个集群下全部项目 的应用日志；")])]),t._v(" "),s("p",[s("strong",[s("code",[t._v("② 项目层面：")]),t._v("在项目层面对接日志系统后，它将收集本项目下应用日志。")])]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("修改内核参数")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/sysctl.conf ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("vm.max_map_count")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26214")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sysctl -p")]),t._v("\nvm.max_map_count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26214")]),t._v("\n")])])]),s("ol",{attrs:{start:"2"}},[s("li",[s("p",[s("strong",[t._v("启动 Elasticsearch")])]),t._v(" "),s("p",[s("strong",[t._v("在cicd节点启动Elasticsearch")])])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -td -p 9200:9200 -p 9300:9300 \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /opt/data/elasticsearch/esdata:/usr/share/elasticsearch/data "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"discovery.type=single-node"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nelasticsearch\n")])])]),s("ol",{attrs:{start:"3"}},[s("li",[s("strong",[t._v("启动 Kibana")])])]),t._v(" "),s("p",[t._v("​\t"),s("strong",[t._v("在cicd节点启动Kibana（10.18.5.14 为harbor节点IP）")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@cicd ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run --name some-kibana \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ELASTICSEARCH_URL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://10.18.5.14:9200 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5601")]),t._v(":5601 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" kibana\n")])])]),s("ol",{attrs:{start:"4"}},[s("li",[s("strong",[t._v("Rancher 对接 Elasticsearch")])])]),t._v(" "),s("p",[s("strong",[t._v("登录Rancher仪表盘界面，选择"),s("code",[t._v("“工具→日志”")]),t._v("菜单命令， 日志可以基于集群层面，也可以基于项目层面。")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157130.png",alt:"image-20211129110016023"}}),t._v(" "),s("p",[s("strong",[t._v("在图中单击"),s("code",[t._v("“Elasticsearch”")]),t._v("按钮，"),s("code",[t._v("设置访问地址和前缀")])])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157718.png",alt:"image-20211129110227610"}}),t._v(" "),s("p",[s("strong",[t._v("滑到底部，单击"),s("code",[t._v("“测试”按钮")]),t._v("，进行测试，测试结果如图所示。如 果通过则进行保存。")])]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157115.png",alt:"image-20211129110502765"}}),t._v(" "),s("ol",{attrs:{start:"5"}},[s("li",[s("strong",[t._v("查看日志")])])]),t._v(" "),s("p",[s("strong",[t._v("登录 Kibana（http://10.18.5.14:5601），在 Index pattern 处输入日志前缀 "),s("code",[t._v("“logstash-*”")]),t._v("进行过滤，如图所示。"),s("code",[t._v("Time Filter field name")]),t._v(" 的下拉菜单选 项选择"),s("code",[t._v("“I don't want to use the Time Filter.”")]),t._v("。")])]),t._v(" "),s("img",{staticStyle:{zoom:"67%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157081.png",alt:"image-20211129110639009"}}),t._v(" "),s("p",[s("strong",[t._v("单击“create”按钮，跳转至过滤后的日志页面")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157376.png",alt:"image-20211129110724601"}}),t._v(" "),s("p",[s("strong",[t._v("在 Rancher 集群仪表盘界面下方单击"),s("code",[t._v("“Rancher 日志功能监控”")]),t._v("按钮，可以 查看")])]),t._v(" "),s("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111157179.png",alt:"image-20211129110826525"}})])}),[],!1,null,null,null);s.default=n.exports}}]);