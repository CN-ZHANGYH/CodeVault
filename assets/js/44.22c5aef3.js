(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{360:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"ansible企业应用实战"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ansible企业应用实战"}},[t._v("#")]),t._v(" Ansible企业应用实战")]),t._v(" "),s("h4",{attrs:{id:"掌握要点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#掌握要点"}},[t._v("#")]),t._v(" 掌握要点")]),t._v(" "),s("blockquote",[s("p",[t._v("该实战案例为使用 Ansible 工具部署一个 3 节点的集群商城系统。")]),t._v(" "),s("p",[t._v("部署Mariadb高可用+Redis+Zookeeper+Kafka的集群。")])]),t._v(" "),s("h4",{attrs:{id:"节点规划"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#节点规划"}},[t._v("#")]),t._v(" 节点规划")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("IP")])]),t._v(" "),s("th",[t._v("主机名")]),t._v(" "),s("th",[t._v("节点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("192.168.1.4")]),t._v(" "),s("td",[t._v("ansible")]),t._v(" "),s("td",[t._v("Ansible  节点")])]),t._v(" "),s("tr",[s("td",[t._v("192.168.1.7")]),t._v(" "),s("td",[t._v("node1")]),t._v(" "),s("td",[t._v("Node1  节点")])]),t._v(" "),s("tr",[s("td",[t._v("192.168.1.26")]),t._v(" "),s("td",[t._v("node2")]),t._v(" "),s("td",[t._v("Node2  节点")])]),t._v(" "),s("tr",[s("td",[t._v("192.168.1.3")]),t._v(" "),s("td",[t._v("node3")]),t._v(" "),s("td",[t._v("Node3  节点")])])])]),t._v(" "),s("h4",{attrs:{id:"目录结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目录结构"}},[t._v("#")]),t._v(" 目录结构")]),t._v(" "),s("h5",{attrs:{id:"⚫项目目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚫项目目录"}},[t._v("#")]),t._v(" ⚫"),s("strong",[t._v("项目目录")])]),t._v(" "),s("p",[t._v("首先在/opt 目录下创建一个项目目录 gpmall_ansible，这个就是本次企业应用实战的项目目录.")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir /opt/gpmall_ansible ")]),t._v("\n")])])]),s("h5",{attrs:{id:"⚫创建角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚫创建角色"}},[t._v("#")]),t._v(" "),s("strong",[t._v("⚫创建角色")])]),t._v(" "),s("p",[t._v("在创建 roles 角色目录之前，考虑将集群商城+监控案例拆分为多个 roles 执行，这样的话，PlayBook 易于编写和读懂。 安装集群商城+监控，使用 init（基础环境）、mariadb（数据库）、redis（数据库）、zookeeper（协调服务）、kafka（消息队列）、jar（运行 Jar 包）、nginx （前端服务）这些 roles 来完成。")]),t._v(" "),s("p",[t._v("在每个角色目录下面都有一样的目录，这些目录中的 task 目录一般是一定会用到的，其他的目录视情况而定来使用。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir -p /opt/gpmall_ansible/roles/{init,mariadb,redis,zookeeper,kafka,jar,nginx,zabbix}/{tasks,files,templates,meta,handlers,vars} ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tree /opt/gpmall_ansible/ ")]),t._v("\n/opt/gpmall_ansible/ \n└── roles \n    ├── init \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    ├── jar \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    ├── kafka \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n\n    │   ├── templates \n    │   └── vars \n    ├── mariadb \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    ├── nginx \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    ├── redis \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    ├── zabbix \n    │   ├── files \n    │   ├── handlers \n    │   ├── meta \n    │   ├── tasks \n    │   ├── templates \n    │   └── vars \n    └── zookeeper \n        ├── files \n        ├── handlers \n        ├── meta \n        ├── tasks \n        ├── templates \n        └── vars \n\n")])])]),s("h5",{attrs:{id:"⚫创建-group-vars-目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚫创建-group-vars-目录"}},[t._v("#")]),t._v(" "),s("strong",[t._v("⚫创建 group_vars 目录")])]),t._v(" "),s("p",[t._v("在项目目录/opt/gpmall_ansible 下创建 group_vars 目录，并在该目录下创建all 文件，该目录用来存放变量声明文件 all。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /opt/gpmall_ansible/ ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir group_vars ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd group_vars/ ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible group_vars"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# touch all ")]),t._v("\n")])])]),s("h5",{attrs:{id:"⚫创建安装入口文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#⚫创建安装入口文件"}},[t._v("#")]),t._v(" "),s("strong",[t._v("⚫创建安装入口文件")])]),t._v(" "),s("p",[t._v("进入/opt/gpmall_ansible 目录，创建 install_gpmall_cluster.yaml 文件，该文件是安装动作的入口文件。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# touch install_gpmall_cluster.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll ")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \ndrwxr-xr-x.  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(" Aug "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(":31 group_vars \n-rw-r--r--.  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" Aug "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(":33 install_gpmall_cluster.yaml \ndrwxr-xr-x. "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("114")]),t._v(" Aug "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(":18 roles \n")])])]),s("h4",{attrs:{id:"编写init角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写init角色"}},[t._v("#")]),t._v(" 编写init角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色执行的任务是用来部署 3 个 Node 节点的基础环境，包括关闭防火墙、 SELinux、配置 Yum 源、安装 Java JDK 环境。")]),t._v(" "),s("p",[t._v("⚫在 "),s("strong",[t._v("roles/init/tasks")]),t._v(" 目录下，创建 "),s("strong",[t._v("main.yaml")]),t._v(" 文件。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible roles"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim init/tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" disable selinux\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" setenforce 0\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" stop firewalld\n "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" systemctl stop firewalld\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" tar gpmall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("repo\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("unarchive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gpmall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("repo.tar.gz\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mv repo          \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf /etc/yum.repos.d/*\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" create local.repo\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=local.repo dest=/etc/yum.repos.d/\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install jdk\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name="),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("item"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" state=present\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.8.0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openjdk\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.8.0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openjdk"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("devel\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" copy hosts\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=hosts.j2 dest=/etc/hosts\n")])])]),s("h5",{attrs:{id:"_2-files添加文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-files添加文件"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.files添加文件")])]),t._v(" "),s("p",[t._v("⚫该剧本用到了 copy 和 template 以及unarchive模块，copy 模块使用的文件及镜像包，放入 tasks 同级目录的 files 目录下；")]),t._v(" "),s("p",[t._v("⚫template 模块使用的 Jinja2 文件，放入 tasks 同级目录的 templates 目录下。")]),t._v(" "),s("p",[t._v("⚫在该 init 角色剧本中，即把 "),s("strong",[t._v("gpmall-repo.tar.gz")]),t._v(" 镜像和 "),s("strong",[t._v("local.repo")]),t._v(" 文件拷贝至 init/files 目录下。")]),t._v(" "),s("p",[t._v("⚫把 "),s("strong",[t._v("hosts.j2")]),t._v(" 文件拷贝至 "),s("strong",[t._v("init/templates")]),t._v(" 目录下。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll files/")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("194544")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("199206529")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" 01:56 gpmall-repo.tar.gz\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("148")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" 01:57 local.repo\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll templates/")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("244")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" 01:59 hosts.j2\n")])])]),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat files/local.repo ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("centos"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("centos \n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("baseurl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://192.168.1.113/file/repo/centos/\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gpgcheck")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("gpmall"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("gpmall\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("baseurl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("file:///opt/gpmall-repo \n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gpgcheck")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible init"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat templates/hosts.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h5",{attrs:{id:"_3-在all添加变量"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-在all添加变量"}},[t._v("#")]),t._v(" "),s("strong",[t._v("3.在all添加变量")])]),t._v(" "),s("p",[t._v("因为设置的变量，所以需要在**/opt/gpmall_ansible/group_vars/all** 中声明变量，all 文件内容如下。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  group_vars/all ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.7 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.26\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.3 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node1 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node2 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node3 \n")])])]),s("h4",{attrs:{id:"编写mariadb角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写mariadb角色"}},[t._v("#")]),t._v(" 编写mariadb角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-2"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是在 3 个节点上安装数据库服务并配置成数据库 MariaDBGalera Cluster 集群，在 "),s("strong",[t._v("roles/mariadb/tasks")]),t._v(" 目录下，创建 "),s("strong",[t._v("main.yaml")]),t._v(" 文件。")]),t._v(" "),s("p",[t._v("⚫主要内容是安装mariadb以及配置成高可用。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible mariadb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install mariadb \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mariadb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server \n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mariadb \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" present \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start  mariadb \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mariadb \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" started \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql_pass \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysqladmin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("uroot password "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_PASS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config mariadb \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=server.cnf.j2 dest=/etc/my.cnf.d/server.cnf \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" grant privileges \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("uroot "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_PASS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('e "grant all privileges on '),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("*.*")]),t._v(" to root@'%' identified by '"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_PASS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("';\"\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" stop db \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" systemctl stop mariadb \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" new cluster \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" galera_new_cluster\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start maraidb \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" systemctl start mariadb \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" item "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n  '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with_items")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node2 \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node3 \n")])])]),s("h5",{attrs:{id:"_2-修改template模板"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改template模板"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.修改template模板")])]),t._v(" "),s("p",[t._v("⚫在该 mariadb 角色剧本中，用到了 template 模块，需要把 "),s("strong",[t._v("server.cnf.j2")]),t._v(" 文件放入 tasks 同级别的 "),s("strong",[t._v("templates")]),t._v(" 目录下。")]),t._v(" "),s("p",[t._v("⚫需要修改成的内容将会用ansible的循环语句进行修改成"),s("strong",[t._v("j2的模板。")])]),t._v(" "),s("p",[t._v("⚫"),s("strong",[t._v("server.cnf.j2")]),t._v(" 文件为数据库的配置文件，因需要确保各个节点的配置，需要使用变量。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible mariadb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat templates/server.cnf.j2  ")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("galera"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Mandatory settings")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_on")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ON\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_provider")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/lib64/galera/libgalera_smm.so\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_cluster_address")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"gcomm://{{hostip1}},{{hostip2}},{{hostip3}}"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_address")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elif")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node2"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_address")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostname3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_node_address")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% endif %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_sst_method")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("rsync  \n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_causal_reads")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("ON \n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("binlog_format")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("row\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("default_storage_engine")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("InnoDB\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("innodb_autoinc_lock_mode")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("innodb_buffer_pool_size")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("120M \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Allow server to accept connections on all interfaces.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nbind-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elif")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node2"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nbind-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nbind-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% endif %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Optional setting")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("wsrep_slave_threads")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("innodb_flush_log_at_trx_commit")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),s("p",[t._v("脚本中使用了 DB_PASS 变量，所以需要在 all 文件中声明，编辑**/opt/gpmall_ansible/group_vars/all** 文件，添加一条变量声明。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat group_vars/all ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.7 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.26\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostip3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.1.3 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node1 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node2 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node3 \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DB_PASS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#添加一个DB_PASS")]),t._v("\n")])])]),s("h4",{attrs:{id:"编写redis角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写redis角色"}},[t._v("#")]),t._v(" 编写redis角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-3"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是"),s("strong",[t._v("安装 redis 服务并配置")]),t._v("启动。")]),t._v(" "),s("p",[t._v("⚫关闭"),s("strong",[t._v("bind 127.0.0.1")]),t._v(" 和关闭"),s("strong",[t._v("保护模式")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install redis\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("state")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" present\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config redis\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=redis.conf dest=/etc/redis.conf\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start redis\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" systemctl restart redis\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n')])])]),s("h5",{attrs:{id:"_2-修改配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改配置文件"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.修改配置文件")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp /etc/redis.conf  files/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible redis"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim files/redis.conf")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#bind 127.0.0.1     将bind 127.0.0.1注释掉")]),t._v("\nprotected-mode no    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#将yes修改为no")]),t._v("\n")])])]),s("h4",{attrs:{id:"编写zookeeper角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写zookeeper角色"}},[t._v("#")]),t._v(" 编写zookeeper角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-4"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是在 3 个节点上安装 Zookeeper 服务并配置为 Zookeeper 集群。")]),t._v(" "),s("p",[t._v("⚫在 roles/zookeeper/tasks 目录下，创建 main.yaml 文件。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" unarchive tar \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("unarchive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("3.4.14.tar.gz\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" delete zoo.cfg \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf /opt/zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("3.4.14/conf/zoo_sample.cfg \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config zoo.cfg \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" zoo.cfg.j2 \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt/zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("3.4.14/conf/zoo.cfg \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mkdir file \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mkdir "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p /tmp/zookeeper \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config myid \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" myid.j2 \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /tmp/zookeeper/myid \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start zookeeper \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sh /opt/zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("3.4.14/bin/zkServer.sh start \n")])])]),s("h5",{attrs:{id:"_2-添加文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加文件"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.添加文件")])]),t._v(" "),s("p",[t._v("⚫该剧本使用了 "),s("strong",[t._v("copy")]),t._v(" 和 "),s("strong",[t._v("template")]),t._v(" 模块，故需要将 zookeeper-3.4.14.tar.gz 镜像 包拷贝至 tasks 目录同级别的 files 目录下。")]),t._v(" "),s("p",[t._v("⚫将 "),s("strong",[t._v("zoo.cfg.j2")]),t._v(" 文件和 "),s("strong",[t._v("myid.j2")]),t._v(" 文件拷贝 至 templates 下。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll files/")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("36796")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("37676320")]),t._v(" Nov "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" zookeeper-3.4.14.tar.gz\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat templates/myid.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elif")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node2"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("%endif%"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible zookeeper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat templates/zoo.cfg.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The number of milliseconds of each tick")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("tickTime")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The number of ticks that the initial ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# synchronization phase can take")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("initLimit")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The number of ticks that can pass between ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sending a request and getting an acknowledgement")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("syncLimit")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the directory where the snapshot is stored.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# do not use /tmp for storage, /tmp here is just ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# example sakes.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dataDir")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/tmp/zookeeper\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the port at which the clients will connect")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("clientPort")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2181")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the maximum number of client connections.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# increase this if you need to handle more clients")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#maxClientCnxns=60")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Be sure to read the maintenance section of the ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# administrator guide before turning on autopurge.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The number of snapshots to retain in dataDir")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#autopurge.snapRetainCount=3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Purge task interval in hours")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# Set to "0" to disable auto purge feature')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#autopurge.purgeInterval=1")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("server.1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2888:3888\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("server.2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2888:3888\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("server.3")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2888:3888\n")])])]),s("h4",{attrs:{id:"编写kafka角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写kafka角色"}},[t._v("#")]),t._v(" 编写kafka角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-5"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是在 3 个节点上安装 Kafka 服务并配置为 Kafka 集群，在 "),s("strong",[t._v("roles/kafka/tasks")]),t._v(" 目录下。")]),t._v(" "),s("p",[t._v("⚫配置"),s("strong",[t._v("template")]),t._v("将修改好的配置文件替换。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" unarchive  tar \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("unarchive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kafka_2.11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.1.1.tgz\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" server.properties.j2 \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt/kafka_2.11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.1.1/config/server.properties\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start kafka \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" sh /opt/kafka_2.11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.1.1/bin/kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("server"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("start.sh "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("daemon /opt/kafka_2.11"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("1.1.1/config/server.properties\n")])])]),s("h5",{attrs:{id:"_2-添加文件-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加文件-2"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.添加文件")])]),t._v(" "),s("p",[t._v("⚫该剧本使用了 "),s("strong",[t._v("copy")]),t._v(" 和 "),s("strong",[t._v("template")]),t._v(" 模块，故需要将 "),s("strong",[t._v("kafka_2.11-1.1.1.tgz")]),t._v(" 镜像包 拷贝至tasks目录同级别的files目录下。")]),t._v(" "),s("p",[t._v("⚫将"),s("strong",[t._v("server.properties.j2")]),t._v("文件拷贝至templates 下。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll files/")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("56128")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("57471165")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(" 00:50 kafka_2.11-1.1.1.tgz\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible kafka"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  templates/server.properties.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#broker.id=0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#zookeeper.connect=localhost:2181")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("broker.id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elif")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node2"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("broker.id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("broker.id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% endif %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("zookeeper.connect")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2181,"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2181,"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":2181 \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nlisteners "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PLAINTEXT://"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":9092\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elif")]),t._v(" ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node2"')]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nlisteners "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PLAINTEXT://"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":9092\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nlisteners "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PLAINTEXT://"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":9092\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("% endif %"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n")])])]),s("h4",{attrs:{id:"编写jar角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写jar角色"}},[t._v("#")]),t._v(" 编写jar角色")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-6"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-6"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是在 Node2 和 Node3 节点上启动应用商城的 Jar 包，在 roles/jar/tasks 目录下，创建 main.yaml 文件")]),t._v(" "),s("p",[t._v("⚫主要工作是负责传送jar包包括启动jar包。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible jar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat tasks/main.yaml ")]),t._v("\n- name: copy sql \n  copy: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("gpmall.sql "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/gpmall.sql \n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v("\n- name: config db \n  shell: mysql "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-uroot")]),t._v(" -p"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DB_PASS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create database gpmall;use gpmall;source /opt/gpmall.sql;"')]),t._v("\n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node1"')]),t._v("\n- name: unarchive jar \n  unarchive: \n    src: jar.tar.gz \n    dest: /opt \n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{item}}"')]),t._v(" \n  with_items:  \n    - node2 \n    - node3 \n- name: copy hostst \n  template: "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("hosts.j2 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("dest")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/hosts \n- name: start jar \n  shell: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("java")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-jar")]),t._v(" /opt/user-provider-0.0.1-SNAPSHOT.jar "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{item}}"')]),t._v("\n  with_items:\n    - node2\n    - node3\n- name: start jar\n  shell: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("java")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-jar")]),t._v(" /opt/shopping-provider-0.0.1-SNAPSHOT.jar "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{item}}"')]),t._v("\n  with_items:\n    - node2\n    - node3\n- name: start jar\n  shell: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("java")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-jar")]),t._v(" /opt/gpmall-shopping-0.0.1-SNAPSHOT.jar "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{item}}"')]),t._v("\n  with_items:\n    - node2\n    - node3\n- name: start jar\n  shell: "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("java")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-jar")]),t._v(" /opt/gpmall-user-0.0.1-SNAPSHOT.jar "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n  when: ansible_fqdn "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{item}}"')]),t._v("\n  with_items: \n    - node2\n    - node3\n")])])]),s("h5",{attrs:{id:"_2-添加文件-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加文件-3"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.添加文件")])]),t._v(" "),s("p",[t._v("⚫同样，该剧本使用了 copy 和 template 模块，需要将 gpmall.sql 和 4 个 gpmall 商城的 Jar 包拷贝至 tasks 目录同级别的 files 目录下。")]),t._v(" "),s("p",[t._v("⚫将 hosts.j2 文件拷贝至 templates 目录下。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible jar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll files/")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("179696")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("59239")]),t._v(" Nov "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" gpmall.sql\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("183943654")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(" 01:24 jar.tar.gz\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible jar"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  templates/hosts.j2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),t._v(".0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6\n \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" redis.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" mysql.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" kafka1.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" kafka2.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" kafka3.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zk1.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zk2.mall\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" zk3.mal\n")])])]),s("h4",{attrs:{id:"编写nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写nginx"}},[t._v("#")]),t._v(" 编写nginx")]),t._v(" "),s("h5",{attrs:{id:"_1-编写清单-7"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-编写清单-7"}},[t._v("#")]),t._v(" "),s("strong",[t._v("1.编写清单")])]),t._v(" "),s("p",[t._v("⚫该角色的作用是在 Node1 节点上安装 Nginx 服务，部署前端，并使用 IP 轮 询的方式配置负载均衡，在 roles/nginx/tasks 目录下，创建 main.yaml 文件。")]),t._v(" "),s("p",[t._v("⚫主要是修改配置文件然后重启服务。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat tasks/main.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install nginx \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("yum")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name=nginx  state=present \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1" \n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" delete html \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf /usr/share/nginx/html/* \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" copy file\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("copy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=dist dest=/opt\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cp file \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cp "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rvf /opt/dist/* /usr/share/nginx/html/ \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" config default.config \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" src=default.conf.j2 dest=/etc/nginx/conf.d/default.conf \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1"\n'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" start nginx \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" name=nginx state=started \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("when")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' ansible_fqdn == "node1" \n')])])]),s("h5",{attrs:{id:"_2-添加文件-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加文件-4"}},[t._v("#")]),t._v(" "),s("strong",[t._v("2.添加文件")])]),t._v(" "),s("p",[t._v("⚫该剧本使用了 copy 和 template 模块，故需要将 dist 目录拷贝至 tasks 目录同 级别的 files 目录下。")]),t._v(" "),s("p",[t._v("⚫将 default.conf.j2 文件拷贝至 templates 下。下面代码展示了 default.conf.j2 文件的内容。")]),t._v(" "),s("div",{staticClass:"language-nginx extra-class"},[s("pre",{pre:!0,attrs:{class:"language-nginx"}},[s("code",[t._v("[root@ansible "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nginx]#")]),t._v(" ll files/\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\ndrwxr-xr-x "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("38")]),t._v(" Feb "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v(" 02:13 dist\n[root@ansible nginx]# cat templates/default.conf.j2 \n        upstream myuser")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8082"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8082"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ip_hash")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" myshopping")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8081"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8081"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ip_hash")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" mycashier")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8083"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("hostip3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(":8083"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" \n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ip_hash")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v("  localhost")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#charset koi8-r;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#access_log  /var/log/nginx/host.access.log  main;")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v("   /usr/share/nginx/html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("index")]),t._v("  index.html index.htm")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /user")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://myuser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /shopping")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://myshopping")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /cashier")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://mycashier")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#error_page  404              /404.html;")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# redirect server error pages to the static page /50x.html")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_page")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("502")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("503")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("504")]),t._v("  /50x.html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" = /50x.html")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token directive"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("root")]),t._v("   /usr/share/nginx/html")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# proxy the PHP scripts to Apache listening on 127.0.0.1:80")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#location ~ \\.php$ {")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    proxy_pass   http://127.0.0.1;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#location ~ \\.php$ {")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    root           html;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    fastcgi_pass   127.0.0.1:9000;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    fastcgi_index  index.php;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    include        fastcgi_params;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# deny access to .htaccess files, if Apache's document root")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# concurs with nginx's one")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#location ~ /\\.ht {")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#    deny  all;")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"编写role角色"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写role角色"}},[t._v("#")]),t._v(" 编写role角色")]),t._v(" "),s("p",[t._v("⚫执行角色剧本之后可以访问node1节点的IP")]),t._v(" "),s("p",[t._v("⚫过程中报错需要进行解决。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat install_gpmall_cluster.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hosts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" hosts\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("remote_user")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" root\n \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roles")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" init\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mariadb\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" redis\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" zookeeper\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kafka\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" jar\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nginx\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@ansible gpmall_ansible"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ansible-playboox install_gpmall_cluster.yaml ")]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111159261.png",alt:"image-20220221104913383"}})])])}),[],!1,null,null,null);s.default=e.exports}}]);