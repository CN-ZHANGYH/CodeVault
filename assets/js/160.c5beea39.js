(window.webpackJsonp=window.webpackJsonp||[]).push([[160],{473:function(s,t,a){"use strict";a.r(t);var e=a(7),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"kubernetes-k8s-helm-v3-部署-efk-日志系统"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-k8s-helm-v3-部署-efk-日志系统"}},[s._v("#")]),s._v(" Kubernetes（k8s）Helm v3 部署 EFK 日志系统")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111213092.jpeg",alt:"Kubernetes（k8s）Helm 部署 EFK 集群"}})]),s._v(" "),t("h3",{attrs:{id:"查看k8s集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看k8s集群"}},[s._v("#")]),s._v(" 查看K8S集群")]),s._v(" "),t("p",[s._v("在这里使用的是kubernetes v1.21.1的版本部署。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get node ")]),s._v("\nNAME               STATUS   ROLES                         AGE   VERSION\nk8s-master-node1   Ready    control-plane,master,worker   15h   v1.21.1\nk8s-worker-node1   Ready    worker                        15h   v1.21.1\n")])])]),t("h3",{attrs:{id:"安装helm3"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装helm3"}},[s._v("#")]),s._v(" 安装Helm3")]),s._v(" "),t("p",[s._v("通过tar包安装helm3 ，查看当前的helm版本。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar xf helm-v3.5.4-linux-amd64.tar.gz")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv linux-amd64/helm /usr/local/sbin/helm")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm  version ")]),s._v("\nversion.BuildInfo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("Version:"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v3.7.1"')]),s._v(", GitCommit:"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4"')]),s._v(", GitTreeState:"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clean"')]),s._v(", GoVersion:"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go1.16.9"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("h3",{attrs:{id:"添加公用的仓库"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加公用的仓库"}},[s._v("#")]),s._v(" 添加公用的仓库")]),s._v(" "),t("p",[s._v("配置helm微软源地址")]),s._v(" "),t("p",[s._v("配置helm阿里源地址")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm repo add stable http://mirror.azure.cn/kubernetes/charts")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts             ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"aliyun"')]),s._v(" has been added to your repositories\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm repo list ")]),s._v("\nNAME    URL                                                   \nstable  http://mirror.azure.cn/kubernetes/charts/             \naliyun  https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts\n")])])]),t("h3",{attrs:{id:"部署elasticsearch"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署elasticsearch"}},[s._v("#")]),s._v(" 部署Elasticsearch")]),s._v(" "),t("p",[t("strong",[s._v("ES 集群环境")])]),s._v(" "),t("ul",[t("li",[s._v("es-master 搭建一个 elasticsearch 至少需要 3 个 Pod 以防止集群脑裂")]),s._v(" "),t("li",[s._v("es-data 数据节点至少需要 2 个 Pod 。数据节点将保留数据、接收查询和索引请求")]),s._v(" "),t("li",[s._v("es-client 做为协调 elasticsearch 集群。至少需要 2 个。用于集群连接，并充当 HTTP 代理。如果不使用 es-clinet 那么 es-data 充当协调，尽量避免在较大的集群上这样做。")]),s._v(" "),t("li",[s._v("这里我没有使用NFS 类型的 StorageClass 来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD 之类的存储来持久化 Elasticsearch 的数据")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111213350.webp",alt:"图片"}})]),s._v(" "),t("p",[s._v("从官方的仓库拉取elasticsearch的chart包。")]),s._v(" "),t("ul",[t("li",[s._v("如果主机内存小可以将replicas的副本设置为1，则默认")]),s._v(" "),t("li",[s._v("这里关闭pvc存储。")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 opt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir efk && cd  efk ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl  create namespace efk      ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm fetch stable/elasticsearch ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf elasticsearch-1.32.5.tgz  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd elasticsearch/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nChart.yaml  ci  README.md  templates  values.yaml\n")])])]),t("p",[s._v("将persistence的enabled选项设置为false，有则用true。")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node1 elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim values.yaml  ")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistence")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessMode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ReadWriteOnce\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("size")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4Gi"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# storageClass: "ssd"')]),s._v("\n")])])]),t("p",[s._v("helm安装elasticsearch指定命名空间指定value文件。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm install els1 --namespace=efk -f  values.yaml stable/elasticsearch ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n efk  ")]),s._v("\nNAME                                         READY   STATUS    RESTARTS   AGE\nels1-elasticsearch-client-69bd9656b4-hhtr5   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          176m\nels1-elasticsearch-client-69bd9656b4-qq89w   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          176m\nels1-elasticsearch-data-0                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          176m\nels1-elasticsearch-data-1                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          175m\nels1-elasticsearch-master-0                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          176m\nels1-elasticsearch-master-1                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          175m\nels1-elasticsearch-master-2                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          174m\n")])])]),t("h3",{attrs:{id:"部署fluentd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署fluentd"}},[s._v("#")]),s._v(" 部署Fluentd")]),s._v(" "),t("p",[s._v("要收集 Kubernetes 集群的日志，直接用 DasemonSet 控制器来部署 Fluentd 应用，这样，它就可以从 Kubernetes 节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd 容器。")]),s._v(" "),t("p",[s._v("从官方的仓库拉取fluentd的chart包。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm  fetch stable/fluentd-elasticsearch ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar  zxvf fluentd-elasticsearch-2.0.7.tgz ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd fluentd-elasticsearch/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 fluentd-elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nChart.yaml  OWNERS  README.md  templates  values.yaml\n")])])]),t("p",[s._v("修改elasticsearch的连接地址，可以通过查看efk命名空间的svc，找到elasticsearch的地址。")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node1 fluentd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n efk  ")]),s._v("\nNAME                           TYPE        CLUSTER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("IP      EXTERNAL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("IP   PORT(S)         AGE\nels1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client      ClusterIP   10.96.188.11    <none"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("        9200/TCP        3h4m\nels1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("discovery   ClusterIP   None            <none"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v("        9300/TCP        3h4m\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node1 fluentd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim values.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'10.96.188.11'")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#将这里的默认修改成elasticsearch的ip")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheme")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssl_version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TLSv1_2\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("buffer_chunk_limit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2M\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("buffer_queue_limit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("logstash_prefix")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'logstash'")]),s._v("\n")])])]),t("p",[s._v("helm安装fluentd指定命名空间指定value文件。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 fluentd-elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm install flu1 --namespace=efk -f values.yaml stable/fluentd-elasticsearch ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 fluentd-elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n efk  ")]),s._v("\nNAME                                         READY   STATUS    RESTARTS   AGE\nels1-elasticsearch-client-69bd9656b4-hhtr5   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h6m\nels1-elasticsearch-client-69bd9656b4-qq89w   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h6m\nels1-elasticsearch-data-0                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h6m\nels1-elasticsearch-data-1                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h5m\nels1-elasticsearch-master-0                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h6m\nels1-elasticsearch-master-1                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h5m\nels1-elasticsearch-master-2                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h4m\nflu1-fluentd-elasticsearch-4vbcv             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          56m\nflu1-fluentd-elasticsearch-mbpd4             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          56m\n")])])]),t("blockquote",[t("p",[s._v("注意：")]),s._v(" "),t("p",[s._v("这里面涉及到一个镜像gcr.io/google-containers/fluentd-elasticsearch:v2.3.2，国内网络无法访问可以拉取阿里云的镜像然后修改，包括后面的kibana镜像也一样的操作。"),t("code",[s._v("然后需要使用save -o 导出来分发到其他节点上传镜像。")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 fluentd-elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull registry.aliyuncs.com/google_containers/fluentd-elasticsearch:v2.3.2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 fluentd-elasticsearch"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker tag registry.aliyuncs.com/google_containers/fluentd-elasticsearch:v2.3.2    gcr.io/google-containers/fluentd-elasticsearch:v2.3.2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker save -o fluentd-elasticsearch.tar gcr.io/google-containers/fluentd-elasticsearch:v2.3.2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# scp  fluentd-elasticsearch.tar k8s-worker-node1:/root/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-worker-node1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker load -i fluentd-elasticsearch.tar ")]),s._v("\n")])])])]),s._v(" "),t("h3",{attrs:{id:"部署kibana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署kibana"}},[s._v("#")]),s._v(" 部署Kibana")]),s._v(" "),t("p",[s._v("修改kibana文件(注意kibana的版本一定要"),t("strong",[s._v("与elasticsearch一致)")])]),s._v(" "),t("p",[s._v("Kibana 是Elastic Search 的数据分析及可视化平台， 能够用来搜索、查看存储在ElasticSearch索引中的数据。")]),s._v(" "),t("p",[s._v("它可以通过各种图表进行高级数据分析及展示，用户基于Web GUI可以快速创建仪表板（ dashboard ）实时显示ElasticSearch 的查询结果。")]),s._v(" "),t("p",[s._v("从官方的仓库拉取kibana的chart包。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm fetch stable/kibana")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf kibana-3.2.8.tgz ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd kibana/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 kibana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls")]),s._v("\nChart.yaml  ci  OWNERS  README.md  templates  values.yaml\n")])])]),t("p",[s._v("通过查看k8s集群的clusterip，跟elasticsearch一样的clusterip。")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node1 kibana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim values.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("files")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kibana.yml")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## Default Kibana configuration from kibana-docker.")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kibana\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server.host")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## For kibana < 6.6, use elasticsearch.url instead")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("elasticsearch.hosts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//10.96.188.11"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("\n")])])]),t("p",[s._v("helm安装kibana指定命名空间指定value文件。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 kibana"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm  install kibana --namespace=efk -f  values.yaml stable/kibana ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n efk ")]),s._v("\nNAME                                         READY   STATUS    RESTARTS   AGE\nels1-elasticsearch-client-69bd9656b4-hhtr5   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h24m\nels1-elasticsearch-client-69bd9656b4-qq89w   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h24m\nels1-elasticsearch-data-0                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h24m\nels1-elasticsearch-data-1                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h23m\nels1-elasticsearch-master-0                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h24m\nels1-elasticsearch-master-1                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3h23m\nels1-elasticsearch-master-2                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("          3h22m\nflu1-fluentd-elasticsearch-4vbcv             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          74m\nflu1-fluentd-elasticsearch-mbpd4             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          74m\nkibana-56fdd4b5c-57hzr                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          64m\n")])])]),t("p",[s._v("将kibana的services暴露端口服务修改ClusterIP为NodePort。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@k8s-master-node1 efk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n efk ")]),s._v("\nNAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("         AGE\nels1-elasticsearch-client      ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".188.11    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9200")]),s._v("/TCP        3h24m\nels1-elasticsearch-discovery   ClusterIP   None            "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9300")]),s._v("/TCP        3h24m\nkibana                         NodePort    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".214.238   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v(":59247/TCP   65m\n")])])]),t("p",[s._v("通过界面访问http://192.168.1.3:59247。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111213979.png",alt:"image-20220307150613417"}})]),s._v(" "),t("h3",{attrs:{id:"创建索引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#创建索引"}},[s._v("#")]),s._v(" 创建索引")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111214856.png",alt:"image-20220307150728270"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111214439.png",alt:"image-20220307150841897"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111214096.png",alt:"image-20220307150851578"}})]),s._v(" "),t("p",[s._v("创建好索引模式之后，即可通过“ Discover ”搜索数据，或者在“ Visualize ”界面中定义可视化图形，并将它们集成于可在“ Dashboard ”中创建的仪表板里。")]),s._v(" "),t("p",[s._v("以下就是2022年3月06号的日志。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204111214818.png",alt:"image-20220307150941899"}})])])}),[],!1,null,null,null);t.default=n.exports}}]);