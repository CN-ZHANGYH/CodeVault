(window.webpackJsonp=window.webpackJsonp||[]).push([[167],{483:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"监控、审计和运行时安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控、审计和运行时安全"}},[t._v("#")]),t._v(" 监控、审计和运行时安全")]),t._v(" "),s("h3",{attrs:{id:"主要内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[t._v("#")]),t._v(" 主要内容")]),t._v(" "),s("p",[t._v("❖ 分析容器系统调用：Sysdig")]),t._v(" "),s("p",[t._v("❖ 监控容器运行时：Falco")]),t._v(" "),s("p",[t._v("❖ Kubernetes 审计日志")]),t._v(" "),s("h3",{attrs:{id:"分析容器系统调用-sysdig"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分析容器系统调用-sysdig"}},[t._v("#")]),t._v(" 分析容器系统调用：Sysdig")]),t._v(" "),s("h4",{attrs:{id:"sysdig简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sysdig简介"}},[t._v("#")]),t._v(" Sysdig简介")]),t._v(" "),s("p",[t._v("Sysdig：一个非常强大的系统监控、分析和故障排查工具。")]),t._v(" "),s("p",[t._v("汇聚 strace+tcpdump+htop+iftop+lsof 工具功能于一身！")]),t._v(" "),s("p",[t._v("sysdig 除了能获取系统资源利用率、进程、网络连接、系统调用等信息， 还具备了很强的分析能力，例如：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("按照CPU使用率对进程排序")])]),t._v(" "),s("li",[s("p",[t._v("按照数据包对进程排序")])]),t._v(" "),s("li",[s("p",[t._v("打开最多的文件描述符进程")])]),t._v(" "),s("li",[s("p",[t._v("查看进程打开了哪些文件")])]),t._v(" "),s("li",[s("p",[t._v("查看进程的HTTP请求报文")])]),t._v(" "),s("li",[s("p",[t._v("查看机器上容器列表及资源使用情况")])])]),t._v(" "),s("p",[t._v("项目地址：https://github.com/draios/sysdig")]),t._v(" "),s("p",[t._v("文档：https://github.com/draios/sysdig/wiki")]),t._v(" "),s("p",[t._v("sysdig 通过在内核的驱动模块注册系统调用的 hook，这样当有系 统调用发生和完成的时候，它会把系统调用信息拷贝到特定的 buffer，然后用户态组件对数据信息处理（解压、解析、过滤等）， 并最终通过 sysdig 命令行和用户进行交互。")]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151059040.png",alt:"image-20220414220604964"}}),t._v(" "),s("h4",{attrs:{id:"安装sysdig"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装sysdig"}},[t._v("#")]),t._v(" 安装sysdig")]),t._v(" "),s("p",[t._v("导入sysdig的repo源，安装epel源。")]),t._v(" "),s("p",[t._v("安装完sysdig的时候，需要更新一下软件包，会更新sysdig，才能加载模块。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rpm --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# curl -s -o /etc/yum.repos.d/draios.repo https://s3.amazonaws.com/download.draios.com/stable/rpm/draios.repo")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install epel-release -y")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install sysdig -y")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum update -y ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# /usr/bin/sysdig-probe-loader # 加载驱动模块")]),t._v("\n")])])]),s("h4",{attrs:{id:"sysdig常用参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sysdig常用参数"}},[t._v("#")]),t._v(" sysdig常用参数")]),t._v(" "),s("p",[s("code",[t._v("-l, --list")]),t._v("：列出可用于过滤和输出的字段")]),t._v(" "),s("p",[s("code",[t._v("-M")]),t._v("  ：多少秒后停止收集")]),t._v(" "),s("p",[s("code",[t._v("-p")]),t._v(" , --print= ：指定打印事件时使用的格式")]),t._v(" "),s("ul",[s("li",[t._v("使用-pc或-pcontainer 容器友好的格式")]),t._v(" "),s("li",[t._v("使用-pk或-pkubernetes k8s友好的格式")])]),t._v(" "),s("p",[s("code",[t._v("-c")]),t._v("  ：指定内置工具，可直接完成具体的数据聚合、分析工作")]),t._v(" "),s("p",[s("code",[t._v("-w")]),t._v(" ：保存到文件中")]),t._v(" "),s("p",[s("code",[t._v("-r")]),t._v(" ：从文件中读取")]),t._v(" "),s("p",[t._v("执行sysdig命令，实时输出大量系统调用。")]),t._v(" "),s("p",[t._v("示例：59509 23:59:19.023099531 0 kubelet (1738) < epoll_ctl")]),t._v(" "),s("p",[t._v("格式：%evt.num %evt.outputtime %evt.cpu %proc.name (%thread.tid) %evt.dir %evt.type %evt.info")]),t._v(" "),s("p",[s("code",[t._v("evt.num")]),t._v("： 递增的事件号")]),t._v(" "),s("p",[s("code",[t._v("evt.time")]),t._v("： 事件发生的时间")]),t._v(" "),s("p",[s("code",[t._v("evt.cpu")]),t._v("： 事件被捕获时所在的 CPU，也就是系统调用是在哪个 CPU 执行的")]),t._v(" "),s("p",[s("code",[t._v("proc.name")]),t._v("： 生成事件的进程名字")]),t._v(" "),s("p",[s("code",[t._v("thread.tid")]),t._v("： 线程的 id，如果是单线程的程序，这也是进程的 pid")]),t._v(" "),s("p",[s("code",[t._v("evt.dir")]),t._v("： 事件的方向（direction），> 代表进入事件，< 代表退出事件")]),t._v(" "),s("p",[s("code",[t._v("evt.type")]),t._v("： 事件的名称，比如 open、stat等，一般是系统调用")]),t._v(" "),s("p",[s("code",[t._v("evt.args")]),t._v("： 事件的参数。如果是系统调用，这些对应着系统调用的参数")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("自定义格式输出")]),t._v("："),s("code",[t._v('sysdig -p "user:%user.name time:%evt.time proc_name:%proc.name"')])])]),t._v(" "),s("h4",{attrs:{id:"sysdig过滤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sysdig过滤"}},[t._v("#")]),t._v(" sysdig过滤")]),t._v(" "),s("ol",[s("li",[t._v("**fd：**根据文件描述符过滤，比如 fd 标号（fd.num）、fd 名字（fd.name）")]),t._v(" "),s("li",[t._v("**process：**根据进程信息过滤，比如进程 id（proc.id）、进程名（proc.name）")]),t._v(" "),s("li",[t._v("**evt：**根据事件信息过滤，比如事件编号、事件名")]),t._v(" "),s("li",[t._v("**user：**根据用户信息过滤，比如用户 id、用户名、用户 home 目录")]),t._v(" "),s("li",[t._v("**syslog：**根据系统日志过滤，比如日志的严重程度、日志的内容")]),t._v(" "),s("li",[t._v("**container：**根据容器信息过滤，比如容器ID、容器名称、容器镜像")])]),t._v(" "),s("p",[t._v("查看完整过滤器列表：sysdig -l")]),t._v(" "),s("p",[t._v("示例：")]),t._v(" "),s("p",[t._v("1、查看一个进程的系统调用")]),t._v(" "),s("p",[t._v("sysdig proc.name=kubelet")]),t._v(" "),s("p",[t._v("2、查看建立TCP连接的事件")]),t._v(" "),s("p",[t._v("sysdig evt.type=accept")]),t._v(" "),s("p",[t._v("3、查看/etc目录下打开的文件描述符")]),t._v(" "),s("p",[t._v("sysdig fd.name contains /etc")]),t._v(" "),s("p",[t._v("4、查看容器的系统调用")]),t._v(" "),s("p",[t._v("sysdig -M 10 container.name=web")]),t._v(" "),s("blockquote",[s("p",[t._v("注：还支持运算操作符，= 、!=、>=、>、<、 <=、contains、in 、exists、and、or、not")])]),t._v(" "),s("h4",{attrs:{id:"chisels工具箱"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#chisels工具箱"}},[t._v("#")]),t._v(" Chisels工具箱")]),t._v(" "),s("p",[t._v("**Chisels：**实用的工具箱，一组预定义的功能集合，用来分析特定的场景。")]),t._v(" "),s("p",[s("strong",[t._v("sysdig –cl")]),t._v(" 列出所有Chisels，以下是一些常用的：")]),t._v(" "),s("ul",[s("li",[t._v("topprocs_cpu：输出按照 CPU 使用率排序的进程列表，例如sysdig -c")]),t._v(" "),s("li",[t._v("topprocs_net：输出进程使用网络TOP")]),t._v(" "),s("li",[t._v("topprocs_file：进程读写磁盘文件TOP")]),t._v(" "),s("li",[t._v("topfiles_bytes：读写磁盘文件TOP")]),t._v(" "),s("li",[t._v("netstat：列出网络的连接情况")])]),t._v(" "),s("h4",{attrs:{id:"其他常用命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他常用命令"}},[t._v("#")]),t._v(" 其他常用命令")]),t._v(" "),s("p",[t._v("sysdig -c netstat\nsysdig -c ps\nsysdig -c lsof")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th"),t._v(" "),s("th")])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("网络")]),t._v(" "),s("td",[t._v("# 查看使用网络的进程"),s("br"),t._v("TOP sysdig -c topprocs_net "),s("br"),t._v("# 查看建立连接的端口 "),s("br"),t._v('sysdig -c fdcount_by fd.sport "evt.type=accept" -M 10 '),s("br"),t._v("# 查看建立连接的端口 "),s("br"),t._v("sysdig -c fdbytes_by fd.sport "),s("br"),t._v("# 查看建立连接的IP "),s("br"),t._v('sysdig -c fdcount_by fd.cip "evt.type=accept" -M 10 '),s("br"),t._v("# 查看建立连接的IP "),s("br"),t._v("sysdig -c fdbytes_by fd.cip")])]),t._v(" "),s("tr",[s("td",[t._v("硬盘")]),t._v(" "),s("td",[t._v("# 查看进程磁盘I/O读写 "),s("br"),t._v("sysdig -c topprocs_file "),s("br"),t._v("# 查看进程打开的文件描述符数量 "),s("br"),t._v('sysdig -c fdcount_by proc.name "fd.type=file" -M 10 '),s("br"),t._v("# 查看读写磁盘文件 "),s("br"),t._v("sysdig -c topfiles_bytes sysdig -c topfiles_bytes proc.name=etcd "),s("br"),t._v("# 查看/tmp目录读写磁盘活动文件 "),s("br"),t._v('sysdig -c fdbytes_by fd.filename "fd.directory=/tmp/"')])]),t._v(" "),s("tr",[s("td",[t._v("CPU")]),t._v(" "),s("td",[t._v("# 查看CPU使用率TOP "),s("br"),t._v("sysdig -c topprocs_cpu "),s("br"),t._v("# 查看容器CPU使用率TOP "),s("br"),t._v("sysdig -pc -c topprocs_cpu container.name=web "),s("br"),t._v("sysdig -pc -c topprocs_cpu container.id=web")])]),t._v(" "),s("tr",[s("td",[t._v("容器")]),t._v(" "),s("td",[t._v("# 查看机器上容器列表及资源使用情况 "),s("br"),t._v("csysdig –vcontainers "),s("br"),t._v("# 查看容器资源使用TOP "),s("br"),t._v("sysdig -c topcontainers_cpu/topcontainers_net/topcontainers_file")])])])]),t._v(" "),s("h3",{attrs:{id:"监控容器运行时-falco"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#监控容器运行时-falco"}},[t._v("#")]),t._v(" 监控容器运行时：Falco")]),t._v(" "),s("h4",{attrs:{id:"falco简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#falco简介"}},[t._v("#")]),t._v(" Falco简介")]),t._v(" "),s("p",[t._v("Falco 是一个 Linux 安全工具，它使用系统调用来保护和监控系统。 Falco最初是由Sysdig开发的，后来加入CNCF孵化器，成为首个加入CNCF的运行时安全项目。")]),t._v(" "),s("p",[t._v("Falco提供了一组默认规则，可以监控内核态的异常行为，例如：")]),t._v(" "),s("ul",[s("li",[t._v("对于系统目录/etc, /usr/bin, /usr/sbin的读写行为")]),t._v(" "),s("li",[t._v("文件所有权、访问权限的变更")]),t._v(" "),s("li",[t._v("从容器打开shell会话")]),t._v(" "),s("li",[t._v("容器生成新进程")]),t._v(" "),s("li",[t._v("特权容器启动")])]),t._v(" "),s("p",[t._v("项目地址：https://github.com/falcosecurity/falco")]),t._v(" "),s("h4",{attrs:{id:"falco架构图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#falco架构图"}},[t._v("#")]),t._v(" Falco架构图")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151059595.png",alt:"image-20220414231953852"}})]),t._v(" "),s("h4",{attrs:{id:"安装falco"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装falco"}},[t._v("#")]),t._v(" 安装falco")]),t._v(" "),s("p",[t._v("falco配置文件目录：/etc/falco")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("falco.yaml")]),t._v(" falco配置与输出告警通知方式")]),t._v(" "),s("li",[s("code",[t._v("falco_rules.yaml")]),t._v(" 规则文件，默认已经定义很多威胁场景")]),t._v(" "),s("li",[s("code",[t._v("falco_rules.local.yaml")]),t._v(" 自定义扩展规则文件")]),t._v(" "),s("li",[s("code",[t._v("k8s_audit_rules.yaml")]),t._v(" K8s审计日志规则")])]),t._v(" "),s("p",[t._v("安装文档：https://falco.org/zh/docs/installation")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rpm --import https://falco.org/repo/falcosecurity-3672BA8F.asc")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# curl -s -o /etc/yum.repos.d/falcosecurity.repo https://falco.org/repo/falcosecurity-rpm.repo")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install epel-release -y")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum update")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install falco -y")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl start falco")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl enable falco")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# touch abc /usr/sbin/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tail -f /var/log/messages")]),t._v("\n\nApr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" 02:04:03 master01 falco: 02:04:03.052503851: Error File below /etc opened "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" writing "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("user_loginuid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("touch abc /usr/sbin/ "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("parent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bash "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("pcmdline")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bash "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("file")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/falco/abc "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("program")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("touch "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gparent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("sshd "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ggparent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("sshd "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gggparent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("systemd "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("host "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("NA"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h4",{attrs:{id:"falco告警规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#falco告警规则"}},[t._v("#")]),t._v(" falco告警规则")]),t._v(" "),s("p",[t._v("告警规则示例（falco_rules.local.yaml）：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim falco_rules.local.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' The program "sudo" is run in a container\n  '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("desc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" An event will trigger every time you run sudo in a container\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("condition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" evt.type = execve and evt.dir=< and container.id "),s("span",{pre:!0,attrs:{class:"token tag"}},[t._v("!=")]),t._v(" host and proc.name = sudo\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Sudo run in container (user=%user.name %container.info parent=%proc.pname cmdline=%proc.cmdline)"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("priority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ERROR\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("users"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h4",{attrs:{id:"参数说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数说明"}},[t._v("#")]),t._v(" 参数说明")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("rule")]),t._v("：规则名称，唯一")]),t._v(" "),s("li",[s("code",[t._v("desc")]),t._v("：规则的描述")]),t._v(" "),s("li",[s("code",[t._v("condition")]),t._v("： 条件表达式")]),t._v(" "),s("li",[s("code",[t._v("output")]),t._v("：符合条件事件的输出格式")]),t._v(" "),s("li",[s("code",[t._v("priority")]),t._v("：告警的优先级")]),t._v(" "),s("li",[s("code",[t._v("tags")]),t._v("：本条规则的 tags 分类")])]),t._v(" "),s("h4",{attrs:{id:"威胁场景测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#威胁场景测试"}},[t._v("#")]),t._v(" "),s("strong",[t._v("威胁场景测试")])]),t._v(" "),s("p",[t._v("1、监控系统二进制文件目录读写（默认规则）")]),t._v(" "),s("p",[t._v("2、监控根目录或者/root目录写入文件（默认规则）")]),t._v(" "),s("p",[t._v("3、监控运行交互式Shell的容器（默认规则）")]),t._v(" "),s("p",[t._v("4、监控容器创建的不可信任进程（自定义规则）")]),t._v(" "),s("p",[t._v("验证：tail -f /var/log/messages（告警通知默认输出到标准输出和系统日志）")]),t._v(" "),s("p",[s("strong",[t._v("监控容器创建的不可信任进程规则")])]),t._v(" "),s("p",[t._v("在falco_rules.local.yaml文件添加：")]),t._v(" "),s("p",[t._v("condition表达式解读：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("spawned_process")]),t._v(" 运行新进程")]),t._v(" "),s("li",[s("code",[t._v("container")]),t._v(" 容器")]),t._v(" "),s("li",[s("code",[t._v("container.image startswith nginx")]),t._v(" 以nginx开头的容器镜像")]),t._v(" "),s("li",[s("code",[t._v("not proc.name in (nginx)")]),t._v(" 不属于nginx的进程名称（允许进程名称列表）")])]),t._v(" "),s("blockquote",[s("p",[t._v("重启falco应用新配置文件：")]),t._v(" "),s("p",[s("code",[t._v("systemctl restart falco")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim falco_rules.local.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Unauthorized process on nginx containers\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("condition")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" spawned_process and container and container.image startswith nginx and not proc.name in (nginx)\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("desc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Unauthorized process on nginx containers (user=%user.name container_name=%container.name container_id=%container.id image=%container.image.repository shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline terminal=%proc.tty)"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("priority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" WARNING\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart falco")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# journalctl -u falco -f  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" Logs begin at Thu 2022"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("04"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("14 14"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("39"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("00 UTC. "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 systemd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Stopped Falco")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container Native Runtime Security.\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 systemd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Starting Falco")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container Native Runtime Security"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 systemd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Started Falco")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container Native Runtime Security.\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Falco version 0.31.1 (driver version b7eb0dd65226a8dc254d228c8d950d07bf3521d2)\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Falco initialized with configuration file /etc/falco/falco.yaml\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Loading rules from file /etc/falco/falco_rules.yaml")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("05 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Loading rules from file /etc/falco/falco_rules.local.yaml")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("06 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Loading rules from file /etc/falco/k8s_audit_rules.yaml")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("07 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Starting internal webserver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" listening on port 8765\nApr 15 02"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("38"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("07 master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("116163")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("02:38:07.523070816")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Informational Privileged container started (user=<NA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" user_loginuid=0 command=container"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("8ab8ea9eb331 kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("proxy (id=8ab8ea9eb331) image=registry.aliyuncs.com/google_containers/kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("proxy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.22.1)\n")])])]),s("p",[t._v("创建container容器之后触发falco")]),t._v(" "),s("ol",[s("li",[t._v("第一次创建"),s("code",[t._v("nginx")]),t._v("的"),s("code",[t._v("container")]),t._v("的时候输入创建")]),t._v(" "),s("li",[t._v("第二次使用tail查看日志，触发"),s("code",[t._v("faclo")]),t._v("有输出"),s("code",[t._v("shell=tail")]),t._v("字段")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d nginx ")]),t._v("\n801e315438d5e62c0d02eff444df9b17a9e7d635061e85037df56be9eaa02c4d\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tail -f /var/log/messages")]),t._v("\nApr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" 02:39:34 master01 falco: 02:39:34.313610957: Warning Unauthorized process on nginx containers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cool_heisenberg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("801e315438d5 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("md5sum "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("parent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-listen-on-ip "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("cmdline")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("md5sum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" - "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("terminal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nApr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" 02:39:34 master01 falco: 02:39:34.319772871: Warning Unauthorized process on nginx containers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cool_heisenberg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("801e315438d5 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("sed "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("parent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v("-listen-on-ip "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("cmdline")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("sed "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-E")]),t._v(" s,listen       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(",listen       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("n    listen  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("::"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(":80"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(", /etc/nginx/conf.d/default.conf "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("terminal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker exec -it 801e315438d5 tail /var/log/nginx/access.log ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tail -f /var/log/messages")]),t._v("\nApr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" 02:43:33 master01 falco: 02:43:33.449344235: Warning Unauthorized process on nginx containers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("root "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("cool_heisenberg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("container_id")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("801e315438d5 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("shell")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tail "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("parent")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("runc "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("cmdline")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("tail /var/log/nginx/access.log "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("terminal")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("34816")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h4",{attrs:{id:"falco输出方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#falco输出方式"}},[t._v("#")]),t._v(" Falco输出方式")]),t._v(" "),s("p",[s("strong",[t._v("Falco支持五种输出告警通知的方式：")])]),t._v(" "),s("ol",[s("li",[t._v("输出到标准输出（默认启用）")]),t._v(" "),s("li",[t._v("输出到文件")]),t._v(" "),s("li",[t._v("输出到Syslog（默认启用）")]),t._v(" "),s("li",[t._v("输出到HTTP服务")]),t._v(" "),s("li",[t._v("输出到其他程序（命令行管道方式）")])]),t._v(" "),s("p",[t._v("告警配置文件："),s("code",[t._v("/etc/falco/falco.yaml")])]),t._v(" "),s("p",[t._v("例如输出到指定文件，使用json格式：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim falco.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("json_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n···\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("syslog_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n···\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("file_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("keep_alive")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("filename")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/log/falco_events.log\n···\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stdout_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n  \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart falco ")]),t._v("\n")])])]),s("h4",{attrs:{id:"falco告警集中化展示"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#falco告警集中化展示"}},[t._v("#")]),t._v(" Falco告警集中化展示")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151059354.png",alt:"image-20220415010916499"}})]),t._v(" "),s("p",[t._v("• FalcoSideKick：一个集中收集并指定输出，支持大量方式输出，例如Influxdb、Elasticsearch等")]),t._v(" "),s("p",[t._v("项目地址 https://github.com/falcosecurity/falcosidekick")]),t._v(" "),s("p",[t._v("• FalcoSideKick-UI：告警通知集中图形展示系统")]),t._v(" "),s("p",[t._v("项目地址 https://github.com/falcosecurity/falcosidekick-ui")]),t._v(" "),s("h4",{attrs:{id:"部署falco-ui"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署falco-ui"}},[t._v("#")]),t._v(" 部署Falco UI")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2801")]),t._v(":2801 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" falcosidekick "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("WEBUI_URL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("http://10.11.121.118:2802 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nfalcosecurity/falcosidekick\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2802")]),t._v(":2802 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" falcosidekick-ui "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\nfalcosecurity/falcosidekick-ui \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker ps ")]),t._v("\nCONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS                                       NAMES\n9663f92ade3a   falcosecurity/falcosidekick-ui   "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./falcosidekick-ui"')]),t._v("     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" minutes ago    Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" minutes    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:2802-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2802")]),t._v("/tcp, :::2802-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2802")]),t._v("/tcp   falcosidekick-ui\n80c5d162842f   falcosecurity/falcosidekick      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./falcosidekick"')]),t._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" minutes ago    Up "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" minutes    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:2801-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2801")]),t._v("/tcp, :::2801-"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2801")]),t._v("/tcp   falcosidekick\n")])])]),s("p",[t._v("修改falco配置文件指定http方式输出：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim falco.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("json_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("json_include_output_property")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http_output")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("url")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://10.11.121.118:2801/"')]),t._v("\n  \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 falco"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart falco")]),t._v("\n")])])]),s("p",[t._v("UI访问地址：http://10.11.121.118:2802/ui/")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151058161.png",alt:"image-20220415105834715"}})]),t._v(" "),s("h3",{attrs:{id:"kubernetes-审计日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-审计日志"}},[t._v("#")]),t._v(" Kubernetes 审计日志")]),t._v(" "),s("h4",{attrs:{id:"什么是审计日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是审计日志"}},[t._v("#")]),t._v(" 什么是审计日志？")]),t._v(" "),s("p",[t._v("在Kubernetes集群中，API Server的审计日志记录了哪些用户、哪些服务请求操作集群资源，并且可以编写不同规则， 控制忽略、存储的操作日志。 审计日志采用JSON格式输出，每条日志都包含丰富的元数据，例如请求的URL、HTTP方法、客户端来源等，你可以使 用监控服务来分析API流量，以检测趋势或可能存在的安全隐患。")]),t._v(" "),s("p",[t._v("这些可能服务会访问API Server：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("管理节点")]),t._v("（controller-manager、scheduler）")]),t._v(" "),s("li",[s("strong",[t._v("工作节点")]),t._v("（kubelet、kube-proxy）")]),t._v(" "),s("li",[s("strong",[t._v("集群服务")]),t._v("（CoreDNS、Calico、HPA等）")]),t._v(" "),s("li",[t._v("kubectl、API、Dashboard")])]),t._v(" "),s("h4",{attrs:{id:"事件阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#事件阶段"}},[t._v("#")]),t._v(" 事件阶段")]),t._v(" "),s("p",[t._v("当客户端向 API Server发出请求时，该请求将经历一个或多个阶段：")]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151058322.png",alt:"image-20220414232402761"}}),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("阶段")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("RequestReceived")]),t._v(" "),s("td",[t._v("审核处理程序已收到请求")])]),t._v(" "),s("tr",[s("td",[t._v("ResponseStarted")]),t._v(" "),s("td",[t._v("已发送响应标头，但尚未发送响应正文")])]),t._v(" "),s("tr",[s("td",[t._v("ResponseComplete")]),t._v(" "),s("td",[t._v("响应正文已完成，不再发送任何字节")])]),t._v(" "),s("tr",[s("td",[t._v("Panic")]),t._v(" "),s("td",[t._v("内部服务器出错，请求未完成")])])])]),t._v(" "),s("h4",{attrs:{id:"审计日志策略规则"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#审计日志策略规则"}},[t._v("#")]),t._v(" 审计日志策略规则")]),t._v(" "),s("p",[t._v("Kubernetes审核策略文件包含一系列规则，描述了记录日志的级别， 采集哪些日志，不采集哪些日志。 规则级别如下表所示：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("级别")]),t._v(" "),s("th",[t._v("说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("None")]),t._v(" "),s("td",[t._v("不为事件创建日志条目")])]),t._v(" "),s("tr",[s("td",[t._v("Metadata")]),t._v(" "),s("td",[t._v("创建日志条目。包括元数据，但不包括请求正文或响应正文")])]),t._v(" "),s("tr",[s("td",[t._v("Request")]),t._v(" "),s("td",[t._v("创建日志条目。包括元数据和请求正文，但不包括响应正文")])]),t._v(" "),s("tr",[s("td",[t._v("RequestResponse")]),t._v(" "),s("td",[t._v("创建日志条目。包括元数据、请求正文和响应正文")])])])]),t._v(" "),s("p",[t._v("参考资料：https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/")]),t._v(" "),s("h4",{attrs:{id:"日志格式示例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日志格式示例"}},[t._v("#")]),t._v(" 日志格式示例")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151058490.png",alt:"image-20220414232719211"}})]),t._v(" "),s("h4",{attrs:{id:"配置审计日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置审计日志"}},[t._v("#")]),t._v(" 配置审计日志")]),t._v(" "),s("p",[t._v("审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。")]),t._v(" "),s("p",[s("strong",[t._v("配置流程：")])]),t._v(" "),s("ol",[s("li",[t._v("准备配置文件（审计规则）")]),t._v(" "),s("li",[t._v("启用准入控制器")]),t._v(" "),s("li",[t._v("查看日志情况")])]),t._v(" "),s("p",[s("strong",[t._v("启用审计日志功能：")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151058955.png",alt:"image-20220415000552047"}})]),t._v(" "),s("blockquote",[s("p",[t._v("注：需要使用hostpath数据卷将宿主 机策略文件和日志文件挂载到容器中")])]),t._v(" "),s("h5",{attrs:{id:"_1-准备配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-准备配置文件"}},[t._v("#")]),t._v(" 1.准备配置文件")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("/etc/kubernetes/")]),t._v("下创建"),s("code",[t._v("audit")]),t._v("目录")]),t._v(" "),s("p",[t._v("配置文件为"),s("code",[t._v("audit-policy.yaml")]),t._v("，准入控制器需要挂载该目录的文件。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir /etc/kubernetes/audit && cd /etc/kubernetes/audit")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat audit-policy.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit.k8s.io/v1 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This is required.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Policy\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("omitStages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RequestReceived"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RequestResponse\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods/log"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods/status"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configmaps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resourceNames")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"controller-leader"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("users")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:kube-proxy"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"watch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# core API group")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"endpoints"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"services"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("userGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:authenticated"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nonResourceURLs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/api*"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Wildcard matching.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/version"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Request\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# core API group")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configmaps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-system"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# core API group")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secrets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configmaps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Request\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# core API group")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"extensions"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("omitStages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RequestReceived"')]),t._v("\n")])])]),s("h5",{attrs:{id:"_2-启用准入控制器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-启用准入控制器"}},[t._v("#")]),t._v(" 2.启用准入控制器")]),t._v(" "),s("p",[t._v("审计日志支持写入本地文件和Webhook（发送到外部HTTP API）两种方式。")]),t._v(" "),s("p",[t._v("启用审计日志功能：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/kubernetes/manifests/kube-apiserver.yaml")]),t._v("\n…\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("policy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("file=/etc/kubernetes/audit/audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("policy.yaml\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("path=/var/log/k8s_audit.log\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("maxage=30\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("maxbackup=10\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("maxsize=100\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumeMounts")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/audit/audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("policy.yaml\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/log/k8s_audit.log\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/audit/audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("policy.yaml\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" File\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("log\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/log/k8s_audit.log\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" FileOrCreate\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart kubelet ")]),t._v("\n")])])]),s("h5",{attrs:{id:"_3-查看日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-查看日志"}},[t._v("#")]),t._v(" 3.查看日志")]),t._v(" "),s("p",[t._v("测试查看当前的资源操作日志：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  /var/log/k8s_audit.log")]),t._v("\n···\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Event"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"audit.k8s.io/v1"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Metadata"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"auditID"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a2fb8bdd-1289-4045-b0f4-ccbafe4416c8"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ResponseComplete"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestURI"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/apis/discovery.k8s.io/v1/namespaces/default/endpointslices/kubernetes"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verb"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:apiserver"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uid"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bb28e427-363f-4841-9925-7ae0f7af6c1d"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"groups"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:masters"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sourceIPs"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"::1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userAgent"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-apiserver/v1.22.1 (linux/amd64) kubernetes/632ed30"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"objectRef"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resource"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"endpointslices"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespace"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiGroup"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"discovery.k8s.io"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"responseStatus"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metadata"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),t._v(":200"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestReceivedTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:13:56.054960Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stageTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:13:56.056415Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"annotations"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/decision"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"allow"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/reason"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Event"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"audit.k8s.io/v1"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Metadata"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"auditID"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"51e01b26-c275-4953-9472-efec1f8b0ca2"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ResponseComplete"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestURI"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/apis/coordination.k8s.io/v1/namespaces/kube-node-lease/leases/master02?timeout=10s"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verb"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"update"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:node:master02"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"groups"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:nodes"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:authenticated"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sourceIPs"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.11.121.116"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userAgent"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubelet/v1.22.1 (linux/amd64) kubernetes/632ed30"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"objectRef"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resource"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"leases"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespace"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kube-node-lease"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"master02"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uid"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"b2b0fc89-4220-48ee-86c9-b08e8c283f94"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiGroup"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"coordination.k8s.io"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resourceVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"921237"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"responseStatus"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metadata"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),t._v(":200"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestReceivedTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:13:56.316392Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stageTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:13:56.324183Z"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"annotations"')]),t._v(":"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/decision"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"allow"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/reason"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h5",{attrs:{id:"_4-只记录指定资源操作日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-只记录指定资源操作日志"}},[t._v("#")]),t._v(" 4.只记录指定资源操作日志")]),t._v(" "),s("p",[t._v("创建日志条目,包括元数据，但不包括请求正文或响应正文支持资源如下：")]),t._v(" "),s("ul",[s("li",[t._v("pods")]),t._v(" "),s("li",[t._v("deployments")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  /etc/kubernetes/audit/audit-policy.yaml  ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit.k8s.io/v1 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This is required.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Policy\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("omitStages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RequestReceived"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("users")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("apiserver \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("controller"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("manager\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("scheduler\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("proxy\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" kubelet \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apps"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"deployments"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" None \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ps -ef | grep kubelet ")]),t._v("\nroot      72326  72272 10 16"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("04 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("?")]),t._v("        00"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("04"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("02 kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("apiserver "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("advertise"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("address=10.11.121.118 \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kill -9 72326 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart kubelet ")]),t._v("\n")])])]),s("p",[t._v("创建一个Pod查看当前的日志情况、使用jq转换为json查看：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl run  web-test-my-pod --image=nginx --image-pull-policy=IfNotPresent ")]),t._v("\npod/web created\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /var/log/k8s_audit.log  | grep web-test-my-pod ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# echo \'{"kind":"Event","apiVersion":"audit.k8s.io/v1","level":"Metadata","auditID":"53298e83-3e00-471a-80b0-e7f9fa721be9","stage":"ResponseComplete","requestURI":"/api/v1/namespaces/default/pods?fieldManager=kubectl-run","verb":"create","user":{"username":"kubernetes-admin","groups":["system:masters","system:authenticated"]},"sourceIPs":["10.11.121.118"],"userAgent":"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78","objectRef":{"resource":"pods","namespace":"default","name":"web-test-my-pod","apiVersion":"v1"},"responseStatus":{"metadata":{},"code":201},"requestReceivedTimestamp":"2022-04-14T16:51:26.948369Z","stageTimestamp":"2022-04-14T16:51:26.959232Z","annotations":{"authorization.k8s.io/decision":"allow","authorization.k8s.io/reason":"","imagepolicywebhook.image-policy.k8s.io/failed-open":"true"}}\' | jq .')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kind"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Event"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"audit.k8s.io/v1"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"level"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Metadata"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"auditID"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"53298e83-3e00-471a-80b0-e7f9fa721be9"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ResponseComplete"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestURI"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/api/v1/namespaces/default/pods?fieldManager=kubectl-run"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"verb"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"create"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes-admin"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"groups"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:masters"')]),t._v(",\n      "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:authenticated"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sourceIPs"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.11.121.118"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userAgent"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubectl/v1.23.5 (linux/amd64) kubernetes/c285e78"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"objectRef"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resource"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespace"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"web-test-my-pod"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apiVersion"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"v1"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"responseStatus"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"metadata"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"code"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("201")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"requestReceivedTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:51:26.948369Z"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stageTimestamp"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-14T16:51:26.959232Z"')]),t._v(",\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"annotations"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/decision"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"allow"')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization.k8s.io/reason"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(",\n    "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"imagepolicywebhook.image-policy.k8s.io/failed-open"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h5",{attrs:{id:"_5-审计日志练习"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-审计日志练习"}},[t._v("#")]),t._v(" 5.审计日志练习")]),t._v(" "),s("p",[t._v("编辑和扩展基本策略到日志：")]),t._v(" "),s("ol",[s("li",[t._v("命名空间在 RequestResponse 级别更改")]),t._v(" "),s("li",[t._v("PV 的请求内容在 front-apps 命名空间发生了更改")]),t._v(" "),s("li",[t._v("Configmap 和 secret 在所有命名空间 Metadata 级别更改")]),t._v(" "),s("li",[t._v("另外，添加一个catch-all来记录在Metadata 级别的所有请求。")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /etc/kubernetes/audit/audit-policy.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" audit.k8s.io/v1 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# This is required.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Policy\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("omitStages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RequestReceived"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RequestResponse   \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" \n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"namespaces"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Request\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"persistentvolumes"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("    \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespaces")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"front-apps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("group")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"secrets"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"configmaps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("level")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Metadata\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("omitStages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"RequestReceived"')]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);