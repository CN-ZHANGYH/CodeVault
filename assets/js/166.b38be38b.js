(window.webpackJsonp=window.webpackJsonp||[]).push([[166],{480:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"供应链安全"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#供应链安全"}},[s._v("#")]),s._v(" 供应链安全")]),s._v(" "),t("h3",{attrs:{id:"主要内容"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[s._v("#")]),s._v(" 主要内容")]),s._v(" "),t("p",[s._v("❖ 可信任软件供应链概述")]),s._v(" "),t("p",[s._v("❖ 构建镜像Dockerfile文件优化")]),s._v(" "),t("p",[s._v("❖ 镜像漏洞扫描工具：Trivy")]),s._v(" "),t("p",[s._v("❖ 检查YAML文件安全配置：kubesec")]),s._v(" "),t("p",[s._v("❖ 准入控制器： Admission Webhook")]),s._v(" "),t("p",[s._v("❖ 准入控制器： ImagePolicyWebhook")]),s._v(" "),t("h3",{attrs:{id:"可信任软件供应链概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#可信任软件供应链概述"}},[s._v("#")]),s._v(" 可信任软件供应链概述")]),s._v(" "),t("p",[s._v("可信任软件供应链：指在建设基础架构过程中，涉及的软件都是可信任的。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204151356279.png",alt:"image-20220414122733589"}})]),s._v(" "),t("h3",{attrs:{id:"构建镜像dockerfile文件优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建镜像dockerfile文件优化"}},[s._v("#")]),s._v(" 构建镜像Dockerfile文件优化")]),s._v(" "),t("ul",[t("li",[s._v("**减少镜像层：**一次RUN指令形成新的一层，尽量Shell命令都写在一行，减少镜像层。")]),s._v(" "),t("li",[s._v("**清理无用文件：**清理对应的残留数据，例如yum缓存。")]),s._v(" "),t("li",[s._v("**清理无用的软件包：**基础镜像默认会带一些debug工具，可以删除掉，仅保留应用程序所需软件，防止黑客利用。")]),s._v(" "),t("li",[s._v("**选择最小的基础镜像：**例如alpine")]),s._v(" "),t("li",[s._v("**使用非root用户运行：**USER指令指定普通用户")])]),s._v(" "),t("p",[s._v("示例：构建python web镜像")]),s._v(" "),t("p",[s._v("参数化构建如下：")]),s._v(" "),t("ol",[t("li",[s._v("使用了非root用户运行镜像")]),s._v(" "),t("li",[s._v("使用了一个镜像层，并非多层")])]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" useradd python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir /data/www -p")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . /data/www")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" chown -R python /data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" pip install flask -i https://mirrors.aliyun.com/pypi/simple/ && yum makecache ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /data/www")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" python main.py ")]),s._v("\n")])])]),t("h3",{attrs:{id:"镜像漏洞扫描工具-trivy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#镜像漏洞扫描工具-trivy"}},[s._v("#")]),s._v(" 镜像漏洞扫描工具：Trivy")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141243326.png",alt:"image-20220414124314141"}})]),s._v(" "),t("p",[s._v("Trivy：是一种用于容器镜像、文件系统、Git仓库的漏洞扫描工具。发现目标软件存在的漏洞。 Trivy易于使用，只需安装二进制文件即可进行扫描，方便集成CI系统。")]),s._v(" "),t("p",[s._v("项目地址：https://github.com/aquasecurity/trivy")]),s._v(" "),t("h4",{attrs:{id:"安装trivy"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装trivy"}},[s._v("#")]),s._v(" 安装Trivy")]),s._v(" "),t("p",[s._v("在官网下载二进制的文件，移到"),t("code",[s._v("/usr/local/bin/")]),s._v("下")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv trivy /usr/local/bin ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# trivy --version ")]),s._v("\nVersion: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.18")]),s._v(".3\nVulnerability DB:\n  Type: Light\n  Version: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  UpdatedAt: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14 00:51:13.721973471 +0000 UTC\n  NextUpdate: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14 06:51:13.721972971 +0000 UTC\n  DownloadedAt: 0001-01-01 00:00:00 +0000 UTC\n")])])]),t("h4",{attrs:{id:"下载数据库超时解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载数据库超时解决"}},[s._v("#")]),s._v(" 下载数据库超时解决")]),s._v(" "),t("p",[s._v("安全扫描通常都需要下载安全漏洞的下载数据库比较完整的版本。数据库速度很慢而且从github下载。所以需要离线。")]),s._v(" "),t("p",[s._v("GitHub项目地址： https://github.com/aquasecurity/trivy-db/releases")]),s._v(" "),t("p",[s._v("下载 trivy-offline.db.tgz 放在trivy cache目录。默认的cache目录的位置上")]),s._v(" "),t("p",[s._v("目录： "),t("code",[s._v("/home/.cache/trivy/db")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp  trivy-offline.db.tgz .cache/trivy/db/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd .cache/trivy/db/ ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/.cache/trivy/db"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf trivy-offline.db.tgz && rm -rf trivy-offline.db.tgz")]),s._v("\n")])])]),t("h4",{attrs:{id:"trivy使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#trivy使用"}},[s._v("#")]),s._v(" Trivy使用")]),s._v(" "),t("p",[t("strong",[s._v("1.容器镜像扫描")])]),s._v(" "),t("p",[s._v("也可以指定tar使用"),t("code",[s._v("trivy image -i nginx.tar")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# trivy image nginx")]),s._v("\n\n+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" zlib1g              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CVE-2018-25032   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" HIGH     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":1.2.11.dfsg-2    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":1.2.11.dfsg-2+deb11u1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" zlib: A flaw found "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" zlib v1.2.2.2 through zlib              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" v1.2.11 when compressing"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("avd.aquasec.com/nvd/cve-2018-25032   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+\n")])])]),t("p",[t("strong",[s._v("2. 打印指定（高危、严重）漏洞信息")])]),s._v(" "),t("p",[s._v("可以通过-s 参数指定是高危漏洞还是严重漏洞")]),s._v(" "),t("p",[t("code",[s._v("HIGH")]),s._v("   是高危漏洞")]),s._v(" "),t("p",[t("code",[s._v("CRITICAL")]),s._v("  是严重漏洞")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# trivy image -s HIGH,CRITICAL nginx ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14T13:38:38.566+0800    INFO    Detected OS: debian\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14T13:38:38.567+0800    INFO    Detecting Debian vulnerabilities"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14T13:38:38.579+0800    INFO    Number of PL dependency files: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-04-14T13:38:38.579+0800    INFO    Detecting jar vulnerabilities"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nnginx "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("debian "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\nTotal: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("76")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HIGH: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),s._v(", CRITICAL: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       LIBRARY       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" VULNERABILITY ID "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" SEVERITY "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" INSTALLED VERSION  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("      FIXED VERSION      "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  TITLE                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CVE-2021-22945   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CRITICAL "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.74")]),s._v(".0-1.3+deb11u1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" curl: use-after-free and                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" double-free "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" MQTT sending             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("avd.aquasec.com/nvd/cve-2021-22945   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+                     +------------------+----------+                    +-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CVE-2021-22946   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" HIGH     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" curl: Requirement to use                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" TLS not properly enforced               "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" IMAP, POP3, and"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("avd.aquasec.com/nvd/cve-2021-22946   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+---------------------+------------------+          +--------------------+-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" e2fsprogs           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CVE-2022-1304    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.46")]),s._v(".2-2           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" e2fsprogs: out-of-bounds                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" read/write via crafted filesystem       "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("avd.aquasec.com/nvd/cve-2022-1304    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+---------------------+------------------+          +--------------------+-------------------------+-----------------------------------------+\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("gzip")]),s._v("                "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" CVE-2022-1271    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.10")]),s._v("-4             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" gzip: arbitrary-file-write              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" vulnerability                           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("                         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" --"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("avd.aquasec.com/nvd/cve-2022-1271    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n+---------------------+------------------+----------+--------------------+-------------------------+-----------------------------------------+\n")])])]),t("h3",{attrs:{id:"检查yaml文件安全配置-kubesec"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查yaml文件安全配置-kubesec"}},[s._v("#")]),s._v(" 检查YAML文件安全配置：kubesec")]),s._v(" "),t("h4",{attrs:{id:"kubesec简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubesec简介"}},[s._v("#")]),s._v(" kubesec简介")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141343065.png",alt:"image-20220414134332943"}})]),s._v(" "),t("p",[s._v("kubesec：是一个针对K8s资源清单文件进行安全配置评估的工具，根据安全配置 最佳实践来验证并给出建议。")]),s._v(" "),t("p",[s._v("官网：https://kubesec.io")]),s._v(" "),t("p",[s._v("项目地址：https://github.com/controlplaneio/kubesec")]),s._v(" "),t("h4",{attrs:{id:"kubesec安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubesec安装"}},[s._v("#")]),s._v(" kubesec安装")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar zxvf kubesec_linux_amd64.tar.gz ")]),s._v("\nCHANGELOG.md\nLICENSE\nREADME.md\nkubesec\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv kubesec /usr/local/bin/")]),s._v("\n")])])]),t("h4",{attrs:{id:"kubesec使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubesec使用"}},[s._v("#")]),s._v(" kubesec使用")]),s._v(" "),t("p",[s._v("示例：")]),s._v(" "),t("ol",[t("li",[s._v("会有提示告诉你是否使用资源限制")]),s._v(" "),t("li",[s._v("可以根据建议添加要求去加固Pod的安全范围")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubesec scan deployment.yaml \n···\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestsMemory"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"selector"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers[] .resources .limits .memory"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"reason"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enforcing memory limits prevents DOS via resource exhaustion"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"points"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"RequestsCPU"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"selector"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers[] .resources .requests .cpu"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"reason"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enforcing CPU requests aids a fair balancing of resources across the cluster"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"points"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n")])])]),t("p",[s._v("或者使用容器环境执行检查")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" kubesec/kubesec scan /dev/stdin "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" deployment.yaml\n")])])]),t("p",[s._v("kubesec内置一个HTTP服务器，可以直接启用，远程调用。")]),s._v(" "),t("p",[s._v("二进制")]),s._v(" "),t("p",[t("strong",[s._v("kubesec http 8080 &")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141356188.png",alt:"image-20220414135608347"}})]),s._v(" "),t("p",[s._v("Docker容器")]),s._v(" "),t("p",[t("strong",[s._v("docker run -d -p 8080:8080 kubesec/kubesec http 8080")])]),s._v(" "),t("blockquote",[t("p",[s._v("示例：")]),s._v(" "),t("p",[s._v("curl -sSX POST --data-binary @deployment.yaml http://192.168.31.71:8080/scan")])]),s._v(" "),t("h3",{attrs:{id:"admission-webhook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#admission-webhook"}},[s._v("#")]),s._v(" Admission Webhook")]),s._v(" "),t("p",[t("strong",[s._v("Admission Webhook：准入控制器Webhook是准入控制插件的一种")]),s._v("，用于拦截所有向APISERVER发送的 请求，并且可以修改请求或拒绝请求。")]),s._v(" "),t("p",[s._v("Admission webhook为开发者提供了非常灵活的插件模式，在kubernetes资源持久化之前，管理员通过程序 可以对指定资源做校验、修改等操作。例如为资源自动打标签、pod设置默认SA，自动注入sidecar容器等。")]),s._v(" "),t("p",[s._v("相关Webhook准入控制器：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("MutatingAdmissionWebhook：")]),s._v("修改资源，理论上可以监听并修改任何经过ApiServer处理的请求")]),s._v(" "),t("li",[t("code",[s._v("ValidatingAdmissionWebhook：")]),s._v("验证资源")]),s._v(" "),t("li",[t("code",[s._v("ImagePolicyWebhook：")]),s._v("镜像策略，主要验证镜像字段是否满足条件")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141359941.png",alt:"image-20220414135937964"}})]),s._v(" "),t("h3",{attrs:{id:"imagepolicywebhook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#imagepolicywebhook"}},[s._v("#")]),s._v(" ImagePolicyWebhook")]),s._v(" "),t("h4",{attrs:{id:"镜像策略的工作流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#镜像策略的工作流程"}},[s._v("#")]),s._v(" 镜像策略的工作流程")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141400570.png",alt:"image-20220414140015972"}})]),s._v(" "),t("h4",{attrs:{id:"启用准入控制器插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启用准入控制器插件"}},[s._v("#")]),s._v(" 启用准入控制器插件")]),s._v(" "),t("ol",[t("li",[s._v("提供HTTPS证书")]),s._v(" "),t("li",[s._v("添加配置文件")]),s._v(" "),t("li",[s._v("需要启用准入控制器开启ImagePolicyWebhook插件")])]),s._v(" "),t("h5",{attrs:{id:"_1-生成https证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-生成https证书"}},[s._v("#")]),s._v(" 1.生成HTTPS证书")]),s._v(" "),t("ul",[t("li",[s._v("需要使用"),t("code",[s._v("cfssl")]),s._v("工具、生成"),t("code",[s._v("https")]),s._v("证书")]),s._v(" "),t("li",[s._v("需要"),t("code",[s._v("admission_configuration")]),s._v("和"),t("code",[s._v("connect_webhook")]),s._v("的配置文件")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18820")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("508")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":53 admission_configuration.yaml\n-rwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10376657")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" cfssl\n-rwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6595195")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" cfssl-certinfo\n-rwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2277873")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" cfssljson\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("632")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":46 connect_webhook.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1367")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" image-policy-certs.sh\ndrwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" image-policy-webhook\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim image-policy-certs.sh")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" webhook-csr.json "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v("EOF\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CN"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"webhook"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hosts"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.11.121.111"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改一下IP，我这里是master")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"key"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"algo"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"rsa"')]),s._v(",\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"size"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2048")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"names"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"C"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CN"')]),s._v(",\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"L"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BeiJing"')]),s._v(",\n      "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ST"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"BeiJing"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("通过cfssl工具生成https认证")]),s._v(" "),t("ul",[t("li",[s._v("生成的key和pem文件需要复制到imagepolicywebhook需要的目录")]),s._v(" "),t("li",[s._v("还需要将两个连接webhook配置文件复制到指定目录")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv cfssl* /usr/local/bin/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chmod +x image-policy-certs.sh ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./image-policy-certs.sh ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("508")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":53 admission_configuration.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("956")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 apiserver-client.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("182")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 apiserver-client-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1675")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 apiserver-client-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1306")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 apiserver-client.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("294")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 ca-config.json\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("960")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 ca.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("212")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 ca-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1675")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 ca-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1273")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 ca.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("632")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("月 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":46 connect_webhook.yaml\n-rwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1367")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" image-policy-certs.sh\ndrwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" image-policy-webhook\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1330")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook.pem\n")])])]),t("h5",{attrs:{id:"_2-添加配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-添加配置文件"}},[s._v("#")]),s._v(" 2.添加配置文件")]),s._v(" "),t("ul",[t("li",[s._v("查看"),t("code",[s._v("admission_configuration.yaml")])]),s._v(" "),t("li",[s._v("查看"),t("code",[s._v("connect_webhook.yaml")])]),s._v(" "),t("li",[t("code",[s._v("/etc/kubernetes/image-policy/")]),s._v("该目录是不存在的，所以需要创建，用作数据卷持久化")]),s._v(" "),t("li",[s._v("需要修改的是connect_webhook的server地址，该地址是镜像策略服务地址，这里我使用master01")]),s._v(" "),t("li",[t("code",[s._v("admission_configuration.yaml")]),s._v("和 "),t("code",[s._v("connect_webhook.yaml")]),s._v("需要存放到"),t("code",[s._v("/etc/kubernetes/image-policy/")]),s._v("目录")])]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat admission_configuration.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apiserver.config.k8s.io/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" AdmissionConfiguration\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("plugins")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ImagePolicyWebhook\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("configuration")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubeConfigFile")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy/connect_webhook.yaml  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接镜像策略服务器配置文件")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("allowTTL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 控制批准请求的缓存时间，单位秒")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("denyTTL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 控制批准请求的缓存时间，单位秒")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("retryBackoff")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 控制重试间隔，单位毫秒")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("defaultAllow")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 确定webhook后端失效的行为")]),s._v("\n      \n      \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat connect_webhook.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Config\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusters")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("certificate-authority")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy/webhook.pem "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数字证书，用于验证远程服务")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//10.11.121.111"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("8080/image_policy "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 镜像策略服务器地址，必须是https")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("contexts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apiserver\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("current-context")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" webhook \n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preferences")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("users")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apiserver\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("client-certificate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy/apiserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client.pem "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# webhook准入控制器使用的证书")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("client-key")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy/apiserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key.pem "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 对应私钥证书 ")]),s._v("\n")])])]),t("p",[s._v("新建/etc/kubernetes/image-policy的目录，复制文件到该目录下")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mkdir /etc/kubernetes/image-policy")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp admission_configuration.yaml connect_webhook.yaml /etc/kubernetes/image-policy/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp apiserver*  /etc/kubernetes/image-policy/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp webhook* /etc/kubernetes/image-policy/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp ca.pem  /etc/kubernetes/image-policy/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll /etc/kubernetes/image-policy/")]),s._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("508")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:38 admission_configuration.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("956")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 apiserver-client.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("182")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 apiserver-client-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1675")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 apiserver-client-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1306")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 apiserver-client.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1273")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 ca.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("632")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:38 connect_webhook.yaml\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 webhook.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 webhook-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 webhook-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1330")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:39 webhook.pem\n")])])]),t("h5",{attrs:{id:"_3-开启imagepolicywebhook插件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-开启imagepolicywebhook插件"}},[s._v("#")]),s._v(" 3.开启ImagePolicyWebhook插件")]),s._v(" "),t("p",[s._v("使用hostpath数据卷将宿主机"),t("code",[s._v("/etc/kubernetes/image-policy")]),s._v("目录挂载到容器中。")]),s._v(" "),t("p",[s._v("重启kubelet，等待一分钟重建kube-apiserver的Pod。")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/kube-apiserver.yaml ")]),s._v("\n \t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("enable"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admission"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plugins=NodeRestriction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ImagePolicyWebhook\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("admission"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("control"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy/admission_configuration.yaml\n···\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n···\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Directory\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("policy\n      \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("~/image"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# systemctl  restart  kubelet ")]),s._v("\n")])])]),t("h5",{attrs:{id:"_4-部署镜像服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-部署镜像服务器"}},[s._v("#")]),s._v(" 4.部署镜像服务器")]),s._v(" "),t("p",[s._v("在本机的master节点部署镜像服务器，来当server，要求如下：")]),s._v(" "),t("ol",[t("li",[s._v("使用Python编写一个连接"),t("code",[s._v("ImagePolicyWebhook的api")]),s._v("接口")]),s._v(" "),t("li",[s._v("编写一个"),t("code",[s._v("Dockerfile")]),s._v("运行这个"),t("code",[s._v("python")]),s._v("文件")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv webhook* image-policy-webhook/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook/image-policy-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v("\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("212")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" Dockerfile\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("982")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("月   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" main.py\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook.csr\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("204")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook-csr.json\n-rw------- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1679")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook-key.pem\n-rw-r--r-- "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1330")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("月  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 09:31 webhook.pem\n")])])]),t("p",[s._v("查看当前的Dockerfile文件")]),s._v(" "),t("div",{staticClass:"language-dockerfile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[t("code",[s._v("[root@master01:~/image-webhook/image-policy-webhook] # cat Dockerfile \n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" useradd python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" mkdir /data/www -p")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("COPY")]),s._v(" . /data/www")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" chown -R python /data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("RUN")]),s._v(" pip install flask -i https://mirrors.aliyun.com/pypi/simple/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WORKDIR")]),s._v(" /data/www")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("USER")]),s._v(" python")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token instruction"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CMD")]),s._v(" python main.py ")]),s._v("\n")])])]),t("p",[s._v("查看当前的Python脚本")]),s._v(" "),t("div",{staticClass:"language-python extra-class"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("~")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("image"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat main.py ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" flask "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Flask"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("request\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" json\n\napp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Flask"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__name__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("route")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/image_policy'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("methods"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("image_policy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    post_data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("decode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#print("POST数据: %s" %post_data)')]),s._v("\n    data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("loads"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("post_data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" c "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" data"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'spec'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'containers'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果镜像里不带冒号或者带:latest说明是镜像使用latest标签")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("or")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('":latest"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" c"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  \n            allowed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reason "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查镜像失败！镜像标签不允许使用latest!"')]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            allowed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" reason "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查镜像通过."')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"检查结果: %s"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v("reason"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    result "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" allowed"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"reason"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" reason"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" json"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("dumps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ensure_ascii"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" __name__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"__main__"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    app"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("run"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("host"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.0.0.0"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ssl_context"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/www/webhook.pem'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/data/www/webhook-key.pem'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("构建Dockerfile")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook/image-policy-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker build -t image-policy-webhook .")]),s._v("\nDigest: sha256:dbbfcbf95f6b596d2be1d8f3b368016619f78f829facf6f2e361bea1151794e5\nStatus: Downloaded newer image "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" python:latest\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" a5d7930b60cc\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("useradd")]),s._v(" python\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" fcd9fcc7e44f\nRemoving intermediate container fcd9fcc7e44f\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 10b842f26fed\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /data/www "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v("\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" cffd0d6f3bbd\nRemoving intermediate container cffd0d6f3bbd\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 4db5fe4dc849\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" COPY "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" /data/www\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" d27fa5502133\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" python /data\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 7559149b085b\nRemoving intermediate container 7559149b085b\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" a35d92963cfd\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" RUN pip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" flask "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" https://mirrors.aliyun.com/pypi/simple/\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 8aea1cb3d0fe\n Removing intermediate container 8aea1cb3d0fe\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" b81eed200f98\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WORKDIR /data/www\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" fb82b0cc633e\nRemoving intermediate container fb82b0cc633e\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 2e43f0dff4ad\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v(" python\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 5faeb5a8566e\nRemoving intermediate container 5faeb5a8566e\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 6797205b1622\nStep "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("/9 "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" CMD python main.py\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" Running "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" da4ae6eabc00\nRemoving intermediate container da4ae6eabc00\n ---"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" d49ca131fdb9\nSuccessfully built d49ca131fdb9\nSuccessfully tagged image-policy-webhook:latest\n")])])]),t("h5",{attrs:{id:"_5-部署镜像服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-部署镜像服务"}},[s._v("#")]),s._v(" 5.部署镜像服务")]),s._v(" "),t("p",[s._v("自己用python开发一个简单的webhook端点服务器，作用是拒绝部署的镜像乜有指定标签（即latest）。")]),s._v(" "),t("ol",[t("li",[s._v("自签"),t("code",[s._v("HTTPS")]),s._v("证书")]),s._v(" "),t("li",[t("code",[s._v("Docker")]),s._v("容器启动镜像策略服务")]),s._v(" "),t("li",[s._v("查看当前的Docker日志")])]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook/image-policy-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker run -d -u root --name=image-policy-webhook \\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/webhook.pem:/data/www/webhook.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PWD")]),s._v("/webhook-key.pem:/data/www/webhook-key.pem "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PYTHONUNBUFFERED")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":8080 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" image-policy-webhook\n73a9ae72a7bc8f379fe5414f575b779bf34c969089f6e544e1c7a81a60fc5b9d.\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01:~/image-webhook/image-policy-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker logs -f image-policy-webhook ")]),s._v("\n * Serving Flask app "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'main'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lazy loading"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n * Environment: production\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n   Use a production WSGI server instead.\n * Debug mode: off\n * Running on all addresses "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n * Running on https://127.0.0.1:8080\n * Running on https://172.17.0.2:8080 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Press CTRL+C to quit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])])]),t("p",[s._v("测试ImagePolicyWebhook")]),s._v(" "),t("p",[s._v("创建Deployment使用nginx镜像，使用nginx:1.16的版本，查看日志。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create deployment web1 --image=nginx:1.16 ")]),s._v("\ndeployment.apps/web1 created\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker logs  -f image-policy-webhook ")]),s._v("\n * Serving Flask app "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'main'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lazy loading"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n * Environment: production\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n   Use a production WSGI server instead.\n * Debug mode: off\n * Running on all addresses "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n * Running on https://127.0.0.1:8080\n * Running on https://172.17.0.2:8080 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Press CTRL+C to quit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nPOST数据: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creationTimestamp"')]),s._v(":null"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spec"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx:1.16"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),s._v(":false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n检查结果: 检查镜像通过.\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.11")]),s._v(".121.118 - - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("/Apr/2022 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":00:46"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST /image_policy?timeout=30s HTTP/1.1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -\nPOST数据: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creationTimestamp"')]),s._v(":null"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spec"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx:latest"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),s._v(":false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),t("p",[s._v("创建Deployment使用nginx镜像，使用nginx:latest的版本，查看日志。")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create deployment web2 --image=nginx:latest")]),s._v("\ndeployment.apps/web2 created\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master01 image-policy-webhook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker logs  -f image-policy-webhook ")]),s._v("\n * Serving Flask app "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'main'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("lazy loading"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n * Environment: production\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n   Use a production WSGI server instead.\n * Debug mode: off\n * Running on all addresses "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   WARNING: This is a development server. Do not use it "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" a production deployment.\n * Running on https://127.0.0.1:8080\n * Running on https://172.17.0.2:8080 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Press CTRL+C to quit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nPOST数据: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creationTimestamp"')]),s._v(":null"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spec"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx:1.16"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),s._v(":false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n检查结果: 检查镜像通过.\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.11")]),s._v(".121.118 - - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("/Apr/2022 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":00:46"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST /image_policy?timeout=30s HTTP/1.1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -\nPOST数据: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creationTimestamp"')]),s._v(":null"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spec"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx:latest"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),s._v(":false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n检查结果: 检查镜像失败！镜像标签不允许使用latest"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.11")]),s._v(".121.118 - - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("/Apr/2022 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":01:04"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST /image_policy?timeout=30s HTTP/1.1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -\nPOST数据: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ImageReview"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"imagepolicy.k8s.io/v1alpha1"')]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"creationTimestamp"')]),s._v(":null"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spec"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"containers"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"nginx:latest"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(","),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"status"')]),s._v(":"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"allowed"')]),s._v(":false"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n检查结果: 检查镜像失败！镜像标签不允许使用latest"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.11")]),s._v(".121.118 - - "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v("/Apr/2022 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(":02:26"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"POST /image_policy?timeout=30s HTTP/1.1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" -\n")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);