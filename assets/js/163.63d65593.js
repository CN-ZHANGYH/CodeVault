(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{478:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"集群强化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#集群强化"}},[t._v("#")]),t._v(" 集群强化")]),t._v(" "),s("h3",{attrs:{id:"主要内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[t._v("#")]),t._v(" 主要内容")]),t._v(" "),s("p",[t._v("❖ K8s安全框架")]),t._v(" "),s("p",[t._v("❖ RBAC认证授权案例")]),t._v(" "),s("p",[t._v("❖ 资源配额 ResourceQuota")]),t._v(" "),s("p",[t._v("❖ 资源限制 LimitRange")]),t._v(" "),s("h3",{attrs:{id:"kubernetes-安全框架"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-安全框架"}},[t._v("#")]),t._v(" Kubernetes 安全框架")]),t._v(" "),s("p",[t._v("K8S安全控制框架主要由下面3个阶段进行控制，每一个阶段都支持 插件方式，通过API Server配置来启用插件。")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("Authentication")]),t._v("（鉴权）")]),t._v(" "),s("li",[s("code",[t._v("Authorization")]),t._v("（授权）")]),t._v(" "),s("li",[s("code",[t._v("Admission Control")]),t._v("（准入控制）")])]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204120958219.png",alt:"image-20220412095759505"}}),t._v(" "),s("h4",{attrs:{id:"鉴权-authentication"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#鉴权-authentication"}},[t._v("#")]),t._v(" 鉴权（Authentication）")]),t._v(" "),s("p",[s("code",[t._v("K8s Apiserver提供三种客户端身份认证")]),t._v("：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("HTTPS 证书认证")]),t._v("：基于CA证书签名的数字证书认证（kubeconfig）")]),t._v(" "),s("li",[s("strong",[t._v("HTTP Token认证")]),t._v("：通过一个Token来识别用户（serviceaccount）")]),t._v(" "),s("li",[s("strong",[t._v("HTTP Base认证")]),t._v("：用户名+密码的方式认证（1.19版本弃用）")])]),t._v(" "),s("h4",{attrs:{id:"授权-authorization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#授权-authorization"}},[t._v("#")]),t._v(" 授权（Authorization）")]),t._v(" "),s("p",[s("code",[t._v("RBAC（Role-Based Access Control，基于角色的访问控制）")]),t._v("：负责完成授权（Authorization）工作。")]),t._v(" "),s("p",[t._v("RBAC根据API请求属性，决定允许还是拒绝。")]),t._v(" "),s("p",[t._v("比较常见的授权维度：")]),t._v(" "),s("ol",[s("li",[t._v("user：用户名")]),t._v(" "),s("li",[t._v("group：用户分组")]),t._v(" "),s("li",[t._v("资源，例如pod、deployment")]),t._v(" "),s("li",[t._v("资源操作方法：get，list，create，update，patch，watch，delete")]),t._v(" "),s("li",[t._v("命名空间")]),t._v(" "),s("li",[t._v("API组")])]),t._v(" "),s("h4",{attrs:{id:"准入控制-admission-control"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准入控制-admission-control"}},[t._v("#")]),t._v(" 准入控制（Admission Control）")]),t._v(" "),s("p",[t._v("Adminssion Control实际上是一个准入控制器插件列表，发送到API Server的请求都需要经过这个列表中的每个准入控制器 插件的检查，检查不通过，则拒绝请求。")]),t._v(" "),s("p",[s("strong",[t._v("启用一个准入控制器：")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kube-apiserver --enable-admission-plugins"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("NamespaceLifecycle,LimitRanger "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),s("p",[s("strong",[t._v("关闭一个准入控制器：")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kube-apiserver --disable-admission-plugins"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("PodNodeSelector,AlwaysDeny "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". \n")])])]),s("p",[s("strong",[t._v("查看默认启用：")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" kube-apiserver-k8s-master "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" kube-system -- kube-apiserver "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-h")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" enable-admission-plugins\n")])])]),s("h4",{attrs:{id:"基于角色的权限访问控制-rbac"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于角色的权限访问控制-rbac"}},[t._v("#")]),t._v(" 基于角色的权限访问控制：RBAC")]),t._v(" "),s("p",[s("code",[t._v("RBAC（Role-Based Access Control，基于角色的访问控制）")]),t._v("， 是K8s默认授权策略，并且是动态配置策略（修改即时生效）。")]),t._v(" "),s("p",[s("strong",[t._v("主体（subject）")])]),t._v(" "),s("ul",[s("li",[t._v("User：用户")]),t._v(" "),s("li",[t._v("Group：用户组")]),t._v(" "),s("li",[t._v("ServiceAccount：服务账号")])]),t._v(" "),s("p",[s("strong",[t._v("角色")])]),t._v(" "),s("ul",[s("li",[t._v("Role：授权特定命名空间的访问权限")]),t._v(" "),s("li",[t._v("ClusterRole：授权所有命名空间的访问权限")])]),t._v(" "),s("p",[s("strong",[t._v("角色绑定")])]),t._v(" "),s("ul",[s("li",[t._v("RoleBinding：将角色绑定到主体（即subject）")]),t._v(" "),s("li",[t._v("ClusterRoleBinding：将集群角色绑定到主体")])]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204121007979.png",alt:"image-20220412100724042"}}),t._v(" "),s("blockquote",[s("p",[t._v("注：RoleBinding在指定命名空间中执行授权，ClusterRoleBinding在集群范围执行授权。")])]),t._v(" "),s("h4",{attrs:{id:"基于角色的权限访问控制-rbac-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基于角色的权限访问控制-rbac-2"}},[t._v("#")]),t._v(" 基于角色的权限访问控制：RBAC")]),t._v(" "),s("p",[t._v("k8s预定好了四个集群角色供用户使用，使用kubectl get  clusterrole查看，其中systemd:开头的为系统内部使用。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("内置集群角色")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("cluster-admin")]),t._v(" "),s("td",[t._v("超级管理员，对集群所有权限")])]),t._v(" "),s("tr",[s("td",[t._v("admin")]),t._v(" "),s("td",[t._v("主要用于授权命名空间所有读写权限")])]),t._v(" "),s("tr",[s("td",[t._v("edit")]),t._v(" "),s("td",[t._v("允许对命名空间大多数对象读写操作，不允许查看或者修改角色，角色绑定")])]),t._v(" "),s("tr",[s("td",[t._v("view")]),t._v(" "),s("td",[t._v("允许对命名空间大多数对象只读权限，不允许查看角色、角色绑定和secret")])])])]),t._v(" "),s("h3",{attrs:{id:"案例实施"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h4",{attrs:{id:"案例1-对用户授权访问k8s-tls证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例1-对用户授权访问k8s-tls证书"}},[t._v("#")]),t._v(" 案例1：对用户授权访问K8s（TLS证书）")]),t._v(" "),s("p",[t._v("需求：为指定用户授权访问不同命名空间权限，例如新入职一个小弟，希望让他先熟悉K8s集 群，为了安全性，先不能给他太大权限，因此先给他授权访问default命名空间Pod读取权限。 实施大致步骤：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("用K8S CA签发客户端证书")])]),t._v(" "),s("li",[s("code",[t._v("生成kubeconfig授权文件")])]),t._v(" "),s("li",[s("code",[t._v("创建RBAC权限策略")])]),t._v(" "),s("li",[s("code",[t._v("指定kubeconfig文件测试权限：kubectl get pods --kubeconfig=./aliang.kubeconfig")])])]),t._v(" "),s("h5",{attrs:{id:"对用户授权访问k8s-tls证书"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对用户授权访问k8s-tls证书"}},[t._v("#")]),t._v(" 对用户授权访问K8s（TLS证书）")]),t._v(" "),s("ul",[s("li",[t._v("利用"),s("code",[t._v("cfssl工具")]),t._v("生成证书")]),t._v(" "),s("li",[t._v("在当前的目录下会生成新的"),s("code",[t._v("TLS自签名证书")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ./cert.sh ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:42 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" generate received request\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:42 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" received CSR\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:42 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" generating key: rsa-2048\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:43 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" encoded CSR\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:43 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("INFO"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" signed certificate with serial number "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("66521569005511148107562700581322500464829062465")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2022")]),t._v("/04/12 02:42:43 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("WARNING"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" This certificate lacks a "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hosts"')]),t._v(" field. This makes it unsuitable "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v("\nwebsites. For "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("more")]),t._v(" information see the Baseline Requirements "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" the Issuance and Management\nof Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("https://cabforum.org"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nspecifically, section "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.2")]),t._v(".3 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Information Requirements"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ll")]),t._v("\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("997")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:42 aliang.csr\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("219")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:42 aliang-csr.json\n-rw------- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1679")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:42 aliang-key.pem\n-rw------- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5759")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:44 aliang.kubeconfig\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1277")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:42 aliang.pem\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("292")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:42 ca-config.json\n-rwxr-xr-x "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("741")]),t._v(" Sep  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v(" cert.sh\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1048")]),t._v(" Jun "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("23")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v(" k8s-api-test.py\n-rwxr-xr-x "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("622")]),t._v(" Apr "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12")]),t._v(" 02:41 kubeconfig.sh\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("664")]),t._v(" Jun "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2021")]),t._v(" python-pod-sa.yaml\n")])])]),s("h5",{attrs:{id:"生成kubeconfig授权文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生成kubeconfig授权文件"}},[t._v("#")]),t._v(" 生成kubeconfig授权文件")]),t._v(" "),s("ul",[s("li",[t._v("使用kubectl config命令生成新的授权文件")]),t._v(" "),s("li",[t._v("配置客户端认证以及配置集群上下文")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config set-cluster kubernetes \\")]),t._v("\n  --certificate-authority"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/pki/ca.crt "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --embed-certs"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--server")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://10.11.121.118:6443 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--kubeconfig")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang.kubeconfig\nCluster "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),t._v(" set.\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置客户端认证")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config set-credentials aliang \\")]),t._v("\n  --client-key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang-key.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --client-certificate"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang.pem "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  --embed-certs"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--kubeconfig")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang.kubeconfig\nUser "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aliang"')]),t._v(" set.\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置默认上下文")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config set-context kubernetes \\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--cluster")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubernetes "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--user")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--kubeconfig")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("aliang.kubeconfig\nContext "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),t._v(" created.\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#设置当前使用配置")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl config use-context kubernetes --kubeconfig=aliang.kubeconfig")]),t._v("\nSwitched to context "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),s("p",[t._v("此时测试会发现报错")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods --kubeconfig=aliang.kubeconfig ")]),t._v("\nError from server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Forbidden"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": pods is forbidden: User "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"aliang"')]),t._v(" cannot list resource "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" API group "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" the namespace "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),t._v("\n")])])]),s("h5",{attrs:{id:"创建rbac策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建rbac策略"}},[t._v("#")]),t._v(" 创建RBAC策略")]),t._v(" "),s("ul",[s("li",[t._v("创建Role的名称为"),s("code",[t._v("pod-reader")])]),t._v(" "),s("li",[t._v("创建Role绑定"),s("code",[t._v("pods")]),t._v("和"),s("code",[t._v("services")]),t._v("资源")]),t._v(" "),s("li",[t._v("Role的权限为"),s("code",[t._v("get、watch、list")])]),t._v(" "),s("li",[t._v("绑定RoleBinding使用"),s("code",[t._v("User为aliang")])]),t._v(" "),s("li",[t._v("绑定RoleBinding的"),s("code",[t._v("Role为pod-preader")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("reader\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"services"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"watch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"list"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RoleBinding\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" read"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pods\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subjects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" User\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" aliang\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roleRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("reader\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n  \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f rbac.yaml ")]),t._v("\nrole.rbac.authorization.k8s.io/pod"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("reader created\nrolebinding.rbac.authorization.k8s.io/read"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pods created\n")])])]),s("p",[t._v("测试查看可以发现pods和service的资源可以使用用户访问。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods  --kubeconfig=aliang.kubeconfig    ")]),t._v("\nNo resources found "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" default namespace.\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get svc --kubeconfig=aliang.kubeconfig ")]),t._v("\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   AGE\nkubernetes   ClusterIP   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.1    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP   4d23h\n")])])]),s("blockquote",[s("p",[t._v("**用户组：**用户组的好处是无需单独为某个用户创建权限，统一为这个组名进 行授权，所有的用户都以组的身份访问资源。")])]),t._v(" "),s("p",[t._v("例如：为dev用户组统一授权")]),t._v(" "),s("ol",[s("li",[t._v("将certs.sh文件中的aliang-csr.json下的O字段改为dev，并重新生成证 书和kubeconfig文件")]),t._v(" "),s("li",[t._v("将dev用户组绑定Role（pod-reader）")]),t._v(" "),s("li",[t._v("测试，只要O字段都是dev，这些用户持有的kubeconfig文件都拥有相 同的权限")])]),t._v(" "),s("h4",{attrs:{id:"案例2-对应用程序授权访问k8s-sa"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例2-对应用程序授权访问k8s-sa"}},[t._v("#")]),t._v(" 案例2：对应用程序授权访问K8s （SA）")]),t._v(" "),s("p",[s("strong",[t._v("先了解下ServiceAccount，简称SA，是一种用于让程序访问K8s API的服务账号。")])]),t._v(" "),s("ul",[s("li",[t._v("当创建namespace时，会自动创建一个名为default的SA，这个SA没有绑定任何权限")]),t._v(" "),s("li",[t._v("当default SA创建时，会自动创建一个default-token-xxx的secret，并自动关联到SA")]),t._v(" "),s("li",[t._v("当创建Pod时，如果没有指定SA，会自动为pod以volume方式挂载这个default SA，在容 器目录："),s("code",[t._v("/var/run/secrets/kubernetes.io/serviceaccount")])])]),t._v(" "),s("p",[t._v("验证默认SA权限：")]),t._v(" "),s("blockquote",[s("p",[t._v("kubectl --as=system:serviceaccount:default:default get pods")])]),t._v(" "),s("p",[t._v("需求：授权容器中Python程序对K8s API访问权限 实施大致步骤：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("创建Role")])]),t._v(" "),s("li",[s("code",[t._v("创建ServiceAccount")])]),t._v(" "),s("li",[s("code",[t._v("将ServiceAccount与Role绑定")])]),t._v(" "),s("li",[s("code",[t._v("为Pod指定自定义的SA")])]),t._v(" "),s("li",[s("code",[t._v("进入容器里执行Python程序测试操作K8s API权限")])])]),t._v(" "),s("h5",{attrs:{id:"创建role"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建role"}},[t._v("#")]),t._v(" 创建Role")]),t._v(" "),s("ul",[s("li",[t._v("创建名称为"),s("code",[t._v("py-role")]),t._v("的Role")]),t._v(" "),s("li",[t._v("可访问资源为"),s("code",[t._v("pods")])]),t._v(" "),s("li",[t._v("对pods资源可执行"),s("code",[t._v("get、watch、list")]),t._v("的权限")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pods"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"get"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"watch"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"list"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h5",{attrs:{id:"创建serviceaccount"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建serviceaccount"}},[t._v("#")]),t._v(" 创建ServiceAccount")]),t._v(" "),s("ul",[s("li",[t._v("创建serviceaccount的名称为"),s("code",[t._v("py-role")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ServiceAccount\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("k8s\n")])])]),s("h5",{attrs:{id:"将serviceaccount与role绑定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将serviceaccount与role绑定"}},[t._v("#")]),t._v(" 将ServiceAccount与Role绑定")]),t._v(" "),s("ul",[s("li",[t._v("创建名称为"),s("code",[t._v("py-role")]),t._v("的RoleBinding")]),t._v(" "),s("li",[t._v("绑定默认命名空间的"),s("code",[t._v("py-k8s")]),t._v("名称的sa")]),t._v(" "),s("li",[t._v("绑定"),s("code",[t._v("py-role")]),t._v("的Role")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RoleBinding\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subjects")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ServiceAccount\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("k8s\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roleRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n")])])]),s("h5",{attrs:{id:"创建绑定sa的pod"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#创建绑定sa的pod"}},[t._v("#")]),t._v(" 创建绑定SA的Pod")]),t._v(" "),s("ul",[s("li",[t._v("创建名称为"),s("code",[t._v("py-k8s")]),t._v("的Pod")]),t._v(" "),s("li",[t._v("绑定SA认证为"),s("code",[t._v("py-k8s")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("k8s\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceAccountName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" py"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("k8s\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" python"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" python\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 24h\n")])])]),s("p",[t._v("创建测试，并使用Python脚本通过访问SA的认证，连接K8S的apiserver。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f python-pod-sa.yaml")]),t._v("\nserviceaccount/py-k8s created\nrole.rbac.authorization.k8s.io/py-role created\nrolebinding.rbac.authorization.k8s.io/py-role created\npod/py-k8s created\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cp k8s-api-test.py py-k8s:/opt/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/RBAC"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl exec -it py-k8s -- bash")]),t._v("\nroot@py-k8s:/"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# pip install kubernetes")]),t._v("\n")])])]),s("p",[t._v("查看当前的脚本并运行查看结果：")]),t._v(" "),s("div",{staticClass:"language-python extra-class"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[t._v("root@py"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat k8s-api-test.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" kubernetes "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" config\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("open")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/var/run/secrets/kubernetes.io/serviceaccount/token'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n     token "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nconfiguration "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Configuration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nconfiguration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("host "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://kubernetes"')]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# APISERVER地址")]),t._v("\nconfiguration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ssl_ca_cert"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"')]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# CA证书")]),t._v("\nconfiguration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("verify_ssl "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启用证书验证")]),t._v("\nconfiguration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("api_key "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"authorization"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Bearer "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" token"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定Token字符串")]),t._v("\nclient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Configuration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("set_default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configuration"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\napps_api "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AppsV1Api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncore_api "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("CoreV1Api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"###### Deployment列表 ######"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#列出default命名空间所有deployment名称")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" dp "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" apps_api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list_namespaced_deployment"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metadata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"没有权限访问Deployment资源！"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#列出default命名空间所有pod名称")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"###### Pod列表 ######"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" po "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" core_api"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list_namespaced_pod"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"default"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("items"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("po"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("metadata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("except")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"没有权限访问Pod资源！"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nroot@py"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("opt"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# python3 k8s-api-test.py")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("###### Deployment列表 ######")]),t._v("\n没有权限访问Deployment资源！\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("###### Pod列表 ######")]),t._v("\npy"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("k8s\npython\n")])])]),s("blockquote",[s("p",[s("strong",[t._v("命令行使用：授权SA只能查看test命名空间控制器的权限")])])]),t._v(" "),s("p",[s("strong",[t._v("1.创建角色")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl create role role-test "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--verb")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("get,list "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--resource")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("deployments,daemonsets,statefulsets "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n")])])]),s("p",[s("strong",[t._v("2.创建服务账号")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl create serviceaccount app-demo "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" \n")])])]),s("p",[s("strong",[t._v("3.将服务账号绑定角色")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl create rolebinding role-test:app-demo "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--serviceaccount")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("test:app-demo "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--role")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("role-test "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" \n")])])]),s("p",[s("strong",[t._v("4.测试")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ kubectl "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--as")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:serviceaccount:test:app-demo get pods "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-n")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n")])])]),s("h3",{attrs:{id:"资源配额-resourcequota"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#资源配额-resourcequota"}},[t._v("#")]),t._v(" 资源配额 ResourceQuota")]),t._v(" "),s("p",[t._v("当多个团队、多个用户共享使用K8s集群时，会出现不均匀资源使用，默认情况下先到先得，这时可以通过 ResourceQuota来对命名空间资源使用总量做限制，从而解决这个问题。")]),t._v(" "),s("p",[t._v("使用流程："),s("code",[t._v("k8s管理员为每个命名空间创建一个或多个ResourceQuota对象，定义资源使用总量")]),t._v("，K8s会跟踪命名空间 资源使用情况，当超过定义的资源配额会返回拒绝。")]),t._v(" "),s("p",[t._v("ResourceQuota功能是一个准入控制插件，默认已经启用。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204121520062.png",alt:"image-20220412151959092"}})]),t._v(" "),s("h4",{attrs:{id:"命名空间资源配额"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命名空间资源配额"}},[t._v("#")]),t._v(" 命名空间资源配额")]),t._v(" "),s("ul",[s("li",[t._v("首先需要创建一个命名空间，我们对这个命名空间资源进行限制")]),t._v(" "),s("li",[t._v("创建Quota资源限制对test命名空间设置资源大小")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create ns test")]),t._v("\nnamespace/test created\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  quota.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ResourceQuota\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" compute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("resources\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hard")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests.cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests.memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 4Gi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits.cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits.memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 6Gi\n")])])]),s("p",[t._v("执行yaml文件查看当前的quota资源使用情况：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f quota.yaml")]),t._v("\nresourcequota/compute-resources configured\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get quota -n test")]),t._v("\nNAME                AGE     REQUEST                                     LIMIT\ncompute-resources   8m43s   requests.cpu: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/2, requests.memory: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/4Gi   limits.cpu: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/4, limits.memory: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/6Gi\n")])])]),s("p",[t._v("创建Deployment并且使用三个副本数，使用资源配额：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("creationTimestamp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("null")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("strategy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("creationTimestamp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("null")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 500m\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 512Mi\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 256m\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 256Mi\n")])])]),s("p",[t._v("再次查看当前的资源使用情况：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods -n test")]),t._v("\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-646967b68d-cpwlt   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          11m\nnginx-646967b68d-gfz6h   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          11m\nnginx-646967b68d-lz5hp   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          11m\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get quota -n test")]),t._v("\nNAME                AGE   REQUEST                                            LIMIT\ncompute-resources   22m   requests.cpu: 768m/2, requests.memory: 768Mi/4Gi   limits.cpu: 1500m/4, limits.memory: 1536Mi/6Gi\n")])])]),s("h4",{attrs:{id:"对象数量配额"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象数量配额"}},[t._v("#")]),t._v(" 对象数量配额")]),t._v(" "),s("ul",[s("li",[t._v("配置test命名空间下的对象数量配额")]),t._v(" "),s("li",[t._v("控制deployment的数量在3个")]),t._v(" "),s("li",[t._v("控制services的数量在3个")]),t._v(" "),s("li",[t._v("控制pods的数量为4个")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ResourceQuota\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("quota\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hard")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"4"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count/deployments.apps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count/services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3"')]),t._v("\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get quota -n test")]),t._v("\nNAME          AGE   REQUEST                                                       LIMIT\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count-quota   49s   count/deployments.apps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0/3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("count/services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0/3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pods")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0/4\n")])])]),s("p",[t._v("创建Deployment的副本数为2个：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create deployment nginx --image=nginx --replicas=2 -n test")]),t._v("\ndeployment.apps/nginx created\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get  pods -n test")]),t._v("\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-6799fc88d8-gcnqv   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6s\nnginx-6799fc88d8-vhttg   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6s\n")])])]),s("p",[t._v("此时查看当前的限制使用情况：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get quota -n test")]),t._v("\nNAME          AGE    REQUEST                                                       LIMIT\ncount-quota   2m2s   count/deployments.apps: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/3, count/services: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/3, pods: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/4\n")])])]),s("p",[t._v("现在我们将Deployment的副本数扩容到5个副本看看会发生什么：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("Deployment的副本数并没有扩容到4")])]),t._v(" "),s("li",[s("code",[t._v("当前的quota限制里，Deployment的资源耗尽")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl scale deployment nginx --replicas=5 -n test")]),t._v("\ndeployment.apps/nginx scaled\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods -n test")]),t._v("\nNAME                     READY   STATUS    RESTARTS   AGE\nnginx-6799fc88d8-2nkjg   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          21s\nnginx-6799fc88d8-fnmhj   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          21s\nnginx-6799fc88d8-gcnqv   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          71s\nnginx-6799fc88d8-vhttg   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          71s\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get quota -n test")]),t._v("\nNAME          AGE   REQUEST                                                       LIMIT\ncount-quota   3m    count/deployments.apps: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/3, count/services: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/3, pods: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v("/4\n")])])]),s("h3",{attrs:{id:"资源限制-limitrange"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#资源限制-limitrange"}},[t._v("#")]),t._v(" 资源限制 LimitRange")]),t._v(" "),s("p",[t._v("默认情况下，K8s集群上的容器对计算资源没有任何限制，可能会导致个别容器资源过大导致影响其他容器正常工 作，这时可以使用LimitRange定义容器默认CPU和内存请求值或者最大上限。")]),t._v(" "),s("p",[t._v("LimitRange限制维度：")]),t._v(" "),s("ul",[s("li",[t._v("限制容器配置"),s("code",[t._v("requests.cpu/memory，limits.cpu/memory")]),t._v("的最小、最大值")]),t._v(" "),s("li",[t._v("限制容器配置"),s("code",[t._v("requests.cpu/memory，limits.cpu/memory")]),t._v("的默认值")]),t._v(" "),s("li",[t._v("限制PVC配置"),s("code",[t._v("requests.storage")]),t._v("的最小、最大值")])]),t._v(" "),s("h4",{attrs:{id:"计算资源大小限制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#计算资源大小限制"}},[t._v("#")]),t._v(" 计算资源大小限制")]),t._v(" "),s("ul",[s("li",[t._v("创建一个LimitRange的资源")]),t._v(" "),s("li",[t._v("设置cpu最小能设置为"),s("code",[t._v("200m，最大1个")])]),t._v(" "),s("li",[t._v("设置内存最小能设置为"),s("code",[t._v("200Mi，最大1Gi")])]),t._v(" "),s("li",[t._v("低于最小的请求或者超过最大的请求将会报错")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" LimitRange\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("memory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("min"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("max\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 容器能设置limit的最大值")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 容器能设置request的最小值")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 200m\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 200Mi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container\n")])])]),s("p",[t._v("创建一个Pod查看资源使用情况：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f pod.yaml")]),t._v("\npod/nginx created\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat pod.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 500m\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 256Mi\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 300m\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 200Mi\n")])])]),s("p",[t._v("查看当前的资源限制状态：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe limitranges -n test cpu-memory-min-max")]),t._v("\nName:       cpu-memory-min-max\nNamespace:  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nType        Resource  Min    Max  Default Request  Default Limit  Max Limit/Request Ratio\n----        --------  ---    ---  ---------------  -------------  -----------------------\nContainer   cpu       200m   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("                "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("              -\nContainer   memory    200Mi  1Gi  1Gi              1Gi            -\n")])])]),s("p",[t._v("尝试创建一个超过大小的Pod，将以上Pod改成最大请求2Gi内存和2个CPU:")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("提示报错警告不能超过最大请求")])]),t._v(" "),s("li",[s("code",[t._v("所以资源限制生效")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f pod.yaml")]),t._v("\nError from server "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Forbidden"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": error when creating "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pod.yaml"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" pods "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx"')]),t._v(" is forbidden: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("maximum cpu usage per Container is "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", but limit is "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", maximum memory usage per Container is 1Gi, but limit is 2Gi"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h4",{attrs:{id:"计算资源默认值限制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#计算资源默认值限制"}},[t._v("#")]),t._v(" 计算资源默认值限制")]),t._v(" "),s("ul",[s("li",[t._v("创建LimitRange资源")]),t._v(" "),s("li",[t._v("设置默认的内存限制"),s("code",[t._v("最小300m，最大500m")])]),t._v(" "),s("li",[t._v("设置默认的cpu限制最"),s("code",[t._v("小300m，最大500m")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" LimitRange\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cpu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("memory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("min"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("max\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("default")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 500m\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 500Mi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("defaultRequest")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 300m\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 300Mi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Container\n")])])]),s("p",[t._v("创建资源限制查看当前的状态：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe limitranges -n test cpu-memory-min-max")]),t._v("\nName:       cpu-memory-min-max\nNamespace:  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\nType        Resource  Min  Max  Default Request  Default Limit  Max Limit/Request Ratio\n----        --------  ---  ---  ---------------  -------------  -----------------------\nContainer   memory    -    -    300Mi            500Mi          -\nContainer   cpu       -    -    300m             500m           -\n")])])]),s("p",[t._v("创建Pod测试，不需要设置当前Pod的资源请求部分，创建之后查看：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat pod.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/work"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl describe pods -n test | grep Limits -A 5")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("     500m\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  500Mi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("Requests")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cpu")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("        300m\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("     300Mi\n")])])]),s("h4",{attrs:{id:"存储资源最大、最小限制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存储资源最大、最小限制"}},[t._v("#")]),t._v(" 存储资源最大、最小限制")]),t._v(" "),s("ul",[s("li",[t._v("创建LimitRange资源")]),t._v(" "),s("li",[t._v("设置最小的申请PVC限制"),s("code",[t._v("最小为1Gi，最大10Gi")])])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" LimitRange\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" storage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("min"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("max\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("limits")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PersistentVolumeClaim\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10Gi\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("min")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n")])])]),s("p",[t._v("此资源在PVC中使用如下：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PersistentVolumeClaim\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pvc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("quota"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo2\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storageClassName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" manual\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("accessModes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ReadWriteOnce\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("requests")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("storage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1Gi\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);