(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{481:function(t,s,n){"use strict";n.r(s);var a=n(7),e=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"restclient原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#restclient原理"}},[t._v("#")]),t._v(" RESTClient原理")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"环境要求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环境要求"}},[t._v("#")]),t._v(" 环境要求")]),t._v(" "),s("p",[s("strong",[t._v("K8S版本：v1.23.3")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl cluster-info ")]),t._v("\nKubernetes control plane is running at https://10.11.121.111:6443\nCoreDNS is running at https://10.11.121.111:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubectl cluster-info dump'")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),s("p",[s("strong",[t._v("client-go版本: v0.23.3")])]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204260909522.png",alt:"width:26cm height:14cm"}})]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204260908476.png",alt:"width:13cm height:7cm"}}),t._v(" "),s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204260908179.png",alt:"width:13cm height:7cm"}})]),t._v(" "),s("hr"),t._v(" "),s("h3",{attrs:{id:"client-go架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client-go架构"}},[t._v("#")]),t._v(" Client-go架构")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204260908578.png",alt:"width:26cm height:14cm"}})]),t._v(" "),s("h3",{attrs:{id:"控制器逻辑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#控制器逻辑"}},[t._v("#")]),t._v(" 控制器逻辑")]),t._v(" "),s("ul",[s("li",[t._v("观察：通过监控Kubernetes资源对象变化的事件来获取当前对象状态，我们只需要注入EventHandler让client-go将变化的事件对象信息放入WorkQueue中。")]),t._v(" "),s("li",[t._v("分析：确定当前状态和期望状态的不同，由Worker完成。")]),t._v(" "),s("li",[t._v("执行：执行能够驱动对象当前状态变化的操作，由Worker完成。")]),t._v(" "),s("li",[t._v("更新：更新对象的当前状态，由Worker完成。")])]),t._v(" "),s("h3",{attrs:{id:"client类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client类型"}},[t._v("#")]),t._v(" Client类型")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("RESTClient")]),t._v("： 最基础的客户端，提供最基本的封装")]),t._v(" "),s("li",[s("code",[t._v("Clientset")]),t._v("：是一个Client的集合，在Clientset中包含了所有K8S内置资源的Client，通过Clientset便可以很方便的操作如Pod、Service这些资源")]),t._v(" "),s("li",[s("code",[t._v("dynamicClient")]),t._v("：动态客户端，可以操作任意K8S的资源，包括CRD定义的资源")]),t._v(" "),s("li",[s("code",[t._v("DiscoveryClient")]),t._v("：用于发现K8S提供的资源组、资源版本和资源信息，比如："),s("code",[t._v("kubectl api-resources")])])]),t._v(" "),s("h3",{attrs:{id:"restclient的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#restclient的使用"}},[t._v("#")]),t._v(" RESTClient的使用")]),t._v(" "),s("p",[t._v("RESTClient 是底层的用于网络请求的对象，可以直接通过 RESTClient 提供的 RESTful 方法如 Get()、Put()、Post()、Delete() 等和 APIServer 进行交互。")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("同时支持 JSON 和 protobuf 两种序列化方式")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("支持所有原生资源")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("RESTClientFor")]),t._v(": 为创建"),s("code",[t._v("RESTClient")]),t._v("准备config，比如限速器、编解码器等")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("UnversionedRESTClientFor")]),t._v(": 与"),s("code",[t._v("RESTClientFor")]),t._v("类似，只是允许config.GroupVersion为空")])])]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" clientcmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BuildConfigFromFlags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("kubeconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    client"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("RESTClientFor")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h3",{attrs:{id:"clientset的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#clientset的使用"}},[t._v("#")]),t._v(" Clientset的使用")]),t._v(" "),s("p",[t._v("Clientset 是调用 Kubernetes 资源对象最常用的客户端，可以操作所有的资源对象。")]),t._v(" "),s("p",[t._v("Kubernetes 集群资源的方式，通过 client-go 提供的 Clientset 对象来获取资源数据，主要有以下三个步骤：")]),t._v(" "),s("ol",[s("li",[t._v("使用 kubeconfig 文件或者 ServiceAccount（InCluster 模式）来创建访问 Kubernetes API 的 Restful 配置参数，也就是代码中的 "),s("code",[t._v("rest.Config")]),t._v(" 对象")]),t._v(" "),s("li",[t._v("使用 rest.Config 参数创建 Clientset 对象，这一步非常简单，直接调用 "),s("code",[t._v("kubernetes.NewForConfig(config)")]),t._v(" 即可初始化")]),t._v(" "),s("li",[t._v("然后是 Clientset 对象的方法去获取各个 Group 下面的对应资源对象进行 CRUD 操作")])]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" clientcmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BuildConfigFromFlags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("kubeconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    clientset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" kubernetes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewForConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    deploymentsClient "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" clientset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("AppsV1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Deployments")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),s("h3",{attrs:{id:"dynamicclient的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dynamicclient的使用"}},[t._v("#")]),t._v(" dynamicClient的使用")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("deployment、pod这些资源，其数据结构是明确的固定的，可以精确对应到Clientset中的数据结构和方法，但是对于CRD（用户自定义资源），Clientset客户端就无能为力了")]),t._v("。此时需要有一种数据结构来承载资源对象的数据，也要有对应的方法来处理这些数据；")]),t._v(" "),s("li",[t._v("此刻，前面提到的Unstructured可以登场了，没错，把Clientset不支持的资源对象交给Unstructured来承载，接下来看看dynamicClient和Unstructured的关系：")]),t._v(" "),s("li",[t._v("先看数据结构定义，和clientset没啥区别，只有个restClient字段：")])]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" dynamicClient "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tclient "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("rest"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RESTClient\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("使用方法：")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\tconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" clientcmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BuildConfigFromFlags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("kubeconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tclient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" dynamic"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewForConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),s("h3",{attrs:{id:"discoveryclient的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#discoveryclient的使用"}},[t._v("#")]),t._v(" DiscoveryClient的使用")]),t._v(" "),s("p",[t._v("kubectl api-versions命令，大家应该不陌生吧，可以返回当前kubernetes环境的所有Group+Version的组合，如下：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl api-versions")]),t._v("\nadmissionregistration.k8s.io/v1\nadmissionregistration.k8s.io/v1beta1\napiextensions.k8s.io/v1\napiextensions.k8s.io/v1beta1\napiregistration.k8s.io/v1\napiregistration.k8s.io/v1beta1\napps/v1\nauthentication.k8s.io/v1\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])])]),s("p",[t._v("通过查看kubectl源码可见，上述命令的背后就是使用了DiscoveryClient来实现的，使用如下：")]),t._v(" "),s("div",{staticClass:"language-go extra-class"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\tconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" clientcmd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BuildConfigFromFlags")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("kubeconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("panic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tclient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" discovery"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewDiscoveryClientForConfig")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n")])])]),s("p",[t._v("另外还有两个DiscoveryClient，分别支持将数据缓存在磁盘文件或内存当中")])])}),[],!1,null,null,null);s.default=e.exports}}]);