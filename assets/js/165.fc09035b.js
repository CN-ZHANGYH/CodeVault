(window.webpackJsonp=window.webpackJsonp||[]).push([[165],{479:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"最小化微服务漏洞"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#最小化微服务漏洞"}},[t._v("#")]),t._v(" 最小化微服务漏洞")]),t._v(" "),s("h3",{attrs:{id:"主要内容"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#主要内容"}},[t._v("#")]),t._v(" 主要内容")]),t._v(" "),s("p",[t._v("❖ Pod安全上下文")]),t._v(" "),s("p",[t._v("❖ Pod安全策略")]),t._v(" "),s("p",[t._v("❖ Secret存储敏感数据")]),t._v(" "),s("p",[t._v("❖ 安全沙箱运行容器")]),t._v(" "),s("h3",{attrs:{id:"pod安全上下文"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pod安全上下文"}},[t._v("#")]),t._v(" Pod安全上下文")]),t._v(" "),s("p",[s("code",[t._v("安全上下文（Security Context）")]),t._v("：K8s对Pod和容器提供的安全机制，可以设置Pod特权和访问控制。")]),t._v(" "),s("p",[s("strong",[t._v("安全上下文限制维度：")])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("自主访问控制（Discretionary Access Control）")]),t._v("：基于用户ID（UID）和组ID（GID），来判定对对象（例如文件） 的访问权限。")]),t._v(" "),s("li",[s("code",[t._v("安全性增强的 Linux（SELinux）")]),t._v("： 为对象赋予安全性标签。")]),t._v(" "),s("li",[t._v("以"),s("code",[t._v("特权模式")]),t._v("或者非特权模式运行。")]),t._v(" "),s("li",[s("code",[t._v("Linux Capabilities")]),t._v(": 为进程赋予 root 用户的部分特权而非全部特权。")]),t._v(" "),s("li",[s("code",[t._v("AppArmor")]),t._v("：定义Pod使用AppArmor限制容器对资源访问限制")]),t._v(" "),s("li",[s("code",[t._v("Seccomp")]),t._v("：定义Pod使用Seccomp限制容器进程的系统调用")]),t._v(" "),s("li",[s("code",[t._v("AllowPrivilegeEscalation")]),t._v("： 禁止容器中进程（通过 SetUID 或 SetGID 文件模式）获得特权提升。当容器以特权模式 运行或者具有CAP_SYS_ADMIN能力时，AllowPrivilegeEscalation总为True。")]),t._v(" "),s("li",[s("code",[t._v("readOnlyRootFilesystem")]),t._v("：以只读方式加载容器的根文件系统。")])]),t._v(" "),s("h3",{attrs:{id:"案例实施"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h5",{attrs:{id:"案例1-设置容器以普通用户运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例1-设置容器以普通用户运行"}},[t._v("#")]),t._v(" 案例1：设置容器以普通用户运行")]),t._v(" "),s("p",[t._v("背景：容器中的应用程序默认以root账号运行的，这个root与宿主机root账号是相同的， 拥有大部分对Linux内核的系统调用权限，这样是不安全的，所以我们应该将容器以普 通用户运行，减少应用程序对权限的使用。")]),t._v(" "),s("p",[t._v("可以通过两种方法设置普通用户：")]),t._v(" "),s("ol",[s("li",[t._v("Dockerfile里使用USER指定运行用户")]),t._v(" "),s("li",[t._v("K8s里指定spec.securityContext.runAsUser，指定容器默认用户UID")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runAsUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" \t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 镜像里必须有这个用户UID")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fsGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v(" \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 数据卷挂载后的目录属组设置为该组")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" lizhenliang/flask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("root\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("allowPrivilegeEscalation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 不允许提权")]),t._v("\n")])])]),s("p",[t._v("创建Pod使用安全上下文测试是否改为uuid运行容器:")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat pod-test.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runAsUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fsGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" lizhenliang/flask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("root\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("allowPrivilegeEscalation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n")])])]),s("p",[t._v("执行yaml之后进入容器查看当前的uuid：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl exec -it test -- bash")]),t._v("\npython@test:/data/www$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("uid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("python"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("python"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("groups")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("python"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("h5",{attrs:{id:"案例2-避免使用特权容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例2-避免使用特权容器"}},[t._v("#")]),t._v(" 案例2：避免使用特权容器")]),t._v(" "),s("p",[t._v("背景：容器中有些应用程序可能需要访问宿主机设备、修改内核等需求，在默认情况下， 容器没这个有这个能力，因此这时会考虑给容器设置特权模式。")]),t._v(" "),s("p",[t._v("启用特权模式：")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" lizhenliang/flask"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("demo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("root\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" web\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" true / false \n")])])]),s("blockquote",[s("p",[t._v("启用特权模式就意味着，你要为容器提供了访问Linux内核的所有能力，这是很危险的， 为了减少系统调用的供给，可以使用Capabilities为容器赋予仅所需的能力。")])]),t._v(" "),s("p",[s("code",[t._v("Linux Capabilities：Capabilities 是一个内核级别的权限")]),t._v("，它允许对内核调用权 限进行更细粒度的控制，而不是简单地以 root 身份能力授权。 Capabilities 包括更改文件权限、控制网络子系统和执行系统管理等功能。在 securityContext 中，可以添加或删除 Capabilities，做到容器精细化权限控制。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141224069.png",alt:"image-20220413084355164"}})]),t._v(" "),s("h5",{attrs:{id:"案例3-取消挂载文件系统"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例3-取消挂载文件系统"}},[t._v("#")]),t._v(" 案例3：取消挂载文件系统")]),t._v(" "),s("p",[t._v("容器默认没有挂载文件系统能力，添加SYS_ADMIN增加这个能力")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 24h\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("capabilities")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SYS_ADMIN"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("创建进入容器测试挂载权限：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl exec -it  busybox -- sh")]),t._v("\n/ "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mount /data/ /tmp/")]),t._v("\nmount: mounting /data/ on /tmp/ failed: Permission denied\n")])])]),s("h5",{attrs:{id:"案例4-只读挂载权限"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例4-只读挂载权限"}},[t._v("#")]),t._v(" 案例4：只读挂载权限")]),t._v(" "),s("p",[t._v("只读挂载容器文件系统，防止恶意二进制文件创建")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" busybox\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" sleep\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 24h\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("readOnlyRootFilesystem")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n")])])]),s("p",[t._v("创建进入容器测试文件权限：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl exec -it  busybox  -- sh")]),t._v("\n/ "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mkdir a")]),t._v("\nmkdir: can"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'t create directory '")]),t._v("a': Read-only "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" system\n")])])]),s("h3",{attrs:{id:"pod安全策略-psp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pod安全策略-psp"}},[t._v("#")]),t._v(" Pod安全策略（PSP）")]),t._v(" "),s("p",[s("code",[t._v("PodSecurityPolicy（简称PSP）")]),t._v("：Kubernetes中Pod部署时重要的安全校验手段，能够 有效地约束应用运行时行为安全。 使用PSP对象定义一组Pod在运行时必须遵循的条件及相关字段的默认值，只有Pod满足这 些条件才会被K8s接受。")]),t._v(" "),s("h4",{attrs:{id:"pod安全策略限制维度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pod安全策略限制维度"}},[t._v("#")]),t._v(" Pod安全策略限制维度")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141224517.png",alt:"image-20220413100840633"}})]),t._v(" "),s("h4",{attrs:{id:"启用准入控制器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用准入控制器"}},[t._v("#")]),t._v(" 启用准入控制器")]),t._v(" "),s("p",[t._v("Pod安全策略实现为一个准入控制器，默认没有启用，当启用后会强制实施 Pod安全策略，没有满足的Pod将无法创建。因此，建议在启用PSP之前先添加 策略并对其授权。")]),t._v(" "),s("p",[t._v("启用Pod安全策略：")]),t._v(" "),s("blockquote",[s("p",[t._v("vi /etc/kubernetes/manifests/kube-apiserver.yaml\n...\n--enable-admission-plugins=NodeRestriction,PodSecurityPolicy\n...\nsystemctl restart kubelet")])]),t._v(" "),s("h4",{attrs:{id:"如何使用psp资源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何使用psp资源"}},[t._v("#")]),t._v(" 如何使用PSP资源")]),t._v(" "),s("p",[t._v("用户使用SA （ServiceAccount）创建了一个Pod，"),s("code",[t._v("K8s会先验证这个SA是否 可以访问PSP资源权限")]),t._v("，如果可以进一步验证Pod配置是否满足PSP规则，任 意一步不满足都会拒绝部署。")]),t._v(" "),s("p",[t._v("因此，需要实施需要有这几点：")]),t._v(" "),s("ol",[s("li",[t._v("创建SA服务账号")]),t._v(" "),s("li",[t._v("该SA需要具备创建对应资源权限，例如创建Pod、Deployment")]),t._v(" "),s("li",[t._v("SA使用PSP资源权限：创建Role，使用PSP资源权限，再将SA绑定Role")])]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141224319.png",alt:"image-20220413102111236"}}),t._v(" "),s("h3",{attrs:{id:"案例实施-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施-2"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h5",{attrs:{id:"示例1-禁止创建特权模式的pod"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例1-禁止创建特权模式的pod"}},[t._v("#")]),t._v(" 示例1：禁止创建特权模式的Pod")]),t._v(" "),s("p",[t._v("创建Pod安全策略资源如下：")]),t._v(" "),s("ul",[s("li",[t._v("不允许特权Pod")]),t._v(" "),s("li",[t._v("运行seLinux的规则")]),t._v(" "),s("li",[t._v("指定容器启动的用户ID和主组ID位任何人或者禁止没指定普通用户运行的容器（runAsUser）")]),t._v(" "),s("li",[t._v("允许使用挂载类型数据卷")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat psp.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" policy/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PodSecurityPolicy\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" psp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("example\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 不允许特权Pod")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 下面是一些必要的字段")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("seLinux")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RunAsAny\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("supplementalGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RunAsAny\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runAsUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RunAsAny   /  MustRunAsNonRoot\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("fsGroup")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RunAsAny\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),t._v("\n")])])]),s("p",[t._v("执行之后查看当前的PSP资源情况：")]),t._v(" "),s("p",[t._v("在后续的1.25之后的版本里面，将会完全废弃Pod安全策略，采用安全上下文 的方式。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f psp.yaml")]),t._v("\nWarning: policy/v1beta1 PodSecurityPolicy is deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.21+, unavailable "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.25+\npodsecuritypolicy.policy/psp-example created\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get psp")]),t._v("\nWarning: policy/v1beta1 PodSecurityPolicy is deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.21+, unavailable "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.25+\nNAME          PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES\npsp-example   "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("          RunAsAny   RunAsAny    RunAsAny   RunAsAny   "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("            *\n")])])]),s("h5",{attrs:{id:"示例2-禁止创建特权模式流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例2-禁止创建特权模式流程"}},[t._v("#")]),t._v(" 示例2：禁止创建特权模式流程")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建SA")]),t._v("\n$ kubectl create serviceaccount aliang\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将SA绑定到系统内置Role")]),t._v("\n$ kubectl create rolebinding aliang "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--clusterrole")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("edit "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--serviceaccount")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("default:aliang\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建使用PSP权限的Role")]),t._v("\n$ kubectl create role psp:unprivileged "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--verb")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("use "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--resource")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("podsecuritypolicy --resource-name"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("psp-example\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将SA绑定到Role")]),t._v("\n$ kubectl create rolebinding aliang:psp:unprivileged "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--role")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("psp:unprivileged "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--serviceaccount")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("default:aliang\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建pod测试")]),t._v("\n$ kubectl "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--as")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:serviceaccount:default:psp-sa run nginx "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--image")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("nginx\n")])])]),s("h3",{attrs:{id:"opa-gatekeeper"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opa-gatekeeper"}},[t._v("#")]),t._v(" OPA Gatekeeper")]),t._v(" "),s("h4",{attrs:{id:"opa介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opa介绍"}},[t._v("#")]),t._v(" OPA介绍")]),t._v(" "),s("p",[t._v("PSP不足与状况：")]),t._v(" "),s("ul",[s("li",[t._v("将再1.21版本弃用PSP，在1.25版本删除PSP")]),t._v(" "),s("li",[t._v("仅支持Pod策略")]),t._v(" "),s("li",[t._v("使用复杂，权限模型存在缺陷，控制不明确")])]),t._v(" "),s("p",[t._v("🏷️"),s("a",{attrs:{href:"https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/",target:"_blank",rel:"noopener noreferrer"}},[t._v("弃用文章"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("🏷️"),s("a",{attrs:{href:"https://github.com/kubernetes/enhancements/issues/2579",target:"_blank",rel:"noopener noreferrer"}},[t._v("替代提案"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("code",[t._v("OPA（Open Policy Agent）")]),t._v("：是一个开源的、通用策略引擎，可以将策略编写为代码。提供 一个种高级声明性语言-Rego来编写策略，并把决策这一步骤从复杂的业务逻辑中解耦出来。")]),t._v(" "),s("p",[t._v("OPA可以用来做什么？")]),t._v(" "),s("ol",[s("li",[t._v("拒绝不符合条件的YAML部署")]),t._v(" "),s("li",[t._v("允许使用哪些仓库中的镜像")]),t._v(" "),s("li",[t._v("允许在哪个时间段访问系统")]),t._v(" "),s("li",[t._v("等...")])]),t._v(" "),s("h4",{attrs:{id:"opa工作流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opa工作流程"}},[t._v("#")]),t._v(" OPA工作流程")]),t._v(" "),s("p",[t._v("Gatekeeper 是基于 OPA的一个 Kubernetes 策略解决方案，可替代PSP或者部分RBAC功能。")]),t._v(" "),s("p",[t._v("当在集群中部署了Gatekeeper组件，APIServer所有的创建、更新或者删除操作都会触发 Gatekeeper来处理，如果不满足策略则拒绝。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141223253.png",alt:"image-20220413133253793"}})]),t._v(" "),s("h4",{attrs:{id:"部署opa-gatekeeper"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署opa-gatekeeper"}},[t._v("#")]),t._v(" 部署OPA Gatekeeper")]),t._v(" "),s("p",[t._v("Gatekeeper的策略由两个资源对象组成：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("Template")]),t._v("：策略逻辑实现的地方，使用rego语言")]),t._v(" "),s("li",[s("code",[t._v("Contsraint")]),t._v("：负责Kubernetes资源对象的过滤或者为Template提供输入参数")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods -n gatekeeper-system")]),t._v("\nNAME                                             READY   STATUS    RESTARTS   AGE\ngatekeeper-controller-manager-66f474f785-kn5fl   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          32s\ngatekeeper-controller-manager-66f474f785-xgz7s   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          32s\ngatekeeper-controller-manager-66f474f785-xxwdm   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          32s\n")])])]),s("h3",{attrs:{id:"案例实施-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施-3"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h5",{attrs:{id:"案例1-禁止容器启用特权"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例1-禁止容器启用特权"}},[t._v("#")]),t._v(" 案例1：禁止容器启用特权")]),t._v(" "),s("ul",[s("li",[t._v("需要创建"),s("code",[t._v("ConstraintTemplate")]),t._v("的资源")]),t._v(" "),s("li",[t._v("使用"),s("code",[t._v("rego")]),t._v("的语言编写对启用特权的资源发出警告")]),t._v(" "),s("li",[t._v("需要指定类型为"),s("code",[t._v("privileged")]),t._v("模式")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat privileged_tpl.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" templates.gatekeeper.sh/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConstraintTemplate\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" privileged\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("crd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("names")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" privileged\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" admission.k8s.gatekeeper.sh\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rego")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n        package admission\n        violation[{"msg": msg}] {  # 如果violation为true说明违反约束\n          containers = input.review.object.spec.template.spec.containers\n          c_name := containers[0].name\n          containers[0].securityContext.privileged # 如果返回false或者没获取到值说明通过\n          msg := sprintf("提示：\'%v\'容器禁止启用特权！",[c_name])\n        }')]),t._v("\n        \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get ConstraintTemplate")]),t._v("\nNAME         AGE\nprivileged   32m\n")])])]),s("p",[t._v("创建约束、如下是约束资源类型：")]),t._v(" "),s("ul",[s("li",[t._v("Deployment")]),t._v(" "),s("li",[t._v("DaemonSet")]),t._v(" "),s("li",[t._v("StatefulSet")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat privileged_constraints.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" constraints.gatekeeper.sh/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" privileged\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" privileged\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 匹配的资源")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kinds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kinds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Deployment"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DaemonSet"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"StatefulSet"')]),t._v("\n        \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get constraints")]),t._v("\nNAME         AGE\nprivileged   31m\n")])])]),s("p",[t._v("创建Deployment开启特权模式再执行创建会发出警告。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("securityContext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("privileged")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n          \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f deployment.yaml")]),t._v("\nError from server ("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("privileged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" 提示：'nginx'容器禁止启用特权！)"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v('error when creating "dp.yaml"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v('admission webhook "validation.gatekeeper.sh" denied the request')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("privileged"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" 提示：'nginx'容器禁止启用特权！\n")])])]),s("h5",{attrs:{id:"案例2-只允许使用特定的镜像仓库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例2-只允许使用特定的镜像仓库"}},[t._v("#")]),t._v(" 案例2：只允许使用特定的镜像仓库")]),t._v(" "),s("ul",[s("li",[t._v("需要创建"),s("code",[t._v("ConstraintTemplate")]),t._v("的资源")]),t._v(" "),s("li",[t._v("使用"),s("code",[t._v("rego")]),t._v("的语言编写对镜像仓库的信任")]),t._v(" "),s("li",[t._v("需要指定类型为"),s("code",[t._v("image-check")]),t._v("模式")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat   image-check_tpl.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" templates.gatekeeper.sh/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConstraintTemplate\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("crd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("names")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("validation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("openAPIV3Schema")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("properties")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 需要满足条件的参数")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prefix")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" string\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targets")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" admission.k8s.gatekeeper.sh\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rego")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n        package image\n        violation[{"msg": msg}] {\n          containers = input.review.object.spec.template.spec.containers\n          image := containers[0].image\n          not startswith(image, input.parameters.prefix)\n          msg := sprintf("提示：\'%v\'镜像地址不在可信任仓库！", [image])\n        }')]),t._v("\n        \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get constrainttemplate")]),t._v("\nNAME          AGE\nimage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check   77s\nprivileged    35m\n")])])]),s("p",[t._v('这里需要配置传递OPA的参数为： "lizhenliang/"')]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat image-check_constraints.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" constraints.gatekeeper.sh/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" image"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kinds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"apps"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kinds")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Deployment"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DaemonSet"')]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"StatefulSet"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("parameters")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 传递给opa的参数")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prefix")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"lizhenliang/"')]),t._v("\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get constraints")]),t._v("\nNAME                                                AGE\nimage"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check.constraints.gatekeeper.sh/image"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("check   77s\n")])])]),s("p",[t._v("执行测试时使用docker官方的镜像仓库：")]),t._v(" "),s("ol",[s("li",[s("code",[t._v("由于我们开启了镜像仓库的信任 所以对docker仓库不支持")])]),t._v(" "),s("li",[s("code",[t._v("只能从lizhenliang该仓库进行拉取镜像")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~/cks/opa"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create deployment test --image=nginx")]),t._v("\nerror: failed to create deployment: admission webhook "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"validation.gatekeeper.sh"')]),t._v(" denied the request: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("image-check"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" 提示："),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'nginx'")]),t._v("镜像地址不在可信任仓库！\n")])])]),s("h3",{attrs:{id:"secret存储敏感数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#secret存储敏感数据"}},[t._v("#")]),t._v(" Secret存储敏感数据")]),t._v(" "),s("p",[t._v("Secret是一个用于存储敏感数据的资源，所有的数据要经过base64编码，数据实际会存储在K8s中Etcd， 然后通过创建Pod时引用该数据。")]),t._v(" "),s("p",[t._v("应用场景：凭据")]),t._v(" "),s("p",[t._v("Pod使用secret数据有两种方式：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("变量注入")])]),t._v(" "),s("li",[s("code",[t._v("数据卷挂载")])])]),t._v(" "),s("h4",{attrs:{id:"secret的类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#secret的类型"}},[t._v("#")]),t._v(" secret的类型")]),t._v(" "),s("p",[t._v("kubectl create secret 支持三种数据类型：")]),t._v(" "),s("ul",[s("li",[t._v("docker-registry：存储镜像仓库认证信息")]),t._v(" "),s("li",[t._v("generic：从文件、目录或者字符串创建，例如存储用户名密码")]),t._v(" "),s("li",[t._v("tls：存储证书，例如HTTPS证书")])]),t._v(" "),s("h4",{attrs:{id:"secret的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#secret的使用"}},[t._v("#")]),t._v(" secret的使用")]),t._v(" "),s("p",[t._v("一个 Secret 可以包含 Pod 访问数据库所需的用户凭证。 例如，由用户名和密码组成的数据库连接字符串。 你 可以在本地计算机上，将用户名存储在文件 "),s("code",[t._v("./username.txt")]),t._v(" 中，将密码存储在文件 "),s("code",[t._v("./password.txt")]),t._v(" 中。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo -n 'admin' > username.txt")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo -n '1a2b3c4d' > password.txt")]),t._v("\n")])])]),s("p",[t._v("在这些命令中， -n 标志确保生成的文件在文本末尾不包含额外的换行符。 这一点很重要，因为当 kubectl 读 取文件并将内容编码为 base64 字符串时，多余的换行符也会被编码。")]),t._v(" "),s("p",[t._v("kubectl create secret 命令将这些文件打包成一个 Secret 并在 API 服务器上创建对象。")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create secret generic db-user-pass --from-file=username.txt --from-file=password.txt")]),t._v("\nsecret/db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pass created\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get secrets db-user-pass -o yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("password.txt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MWEyYjNjNGQ=\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("username.txt")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" YWRtaW4=\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Secret\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("creationTimestamp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-13T06:43:03Z"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pass\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resourceVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"100098"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uid")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 440fa829"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("0135"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("4ef2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("b8dc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("9f06f5a2f2a3\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Opaque\n")])])]),s("h4",{attrs:{id:"解码-secret"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解码-secret"}},[t._v("#")]),t._v(" 解码 Secret")]),t._v(" "),s("p",[t._v("要查看创建的 Secret 的内容，运行以下命令：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get secrets db-user-pass -o jsonpath='{.data}'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password.txt"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MWEyYjNjNGQ="')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username.txt"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"YWRtaW4="')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo 'MWEyYjNjNGQ=' | base64 -d")]),t._v("\n1a2b3c4d\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01:~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# echo 'YWRtaW4=' | base64 -d")]),t._v("\nadmin\n")])])]),s("h3",{attrs:{id:"案例实施-4"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施-4"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h5",{attrs:{id:"示例-将mysql用户密码保存到secret中存储"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-将mysql用户密码保存到secret中存储"}},[t._v("#")]),t._v(" 示例：将Mysql用户密码保存到Secret中存储")]),t._v(" "),s("p",[t._v("创建secret，mysql-root-password的键值是1a2a3a4a")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl create secret generic mysql --from-literal=mysql-root-password=1a2a3a4a")]),t._v("\nsecret/mysql created\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get secrets mysql -o yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mysql-root-password")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MWEyYTNhNGE=\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Secret\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("creationTimestamp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2022-04-13T07:06:21Z"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resourceVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"102066"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uid")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3104256b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("5b46"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("43a4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("85ed"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("acc66be7ccba\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Opaque\n")])])]),s("p",[t._v("创建Pod测试，使用env从secret中引用变量")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat pod.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" master01\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  mysql"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.6")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" MYSQL_ROOT_PASSWORD\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("valueFrom")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("secretKeyRef")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mysql"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("password\n          \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token null important"}},[t._v("~")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods")]),t._v("\nNAME    READY   STATUS    RESTARTS   AGE\nmysql   1/1     Running   0          21s\n")])])]),s("h3",{attrs:{id:"安全沙箱运行容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全沙箱运行容器"}},[t._v("#")]),t._v(" 安全沙箱运行容器")]),t._v(" "),s("h4",{attrs:{id:"gvisor介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gvisor介绍"}},[t._v("#")]),t._v(" gVisor介绍")]),t._v(" "),s("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141224780.png",alt:"image-20220413152858652"}}),t._v(" "),s("p",[t._v("所知，容器的应用程序可以直接访问Linux内核的系统调用，容器在安全隔离上还是比较弱，虽然 内核在不断地增强自身的安全特性，但由于内核自身代码极端复杂，CVE 漏洞层出不穷。 所以要想减少这方面安全风险，就是做好安全隔离，阻断容器内程序对物理机内核的依赖。 Google开源的一种gVisor容器沙箱技术就是采用这种思路，gVisor隔离容器内应用和内核之间访 问，提供了大部分Linux内核的系统调用，巧妙的将容器内进程的系统调用转化为对gVisor的访问。")]),t._v(" "),s("p",[t._v("gVisor兼容OCI，与Docker和K8s无缝集成，很方面使用。")]),t._v(" "),s("p",[t._v("项目地址：https://github.com/google/gvisor")]),t._v(" "),s("h4",{attrs:{id:"gvisor内核交互"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gvisor内核交互"}},[t._v("#")]),t._v(" gVisor内核交互")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204131554215.png",alt:"image-20220413152923179"}})]),t._v(" "),s("h4",{attrs:{id:"gvisor架构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gvisor架构"}},[t._v("#")]),t._v(" gVisor架构")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204131554075.png",alt:"image-20220413153011389"}})]),t._v(" "),s("h4",{attrs:{id:"gvisor与docker集成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gvisor与docker集成"}},[t._v("#")]),t._v(" gVisor与Docker集成")]),t._v(" "),s("p",[t._v("gVisor内核要求：")]),t._v(" "),s("p",[t._v("Linux 3.17+ 如果用的是CentOS7则需要升级内核，Ubuntu不需要。")]),t._v(" "),s("p",[t._v("CentOS7内核升级步骤：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml –y")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# grub2-set-default 0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# reboot")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# uname -r")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 5.17.2-1.el7.elrepo.x86_64")]),t._v("\n")])])]),s("p",[t._v("gVisor集成Docker配置")]),t._v(" "),s("p",[t._v("参考文档：https://gvisor.dev/docs/user_guide/install/")]),t._v(" "),s("p",[t._v("已经测试过的应用和工具：https://gvisor.dev/docs/user_guide/compatibility/")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("、准备gVisor二进制文件\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sha512sum -c runsc.sha512")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# rm -f *.sha512")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod a+x runsc ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod a+x containerd-shim-runsc-v1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# mv runsc containerd-shim-runsc-v1 /usr/local/bin")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("、Docker配置使用gVisor\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# runsc install # 查看加的配置/etc/docker/daemon.json")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart docker")]),t._v("\n\n\n使用runsc运行容器：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run -d --runtime=runsc nginx")]),t._v("\n使用dmesg验证：\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker run --runtime=runsc -it nginx dmesg")]),t._v("\n")])])]),s("h4",{attrs:{id:"gvisor与containerd集成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gvisor与containerd集成"}},[t._v("#")]),t._v(" gVisor与Containerd集成")]),t._v(" "),s("p",[t._v("如果这里是Docker的环境，需要切换到Containerd容器引擎。")]),t._v(" "),s("p",[t._v("仍然需要将runsc 、containerd-shim-runsc-v1工具移到/usr/local/bin下面")]),t._v(" "),s("p",[s("strong",[t._v("1.准备配置")])]),t._v(" "),s("p",[t._v("开启ipv4路由转发配置，重新生效系统配置")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat > /etc/sysctl.d/99-kubernetes-cri.conf << EOF")]),t._v("\nnet.bridge.bridge-nf-call-iptables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.ipv4.ip_forward "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-ip6tables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nEOF\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sysctl -system")]),t._v("\n")])])]),s("p",[s("strong",[t._v("2、安装Containerd")])]),t._v(" "),s("p",[t._v("如果默认安装了docker-ce会自动安装containerd的依赖，没有则需要安装containerd。")]),t._v(" "),s("p",[t._v("ubuntu添加docker-ce的repo源之后apt-get install的方式安装")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /etc/yum.repos.d")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y containerd.io")]),t._v("\n")])])]),s("p",[s("strong",[t._v("3、修改配置文件")])]),t._v(" "),s("ol",[s("li",[t._v("pause镜像地址")]),t._v(" "),s("li",[t._v("Cgroup驱动改为systemd")]),t._v(" "),s("li",[t._v("增加runsc容器运行时")]),t._v(" "),s("li",[t._v("配置docker镜像加速器")])]),t._v(" "),s("p",[t._v("修改配置文件默认的containerd的配置文件是空的，所以需要重新生成一个完整的配置文件。")]),t._v(" "),s("p",[t._v("containerd的目录是在 "),s("code",[t._v("/etc/containerd")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /etc/containerd/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 containerd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# containerd config  default > config.toml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 containerd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim config.toml")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("43")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n \t\t····\n \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改镜像为国内的镜像")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),t._v("     sandbox_image "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"registry.aliyuncs.com/google_containers/pause:3.2"')]),t._v("   \n \t\t···· \n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加一个runsc,指定类型为runsc，这里是跟runc同级")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runsc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  \n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("91")]),t._v("           runtime_type "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.runsc.v1"')]),t._v("   \t\t\t\t  \n\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改systemd驱动为true")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("94")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("103")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runc.options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t\t\t\t···\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("114")]),t._v("            SystemdCgroup "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\t\n \t\t\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加docker仓库的镜像源，配置阿里镜像加速")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("139")]),t._v("       "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".registry.mirrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("140")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".registry.mirrors."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker.io"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  \n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("141")]),t._v("          endpoint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://b9pmyelo.mirror.aliyuncs.com"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[s("strong",[t._v("配置kubelet使用containerd")])]),t._v(" "),s("p",[t._v("配置完之后先重启containerd，再重启kubelet，最后如果pod出现报错，重启docker。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/sysconfig/kubelet ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBELET_EXTRA_ARGS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("--container-runtime"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("remote --container-runtime-endpoint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("unix:///run/containerd/containerd.sock --cgroup-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("systemd\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart containerd")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart kubelet")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart docker")]),t._v("\n")])])]),s("p",[s("strong",[t._v("验证当前的Kubernetes容器基层")])]),t._v(" "),s("ol",[s("li",[s("code",[t._v("以上的步骤需要在所有集群配置")])]),t._v(" "),s("li",[s("code",[t._v("包括crictl连接containerd的配置也要在所有集群运行")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get  node -o wide | awk  '{print $1,$2,$5,$NF}' | column -t")]),t._v("\nNAME      STATUS  VERSION  CONTAINER-RUNTIME\nmaster01  Ready   v1.22.1  containerd://1.5.11\nmaster02  Ready   v1.22.1  containerd://1.5.11\nmaster03  Ready   v1.22.1  containerd://1.5.11\n")])])]),s("p",[s("strong",[t._v("crictl连接containerd")])]),t._v(" "),s("p",[t._v("containerd也有 ctr 管理工具，但功能比较简单，一般使用crictl工具检查和调试容器。")]),t._v(" "),s("p",[t._v("项目地址：https://github.com/kubernetes-sigs/cri-tools/")]),t._v(" "),s("p",[t._v("准备crictl连接containerd配置文件：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat > /etc/crictl.yaml << EOF")]),t._v("\nruntime-endpoint: unix:///run/containerd/containerd.sock\nEOF\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl restart  containerd ")]),t._v("\n")])])]),s("p",[t._v("下面是docker与crictl命令对照表：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204141224352.png",alt:"image-20220414115021436"}})]),t._v(" "),s("h3",{attrs:{id:"案例实施-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#案例实施-5"}},[t._v("#")]),t._v(" 案例实施")]),t._v(" "),s("h5",{attrs:{id:"示例-k8s使用gvisor运行容器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-k8s使用gvisor运行容器"}},[t._v("#")]),t._v(" 示例： K8s使用gVisor运行容器")]),t._v(" "),s("ul",[s("li",[t._v("创建RuntimeClass")]),t._v(" "),s("li",[t._v("绑定RuntimeClass")])]),t._v(" "),s("p",[t._v("RuntimeClass 是一个用于选择容器运行时配置的特性，容器运行时配置用 于运行 Pod 中的容器。")]),t._v(" "),s("p",[t._v("创建RuntimeClass：")]),t._v(" "),s("ul",[s("li",[t._v("这里创建一个名称为"),s("code",[t._v("gvisor")]),t._v("的runtimeclass资源")]),t._v(" "),s("li",[t._v("可以创建多个"),s("code",[t._v("runtimeclass")]),t._v("资源，起到隔离的效果")]),t._v(" "),s("li",[t._v("handler一定是"),s("code",[t._v("runsc")]),t._v("，对应CSI的配置名称")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat runtime.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node.k8s.io/v1 "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RuntimeClass 定义于 node.k8s.io API 组")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" RuntimeClass\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gvisor "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用来引用 RuntimeClass 的名字")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("handler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" runsc "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 对应的 CRI 配置的名称")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get runtimeclasses")]),t._v("\nNAME     HANDLER   AGE\ngvisor   runsc     72m\n")])])]),s("p",[t._v("创建Pod测试gVisor：")]),t._v(" "),s("p",[t._v("这里使用"),s("code",[t._v("runtimeClassName")]),t._v("绑定")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat pod.yaml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"master01"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runtimeClassName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gvisor\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" pod\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods")]),t._v("\nNAME   READY   STATUS    RESTARTS   AGE\npod    1/1     Running   0          72m\n")])])])])}),[],!1,null,null,null);s.default=e.exports}}]);