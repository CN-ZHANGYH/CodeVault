(window.webpackJsonp=window.webpackJsonp||[]).push([[142],{458:function(t,s,a){"use strict";a.r(s);var e=a(7),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"containerd部署kubernetes-v1-23-5"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd部署kubernetes-v1-23-5"}},[t._v("#")]),t._v(" Containerd部署Kubernetes v1.23.5")]),t._v(" "),s("h2",{attrs:{id:"containerd简介"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd简介"}},[t._v("#")]),t._v(" Containerd简介")]),t._v(" "),s("p",[t._v("containerd 是一个工业级标准的容器运行时，它强调简单性、健壮性和可移植性。其诞生于Docker，提供如下功能：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("管理容器的生命周期（从创建容器到销毁容器）")])]),t._v(" "),s("li",[s("code",[t._v("拉取/推送容器镜像")])]),t._v(" "),s("li",[s("code",[t._v("存储管理（管理镜像及容器数据的存储）")])]),t._v(" "),s("li",[s("code",[t._v("调用 runc 运行容器（与 runc 等容器运行时交互）")])]),t._v(" "),s("li",[s("code",[t._v("管理容器网络接口及网络")])])]),t._v(" "),s("h2",{attrs:{id:"containerd架构图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd架构图"}},[t._v("#")]),t._v(" containerd架构图")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204181109068.png",alt:"在这里插入图片描述"}})]),t._v(" "),s("h2",{attrs:{id:"集群要求"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#集群要求"}},[t._v("#")]),t._v(" 集群要求")]),t._v(" "),s("ul",[s("li",[t._v("一台或者多台服务器，操作系统"),s("code",[t._v("Centos7.9")])]),t._v(" "),s("li",[t._v("集群之间所有机器要互通 需要"),s("code",[t._v("关闭防火墙")])]),t._v(" "),s("li",[t._v("可以"),s("code",[t._v("访问外网")]),t._v("，需要拉取镜像")]),t._v(" "),s("li",[s("code",[t._v("禁止swap")]),t._v("分区")]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("Ipvs以及iptables")]),t._v("路由转发")]),t._v(" "),s("li",[t._v("使用"),s("code",[t._v("kubeadm")]),t._v("搭建集群： apiserver、etcd、controller-manager、scheduler、kubelet（systemd守护进程管理，其他组件都是采用容器部署）、kube-proxy")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("IP地址")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("主机名称")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("操作系统")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("底层容器")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("10.11.121.111")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("k8s-master")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("CentOS-7.9")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("containerd")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("10.11.121.112")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("k8s-node1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("CentOS-7.9")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("containerd")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("10.11.121.113")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("k8s-node2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("CentOS-7.9")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("containerd")])])])]),t._v(" "),s("h2",{attrs:{id:"搭建kubernetes-准备环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搭建kubernetes-准备环境"}},[t._v("#")]),t._v(" 搭建Kubernetes（准备环境）")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("准备环境：")]),t._v(" "),s("code",[t._v("请在所有的节点上进行操作")])])]),t._v(" "),s("h3",{attrs:{id:"_1-查看当前的主机内核"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-查看当前的主机内核"}},[t._v("#")]),t._v(" 1.查看当前的主机内核")]),t._v(" "),s("p",[t._v("当前使用的是CentOS7.9的内核，如果需要升级到5.17+则需要三个节点更新内核，这里暂时不更新")]),t._v(" "),s("p",[t._v("修改每个节点的主机名称")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# uname -r ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v(".0-1160.el7.x86_64\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# hostnamectl ")]),t._v("\n   Static hostname: k8s-master\n         Icon name: computer-vm\n           Chassis: vm\n        Machine ID: 6a4d2edbefd14658af278cd43366c8c2\n           Boot ID: a25edbef987a42bb8e5757ab42278501\n    Virtualization: vmware\n  Operating System: CentOS Linux "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n       CPE OS Name: cpe:/o:centos:centos:7\n            Kernel: Linux "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v(".0-1160.el7.x86_64\n      Architecture: x86-64\n")])])]),s("h3",{attrs:{id:"_2-配置host"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-配置host"}},[t._v("#")]),t._v(" 2.配置host")]),t._v(" "),s("p",[t._v("配置三个节点的主机映射，也可以方便后续使用NTP时间服务器")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim /etc/hosts ")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.111 k8s-master\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.112 k8s-node1\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.113 k8s-node2\n")])])]),s("h3",{attrs:{id:"_3-配置yum源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置yum源"}},[t._v("#")]),t._v(" 3.配置yum源")]),t._v(" "),s("p",[t._v("这里使用阿里的CentOS7的YUM源")]),t._v(" "),s("p",[t._v("要先删除本地的所有repo文件之后，拉取新的镜像源，然后执行 "),s("code",[t._v("yum makecache fast")]),t._v("清除缓存")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-o")]),t._v(" /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo\n或者\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-O")]),t._v(" /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo\n")])])]),s("h3",{attrs:{id:"_4-关闭防火墙"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-关闭防火墙"}},[t._v("#")]),t._v(" 4.关闭防火墙")]),t._v(" "),s("p",[t._v("这里不需要开启防火墙，包括seLinux所以需要关闭永久关闭防火墙以及seLinux，然后重启系统")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl stop firewalld && systemctl disable firewalld")]),t._v("\nRemoved symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.\nRemoved symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  setenforce 0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#  sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config')]),t._v("\n")])])]),s("h3",{attrs:{id:"_5-关闭swap"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-关闭swap"}},[t._v("#")]),t._v(" 5.关闭swap")]),t._v(" "),s("p",[t._v("关闭系统交换分区swap（k8s要求关闭swap）")]),t._v(" "),s("p",[t._v("可以使用"),s("code",[t._v("swapoff -a")]),t._v("暂时关闭，也可以通过修改配置文件注释掉"),s("code",[t._v("/etc/fstab中的swap")]),t._v("进行永久关闭。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# swapoff -a")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vi /etc/fstab")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#/dev/mapper/centos-swap     swap      swap     defaults     0     0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#确认swap是否被禁用（输出空值即为禁用）")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /proc/swaps")]),t._v("\nFilename                                Type            Size    Used    Priority\n")])])]),s("h3",{attrs:{id:"_6-加载所需内核模块"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_6-加载所需内核模块"}},[t._v("#")]),t._v(" 6.加载所需内核模块")]),t._v(" "),s("p",[t._v("这里是Kubernetes V1.20+以上需要开启")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf")]),t._v("\noverlay\nbr_netfilter\nEOF\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# modprobe overlay")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# modprobe br_netfilter")]),t._v("\n")])])]),s("h3",{attrs:{id:"_7-配置时间同步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_7-配置时间同步"}},[t._v("#")]),t._v(" 7.配置时间同步")]),t._v(" "),s("p",[t._v("使用ntp同步阿里云的时间这里不做详细说明")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y ntpdate ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ntpdate ntp.aliyun.com")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v(" Apr 09:48:20 ntpdate"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1745")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(": step "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("time")]),t._v(" server "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("203.107")]),t._v(".6.88 offset "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.334239")]),t._v(" sec\n")])])]),s("h3",{attrs:{id:"_8-使用ipvs模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_8-使用ipvs模式"}},[t._v("#")]),t._v(" 8.使用IPvs模式")]),t._v(" "),s("p",[t._v("加载"),s("code",[t._v("ipvs模块")]),t._v("（可选项，默认为iptables模式）")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("kuber-proxy代理支持iptables和ipvs两种模式，如果使用ipvs模式需要在初始化集群前所有节点加载ipvs模块并安装ipset工具，Linux kernel 4.19以上的内核版本使用nf_conntrack代替nf_conntrack_ipv4")])]),t._v(" "),s("li",[s("p",[t._v("此外还需要安装ipset、ipvsadm相关的软件包")])])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /etc/modules-load.d/ipvs.modules ")]),t._v("\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack_ipv4\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# chmod 755 /etc/modules-load.d/ipvs.modules ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# bash /etc/modules-load.d/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4")]),t._v("\nnf_conntrack_ipv4      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15053")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \nnf_defrag_ipv4         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12729")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" nf_conntrack_ipv4\nip_vs_sh               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12688")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \nip_vs_wrr              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12697")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \nip_vs_rr               "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12600")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" \nip_vs                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("145458")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(" ip_vs_rr,ip_vs_sh,ip_vs_wrr\nnf_conntrack          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("139264")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" ip_vs,nf_conntrack_ipv4\nlibcrc32c              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("12644")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" xfs,ip_vs,nf_conntrack\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  yum install -y ipset ipvsadm")]),t._v("\n")])])]),s("h3",{attrs:{id:"_9-配置iptables路由转发"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_9-配置iptables路由转发"}},[t._v("#")]),t._v(" 9.配置Iptables路由转发")]),t._v(" "),s("p",[t._v("设置sysctl 参数，允许iptables检查桥接流量，这些参数在重新启动后仍然存在")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim /etc/sysctl.d/k8s.conf ")]),t._v("\nnet.bridge.bridge-nf-call-iptables  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.ipv4.ip_forward                 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-ip6tables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# sysctl --system ")]),t._v("\n")])])]),s("h3",{attrs:{id:"_10-配置kubernetes的源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_10-配置kubernetes的源"}},[t._v("#")]),t._v(" 10.配置Kubernetes的源")]),t._v(" "),s("p",[t._v("所有节点配置kubernetes软件源（使用清华大学镜像源）")]),t._v(" "),s("p",[t._v("当前的阿里云的Kubernetes的源以及华为的Kubernetes源经常性出现问题，所以使用清华大学的。")]),t._v(" "),s("p",[t._v("配置Kubernetes的yum源")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim  /etc/yum.repos.d/kubernetes.repo ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubernetes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("Kubernetes\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("baseurl")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://mirrors.tuna.tsinghua.edu.cn/kubernetes/yum/repos/kubernetes-el7-x86_64/\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("enabled")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("gpgcheck")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])]),s("p",[t._v("安装kubernetes相关的软件")]),t._v(" "),s("p",[t._v("不指定默认版本就是最新，可以指定相对应的版本。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y  kubeadm kubelet kubectl ")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#指定版本号安装")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y kubelet-1.23.1 kubeadm-1.23.1 kubectl-1.23.1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl enable kubelet && systemctl start kubelet ")]),t._v("\nCreated symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service.\n")])])]),s("h2",{attrs:{id:"配置containerd环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置containerd环境"}},[t._v("#")]),t._v(" 配置Containerd环境")]),t._v(" "),s("p",[t._v("配置kubelet使用containerd作为容器运行时，指定cgroupDriver为systemd模式（两种方法实现）")]),t._v(" "),s("h3",{attrs:{id:"方法一"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法一"}},[t._v("#")]),t._v(" 方法一")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("在Master节点上配置")])])]),t._v(" "),s("p",[t._v("配置kubelet使用containerd（所有节点都要配置"),s("code",[t._v("cgroup-driver=systemd")]),t._v("参数，否则node节点无法自动下载和创建pod）")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#cat > /etc/sysconfig/kubelet <<EOF")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBELET_EXTRA_ARGS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("--container-runtime"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("remote --container-runtime-endpoint"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("unix:///run/containerd/containerd.sock --cgroup-driver"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("systemd\nEOF\n")])])]),s("h3",{attrs:{id:"方法二"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方法二"}},[t._v("#")]),t._v(" 方法二")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("在Master节点上配置")])])]),t._v(" "),s("p",[t._v("如果不想修改"),s("code",[t._v("/etc/sysconfig/kubelet")]),t._v("配置，"),s("code",[t._v("kubeadm init必须使用yaml")]),t._v("文件来初始化传递"),s("code",[t._v("cgroupDriver")]),t._v("参数，可以通过如下命令导出默认的初始化配置")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[root@k8s-master ~]# kubeadm config print init-defaults > kubeadm-config.yaml\n")])])]),s("p",[t._v("然后根据自己的需求修改配置：")]),t._v(" "),s("ol",[s("li",[t._v("配置"),s("code",[t._v("advertiseAddress")]),t._v("参数为master的节点IP地址")]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("criSocket")]),t._v("参数为"),s("code",[t._v("/run/containerd/containerd.sock")])]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("taints")]),t._v("参数给当前master节点添加污点")]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("imageRepository")]),t._v("的参数为"),s("code",[t._v("registry.aliyuncs.com/google_containers")]),t._v(" ，当前为阿里的仓库")]),t._v(" "),s("li",[t._v("配置"),s("code",[t._v("kube-proxy")]),t._v("的模式为ipvs")]),t._v(" "),s("li",[t._v("添加"),s("code",[t._v("podSubnet")]),t._v("为10.244.0.0/16")]),t._v(" "),s("li",[t._v("使用containerd作为运行时，所以在初始化节点的时候需要指定cgroupDriver为systemd模式")])]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat  kubeadm-config.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubeadm.k8s.io/v1beta3\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bootstrapTokens")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("groups")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" system"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("bootstrappers"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kubeadm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("default"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("token\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("token")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" abcdef.0123456789abcdef\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ttl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 24h0m0s\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("usages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" signing\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" authentication\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" InitConfiguration\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("localAPIEndpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加IP地址")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("advertiseAddress")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.11.121.111\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("bindPort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("6443")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodeRegistration")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改为containerd的容器底层")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("criSocket")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /run/containerd/containerd.sock \n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master \n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加Master的污点")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("taints")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("effect")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" NoSchedule\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("role.kubernetes.io/master \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiServer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeoutForControlPlane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 4m0s\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubeadm.k8s.io/v1beta3\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("certificatesDir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/kubernetes/pki\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubernetes\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("controllerManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dns")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("etcd")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dataDir")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /var/lib/etcd\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改为阿里云的镜像地址")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imageRepository")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" registry.aliyuncs.com/google_containers\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterConfiguration\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetesVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1.23.0\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("networking")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dnsDomain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cluster.local\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加Pod的网段")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("podSubnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.244.0.0/16\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("serviceSubnet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10.96.0.0/12\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scheduler")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("    \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加kube-proxy的模式为IPvs")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubeproxy.config.k8s.io/v1alpha1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" KubeProxyConfiguration\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ipvs\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加containerd的驱动")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubelet.config.k8s.io/v1beta1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" KubeletConfiguration\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cgroupDriver")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" systemd\n")])])]),s("h2",{attrs:{id:"部署containerd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署containerd"}},[t._v("#")]),t._v(" 部署Containerd")]),t._v(" "),s("blockquote",[s("p",[s("strong",[t._v("Containerd：")]),t._v(" "),s("code",[t._v("请在所有节点上部署")])])]),t._v(" "),s("h3",{attrs:{id:"_1-安装containerd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装containerd"}},[t._v("#")]),t._v(" 1.安装containerd")]),t._v(" "),s("p",[t._v("所有节点配置containerd软件源（containerd组件默认在docker-ce源中）")]),t._v(" "),s("p",[t._v("使用yum search可以查看当前的containerd的版本有哪些")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum install -y yum-utils device-mapper-persistent-data lvm2 ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看containerd.io可用版本")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum search containerd.io --showduplicates")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# yum -y install containerd.io")]),t._v("\n")])])]),s("h3",{attrs:{id:"_2-修改配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-修改配置文件"}},[t._v("#")]),t._v(" 2.修改配置文件")]),t._v(" "),s("ol",[s("li",[t._v("pause镜像地址")]),t._v(" "),s("li",[t._v("Cgroup驱动改为systemd")]),t._v(" "),s("li",[t._v("增加runsc容器运行时")]),t._v(" "),s("li",[t._v("配置docker镜像加速器")])]),t._v(" "),s("p",[t._v("修改配置文件默认的containerd的配置文件是空的，所以需要重新生成一个完整的配置文件。")]),t._v(" "),s("p",[t._v("containerd的目录是在 "),s("code",[t._v("/etc/containerd")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cd /etc/containerd/")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 containerd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# containerd config  default > config.toml")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@master01 containerd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vim config.toml")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("43")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n \t\t····\n \t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改镜像为国内的镜像")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),t._v("     sandbox_image "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"registry.aliyuncs.com/google_containers/pause:3.2"')]),t._v("   \n \t\t···· \n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加一个runsc,指定类型为runsc，这里是跟runc同级")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("90")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runsc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  \n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("91")]),t._v("           runtime_type "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.runsc.v1"')]),t._v("   \t\t\t\t  \n\n\t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改systemd驱动为true")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("94")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("103")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".containerd.runtimes.runc.options"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\t\t\t\t···\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("114")]),t._v("            SystemdCgroup "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\t\n \t\t\n \t\t\t"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 添加docker仓库的镜像源，配置阿里镜像加速")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("139")]),t._v("       "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".registry.mirrors"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("140")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io.containerd.grpc.v1.cri"')]),t._v(".registry.mirrors."),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker.io"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("  \n "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("141")]),t._v("          endpoint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://b9pmyelo.mirror.aliyuncs.com"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h3",{attrs:{id:"_3-cri客户端工具crictl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-cri客户端工具crictl"}},[t._v("#")]),t._v(" 3.CRI客户端工具crictl")]),t._v(" "),s("p",[t._v("工具下载地址：https://github.com/kubernetes-sigs/cri-tools/releases/")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202204181219630.png",alt:"image-20220418121928718"}})]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.23.0/crictl-v1.23.0-linux-amd64.tar.gz")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tar zxvf crictl-v1.23.0-linux-amd64.tar.gz  -C /usr/local/bin/ ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# crictl --version ")]),t._v("\ncrictl version v1.23.0\n")])])]),s("p",[t._v("添加crictl连接containerd的配置文件")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cat /etc/crictl.yaml ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runtime-endpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" unix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("///run/containerd/containerd.sock\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image-endpoint")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" unix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("///run/containerd/containerd.sock\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("debug")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v(" \n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl daemon-reload ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# systemctl enable containerd && systemctl restart containerd ")]),t._v("\n")])])]),s("p",[t._v("或执行以下语句添加参数")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# crictl config runtime-endpoint unix:/run/containerd/containerd.sock")]),t._v("\n")])])]),s("p",[t._v("拉取镜像验证是否成功")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# crictl pull nginx ")]),t._v("\nImage is up to "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("date")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# crictl images")]),t._v("\nIMAGE                \t\tTAG                 IMAGE ID            SIZE\ndocker.io/library/nginx      latest              605c77e624ddb       "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("56")]),t._v(".7MB\n")])])]),s("h2",{attrs:{id:"在master节点启动集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在master节点启动集群"}},[t._v("#")]),t._v(" 在master节点启动集群")]),t._v(" "),s("h3",{attrs:{id:"_1-1使用kubeadm命令部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1使用kubeadm命令部署"}},[t._v("#")]),t._v(" 1-1使用kubeadm命令部署")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("–-apiserver-advertise-address")]),t._v(" 集群通告地址")]),t._v(" "),s("li",[s("code",[t._v("–-image-repository")]),t._v(" 由于默认的拉取镜像地址k8s.gcr.io国内无法访问，这里使用阿里云镜像仓库地址")]),t._v(" "),s("li",[s("code",[t._v("–-kubernetes-version")]),t._v(" k8s的版本")]),t._v(" "),s("li",[s("code",[t._v("–-service-cidr")]),t._v(" 集群内部虚拟网络，Pod的统一访问入口")]),t._v(" "),s("li",[s("code",[t._v("–-pod-network-cidr")]),t._v(" Pod的网络，与下面部署的CNI网络组件yaml中保持一致")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubeadm init \\")]),t._v("\n--apiserver-advertise-address"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.10")]),t._v(".10.128 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--image-repository registry.aliyuncs.com/google_containers "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubernetes-version v1.23.1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--service-cidr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.0/12 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--pod-network-cidr"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".0.0/16 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--ignore-preflight-errors"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("all \n")])])]),s("h3",{attrs:{id:"_1-2使用配置文件启动集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2使用配置文件启动集群"}},[t._v("#")]),t._v(" 1-2使用配置文件启动集群")]),t._v(" "),s("p",[t._v("这里我使用配置文件初始化Kubernetes集群")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubeadm init --config=kubeadm-config.yaml")]),t._v("\n···\nYour Kubernetes control-plane has initialized successfully"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#非root用户")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" /etc/kubernetes/admin.conf "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n\nAlternatively, "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" you are the root user, you can run:\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#root用户")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubectl apply -f [podnetwork].yaml"')]),t._v(" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" any number of worker nodes by running the following on each as root:\n\nkubeadm "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.111:6443 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--token")]),t._v(" abcdef.0123456789abcdef "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n\t--discovery-token-ca-cert-hash sha256:637d4427138d3ca87f32bf57e3a16e85cc806cbbf2dc25b475cf0bec9504a95f \n\n\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-i")]),t._v(" /etc/kubernetes/admin.conf "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("chown")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$HOME")]),t._v("/.kube/config\n")])])]),s("h3",{attrs:{id:"_2-部署容器网络cni"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-部署容器网络cni"}},[t._v("#")]),t._v(" 2.部署容器网络CNI")]),t._v(" "),s("p",[s("code",[t._v("Calico是一个纯三层的数据中心网络方案")]),t._v("，Calico支持广泛的平台，包括Kubernetes、OpenStack等。")]),t._v(" "),s("p",[t._v("Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。")]),t._v(" "),s("p",[t._v("此外，Calico 项目还实现了 Kubernetes 网络策略，提供ACL功能。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'拉取Pod网络插件'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'原因：coredns一直停滞在Pending，需要手动拉取, 最后选择的网络插件是：calico。'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get  pods -A ")]),t._v("\nNAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE\nkube-system   coredns-6d8c4cb4d-44wlk              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          16s\nkube-system   coredns-6d8c4cb4d-dvjms              "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Pending   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          16s\nkube-system   etcd-k8s-master                      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          36s\nkube-system   kube-apiserver-k8s-master            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          28s\nkube-system   kube-controller-manager-k8s-master   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          27s\nkube-system   kube-proxy-qtmsd                     "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          17s\nkube-system   kube-scheduler-k8s-master            "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          33s\n\n")])])]),s("p",[t._v("部署calico网络组件（默认模式）")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml")]),t._v("\nconfigmap/calico-config created\ncustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.apps/calico-node created\nserviceaccount/calico-node created\ndeployment.apps/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\nWarning: policy/v1beta1 PodDisruptionBudget is deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.21+, unavailable "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.25+"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" use policy/v1 PodDisruptionBudget\npoddisruptionbudget.policy/calico-kube-controllers created\n")])])]),s("p",[t._v("再次查看当前的Pod启动情况：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get pods -A ")]),t._v("\nNAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE\nkube-system   calico-kube-controllers-7c845d499-qr7cw   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          99m\nkube-system   calico-node-288zk                         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          99m\nkube-system   calico-node-7dhnc                         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          97m\nkube-system   calico-node-z78p4                         "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          97m\nkube-system   coredns-6d8c4cb4d-44wlk                   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   coredns-6d8c4cb4d-dvjms                   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   etcd-k8s-master                           "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   kube-apiserver-k8s-master                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   kube-controller-manager-k8s-master        "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   kube-proxy-qtmsd                          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\nkube-system   kube-proxy-whjpj                          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          97m\nkube-system   kube-proxy-xnjs9                          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          97m\nkube-system   kube-scheduler-k8s-master                 "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          100m\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get cs ")]),t._v("\nWarning: v1 ComponentStatus is deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" v1.19+\nNAME                 STATUS    MESSAGE                         ERROR\nscheduler            Healthy   ok                              \ncontroller-manager   Healthy   ok                              \netcd-0               Healthy   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"health"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(","),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"reason"')]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   \n")])])]),s("h3",{attrs:{id:"_3-加入集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-加入集群"}},[t._v("#")]),t._v(" 3.加入集群")]),t._v(" "),s("p",[t._v("在master初始化集群之后,复制kubeadm join字段")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-node1 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubeadm join 10.11.121.111:6443 --token abcdef.0123456789abcdef \\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" --discovery-token-ca-cert-hash sha256:637d4427138d3ca87f32bf57e3a16e85cc806cbbf2dc25b475cf0bec9504a95f\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Running pre-flight checks\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Reading configuration from the cluster"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("preflight"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" FYI: You can "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("look")]),t._v(" at this config "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" with "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubectl -n kube-system get cm kubeadm-config -o yaml'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing kubelet configuration to "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/kubelet/config.yaml"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Writing kubelet environment "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" with flags to "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/kubelet/kubeadm-flags.env"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Starting the kubelet\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("kubelet-start"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Waiting "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" the kubelet to perform the TLS Bootstrap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n\nThis "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'kubectl get nodes'")]),t._v(" on the control-plane to see this "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),t._v(" the cluster.\n")])])]),s("h3",{attrs:{id:"_4-验证集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-验证集群"}},[t._v("#")]),t._v(" 4.验证集群")]),t._v(" "),s("ol",[s("li",[t._v("查看当前容器的底层是否为containerd")]),t._v(" "),s("li",[t._v("查看当前集群是否使用ipvs的模式")]),t._v(" "),s("li",[t._v("查看ipvs转发状态")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# kubectl get node -o wide ")]),t._v("\nNAME         STATUS   ROLES                  AGE    VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME\nk8s-master   Ready    control-plane,master   120m   v1.23.5   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.111   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        CentOS Linux "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v(".0-1160.el7.x86_64   containerd://1.5.11\nk8s-node1    Ready    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("                 117m   v1.23.5   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.112   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        CentOS Linux "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v(".0-1160.el7.x86_64   containerd://1.5.11\nk8s-node2    Ready    "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("                 117m   v1.23.5   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.113   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        CentOS Linux "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Core"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.10")]),t._v(".0-1160.el7.x86_64   containerd://1.5.11\n\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#  kubectl -n kube-system get cm kube-proxy -o yaml | grep mode")]),t._v("\n    mode: ipvs\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("root@k8s-master ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ipvsadm -ln ")]),t._v("\nIP Virtual Server version "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v(".1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("size"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nProt LocalAddress:Port Scheduler Flags\n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" RemoteAddress:Port           Forward Weight ActiveConn InActConn\nTCP  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.1:443 rr\n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.11")]),t._v(".121.111:6443           Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("7")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \nTCP  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10:53 rr\n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.194:53            Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.195:53            Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \nTCP  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10:9153 rr\n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.194:9153          Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.195:9153          Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \nUDP  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.96")]),t._v(".0.10:53 rr\n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.194:53            Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("         \n  -"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.244")]),t._v(".235.195:53            Masq    "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("      "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("  \n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);