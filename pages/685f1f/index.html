<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>企业碳排放解决方案合约案例 | CodeVault文档站</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/CodeVault/img/Aj.svg">
    <meta name="description" content="CodeVault一个记录云计算、云原生、Java开发的文档站。">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/CodeVault/assets/css/0.styles.bcdd6f38.css" as="style"><link rel="preload" href="/CodeVault/assets/js/app.ef278985.js" as="script"><link rel="preload" href="/CodeVault/assets/js/2.f96441c8.js" as="script"><link rel="preload" href="/CodeVault/assets/js/224.6bed6414.js" as="script"><link rel="prefetch" href="/CodeVault/assets/js/10.0b981dbd.js"><link rel="prefetch" href="/CodeVault/assets/js/100.5c06c78f.js"><link rel="prefetch" href="/CodeVault/assets/js/101.88d67c9c.js"><link rel="prefetch" href="/CodeVault/assets/js/102.70928850.js"><link rel="prefetch" href="/CodeVault/assets/js/103.ef636770.js"><link rel="prefetch" href="/CodeVault/assets/js/104.c1927b63.js"><link rel="prefetch" href="/CodeVault/assets/js/105.85c8a7cd.js"><link rel="prefetch" href="/CodeVault/assets/js/106.fb2e66ea.js"><link rel="prefetch" href="/CodeVault/assets/js/107.0f35bf63.js"><link rel="prefetch" href="/CodeVault/assets/js/108.fccb735c.js"><link rel="prefetch" href="/CodeVault/assets/js/109.682036f0.js"><link rel="prefetch" href="/CodeVault/assets/js/11.ac4d24fe.js"><link rel="prefetch" href="/CodeVault/assets/js/110.b7f8edea.js"><link rel="prefetch" href="/CodeVault/assets/js/111.fd94666b.js"><link rel="prefetch" href="/CodeVault/assets/js/112.a07708f0.js"><link rel="prefetch" href="/CodeVault/assets/js/113.63efff87.js"><link rel="prefetch" href="/CodeVault/assets/js/114.ab1099fa.js"><link rel="prefetch" href="/CodeVault/assets/js/115.f5fe6b28.js"><link rel="prefetch" href="/CodeVault/assets/js/116.6ce08e8e.js"><link rel="prefetch" href="/CodeVault/assets/js/117.48dbb04e.js"><link rel="prefetch" href="/CodeVault/assets/js/118.5b909be0.js"><link rel="prefetch" href="/CodeVault/assets/js/119.8f6e0bf7.js"><link rel="prefetch" href="/CodeVault/assets/js/12.c1e5feb4.js"><link rel="prefetch" href="/CodeVault/assets/js/120.21cc7ba5.js"><link rel="prefetch" href="/CodeVault/assets/js/121.04134de2.js"><link rel="prefetch" href="/CodeVault/assets/js/122.31567951.js"><link rel="prefetch" href="/CodeVault/assets/js/123.002f9bee.js"><link rel="prefetch" href="/CodeVault/assets/js/124.e99e860a.js"><link rel="prefetch" href="/CodeVault/assets/js/125.72c926b3.js"><link rel="prefetch" href="/CodeVault/assets/js/126.01a5e87f.js"><link rel="prefetch" href="/CodeVault/assets/js/127.1956ebe6.js"><link rel="prefetch" href="/CodeVault/assets/js/128.d65996f5.js"><link rel="prefetch" href="/CodeVault/assets/js/129.67eabc56.js"><link rel="prefetch" href="/CodeVault/assets/js/13.13f84e24.js"><link rel="prefetch" href="/CodeVault/assets/js/130.634c4ce3.js"><link rel="prefetch" href="/CodeVault/assets/js/131.a418f195.js"><link rel="prefetch" href="/CodeVault/assets/js/132.ea662f19.js"><link rel="prefetch" href="/CodeVault/assets/js/133.63b2b38b.js"><link rel="prefetch" href="/CodeVault/assets/js/134.0cd9f3da.js"><link rel="prefetch" href="/CodeVault/assets/js/135.4e8913a1.js"><link rel="prefetch" href="/CodeVault/assets/js/136.53ad8182.js"><link rel="prefetch" href="/CodeVault/assets/js/137.8d8f6ff4.js"><link rel="prefetch" href="/CodeVault/assets/js/138.1e5627de.js"><link rel="prefetch" href="/CodeVault/assets/js/139.4c335178.js"><link rel="prefetch" href="/CodeVault/assets/js/14.92742bc3.js"><link rel="prefetch" href="/CodeVault/assets/js/140.ad32a483.js"><link rel="prefetch" href="/CodeVault/assets/js/141.509650db.js"><link rel="prefetch" href="/CodeVault/assets/js/142.8a4692a4.js"><link rel="prefetch" href="/CodeVault/assets/js/143.4226943d.js"><link rel="prefetch" href="/CodeVault/assets/js/144.a04016d3.js"><link rel="prefetch" href="/CodeVault/assets/js/145.55b32ea3.js"><link rel="prefetch" href="/CodeVault/assets/js/146.d78a1fa5.js"><link rel="prefetch" href="/CodeVault/assets/js/147.c48fa78d.js"><link rel="prefetch" href="/CodeVault/assets/js/148.24a7cd95.js"><link rel="prefetch" href="/CodeVault/assets/js/149.a74e35f1.js"><link rel="prefetch" href="/CodeVault/assets/js/15.6953f44b.js"><link rel="prefetch" href="/CodeVault/assets/js/150.7f27817b.js"><link rel="prefetch" href="/CodeVault/assets/js/151.6445d326.js"><link rel="prefetch" href="/CodeVault/assets/js/152.eadc171d.js"><link rel="prefetch" href="/CodeVault/assets/js/153.2da9c7f8.js"><link rel="prefetch" href="/CodeVault/assets/js/154.a3546076.js"><link rel="prefetch" href="/CodeVault/assets/js/155.351a616f.js"><link rel="prefetch" href="/CodeVault/assets/js/156.e6bbf3b3.js"><link rel="prefetch" href="/CodeVault/assets/js/157.ee152deb.js"><link rel="prefetch" href="/CodeVault/assets/js/158.076e0f8c.js"><link rel="prefetch" href="/CodeVault/assets/js/159.9ad1744e.js"><link rel="prefetch" href="/CodeVault/assets/js/16.df859e45.js"><link rel="prefetch" href="/CodeVault/assets/js/160.c5beea39.js"><link rel="prefetch" href="/CodeVault/assets/js/161.0cf956e1.js"><link rel="prefetch" href="/CodeVault/assets/js/162.c58e81e1.js"><link rel="prefetch" href="/CodeVault/assets/js/163.63d65593.js"><link rel="prefetch" href="/CodeVault/assets/js/164.9626ab8a.js"><link rel="prefetch" href="/CodeVault/assets/js/165.fc09035b.js"><link rel="prefetch" href="/CodeVault/assets/js/166.b38be38b.js"><link rel="prefetch" href="/CodeVault/assets/js/167.8f5417ed.js"><link rel="prefetch" href="/CodeVault/assets/js/168.d636e649.js"><link rel="prefetch" href="/CodeVault/assets/js/169.dd84c459.js"><link rel="prefetch" href="/CodeVault/assets/js/17.a2971fe6.js"><link rel="prefetch" href="/CodeVault/assets/js/170.a488616f.js"><link rel="prefetch" href="/CodeVault/assets/js/171.a7896a98.js"><link rel="prefetch" href="/CodeVault/assets/js/172.90b58f0e.js"><link rel="prefetch" href="/CodeVault/assets/js/173.ce66d68a.js"><link rel="prefetch" href="/CodeVault/assets/js/174.d0a94b6a.js"><link rel="prefetch" href="/CodeVault/assets/js/175.87ea7df7.js"><link rel="prefetch" href="/CodeVault/assets/js/176.67abf34b.js"><link rel="prefetch" href="/CodeVault/assets/js/177.3b2acda5.js"><link rel="prefetch" href="/CodeVault/assets/js/178.5fe697a5.js"><link rel="prefetch" href="/CodeVault/assets/js/179.57349e36.js"><link rel="prefetch" href="/CodeVault/assets/js/18.45b06c71.js"><link rel="prefetch" href="/CodeVault/assets/js/180.a8b6136e.js"><link rel="prefetch" href="/CodeVault/assets/js/181.c96cb1ac.js"><link rel="prefetch" href="/CodeVault/assets/js/182.e13a2ed6.js"><link rel="prefetch" href="/CodeVault/assets/js/183.4982d955.js"><link rel="prefetch" href="/CodeVault/assets/js/184.123e3912.js"><link rel="prefetch" href="/CodeVault/assets/js/185.c1db2bfa.js"><link rel="prefetch" href="/CodeVault/assets/js/186.bff6dc40.js"><link rel="prefetch" href="/CodeVault/assets/js/187.3e10e06d.js"><link rel="prefetch" href="/CodeVault/assets/js/188.53f01570.js"><link rel="prefetch" href="/CodeVault/assets/js/189.53c9b973.js"><link rel="prefetch" href="/CodeVault/assets/js/19.21381c2f.js"><link rel="prefetch" href="/CodeVault/assets/js/190.f9e298a3.js"><link rel="prefetch" href="/CodeVault/assets/js/191.7055ec43.js"><link rel="prefetch" href="/CodeVault/assets/js/192.6083d608.js"><link rel="prefetch" href="/CodeVault/assets/js/193.72e5d099.js"><link rel="prefetch" href="/CodeVault/assets/js/194.cb4c2f87.js"><link rel="prefetch" href="/CodeVault/assets/js/195.add61432.js"><link rel="prefetch" href="/CodeVault/assets/js/196.cafb716f.js"><link rel="prefetch" href="/CodeVault/assets/js/197.29ad1cb1.js"><link rel="prefetch" href="/CodeVault/assets/js/198.1ca9886c.js"><link rel="prefetch" href="/CodeVault/assets/js/199.28f7095d.js"><link rel="prefetch" href="/CodeVault/assets/js/20.fe478246.js"><link rel="prefetch" href="/CodeVault/assets/js/200.cdd91d66.js"><link rel="prefetch" href="/CodeVault/assets/js/201.568571d0.js"><link rel="prefetch" href="/CodeVault/assets/js/202.0b55d1cd.js"><link rel="prefetch" href="/CodeVault/assets/js/203.c9d7036e.js"><link rel="prefetch" href="/CodeVault/assets/js/204.f877fa44.js"><link rel="prefetch" href="/CodeVault/assets/js/205.f7dcea25.js"><link rel="prefetch" href="/CodeVault/assets/js/206.266f6bb0.js"><link rel="prefetch" href="/CodeVault/assets/js/207.962cdf0e.js"><link rel="prefetch" href="/CodeVault/assets/js/208.dcbb7fb9.js"><link rel="prefetch" href="/CodeVault/assets/js/209.89cb12fb.js"><link rel="prefetch" href="/CodeVault/assets/js/21.1a17ddc5.js"><link rel="prefetch" href="/CodeVault/assets/js/210.442ced55.js"><link rel="prefetch" href="/CodeVault/assets/js/211.6d14fe33.js"><link rel="prefetch" href="/CodeVault/assets/js/212.65a1883d.js"><link rel="prefetch" href="/CodeVault/assets/js/213.21351702.js"><link rel="prefetch" href="/CodeVault/assets/js/214.bd781706.js"><link rel="prefetch" href="/CodeVault/assets/js/215.f30b644c.js"><link rel="prefetch" href="/CodeVault/assets/js/216.587501ff.js"><link rel="prefetch" href="/CodeVault/assets/js/217.8db2123f.js"><link rel="prefetch" href="/CodeVault/assets/js/218.aa6b1af6.js"><link rel="prefetch" href="/CodeVault/assets/js/219.2b27640b.js"><link rel="prefetch" href="/CodeVault/assets/js/22.7652d0d6.js"><link rel="prefetch" href="/CodeVault/assets/js/220.eafe6218.js"><link rel="prefetch" href="/CodeVault/assets/js/221.ab153f73.js"><link rel="prefetch" href="/CodeVault/assets/js/222.4f7df33b.js"><link rel="prefetch" href="/CodeVault/assets/js/223.6f5b1e03.js"><link rel="prefetch" href="/CodeVault/assets/js/225.03a64323.js"><link rel="prefetch" href="/CodeVault/assets/js/226.2db9dc4b.js"><link rel="prefetch" href="/CodeVault/assets/js/227.6e01bc51.js"><link rel="prefetch" href="/CodeVault/assets/js/228.d06cad32.js"><link rel="prefetch" href="/CodeVault/assets/js/229.3f46b203.js"><link rel="prefetch" href="/CodeVault/assets/js/23.8a5bbf3f.js"><link rel="prefetch" href="/CodeVault/assets/js/230.b84fd605.js"><link rel="prefetch" href="/CodeVault/assets/js/231.ca2e1834.js"><link rel="prefetch" href="/CodeVault/assets/js/232.e572f662.js"><link rel="prefetch" href="/CodeVault/assets/js/233.0a7e6deb.js"><link rel="prefetch" href="/CodeVault/assets/js/234.9dddbcb6.js"><link rel="prefetch" href="/CodeVault/assets/js/235.b4ed574b.js"><link rel="prefetch" href="/CodeVault/assets/js/236.252b1f69.js"><link rel="prefetch" href="/CodeVault/assets/js/237.c529d9c4.js"><link rel="prefetch" href="/CodeVault/assets/js/238.16da920c.js"><link rel="prefetch" href="/CodeVault/assets/js/239.14f7892d.js"><link rel="prefetch" href="/CodeVault/assets/js/24.1ca1bd80.js"><link rel="prefetch" href="/CodeVault/assets/js/240.d00a46df.js"><link rel="prefetch" href="/CodeVault/assets/js/25.43c779a1.js"><link rel="prefetch" href="/CodeVault/assets/js/26.bdfe293e.js"><link rel="prefetch" href="/CodeVault/assets/js/27.330c11f5.js"><link rel="prefetch" href="/CodeVault/assets/js/28.46dfe7f4.js"><link rel="prefetch" href="/CodeVault/assets/js/29.4fc19b1e.js"><link rel="prefetch" href="/CodeVault/assets/js/3.44fcbdc8.js"><link rel="prefetch" href="/CodeVault/assets/js/30.da1d9fd7.js"><link rel="prefetch" href="/CodeVault/assets/js/31.df871787.js"><link rel="prefetch" href="/CodeVault/assets/js/32.e62268d4.js"><link rel="prefetch" href="/CodeVault/assets/js/33.b2c675b0.js"><link rel="prefetch" href="/CodeVault/assets/js/34.461e2f23.js"><link rel="prefetch" href="/CodeVault/assets/js/35.2666157f.js"><link rel="prefetch" href="/CodeVault/assets/js/36.b55a4b34.js"><link rel="prefetch" href="/CodeVault/assets/js/37.556ba5c1.js"><link rel="prefetch" href="/CodeVault/assets/js/38.8c982590.js"><link rel="prefetch" href="/CodeVault/assets/js/39.a7850266.js"><link rel="prefetch" href="/CodeVault/assets/js/4.8a0557a7.js"><link rel="prefetch" href="/CodeVault/assets/js/40.9a11a440.js"><link rel="prefetch" href="/CodeVault/assets/js/41.c3a71e10.js"><link rel="prefetch" href="/CodeVault/assets/js/42.7e9779c1.js"><link rel="prefetch" href="/CodeVault/assets/js/43.e017fec5.js"><link rel="prefetch" href="/CodeVault/assets/js/44.22c5aef3.js"><link rel="prefetch" href="/CodeVault/assets/js/45.dfe95d23.js"><link rel="prefetch" href="/CodeVault/assets/js/46.10af373d.js"><link rel="prefetch" href="/CodeVault/assets/js/47.a1e4779a.js"><link rel="prefetch" href="/CodeVault/assets/js/48.3142bf91.js"><link rel="prefetch" href="/CodeVault/assets/js/49.08546fe2.js"><link rel="prefetch" href="/CodeVault/assets/js/5.1bad1047.js"><link rel="prefetch" href="/CodeVault/assets/js/50.75c37eaf.js"><link rel="prefetch" href="/CodeVault/assets/js/51.b2f39f65.js"><link rel="prefetch" href="/CodeVault/assets/js/52.97fc3d07.js"><link rel="prefetch" href="/CodeVault/assets/js/53.1a2a51df.js"><link rel="prefetch" href="/CodeVault/assets/js/54.09f7dfd6.js"><link rel="prefetch" href="/CodeVault/assets/js/55.d112e5e2.js"><link rel="prefetch" href="/CodeVault/assets/js/56.b7b00837.js"><link rel="prefetch" href="/CodeVault/assets/js/57.5beac805.js"><link rel="prefetch" href="/CodeVault/assets/js/58.04f116f1.js"><link rel="prefetch" href="/CodeVault/assets/js/59.d660a6b3.js"><link rel="prefetch" href="/CodeVault/assets/js/6.7220274d.js"><link rel="prefetch" href="/CodeVault/assets/js/60.54783427.js"><link rel="prefetch" href="/CodeVault/assets/js/61.6e520517.js"><link rel="prefetch" href="/CodeVault/assets/js/62.78b5acff.js"><link rel="prefetch" href="/CodeVault/assets/js/63.0492d6b3.js"><link rel="prefetch" href="/CodeVault/assets/js/64.bd2a8518.js"><link rel="prefetch" href="/CodeVault/assets/js/65.8acc8c15.js"><link rel="prefetch" href="/CodeVault/assets/js/66.c2dc1d15.js"><link rel="prefetch" href="/CodeVault/assets/js/67.d584fc60.js"><link rel="prefetch" href="/CodeVault/assets/js/68.7221e725.js"><link rel="prefetch" href="/CodeVault/assets/js/69.f1a4c42c.js"><link rel="prefetch" href="/CodeVault/assets/js/7.ee190d28.js"><link rel="prefetch" href="/CodeVault/assets/js/70.8fb27ce3.js"><link rel="prefetch" href="/CodeVault/assets/js/71.2011297a.js"><link rel="prefetch" href="/CodeVault/assets/js/72.81904f20.js"><link rel="prefetch" href="/CodeVault/assets/js/73.cae4a206.js"><link rel="prefetch" href="/CodeVault/assets/js/74.41ca332e.js"><link rel="prefetch" href="/CodeVault/assets/js/75.ae7006ef.js"><link rel="prefetch" href="/CodeVault/assets/js/76.8477b765.js"><link rel="prefetch" href="/CodeVault/assets/js/77.ae764f14.js"><link rel="prefetch" href="/CodeVault/assets/js/78.b47518b4.js"><link rel="prefetch" href="/CodeVault/assets/js/79.bde0466f.js"><link rel="prefetch" href="/CodeVault/assets/js/8.e3ab8186.js"><link rel="prefetch" href="/CodeVault/assets/js/80.94af34f8.js"><link rel="prefetch" href="/CodeVault/assets/js/81.f1ba0edc.js"><link rel="prefetch" href="/CodeVault/assets/js/82.4485e21e.js"><link rel="prefetch" href="/CodeVault/assets/js/83.940dbcc3.js"><link rel="prefetch" href="/CodeVault/assets/js/84.6be8c64a.js"><link rel="prefetch" href="/CodeVault/assets/js/85.aa147bd8.js"><link rel="prefetch" href="/CodeVault/assets/js/86.0259d757.js"><link rel="prefetch" href="/CodeVault/assets/js/87.c88b420b.js"><link rel="prefetch" href="/CodeVault/assets/js/88.38f98c94.js"><link rel="prefetch" href="/CodeVault/assets/js/89.421840d7.js"><link rel="prefetch" href="/CodeVault/assets/js/9.cb249ed0.js"><link rel="prefetch" href="/CodeVault/assets/js/90.cd9b70c8.js"><link rel="prefetch" href="/CodeVault/assets/js/91.0c040f15.js"><link rel="prefetch" href="/CodeVault/assets/js/92.1ea436cf.js"><link rel="prefetch" href="/CodeVault/assets/js/93.7de38599.js"><link rel="prefetch" href="/CodeVault/assets/js/94.f2ad5a97.js"><link rel="prefetch" href="/CodeVault/assets/js/95.22f940d7.js"><link rel="prefetch" href="/CodeVault/assets/js/96.6a991248.js"><link rel="prefetch" href="/CodeVault/assets/js/97.aeccee85.js"><link rel="prefetch" href="/CodeVault/assets/js/98.79db6c16.js"><link rel="prefetch" href="/CodeVault/assets/js/99.aa13c9cb.js">
    <link rel="stylesheet" href="/CodeVault/assets/css/0.styles.bcdd6f38.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CodeVault/" class="home-link router-link-active"><img src="/CodeVault/img/huli.svg" alt="CodeVault文档站" class="logo"> <span class="site-name can-hide">CodeVault文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CodeVault/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈开发" class="dropdown-title"><a href="/CodeVault/pages/d1eaf8/" class="link-title">全栈开发</a> <span class="title" style="display:none;">全栈开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云计算运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/d1eaf8/" class="nav-link">云计算</a></li></ul></li><li class="dropdown-item"><h4>容器开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/e820a7/" class="nav-link">容器</a></li></ul></li><li class="dropdown-item"><h4>K8S虚拟化</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/da2470/" class="nav-link">容器虚拟化</a></li></ul></li><li class="dropdown-item"><h4>运维高级篇</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/ce761d/" class="nav-link">高可用</a></li></ul></li><li class="dropdown-item"><h4>前端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">前端常用</a></li></ul></li><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">后端常用</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源" class="dropdown-title"><a href="/CodeVault/pages/e4db9d/" class="link-title">资源</a> <span class="title" style="display:none;">资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/e4db9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/c936ca/" class="nav-link">学习文档资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习路线" class="dropdown-title"><a href="/CodeVault/pages/f24c41/" class="link-title">学习路线</a> <span class="title" style="display:none;">学习路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f24c41/" class="nav-link">后端学习路线</a></li></ul></li><li class="dropdown-item"><h4>Web3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1583d1/" class="nav-link">区块链学习路线</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/CodeVault/pages/6ffa63/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML5+CSS3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/6ffa63/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/b23e0c/" class="nav-link">CSS3</a></li></ul></li><li class="dropdown-item"><h4>JavaScript</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/0e8324/" class="nav-link">JavaScript开篇</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/4d9ec9/" class="nav-link">JavaScript面向对象</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0505ad/" class="nav-link">JavaScript DOM</a></li></ul></li><li class="dropdown-item"><h4>API</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/845076/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9c8e93/" class="nav-link">Ajax</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Axios</a></li></ul></li><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/a1209f/" class="nav-link">Vuejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/CodeVault/pages/5e1c7d/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/5e1c7d/" class="nav-link">Java进阶</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9b262c/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3e651a/" class="nav-link">SpringBoot</a></li></ul></li><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/135518/" class="nav-link">Beego</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gin</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gorm</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/CodeVault/pages/7ef2c7/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/7ef2c7/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/516f71/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1eaa9a/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1ac9b2/" class="nav-link">Ceph</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/719244/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/6ec6ec/" class="nav-link">Istio</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/30e340/" class="nav-link">Prometheus</a></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/32fd53/" class="nav-link">Docker</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8S" class="dropdown-title"><a href="/CodeVault/pages/46159d/" class="link-title">K8S</a> <span class="title" style="display:none;">K8S</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/46159d/" class="nav-link">Kubernetes</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f87a46/" class="nav-link">CKS认证</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/2d432e/" class="nav-link">Operator</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/f6f110/" class="nav-link">CI/CD</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><a href="/CodeVault/pages/f9fa7a/" class="link-title">Linux</a> <span class="title" style="display:none;">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f9fa7a/" class="nav-link">基础服务</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/314d26/" class="nav-link">Kvm</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/44e450/" class="nav-link">Ansible</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/8292d8/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><a href="/CodeVault/pages/f3ea9f/" class="link-title">区块链</a> <span class="title" style="display:none;">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>FISCO BCOS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f3ea9f/" class="nav-link">WeBASE搭建</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛上</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/685f1f/" aria-current="page" class="nav-link router-link-exact-active router-link-active">碳排放解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3f1596/" class="nav-link">慈善公益解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cc43be/" class="nav-link">构造交易传入AppID</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/75ddc8/" class="nav-link">合约时间触发器</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9bcc7c/" class="nav-link">一键部署环境脚本</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a93fcf/" class="nav-link">合约调用机制与并行合约</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛下</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1fdb40/" class="nav-link">DDCMS后端容器化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/795b78/" class="nav-link">DDCMS第三方登录</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a99040/" class="nav-link">DDCMS智能合约设计</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cb310d/" class="nav-link">DDCMS部署和运维</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0b1c5a/" class="nav-link">DDCMS接口报错</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/99df38/" class="nav-link">合约大小限制优化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f8a343/" class="nav-link">并行合约最佳实践</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3d3086/" class="nav-link">一文搞懂Truffle测试</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/e3d908/" class="nav-link">记录</a></div> <a href="https://github.com/CN-ZHANGYH/CodeVault" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/CodeVault/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈开发" class="dropdown-title"><a href="/CodeVault/pages/d1eaf8/" class="link-title">全栈开发</a> <span class="title" style="display:none;">全栈开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云计算运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/d1eaf8/" class="nav-link">云计算</a></li></ul></li><li class="dropdown-item"><h4>容器开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/e820a7/" class="nav-link">容器</a></li></ul></li><li class="dropdown-item"><h4>K8S虚拟化</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/da2470/" class="nav-link">容器虚拟化</a></li></ul></li><li class="dropdown-item"><h4>运维高级篇</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/ce761d/" class="nav-link">高可用</a></li></ul></li><li class="dropdown-item"><h4>前端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">前端常用</a></li></ul></li><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">后端常用</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源" class="dropdown-title"><a href="/CodeVault/pages/e4db9d/" class="link-title">资源</a> <span class="title" style="display:none;">资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/e4db9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/c936ca/" class="nav-link">学习文档资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习路线" class="dropdown-title"><a href="/CodeVault/pages/f24c41/" class="link-title">学习路线</a> <span class="title" style="display:none;">学习路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f24c41/" class="nav-link">后端学习路线</a></li></ul></li><li class="dropdown-item"><h4>Web3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1583d1/" class="nav-link">区块链学习路线</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/CodeVault/pages/6ffa63/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML5+CSS3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/6ffa63/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/b23e0c/" class="nav-link">CSS3</a></li></ul></li><li class="dropdown-item"><h4>JavaScript</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/0e8324/" class="nav-link">JavaScript开篇</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/4d9ec9/" class="nav-link">JavaScript面向对象</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0505ad/" class="nav-link">JavaScript DOM</a></li></ul></li><li class="dropdown-item"><h4>API</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/845076/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9c8e93/" class="nav-link">Ajax</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Axios</a></li></ul></li><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/a1209f/" class="nav-link">Vuejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/CodeVault/pages/5e1c7d/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/5e1c7d/" class="nav-link">Java进阶</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9b262c/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3e651a/" class="nav-link">SpringBoot</a></li></ul></li><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/135518/" class="nav-link">Beego</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gin</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gorm</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/CodeVault/pages/7ef2c7/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/7ef2c7/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/516f71/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1eaa9a/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1ac9b2/" class="nav-link">Ceph</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/719244/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/6ec6ec/" class="nav-link">Istio</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/30e340/" class="nav-link">Prometheus</a></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/32fd53/" class="nav-link">Docker</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8S" class="dropdown-title"><a href="/CodeVault/pages/46159d/" class="link-title">K8S</a> <span class="title" style="display:none;">K8S</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/46159d/" class="nav-link">Kubernetes</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f87a46/" class="nav-link">CKS认证</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/2d432e/" class="nav-link">Operator</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/f6f110/" class="nav-link">CI/CD</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><a href="/CodeVault/pages/f9fa7a/" class="link-title">Linux</a> <span class="title" style="display:none;">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f9fa7a/" class="nav-link">基础服务</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/314d26/" class="nav-link">Kvm</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/44e450/" class="nav-link">Ansible</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/8292d8/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><a href="/CodeVault/pages/f3ea9f/" class="link-title">区块链</a> <span class="title" style="display:none;">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>FISCO BCOS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f3ea9f/" class="nav-link">WeBASE搭建</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛上</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/685f1f/" aria-current="page" class="nav-link router-link-exact-active router-link-active">碳排放解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3f1596/" class="nav-link">慈善公益解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cc43be/" class="nav-link">构造交易传入AppID</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/75ddc8/" class="nav-link">合约时间触发器</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9bcc7c/" class="nav-link">一键部署环境脚本</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a93fcf/" class="nav-link">合约调用机制与并行合约</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛下</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1fdb40/" class="nav-link">DDCMS后端容器化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/795b78/" class="nav-link">DDCMS第三方登录</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a99040/" class="nav-link">DDCMS智能合约设计</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cb310d/" class="nav-link">DDCMS部署和运维</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0b1c5a/" class="nav-link">DDCMS接口报错</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/99df38/" class="nav-link">合约大小限制优化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f8a343/" class="nav-link">并行合约最佳实践</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3d3086/" class="nav-link">一文搞懂Truffle测试</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/e3d908/" class="nav-link">记录</a></div> <a href="https://github.com/CN-ZHANGYH/CodeVault" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>FISCO BCOS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/f3ea9f/" class="sidebar-link">搭建Fisco的联盟链(WeBase版)</a></li><li><a href="/CodeVault/pages/484318/" class="sidebar-link">FISCO BCOS Air搭建</a></li><li><a href="/CodeVault/pages/58f15c/" class="sidebar-link">FISCO BCOS Pro搭建</a></li><li><a href="/CodeVault/pages/cca1e9/" class="sidebar-link">FISCO BCOS Max搭建</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>2023 Task挑战赛上</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/685f1f/" aria-current="page" class="active sidebar-link">企业碳排放解决方案合约案例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/685f1f/#_1-区块链为-双碳-带来了什么-研讨会回顾" class="sidebar-link">1.区块链为“双碳”带来了什么？ | 研讨会回顾</a></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/685f1f/#_2-碳排放资产管理设计" class="sidebar-link">2.碳排放资产管理设计</a></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/685f1f/#_3-系统架构与合约设计" class="sidebar-link">3.系统架构与合约设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_3-1-整体设计架构" class="sidebar-link">3.1 整体设计架构</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_3-2-具体的设计思路" class="sidebar-link">3.2 具体的设计思路</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/685f1f/#_4-具体开发步骤" class="sidebar-link">4.具体开发步骤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-1-carboncertificationv2合约业务介绍" class="sidebar-link">4.1 CarbonCertificationV2合约业务介绍</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-2-carboncertificationv2合约" class="sidebar-link">4.2 CarbonCertificationV2合约</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-3-carbonassetv2合约业务介绍" class="sidebar-link">4.3 CarbonAssetV2合约业务介绍</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-4-carbonassetv2合约" class="sidebar-link">4.4 CarbonAssetV2合约</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-5-carbonexcitationv2合约业务介绍" class="sidebar-link">4.5 CarbonExcitationV2合约业务介绍</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_4-6-carbonexcitationv2合约" class="sidebar-link">4.6 CarbonExcitationV2合约</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#重构版合约" class="sidebar-link">重构版合约</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/685f1f/#_5-编译部署合约" class="sidebar-link">5.编译部署合约</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_5-1-创建测试用户" class="sidebar-link">5.1 创建测试用户</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_5-2-部署合约" class="sidebar-link">5.2 部署合约</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_5-3-企业审核资质完整业务测试" class="sidebar-link">5.3 企业审核资质完整业务测试</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_5-4-企业碳排放量审批完整业务测试" class="sidebar-link">5.4 企业碳排放量审批完整业务测试</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/685f1f/#_5-5-企业交易碳额度完整业务测试" class="sidebar-link">5.5 企业交易碳额度完整业务测试</a></li></ul></li></ul></li><li><a href="/CodeVault/pages/3f1596/" class="sidebar-link">慈善公益解决方案</a></li><li><a href="/CodeVault/pages/cc43be/" class="sidebar-link">RawTransaction优化</a></li><li><a href="/CodeVault/pages/75ddc8/" class="sidebar-link">Solidity合约时间触发器</a></li><li><a href="/CodeVault/pages/9bcc7c/" class="sidebar-link">一键部署环境脚本</a></li><li><a href="/CodeVault/pages/a93fcf/" class="sidebar-link">合约调用机制与并行合约</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>2023 Task挑战赛下</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/1fdb40/" class="sidebar-link">DDCMS 后端容器化解决方案</a></li><li><a href="/CodeVault/pages/795b78/" class="sidebar-link">DDCMS实现第三方Github登录</a></li><li><a href="/CodeVault/pages/a99040/" class="sidebar-link">DDCMS智能合约设计与实现</a></li><li><a href="/CodeVault/pages/cb310d/" class="sidebar-link">部署DDCMS分布式数据管理</a></li><li><a href="/CodeVault/pages/0b1c5a/" class="sidebar-link">DDCMS-Service后端searchCompany接口解决报错</a></li><li><a href="/CodeVault/pages/99df38/" class="sidebar-link">Solidity智能合约大小限制优化方案</a></li><li><a href="/CodeVault/pages/f8a343/" class="sidebar-link">并行合约设计与实践</a></li><li><a href="/CodeVault/pages/3d3086/" class="sidebar-link">一文搞懂Truffle测试</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/CodeVault/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>区块链</span></li><li data-v-06225672><span data-v-06225672>2023 Task挑战赛上</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/CN-ZHANGYH" target="_blank" title="作者" class="beLink" data-v-06225672>Yyzop</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">企业碳排放解决方案合约案例<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="企业碳排放解决方案合约案例-助力双碳"><a href="#企业碳排放解决方案合约案例-助力双碳" class="header-anchor">#</a> 企业碳排放解决方案合约案例 助力双碳</h1> <h2 id="_1-区块链为-双碳-带来了什么-研讨会回顾"><a href="#_1-区块链为-双碳-带来了什么-研讨会回顾" class="header-anchor">#</a> 1.区块链为“双碳”带来了什么？ | 研讨会回顾</h2> <p>原文介绍：</p> <p>6月22日，由微众区块链、金链盟、FISCO BCOS开源社区联合举办的“‘链’筑可持续”ESG系列研讨会第一期在线举行。本期研讨会以“区块链助推‘双碳’战略”为主题，邀请权威专家和代表企业共话“双碳”工作推进中存在的难点痛点，以及区块链技术如何助推“双碳”战略。</p> <p>研讨会由微众银行区块链CMO李贺主持，邀请了广州碳排放权交易所总经理助理李原、微众银行区块链首席架构师兼金链盟FISCO BCOS首席架构师张开翔、零数科技双碳事业部总经理沈文昌、碳抵科技副总经理耿振博、万物数创CTO黄一分别做主题演讲。</p> <p>随着碳达峰碳中和各项政策纷纷部署落地，碳排放数据的采集、碳普惠机制的激励等实操性痛点问题亟待解决。对此，区块链技术作为可信基础设施，不仅为上述问题提供了可行的解决方案，更与金融、绿色建筑等行业结合，诞生出一系列实践案例。</p> <p>区块链作为一种分布式账本技术，<code>具有去中心化、不可篡改、透明等特点，可以为“双碳”（即低碳经济）</code>发展带来一些潜在的好处。</p> <ol><li><strong>碳交易和碳信用积分</strong>：区块链可以为碳交易和碳信用积分提供一个安全的、透明的、不可篡改的记录和管理方式。通过将碳排放权分割成数字资产，可以方便地进行转移、交易和跟踪。</li> <li><strong>资源管理和监控</strong>：区块链可以用于跟踪能源、水资源和土地等资源的使用情况，并对资源的使用进行监控。这可以帮助促进资源的高效利用和减少浪费。</li> <li><strong>能源交易和分布</strong>：区块链可以用于管理去中心化的能源市场，使个人和企业可以直接进行能源交易和分享。这可以促进可再生能源的使用和减少对传统能源的依赖。</li> <li><strong>碳足迹追溯</strong>：区块链可以用于记录产品的生产和运输过程，并追溯产品的碳足迹。这可以帮助消费者更好地了解产品的环境影响，从而做出更环保的选择。</li></ol> <p>总之，区块链可以为“双碳”发展提供一些有益的支持。通过利用区块链的技术特点，可以实现更加透明、高效和安全的碳交易和碳管理，促进可持续发展和低碳经济的建设。</p> <h2 id="_2-碳排放资产管理设计"><a href="#_2-碳排放资产管理设计" class="header-anchor">#</a> 2.碳排放资产管理设计</h2> <p>基于区块链的碳资产管理可以通过以下设计来实现：</p> <ol><li><strong>碳资产登记</strong>：碳资产应该被注册到区块链上，以确保其真实性和合法性。可以使用智能合约来记录碳资产的属性，例如产生碳排放的方式、数量和时间等。此外，为了防止双重计数，应该为每个碳资产分配唯一的标识符。</li> <li><strong>碳交易</strong>：碳交易应该通过区块链进行。买卖双方应该通过数字签名来确认交易，并将交易记录在区块链上。区块链的智能合约可以自动化交易，以确保快速、安全和低成本的交易。</li> <li><strong>碳资产追踪</strong>：区块链可以记录每个碳资产的交易历史和归属权，以确保其可追溯性。可以将交易信息记录在区块链上，使每个参与方都可以查看碳资产的交易历史。此外，可以使用区块链的权限控制功能来确保只有授权人员可以访问特定的交易记录。</li> <li><strong>碳资产溯源</strong>：区块链可以记录碳资产的溯源信息，以追踪其来源和流向。可以使用智能合约来记录碳资产的生产过程、运输过程和交易过程等信息。这些信息可以用于证明碳资产的真实性和合法性，也可以用于监管和审计。</li></ol> <p>总之，基于区块链的碳资产管理应该包括<code>碳资产登记、碳交易、碳资产追踪、碳资产溯源等方面</code>，以实现快速、安全和低成本的碳交易，并确保碳交易市场的透明度和可信度。</p> <h2 id="_3-系统架构与合约设计"><a href="#_3-系统架构与合约设计" class="header-anchor">#</a> 3.系统架构与合约设计</h2> <h3 id="_3-1-整体设计架构"><a href="#_3-1-整体设计架构" class="header-anchor">#</a> 3.1 整体设计架构</h3> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202310301140741.png" alt="数字碳链架构图.drawio"></p> <h3 id="_3-2-具体的设计思路"><a href="#_3-2-具体的设计思路" class="header-anchor">#</a> 3.2 具体的设计思路</h3> <p>CarbonAsset 合约 CarbonAsset 合约是管理碳排放额度和碳交易的核心合约。该合约包含以下功能：</p> <ul><li><strong>分配碳排放额度</strong>：CarbonCertification 合约审核通过后，将为企业在 CarbonAsset 合约中分配碳排放额度。</li> <li><strong>挂单出售</strong>：企业可以将其碳排放额度挂单出售到 CarbonAsset 合约中。</li> <li><strong>直接购买</strong>：企业可以直接在 CarbonAsset 合约中购买其他企业挂单出售的碳排放额度。</li> <li><strong>检查余额</strong>：企业可以随时查询其在 CarbonAsset 合约中的碳排放额度余额。</li> <li><strong>转移额度</strong>：企业可以将其在 CarbonAsset 合约中的碳排放额度转移给其他企业。</li> <li><strong>支付奖励积分</strong>：企业在完成某些减少碳排放量的行为后，可以获得奖励积分。CarbonAsset 合约可以用来支付奖励积分。</li></ul> <ol><li>CarbonCertification 合约用于管理企业的资质信息和审核状态。企业可以将其资质信息上传到 CarbonCertification 合约中，并等待监管统计部门进行审核。审核通过后，CarbonAsset 合约将分配相应的碳排放额度。</li> <li>CarbonExcitation合约 CarbonExcitation合约用于管理企业的碳排放量和奖励积分。该合约可以追踪企业的碳排放量，并计算其应该获得的奖励积分。企业可以在 CarbonAsset 合约中收到奖励积分，或在 CarbonExcitation合约中查看其奖励积分余额。</li> <li>SafeMath 合约 SafeMath 合约是一个安全数学库，用于处理合约中的数学运算。它可以避免整数溢出和下溢等问题，确保合约中的数学计算是安全和可靠的。在 CarbonAsset 合约中，SafeMath 合约可以用来处理碳排放额度的加减操作，以避免可能的数学错误和安全问题。</li></ol> <p>通过以上合约的设计和实现，我们可以构建一个完整的碳资产管理系统，其中企业和监管统计部门可以使用区块链来实现碳资产的管理和交易，确保碳排放量的准确计量和碳市场的透明和公正。该系统可以提高碳交易的效率和安全性，减少人为错误和舞弊行为的发生，同时也可以为企业提供更多的碳减排激励，促进全社会对低碳经济的转型和发展。</p> <h2 id="_4-具体开发步骤"><a href="#_4-具体开发步骤" class="header-anchor">#</a> 4.具体开发步骤</h2> <h3 id="_4-1-carboncertificationv2合约业务介绍"><a href="#_4-1-carboncertificationv2合约业务介绍" class="header-anchor">#</a> 4.1 CarbonCertificationV2合约业务介绍</h3> <p>CarbonCertification的主要业务：</p> <ul><li>拥有两个角色，分别是企业和监管部门</li> <li>基本业务是注册企业和监管部门的个人信息</li> <li>企业需要上传资质，等待审核</li> <li>监管部门需要查看进行审批，如果审批通过则发放1000的额度，未通过审核的企业无法进行下一步操作</li> <li>企业审核完之后可以对自己的信息进行更新上传，包括余额、总排放量</li> <li>企业之间的交易会记录下交易的信息体，所有需要存放交易的历史记录</li> <li>我定义了四个主要的结构体，分别是：<code>Enterprise</code>，<code>Regulator</code>，<code>Qualification</code>，<code>Transaction</code>。</li></ul> <p><strong>这里我自己定义了Ownable合约，就是可公共拥有的变量或者函数以及事件</strong></p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.25</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">Ownable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义角色枚举类型</span>
    <span class="token keyword">enum</span> <span class="token class-name">Role</span> <span class="token punctuation">{</span> Enterprise<span class="token punctuation">,</span> Regulator <span class="token punctuation">}</span>
    <span class="token comment">// 默认发放的额度</span>
    <span class="token builtin">uint256</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> TOTAL_EMISSION <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// 进行审核的变量</span>
    <span class="token builtin">bool</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> AUDIT_SUCCESS <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token builtin">bool</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> AUDIT_FAILED <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 企业账户的事件</span>
    <span class="token keyword">event</span> <span class="token function">RegisterAccount</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _acount<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">indexed</span> _name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 上传审核的事件</span>
    <span class="token keyword">event</span> <span class="token function">UploadQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _acount<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">indexed</span> _name<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">indexed</span> _content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 审批企业申请的事件</span>
    <span class="token keyword">event</span> <span class="token function">VerifyQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 交易碳额度</span>
    <span class="token keyword">event</span> <span class="token function">TransferEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _from<span class="token punctuation">,</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _to<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 出售碳额度</span>
    <span class="token keyword">event</span> <span class="token function">SellEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新企业账户的余额</span>
    <span class="token keyword">event</span> <span class="token function">UpdateBalnce</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新企业账户的碳排放额度</span>
    <span class="token keyword">event</span> <span class="token function">UpdateEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-2-carboncertificationv2合约"><a href="#_4-2-carboncertificationv2合约" class="header-anchor">#</a> 4.2 CarbonCertificationV2合约</h3> <p><strong>CarbonCertificationV2的合约详细</strong></p> <p>主要的函数方法有如下：</p> <ul><li><code>registerEnterprise()</code>	:  注册企业函数，初始化一个新的企业</li> <li><code>registerRegulator()</code>  ：注册监管机构函数，初始化一个监管机构</li> <li><code>qualificationUpload()</code>  ：企业上传资质函数，等待监管机构审批资质</li> <li><code>verifyQualification()</code>   ：监管机构审批企业的资质函数，用于审批</li> <li><code>updateBalance()</code>  ：更新企业余额函数，企业的账户余额用于交易</li> <li><code>queryEnterpriseInfo()</code>  ：查询企业信息函数，返回企业的结构体信息</li> <li><code>queryRegulatorInfo()</code>  ：查询监管机构信息函数，返回监管机构的结构体信息</li> <li><code>queryAllEnterprises()</code>   ：分页查询所有企业的函数，避免返回整个数组</li> <li><code>queryAllTransactions()</code>   ：分页查询所有企业的交易历史记录函数，避免返回整个数组</li></ul> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.25</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./Ownable.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">CarbonCertificationV2</span> <span class="token keyword">is</span> Ownable <span class="token punctuation">{</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> Owner<span class="token punctuation">;</span>

    <span class="token comment">// 定义一个结构体来表示企业账户信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Enterprise</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> enterpriseId<span class="token punctuation">;</span>                   <span class="token comment">// 账户ID</span>
        <span class="token builtin">address</span> enterpriseAddress<span class="token punctuation">;</span>              <span class="token comment">// 账户地址</span>
        <span class="token builtin">string</span>  enterpriseName<span class="token punctuation">;</span>                 <span class="token comment">// 企业名称</span>
        <span class="token builtin">uint256</span> enterpriseBalance<span class="token punctuation">;</span>              <span class="token comment">// 账户余额</span>
        <span class="token builtin">uint256</span> enterpriseTotalEmission<span class="token punctuation">;</span>        <span class="token comment">// 总需排放的量</span>
        <span class="token builtin">uint256</span> enterpriseOverEmission<span class="token punctuation">;</span>         <span class="token comment">// 已完成的排放量</span>
        <span class="token builtin">uint256</span> enterpriseCarbonCredits<span class="token punctuation">;</span>        <span class="token comment">// 奖励积分</span>
        <span class="token builtin">bool</span> enterpriseVerified<span class="token punctuation">;</span>                <span class="token comment">// 是否通过审核</span>
        Role userType<span class="token punctuation">;</span>                          <span class="token comment">// 账户角色</span>
        Qualification qualification<span class="token punctuation">;</span>            <span class="token comment">// 资质信息</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义一个结构体来表示企业的资质信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Qualification</span> <span class="token punctuation">{</span>
        <span class="token builtin">string</span>  qualificationName<span class="token punctuation">;</span>                    <span class="token comment">// 资质名称</span>
        <span class="token builtin">string</span>  qualificationContent<span class="token punctuation">;</span>                 <span class="token comment">// 资质内容</span>
        <span class="token builtin">uint256</span> qualificationUploadTime<span class="token punctuation">;</span>              <span class="token comment">// 上传时间</span>
        <span class="token builtin">uint256</span> qualificationAuditTime<span class="token punctuation">;</span>               <span class="token comment">// 审核时间</span>
        <span class="token builtin">uint256</span> qualificationEmissionLimit<span class="token punctuation">;</span>           <span class="token comment">// 碳排放额度</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 定义一个结构体来表示监管部门账户信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Regulator</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> regulatorId<span class="token punctuation">;</span>            <span class="token comment">// 账户ID</span>
        <span class="token builtin">address</span> regulatorAddress<span class="token punctuation">;</span>       <span class="token comment">// 账户地址</span>
        <span class="token builtin">string</span>  regulatorName<span class="token punctuation">;</span>          <span class="token comment">// 部门名称</span>
        Role userType<span class="token punctuation">;</span>                  <span class="token comment">// 账户类型</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义一个结构体来表示交易订单信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Transaction</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> transactionId<span class="token punctuation">;</span>               <span class="token comment">// 订单的交易ID</span>
        <span class="token builtin">string</span>  transactionOrderName<span class="token punctuation">;</span>        <span class="token comment">// 订单的名字</span>
        <span class="token builtin">address</span> transactionBuyAddress<span class="token punctuation">;</span>       <span class="token comment">// 买家地址</span>
        <span class="token builtin">address</span> transactionSellAddress<span class="token punctuation">;</span>      <span class="token comment">// 卖家地址</span>
        <span class="token builtin">uint256</span> transactionTime<span class="token punctuation">;</span>             <span class="token comment">// 订单创建时间</span>
        <span class="token builtin">uint256</span> transactionQuantity<span class="token punctuation">;</span>         <span class="token comment">// 购买碳额度的数量</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义交易的记录</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> enterpriseCount<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> regulatorCount<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> transactionCount<span class="token punctuation">;</span>


    <span class="token comment">// 定义存储企业的数据集合</span>
    Enterprise<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> enterpriseList<span class="token punctuation">;</span>
    <span class="token comment">// 定义存储监管部门的数据集合</span>
    Regulator<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> regulatorList<span class="token punctuation">;</span>
    <span class="token comment">// 定义存储交易订单的数据集合</span>
    Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> transactionList<span class="token punctuation">;</span>


    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> enterprisesAddress<span class="token punctuation">;</span>
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> regulatorsAddress<span class="token punctuation">;</span>


    <span class="token comment">// 通过地址映射企业的详细信息</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> Enterprise<span class="token punctuation">)</span> <span class="token keyword">public</span> enterpriseMap<span class="token punctuation">;</span>
    <span class="token comment">// 通过地址映射监管部门的详细信息</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> Regulator<span class="token punctuation">)</span> <span class="token keyword">public</span> regulatorMap<span class="token punctuation">;</span>
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> Transaction<span class="token punctuation">)</span> <span class="token keyword">public</span> transactionMap<span class="token punctuation">;</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">public</span> enterpriseToTransactions<span class="token punctuation">;</span>


    <span class="token comment">// 企业</span>
    <span class="token keyword">modifier</span> <span class="token function">OnlyEnterprice</span><span class="token punctuation">(</span><span class="token builtin">address</span> _account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            enterpriseMap<span class="token punctuation">[</span>_account<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> msg<span class="token punctuation">.</span>sender <span class="token operator">&amp;&amp;</span>
            enterpriseMap<span class="token punctuation">[</span>_account<span class="token punctuation">]</span><span class="token punctuation">.</span>userType <span class="token operator">==</span> Role<span class="token punctuation">.</span>Enterprise<span class="token punctuation">,</span><span class="token string">&quot;当前没有企业的权限&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 监管</span>
    <span class="token keyword">modifier</span> <span class="token function">OnlyRegulator</span><span class="token punctuation">(</span><span class="token builtin">address</span> _account<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            regulatorMap<span class="token punctuation">[</span>_account<span class="token punctuation">]</span><span class="token punctuation">.</span>regulatorAddress <span class="token operator">==</span> msg<span class="token punctuation">.</span>sender <span class="token operator">&amp;&amp;</span>
            regulatorMap<span class="token punctuation">[</span>_account<span class="token punctuation">]</span><span class="token punctuation">.</span>userType <span class="token operator">==</span> Role<span class="token punctuation">.</span>Regulator<span class="token punctuation">,</span><span class="token string">&quot;当前没有监管机构权限&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查是否注册</span>
    <span class="token keyword">modifier</span> <span class="token function">CheckRegistered</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectHasRegulator</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前企业未注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 注册一个企业
    * @param _account 企业账户地址
    * @param _name 企业名称
    */</span>
    <span class="token keyword">function</span> <span class="token function">registerEnterprise</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断当前是否存在</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectHasEnterprise</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前企业已经注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enterpriseCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> _accountId <span class="token operator">=</span> enterpriseCount<span class="token punctuation">;</span>

        Enterprise <span class="token keyword">storage</span> _newEnterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseId <span class="token operator">=</span> _accountId<span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span> _enterpriseAddress<span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseName <span class="token operator">=</span> _enterpriseName<span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseOverEmission <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>enterpriseVerified <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>userType <span class="token operator">=</span> Role<span class="token punctuation">.</span>Enterprise<span class="token punctuation">;</span>
        _newEnterprise<span class="token punctuation">.</span>qualification <span class="token operator">=</span> <span class="token function">Qualification</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// enterpriseNameToAddressMap[_enterpriseName] = _enterpriseAddress;</span>
        enterprisesAddress<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        enterpriseList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_newEnterprise<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 触发企业注册的事件</span>
        <span class="token keyword">emit</span> <span class="token function">RegisterAccount</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">,</span>_enterpriseName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 查询企业是否注册</span>
    <span class="token keyword">function</span> <span class="token function">selectHasEnterprise</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> _enterpriseAddr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/*
    * @dev 注册一个监管部门
    * @param _regulator 监管部门的地址
    * @param _name 监管部门的名称
    */</span>
    <span class="token keyword">function</span> <span class="token function">registerRegulator</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regulatorAddress<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _regulatorName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectHasRegulator</span><span class="token punctuation">(</span>_regulatorAddress<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前监管机构已经注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        regulatorCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> regulatorId <span class="token operator">=</span> regulatorCount<span class="token punctuation">;</span>

        Regulator <span class="token keyword">storage</span> _newRegulator <span class="token operator">=</span> regulatorMap<span class="token punctuation">[</span>_regulatorAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _newRegulator<span class="token punctuation">.</span>regulatorId <span class="token operator">=</span> regulatorId<span class="token punctuation">;</span>
        _newRegulator<span class="token punctuation">.</span>regulatorAddress <span class="token operator">=</span> _regulatorAddress<span class="token punctuation">;</span>
        _newRegulator<span class="token punctuation">.</span>regulatorName <span class="token operator">=</span> _regulatorName<span class="token punctuation">;</span>
        _newRegulator<span class="token punctuation">.</span>userType <span class="token operator">=</span> Role<span class="token punctuation">.</span>Regulator<span class="token punctuation">;</span>

        <span class="token comment">// regulatorNameToAddressMap[_regulatorName] = _regulatorAddress;</span>
        regulatorsAddress<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_regulatorAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        regulatorList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_newRegulator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">RegisterAccount</span><span class="token punctuation">(</span>_regulatorAddress<span class="token punctuation">,</span>_regulatorName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 查询企业是否注册</span>
    <span class="token keyword">function</span> <span class="token function">selectHasRegulator</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regulatorAddr<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regulatorMap<span class="token punctuation">[</span>_regulatorAddr<span class="token punctuation">]</span><span class="token punctuation">.</span>regulatorAddress <span class="token operator">==</span> _regulatorAddr<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 注销企业</span>
    <span class="token keyword">function</span> <span class="token function">deleteEnterprise</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">selectHasRegulator</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">delete</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enterprisesAddress<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> _enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">delete</span> enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 
    
    * @param _qualificationName 审核的资质名称
    * @param _qualificationContent 审核资质的内容
    */</span>
    <span class="token keyword">function</span> <span class="token function">qualificationUpload</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationName<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationContent<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">OnlyEnterprice</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token function">CheckRegistered</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 该企业不能存在已经上传资质的情况</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseVerified <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token string">&quot;已经上传过资质,当前无法上传审核资质&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">;</span>
        <span class="token comment">// 上传审核的资料</span>
        _qualification<span class="token punctuation">.</span>qualificationName <span class="token operator">=</span> _qualificationName<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationContent <span class="token operator">=</span> _qualificationContent<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationUploadTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token comment">// 触发上传审核资料的事件</span>
        <span class="token keyword">emit</span> <span class="token function">UploadQualification</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_qualificationName<span class="token punctuation">,</span>_qualificationContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/*
    * @dev 监控部门审核企业上传的资质
    * @param _enterpriseAddr 企业的账户地址
    * @param _emissionLimit 企业的审批通过下发的额度
    */</span>
    <span class="token keyword">function</span> <span class="token function">verifyQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">bool</span> _flag<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">OnlyRegulator</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Enterprise <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这部分代码是主要业务</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationAuditTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _enterprise<span class="token punctuation">.</span>enterpriseVerified <span class="token operator">=</span> AUDIT_SUCCESS<span class="token punctuation">;</span>
            _enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">=</span> TOTAL_EMISSION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">emit</span> <span class="token function">VerifyQualification</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">,</span>TOTAL_EMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _enterprise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/*
    * @dev 更新企业的余额
    * @param _enterpriseAddr 企业的账户地址
    */</span>
    <span class="token keyword">function</span> <span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">OnlyEnterprice</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token function">CheckRegistered</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">+=</span> _amount<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">UpdateBalnce</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 查看企业的详细信息
    * @param _enterpriseAddr 企业的账户地址
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseInfo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Enterprise <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">memory</span> enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> enterprise<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 查看监管部门的详细信息
    * @param _regulatorAddr 监控部门的账户地址
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryRegulatorInfo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regulatorAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">,</span>Role<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Regulator <span class="token keyword">memory</span> regulator <span class="token operator">=</span>  regulatorMap<span class="token punctuation">[</span>_regulatorAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>regulator<span class="token punctuation">.</span>regulatorId<span class="token punctuation">,</span>regulator<span class="token punctuation">.</span>regulatorAddress<span class="token punctuation">,</span>regulator<span class="token punctuation">.</span>regulatorName<span class="token punctuation">,</span>regulator<span class="token punctuation">.</span>userType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/*
    * @dev 查看企业购买的交易历史信息
    * @param _enterpriseAddr 企业的账户地址
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseTransactionInfo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> transactions <span class="token operator">=</span> enterpriseToTransactions<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transactions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 查看当前企业是否通过认证
    */</span>
    <span class="token keyword">function</span> <span class="token function">checkEnterpriseVerified</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseVerified<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 分页拆查询企业的公司信息
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryAllEnterprises</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Enterprise<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> enterprisesAddress<span class="token punctuation">.</span>length <span class="token operator">?</span> enterprisesAddress<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        Enterprise<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> enterpriseArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enterprise</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            enterpriseArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> enterpriseArr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 分页拆查询企业的交易历史订单信息
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryAllTransactions</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>transactionList<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有任何交易历史记录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> transactionList<span class="token punctuation">.</span>length <span class="token operator">?</span> transactionList<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> transactionArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transaction</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            transactionArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> transactionList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> transactionArr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h3 id="_4-3-carbonassetv2合约业务介绍"><a href="#_4-3-carbonassetv2合约业务介绍" class="header-anchor">#</a> 4.3 CarbonAssetV2合约业务介绍</h3> <p>CarbonAsset的主要业务：</p> <ul><li>需要检查当前的企业是否认证</li> <li>通过认证之后可以进行碳资产的出售和购买</li> <li>企业需要申请排放额度，审批排放额度之后即可排放</li> <li>企业排放资源之后会加入到计算积分排行中</li> <li>对企业的排放量进行排序，在后端进行相应的排序，不要在链上排序，避免消耗极大的GAS</li> <li>可以进行统计排名前三奖励可以自行调整</li></ul> <h3 id="_4-4-carbonassetv2合约"><a href="#_4-4-carbonassetv2合约" class="header-anchor">#</a> 4.4 CarbonAssetV2合约</h3> <p><strong>这里我使用了SafeMath合约，防止计算数字溢出</strong></p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.25</span><span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">SafeMath</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Gas optimization: this is cheaper than requiring 'a' not being zero, but the</span>
        <span class="token comment">// benefit is lost if 'b' is also tested.</span>
        <span class="token comment">// See: https://github.com/OpenZeppelin/openzeppelin-solidity/pull/522</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>c <span class="token operator">/</span> a <span class="token operator">==</span> b<span class="token punctuation">,</span> <span class="token string">&quot;SafeMath: multiplication overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">div</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Solidity only automatically asserts when dividing by 0</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>b <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;SafeMath: division by zero&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span>
        <span class="token comment">// assert(a == b * c + a % b); // There is no case in which this doesn't hold</span>

        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>b <span class="token operator">&lt;=</span> a<span class="token punctuation">,</span> <span class="token string">&quot;SafeMath: subtraction overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>

        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>c <span class="token operator">&gt;=</span> a<span class="token punctuation">,</span> <span class="token string">&quot;SafeMath: addition overflow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">mod</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> a<span class="token punctuation">,</span> <span class="token builtin">uint256</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;SafeMath: modulo by zero&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> a <span class="token operator">%</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>CarbonAssetV2的合约详细</strong></p> <p>主要的函数方法有如下：</p> <ul><li><code>buyEmissionLimit()</code>   : 购买碳额度函数</li> <li><code>sellEmissionLimit()</code>   ： 出售碳额度函数</li> <li><code>enterpriseEmissionUpload()</code>    ：企业碳排放量申请函数</li> <li><code>verifyEnterpriseEmission()</code>   ：监管机构审批企业申请函数</li> <li><code>updateEnterpriseEmission()</code>    ：企业更新总排放量函数</li> <li><code>enterpriseEmission()</code>   ： 企业碳排放函数</li> <li><code>selectAllEnterpriseAssets()</code>   ：查询所有企业出售的信息函数</li> <li><code>queryAllEmissionResources()</code>  ：查询所有企业申请碳排放信息函数</li> <li><code>selectTransactionInfo()</code>  ： 查询企业的交易信息函数</li> <li><code>queryEnterpriseCredit()</code>   ：查询企业的积分函数</li> <li><code>queryEnterpriseTotalEmission()</code>    ：查询企业的总排放量函数</li> <li><code>queryEnterpriseAssetInfo()</code>  ：查询企业碳资产信息函数</li> <li><code>queryEnterpriseEmissionInfo()</code>   ：查询企业碳排放信息</li> <li><code>clearOverEmissions()</code>  ： 清楚所有企业已完成的排放量函数</li> <li><code>initEmissionLimit()</code>  ：初始化每个额度函数</li></ul> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.25</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./CarbonExcitationV2.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;./SafeMath.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">CarbonAssetV2</span> <span class="token keyword">is</span> CarbonExcitationV2 <span class="token punctuation">{</span>
    
    <span class="token keyword">using</span> <span class="token class-name">SafeMath</span> <span class="token keyword">for</span> <span class="token operator">*</span><span class="token punctuation">;</span>


    <span class="token comment">// 排放碳资源的结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">EmissionResource</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> emissionId<span class="token punctuation">;</span>          <span class="token comment">// 排放资源的ID </span>
        <span class="token builtin">address</span> enterpriseAddress<span class="token punctuation">;</span>   <span class="token comment">// 排放的企业</span>
        <span class="token builtin">uint256</span> emissions<span class="token punctuation">;</span>           <span class="token comment">// 排放的量</span>
        <span class="token builtin">string</span>  description<span class="token punctuation">;</span>         <span class="token comment">// 排放的资源描述</span>
        <span class="token builtin">bool</span>    isApprove<span class="token punctuation">;</span>           <span class="token comment">// 是否批准排放</span>
        <span class="token builtin">uint256</span> time<span class="token punctuation">;</span>                <span class="token comment">// 排放时间</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 企业出售碳资产的结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">EAsset</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> assetId<span class="token punctuation">;</span>                   <span class="token comment">// 企业出售碳资产的列表Id</span>
        <span class="token builtin">address</span> assetAddress<span class="token punctuation">;</span>           <span class="token comment">// 企业出售碳资产的账户地址</span>
        <span class="token builtin">uint256</span> assetQuantity<span class="token punctuation">;</span>          <span class="token comment">// 企业出售碳资产的数量 </span>
        <span class="token builtin">uint256</span> assetAmount<span class="token punctuation">;</span>            <span class="token comment">// 企业出售碳资产的价钱</span>
        <span class="token builtin">uint256</span> time<span class="token punctuation">;</span>                   <span class="token comment">// 企业出售碳资产的时间</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义出售的资产记录</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> eassetCount<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> emissionResourceCount<span class="token punctuation">;</span>
    
    <span class="token comment">// 通过Id映射企业出售的详细信息</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> EAsset<span class="token punctuation">)</span> <span class="token keyword">public</span>  eassetMap<span class="token punctuation">;</span>
    
    <span class="token comment">// 存储企业出售碳资产的账户地址映射索引</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token keyword">public</span> eassetIndex<span class="token punctuation">;</span>
        
    <span class="token comment">// 存储排放资源申请对应企业账户地址的映射</span>
    <span class="token comment">// mapping(address =&gt; EmissionResource) public emissionToEnterpriseMap;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> EmissionResource<span class="token punctuation">)</span> <span class="token keyword">public</span> idToEmissionMap<span class="token punctuation">;</span>
    
    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerRegulator</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token string">&quot;监管机构&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 所有企业出售谈额度的数据集合</span>
    EAsset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> eassets<span class="token punctuation">;</span>
    
    EmissionResource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> emissionResources<span class="token punctuation">;</span>

    
    <span class="token comment">// 查看当前的企业是否认证审核通过 </span>
    <span class="token keyword">modifier</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">checkEnterpriseVerified</span><span class="token punctuation">(</span>_enterpriseAddr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前的企业未进行认证&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">event</span> <span class="token function">EnterpriseEmissionUpload</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">event</span> <span class="token function">VerifyEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">event</span> <span class="token function">UpdateEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _totalEmissions<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    
    <span class="token keyword">event</span> <span class="token function">EnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionEmission<span class="token punctuation">,</span><span class="token builtin">bool</span> <span class="token keyword">indexed</span> _isCompulsion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
    <span class="token comment">/*
    * @dev 企业购买碳排放额度
    * @param _enterpriseAddr 购买碳排放额度的地址
    * @param _quantity 购买碳排放额度的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">buyEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> eassetId<span class="token punctuation">,</span><span class="token builtin">uint256</span> _quantity<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">OnlyEnterprice</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查看当前的企业余额是否为满足购买的条件</span>
        <span class="token comment">// require(enterpriseMap[msg.sender].enterpriseBalance &gt; eassetMap[eassetIndex[_enterpriseAddr]].assetAmount,&quot;当前的余额不足,购买失败&quot;);</span>
        <span class="token comment">// 对企业的碳余额进行计算   </span>
        Enterprise <span class="token keyword">storage</span> buyer <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> seller <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EAsset <span class="token keyword">storage</span> easset <span class="token operator">=</span> eassetMap<span class="token punctuation">[</span>eassetId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_enterpriseAddr <span class="token operator">!=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><span class="token string">&quot;自己不能购买&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>easset<span class="token punctuation">.</span>assetQuantity <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前的额度已售完&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>SafeMath<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>easset<span class="token punctuation">.</span>assetQuantity<span class="token punctuation">,</span>_quantity<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;超过当前的数量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        buyer<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">-=</span> SafeMath<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_quantity<span class="token punctuation">,</span>easset<span class="token punctuation">.</span>assetAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        buyer<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _quantity<span class="token punctuation">;</span>
        seller<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">+=</span> SafeMath<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_quantity<span class="token punctuation">,</span>easset<span class="token punctuation">.</span>assetAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        transactionCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> transactionId <span class="token operator">=</span> transactionCount<span class="token punctuation">;</span>
        Transaction <span class="token keyword">storage</span> _transaction <span class="token operator">=</span> transactionMap<span class="token punctuation">[</span>transactionId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionId <span class="token operator">=</span> transactionId<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionOrderName <span class="token operator">=</span> <span class="token string">&quot;碳额度企业交易&quot;</span><span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionBuyAddress <span class="token operator">=</span> buyer<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionSellAddress <span class="token operator">=</span> seller<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionQuantity <span class="token operator">=</span>  _quantity<span class="token punctuation">;</span>
        
        enterpriseToTransactions<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transactionList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        easset<span class="token punctuation">.</span>assetQuantity <span class="token operator">-=</span> _quantity<span class="token punctuation">;</span>
        <span class="token builtin">uint</span> length <span class="token operator">=</span> eassets<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eassets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>assetId <span class="token operator">==</span> eassetId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eassets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>assetQuantity <span class="token operator">-=</span> _quantity<span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">emit</span> <span class="token function">TransferEmissionLimit</span><span class="token punctuation">(</span>_enterpriseAddr<span class="token punctuation">,</span>buyer<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">,</span>_quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _transaction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 企业出售碳额度
    * @param _emissionLimitCount 企业的碳额度数量
    * @param _amount 企业出售的单价
    */</span>
    <span class="token keyword">function</span> <span class="token function">sellEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">OnlyEnterprice</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EAsset <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断当前企业的碳额度是否足够</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">&gt;=</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token string">&quot;当前的企业碳排放额度低于售卖的碳排放额度&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">-=</span> _emissionLimitCount<span class="token punctuation">;</span> 
        
        eassetCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> eassetId <span class="token operator">=</span> eassetCount<span class="token punctuation">;</span>
        EAsset <span class="token keyword">storage</span> _newEasset <span class="token operator">=</span> eassetMap<span class="token punctuation">[</span>eassetCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _newEasset<span class="token punctuation">.</span>assetId <span class="token operator">=</span> eassetId<span class="token punctuation">;</span>
        _newEasset<span class="token punctuation">.</span>assetAddress <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
        _newEasset<span class="token punctuation">.</span>assetQuantity <span class="token operator">=</span> _emissionLimitCount<span class="token punctuation">;</span>
        _newEasset<span class="token punctuation">.</span>assetAmount <span class="token operator">=</span> _amount<span class="token punctuation">;</span>
        _newEasset<span class="token punctuation">.</span>time <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        eassets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_newEasset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        eassetIndex<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> eassetId<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">SellEmissionLimit</span><span class="token punctuation">(</span>_emissionLimitCount<span class="token punctuation">,</span>_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _newEasset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">function</span> <span class="token function">updateSellEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _eassetId<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        EAsset <span class="token keyword">storage</span> _easset <span class="token operator">=</span> eassetMap<span class="token punctuation">[</span>_eassetId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _easset<span class="token punctuation">.</span>assetQuantity <span class="token operator">=</span> _emissionLimitCount<span class="token punctuation">;</span>
        _easset<span class="token punctuation">.</span>assetAmount <span class="token operator">=</span> _amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    
    <span class="token comment">/*
    * @dev 企业的碳排放审批  
    * @param _enterpriseAddr 企业的账户地址
    * @param _emissionEmission 企业排放的量
    * @param _description  企业排放的描述
    */</span>
    <span class="token keyword">function</span> <span class="token function">enterpriseEmissionUpload</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionEmission<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _description<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_emissionEmission <span class="token operator">&lt;=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit<span class="token punctuation">,</span><span class="token string">&quot;当前申请排放的量大于申请的额度&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        emissionResourceCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> emissionResouceId <span class="token operator">=</span> emissionResourceCount<span class="token punctuation">;</span>
        EmissionResource <span class="token keyword">storage</span> emissionResource <span class="token operator">=</span> idToEmissionMap<span class="token punctuation">[</span>emissionResouceId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>emissionId <span class="token operator">=</span> emissionResouceId<span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span> _enterpriseAddr<span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>emissions <span class="token operator">=</span> _emissionEmission<span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>description <span class="token operator">=</span> _description<span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>isApprove <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        emissionResources<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>emissionResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">emit</span> <span class="token function">EnterpriseEmissionUpload</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> emissionResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">/*
    * @dev 审批企业的碳排放量
    * @param _enterpriseAddr 企业的账户地址
    * @param _isApprove 是否批准
    */</span>
    <span class="token keyword">function</span> <span class="token function">verifyEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">,</span><span class="token builtin">bool</span> _isApprove<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        EmissionResource <span class="token keyword">storage</span> emissionResource <span class="token operator">=</span> idToEmissionMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>isApprove <span class="token operator">=</span> _isApprove<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> emissionResources<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>emissionResources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> _enterpriseAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                emissionResources<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emissionResource<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">emit</span> <span class="token function">VerifyEnterpriseEmission</span><span class="token punctuation">(</span>_enterpriseAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> _isApprove<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 更新企业的总排放量
    * @param  _enterpriseAddr 企业的账户地址 
    * @param  _totalEmissions 企业的总排放量
    */</span>
    <span class="token keyword">function</span> <span class="token function">updateEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _totalEmissions<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">storage</span> enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        enterprise<span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">+=</span> _totalEmissions<span class="token punctuation">;</span>
        
        <span class="token keyword">emit</span> <span class="token function">UpdateEnterpriseEmission</span><span class="token punctuation">(</span>_enterpriseAddr<span class="token punctuation">,</span>_totalEmissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    <span class="token comment">/*
    * @dev 企业的碳排放
    * @param _emissionEmission 企业的实际碳排放量
    */</span>
    <span class="token keyword">function</span> <span class="token function">enterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionEmission<span class="token punctuation">,</span><span class="token builtin">bool</span> _isCompulsion<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;请更新当前的总排放量&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> enterprise <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EmissionResource <span class="token keyword">storage</span> emissionResource <span class="token operator">=</span> idToEmissionMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token keyword">require</span><span class="token punctuation">(</span>emissionResource<span class="token punctuation">.</span>emissions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前申请排放量已用完&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            idToEmissionMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">.</span>isApprove <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token operator">||</span> 
            _emissionEmission <span class="token operator">&lt;=</span> idToEmissionMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">.</span>emissions<span class="token punctuation">,</span><span class="token string">&quot;请确定是否审批或是否大于审批的排放量&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 超额罚款</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_isCompulsion<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token builtin">uint256</span> excessTotal <span class="token operator">=</span> SafeMath<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>_emissionEmission<span class="token punctuation">,</span>enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            enterprise<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">-=</span> SafeMath<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>excessTotal<span class="token punctuation">,</span>EXCESS_BALANCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            emissionResource<span class="token punctuation">.</span>emissions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 扣款额度</span>
            enterprise<span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">-=</span> _emissionEmission<span class="token punctuation">;</span>
            enterprise<span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">-=</span> _emissionEmission<span class="token punctuation">;</span>
            emissionResource<span class="token punctuation">.</span>emissions <span class="token operator">-=</span> _emissionEmission<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        enterprise<span class="token punctuation">.</span>enterpriseOverEmission <span class="token operator">+=</span> _emissionEmission<span class="token punctuation">;</span>
        emissionResource<span class="token punctuation">.</span>time <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> emissionResources<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>emissionResources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                emissionResources<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> emissionResource<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">emit</span> <span class="token function">EnterpriseEmission</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_emissionEmission<span class="token punctuation">,</span>_isCompulsion<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">return</span> emissionResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    <span class="token comment">/*
    * @dev 分页拆查询企业出售信息
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">selectAllEnterpriseAssets</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EAsset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>eassets<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有企业出售碳资产&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> eassets<span class="token punctuation">.</span>length <span class="token operator">?</span> eassets<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        EAsset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> eAssetArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EAsset</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            eAssetArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> eassets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> eAssetArr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/*
    * @dev 分页拆查询所有企业排放资源的信息
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryAllEmissionResources</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>emissionResources<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有企业排放资产信息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> emissionResources<span class="token punctuation">.</span>length <span class="token operator">?</span> emissionResources<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        EmissionResource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> emissionResourceArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmissionResource</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            emissionResourceArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> emissionResources<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> emissionResourceArr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">/*
    * @dev 查看交易详细信息
    *
    */</span>
    <span class="token keyword">function</span> <span class="token function">selectTransactionInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _transactionId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Transaction <span class="token keyword">memory</span> transaction <span class="token operator">=</span> transactionMap<span class="token punctuation">[</span>_transactionId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> transaction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    <span class="token comment">/*
    * @dev 查看企业的积分余额
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseCredit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">CheckVerify</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> enterpriseMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/*
    * @dev 查看企业已完成的排放量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseTotalEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> enterpriseMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseOverEmission<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 查看企业的碳额度出售信息情况
    * @param _eassetId 企业出售额度列表的ID
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseAssetInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _eassetId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EAsset <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EAsset <span class="token keyword">memory</span> easset <span class="token operator">=</span> eassetMap<span class="token punctuation">[</span>_eassetId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> easset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    
    <span class="token comment">/*
    * @dev 查看企业的碳排放信息情况
    * @param _enterpriseAddr 企业的地址
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseEmissionInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EmissionResource <span class="token keyword">memory</span> emissionResource <span class="token operator">=</span> idToEmissionMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> emissionResource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    
    <span class="token comment">/*
    * @dev 清空所有企业的每个月的已完成的排放量
    *
    */</span>
    <span class="token keyword">function</span> <span class="token function">clearOverEmissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enterprisesAddress<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseOverEmission <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 每个月发放额度1000
    *
    */</span>
    <span class="token keyword">function</span> <span class="token function">initEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _qualificationEmissionLimit<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enterprisesAddress<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _qualificationEmissionLimit<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h3 id="_4-5-carbonexcitationv2合约业务介绍"><a href="#_4-5-carbonexcitationv2合约业务介绍" class="header-anchor">#</a> 4.5 CarbonExcitationV2合约业务介绍</h3> <p>CarbonExcitationV2的主要业务：</p> <ul><li><p>负责根据所有企业的名称地址以及排放量和积分进行统计</p></li> <li><p>在后端进行将统计完的企业排序，按照排放量底的排序</p></li> <li><p>根据基本的情况进行积分的奖励</p></li></ul> <h3 id="_4-6-carbonexcitationv2合约"><a href="#_4-6-carbonexcitationv2合约" class="header-anchor">#</a> 4.6 CarbonExcitationV2合约</h3> <p>CarbonExcitationV2主要的函数：</p> <ul><li><code>selectWinnerOfCompute()</code>  ： 统计所有企业的函数</li> <li><code>winersCredit()</code>  : 积分奖励函数</li></ul> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.4.25</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./CarbonCertificationV2.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 用于计算企业排名 对企业的排名做积分奖励</span>
<span class="token keyword">contract</span> <span class="token class-name">CarbonExcitationV2</span> <span class="token keyword">is</span> CarbonCertificationV2 <span class="token punctuation">{</span>
    
    <span class="token comment">// 所有企业的地址</span>
    <span class="token keyword">struct</span> <span class="token class-name">Credit</span> <span class="token punctuation">{</span>
        <span class="token builtin">string</span>  enterpriseName<span class="token punctuation">;</span>
        <span class="token builtin">address</span> enterpriseAddr<span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> overEmission<span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> enterpriseCredit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    Credit<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> credits<span class="token punctuation">;</span>
    
    <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> winers<span class="token punctuation">;</span>
    
    <span class="token comment">// 这里是返回所有的address</span>
    <span class="token keyword">function</span> <span class="token function">selectWinnerOfCompute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Credit<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Credit<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> credits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Credit</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>enterprisesAddress<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> enterpriseLength <span class="token operator">=</span> enterprisesAddress<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enterpriseLength<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
            credits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseName <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseName<span class="token punctuation">;</span>
            credits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddr <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
            credits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>overEmission <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseOverEmission<span class="token punctuation">;</span>
            credits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCredit <span class="token operator">=</span> enterpriseMap<span class="token punctuation">[</span>enterprisesAddress<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> credits<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">winersCredit</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> queryWinners<span class="token punctuation">,</span><span class="token builtin">uint256</span> _credits<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> _5Credits <span class="token operator">=</span> _credits <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> _4Credits <span class="token operator">=</span> _credits <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> _3Credits <span class="token operator">=</span> _credits <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> _2Credits <span class="token operator">=</span> _credits <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> queryWinners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> _5Credits<span class="token punctuation">;</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _credits<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> _4Credits<span class="token punctuation">;</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _credits<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> _3Credits<span class="token punctuation">;</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _credits<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> _2Credits<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                enterpriseMap<span class="token punctuation">[</span>queryWinners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> _credits<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h3 id="重构版合约"><a href="#重构版合约" class="header-anchor">#</a> 重构版合约</h3> <p>CarbonAssetService合约：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.10</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./CarbonUserService.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">CarbonAssetService</span> <span class="token keyword">is</span> CarbonUserService <span class="token punctuation">{</span>
    
    
    <span class="token comment">/*
    * @dev 每个月发放额度1000
    *
    */</span>
    <span class="token keyword">function</span> <span class="token function">initEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _qualificationEmissionLimit<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> EnterpriseIDList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Enterprise <span class="token keyword">memory</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>userIdQueryAddress<span class="token punctuation">[</span>EnterpriseIDList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>enterpriseVerified<span class="token punctuation">)</span><span class="token punctuation">{</span>
                QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _qualificationEmissionLimit<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 积分奖励
    *
    */</span>
    <span class="token keyword">function</span> <span class="token function">initPointsRewards</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> _enterpriseAddressList<span class="token punctuation">,</span><span class="token builtin">uint256</span> _credited<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> enterpriseLength <span class="token operator">=</span> _enterpriseAddressList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> enterpriseLength<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin">address</span> _enterpriseAddress <span class="token operator">=</span> _enterpriseAddressList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    _enterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> <span class="token punctuation">(</span>_credited <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    _enterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> <span class="token punctuation">(</span>_credited <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
    * @dev 企业出售碳额度
    * @param _emissionLimitCount 企业的碳额度数量
    * @param _amount 企业出售的单价
    */</span>
    <span class="token keyword">function</span> <span class="token function">sellEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>EnterpriseAsset <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">memory</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EnterpriseAsset <span class="token keyword">storage</span> _enterpriseAsset <span class="token operator">=</span> EnterpriseAssetsMap<span class="token punctuation">[</span>EnterpriseAssetID<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">&lt;</span> _emissionLimitCount<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70001</span><span class="token punctuation">,</span>_enterpriseAsset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetId <span class="token operator">=</span> EnterpriseAssetID<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>enterpriseId <span class="token operator">=</span> _enterprise<span class="token punctuation">.</span>enterpriseId<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span> _enterprise<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetQuantity <span class="token operator">=</span> _emissionLimitCount<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetAmount <span class="token operator">=</span> _amount<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>time <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        EnterpriseAssetIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>EnterpriseAssetID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        EnterpriseAssetID<span class="token operator">++</span><span class="token punctuation">;</span>
        
        _qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">-=</span> _emissionLimitCount<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">SellEmissionLimit</span><span class="token punctuation">(</span>_emissionLimitCount<span class="token punctuation">,</span>_amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_enterpriseAsset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/**
     * @dev 企业碳额度进行补货操作
     * @param _emissionId 订单ID
     * @param _emissionLimitCount 补货的数量
     * @param _amount 修改的单价
     */</span>
    <span class="token keyword">function</span> <span class="token function">updateEmissionAsset</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emissionId<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">memory</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EnterpriseAsset <span class="token keyword">storage</span> _enterpriseAsset <span class="token operator">=</span> EnterpriseAssetsMap<span class="token punctuation">[</span>_emissionId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">&lt;</span> _emissionLimitCount<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 本身的碳额度不能小于补货的</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetQuantity  <span class="token operator">+=</span>_emissionLimitCount<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetAmount <span class="token operator">=</span> _amount<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">-=</span> _emissionLimitCount<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     *  @dev 企业购买碳排放额度
     *  @param _enterpriseSeller 购买碳排放额度的地址
     *  @param _eassetId 资产ID
     *  @param _quantity 购买碳排放额度的数量
     */</span>
    <span class="token keyword">function</span> <span class="token function">buyEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseSeller<span class="token punctuation">,</span><span class="token builtin">uint256</span> _eassetId<span class="token punctuation">,</span><span class="token builtin">uint256</span> _quantity<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>Transaction <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _buyer <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _seller <span class="token operator">=</span>  EnterprisesMap<span class="token punctuation">[</span>_enterpriseSeller<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_buyer<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EnterpriseAsset <span class="token keyword">storage</span> _enterpriseAsset <span class="token operator">=</span> EnterpriseAssetsMap<span class="token punctuation">[</span>_eassetId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Transaction <span class="token keyword">storage</span> _transaction <span class="token operator">=</span> TransactionsMap<span class="token punctuation">[</span>TransactionID<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 余额不足的情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_buyer<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">&lt;</span> <span class="token punctuation">(</span>_quantity <span class="token operator">*</span> _enterpriseAsset<span class="token punctuation">.</span>assetAmount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70002</span><span class="token punctuation">,</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterpriseAsset<span class="token punctuation">.</span>assetQuantity <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            _enterpriseAsset<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70004</span><span class="token punctuation">,</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 资产数量的计算</span>
        _qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _quantity<span class="token punctuation">;</span>
        _enterpriseAsset<span class="token punctuation">.</span>assetQuantity <span class="token operator">-=</span> _quantity<span class="token punctuation">;</span>
        
        <span class="token comment">// 金额的交易</span>
        _buyer<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">-=</span> <span class="token punctuation">(</span>_quantity <span class="token operator">*</span> _enterpriseAsset<span class="token punctuation">.</span>assetAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _seller<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">+=</span> <span class="token punctuation">(</span>_quantity <span class="token operator">*</span> _enterpriseAsset<span class="token punctuation">.</span>assetAmount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 交易订单的生成</span>
        _transaction<span class="token punctuation">.</span>transactionId <span class="token operator">=</span> TransactionID<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>buyerId <span class="token operator">=</span> _buyer<span class="token punctuation">.</span>enterpriseId<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>sellerId <span class="token operator">=</span> _seller<span class="token punctuation">.</span>enterpriseId<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionOrderName <span class="token operator">=</span> <span class="token string">&quot;碳额度交易&quot;</span><span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionBuyAddress <span class="token operator">=</span> _buyer<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionSellAddress <span class="token operator">=</span> _seller<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        _transaction<span class="token punctuation">.</span>transactionQuantity <span class="token operator">=</span> _quantity<span class="token punctuation">;</span>
        TransactionIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>TransactionID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        TransactionID<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">TransferEmissionLimit</span><span class="token punctuation">(</span>_enterpriseSeller<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_quantity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     *  @dev 企业的碳排放申请  
     *  @param _enterpriseAddr 企业的账户地址
     *  @param _emissionEmission 企业排放的量
     *  @param _description  企业排放的描述
     *  @param _emissionWay 排放的方式
     */</span>
    <span class="token keyword">function</span> <span class="token function">uploadEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionEmission<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _description<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _emissionWay<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>EmissionResource <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO:</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        EmissionResource <span class="token keyword">storage</span> _emissionResource <span class="token operator">=</span> EmissionResourcesMap<span class="token punctuation">[</span>EmissionResourceID<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">memory</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断企业是否审核通过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_enterprise<span class="token punctuation">.</span>enterpriseVerified<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60005</span><span class="token punctuation">,</span>_emissionResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断企业的额度是否足够</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">&lt;</span> _emissionEmission<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70001</span><span class="token punctuation">,</span>_emissionResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _emissionResource<span class="token punctuation">.</span>emissionId <span class="token operator">=</span> EmissionResourceID<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>enterpriseId <span class="token operator">=</span> _enterprise<span class="token punctuation">.</span>enterpriseId<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span>  _enterprise<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>emissions <span class="token operator">=</span> _emissionEmission<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>description <span class="token operator">=</span> _description<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>emissionWay <span class="token operator">=</span> _emissionWay<span class="token punctuation">;</span>
        EmissionResourceIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>EmissionResourceID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        EmissionResourceID<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">UploadEnterpriseEmission</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_emissionResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/**
     *  @dev 审批企业的碳排放量
     *  @param _regularAddress 监管机构地址
     *  @param _enterpriseAddr 企业的账户地址
     *  @param _emmissionid 申请ID
     *  @param _isApprove 是否批准
     */</span>
    <span class="token keyword">function</span> <span class="token function">verifyEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regularAddress<span class="token punctuation">,</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">,</span><span class="token builtin">bool</span> _isApprove<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// TODO:</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EmissionResource <span class="token keyword">storage</span> _emissionResource <span class="token operator">=</span> EmissionResourcesMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断当前的地址是否为监管机构</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> _regularAddress<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60002</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断当前是否允许通过审批</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_isApprove<span class="token punctuation">)</span><span class="token punctuation">{</span>
            _emissionResource<span class="token punctuation">.</span>isApprove <span class="token operator">=</span> _isApprove<span class="token punctuation">;</span>
            QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">-=</span> _emissionResource<span class="token punctuation">.</span>emissions<span class="token punctuation">;</span>
            <span class="token keyword">emit</span> <span class="token function">VerifyEnterpriseEmission</span><span class="token punctuation">(</span>_regularAddress<span class="token punctuation">,</span>_enterpriseAddr<span class="token punctuation">,</span>_isApprove<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_isApprove<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            _emissionResource<span class="token punctuation">.</span>isApprove <span class="token operator">=</span> _isApprove<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_isApprove<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span>

    
    <span class="token comment">/**
     *  @dev 企业的碳排放
     *  @param _enterpriseAddr 企业地址
     *  @param _emmissionid 排放的资源ID
     *  @param _emissionEmission 企业的实际碳排放量
     */</span>
    <span class="token keyword">function</span> <span class="token function">enterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">,</span><span class="token builtin">uint256</span> _emissionEmission<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">bool</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// TODO: 更新用户的排放记录</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        EmissionResource <span class="token keyword">storage</span> _emissionResource <span class="token operator">=</span> EmissionResourcesMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_enterprise<span class="token punctuation">.</span>enterpriseVerified<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60005</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断申请是否通过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_emissionResource<span class="token punctuation">.</span>isApprove<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60006</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断是否更新了总排放量</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">70003</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _enterprise<span class="token punctuation">.</span>enterpriseOverEmission <span class="token operator">+=</span> _emissionEmission<span class="token punctuation">;</span>
        _emissionResource<span class="token punctuation">.</span>emissionTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">EnterpriseEmission</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span>_emissionResource<span class="token punctuation">.</span>emissionTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 分页拆查询企业的交易历史订单信息
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryTransactionsByPage</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>TransactionIDList<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有任何交易历史记录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> TransactionIDList<span class="token punctuation">.</span>length <span class="token operator">?</span> TransactionIDList<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        Transaction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> transactionArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transaction</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            transactionArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> TransactionsMap<span class="token punctuation">[</span>TransactionIDList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>transactionArr<span class="token punctuation">,</span>TransactionIDList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    * @dev 分页拆查询企业碳排放的历史记录
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEmissionResourceByPage</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>EmissionResourceIDList<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有任何交易历史记录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> EmissionResourceIDList<span class="token punctuation">.</span>length <span class="token operator">?</span> EmissionResourceIDList<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        EmissionResource<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> emissionResourceArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmissionResource</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            emissionResourceArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> EmissionResourcesMap<span class="token punctuation">[</span>EmissionResourceIDList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>emissionResourceArr<span class="token punctuation">,</span>EmissionResourceIDList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/*
    * @dev 分页拆查询企业出售的资产列表
    * @param page       查询的页数
    * @param pageSize   查询的每页的数量
    */</span>
    <span class="token keyword">function</span> <span class="token function">queryEnterpriseAssetByPage</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> page<span class="token punctuation">,</span><span class="token builtin">uint256</span> pageSize<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EnterpriseAsset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>EnterpriseAssetIDList<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;当前没有任何交易历史记录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>page <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;页数不能为0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> startIndex <span class="token operator">=</span> <span class="token punctuation">(</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算起始索引</span>
        <span class="token builtin">uint256</span> endIndex <span class="token operator">=</span> startIndex <span class="token operator">+</span> pageSize <span class="token operator">&gt;</span> EnterpriseAssetIDList<span class="token punctuation">.</span>length <span class="token operator">?</span> EnterpriseAssetIDList<span class="token punctuation">.</span>length <span class="token punctuation">:</span> startIndex <span class="token operator">+</span> pageSize<span class="token punctuation">;</span> <span class="token comment">// 计算结束索引</span>
        EnterpriseAsset<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> enterpriseAssetArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnterpriseAsset</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>endIndex <span class="token operator">-</span> startIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建每页大小的 Enterprise 数组</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> startIndex<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> endIndex<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            enterpriseAssetArr<span class="token punctuation">[</span>i <span class="token operator">-</span> startIndex<span class="token punctuation">]</span> <span class="token operator">=</span> EnterpriseAssetsMap<span class="token punctuation">[</span>EnterpriseAssetIDList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>enterpriseAssetArr<span class="token punctuation">,</span>EnterpriseAssetIDList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  @dev 更新总需排放量
     *  @param _emmissionsCount 总排放量
     */</span>
    <span class="token keyword">function</span> <span class="token function">updateEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emmissionsCount<span class="token punctuation">)</span> <span class="token keyword">public</span>  <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60004</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">+=</span> _emmissionsCount<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">UpdateEmissionLimit</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_emmissionsCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_emmissionsCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @dev 积分兑换碳额度
     * 
     */</span>
    <span class="token keyword">function</span> <span class="token function">byCreditsExchangedEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> _credits<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddr<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">-=</span> _credits<span class="token punctuation">;</span>
        QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> _credits<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @dev 企业的积分扣取
     * 
     */</span>
    <span class="token keyword">function</span> <span class="token function">subEnterpriseCredit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _credit<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">-=</span> _credit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">selectTransactionInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _transactionId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Transaction <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> TransactionsMap<span class="token punctuation">[</span>_transactionId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">selectSellerAssetInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _eassetId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EnterpriseAsset <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EnterpriseAssetsMap<span class="token punctuation">[</span>_eassetId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">selectEmissionResourceInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _emmissionid<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>EmissionResource <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> EmissionResourcesMap<span class="token punctuation">[</span>_emmissionid<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CarbonUserService合约：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.10</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;./CarbonDataStorage.sol&quot;</span><span class="token punctuation">;</span> 

<span class="token keyword">contract</span> <span class="token class-name">CarbonUserService</span> <span class="token keyword">is</span> CarbonDataStorage<span class="token punctuation">{</span>
    
    <span class="token keyword">event</span> <span class="token function">UserRegistered</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">uint256</span> _registerTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * @dev 注册用户
     * 
     */</span>
     <span class="token keyword">function</span> <span class="token function">registerEnterprise</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>Enterprise <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         userIdQueryAddress<span class="token punctuation">[</span>EnterpriseID<span class="token punctuation">]</span> <span class="token operator">=</span> _enterpriseAddress<span class="token punctuation">;</span>
         Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token comment">// TODO: 已完成已注册用户的校验</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             EnterpriseIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>EnterpriseID<span class="token punctuation">)</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseId <span class="token operator">=</span> EnterpriseID<span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span> _enterpriseAddress<span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseName <span class="token operator">=</span> _enterpriseName<span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseBalance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseTotalEmission <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseOverEmission <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>enterpriseVerified <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>userType <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
             _enterprise<span class="token punctuation">.</span>qualificationId <span class="token operator">=</span> EnterpriseID<span class="token punctuation">;</span>
             EnterpriseID<span class="token operator">++</span><span class="token punctuation">;</span>
             <span class="token keyword">emit</span> <span class="token function">UserRegistered</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">,</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_enterprise<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60001</span><span class="token punctuation">,</span>_enterprise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">// 更新企业的信息</span>
    <span class="token keyword">function</span> <span class="token function">updateEnterprise</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">=</span> _enterpriseAddress<span class="token punctuation">;</span>
        _enterprise<span class="token punctuation">.</span>enterpriseName <span class="token operator">=</span> _enterpriseName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @dev 注册监管机构
     * 
     */</span>
    <span class="token keyword">function</span> <span class="token function">registerRegulator</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regulatorAddress<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _regulatorName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>Regulator <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Regulator <span class="token keyword">storage</span> _regulator <span class="token operator">=</span> RegulatorsMap<span class="token punctuation">[</span>_regulatorAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO: 已完成已注册机构的校验</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_regulator<span class="token punctuation">.</span>regulatorAddress <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            RegulatorIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>RegulatorID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _regulator<span class="token punctuation">.</span>regulatorId <span class="token operator">=</span> RegulatorID<span class="token punctuation">;</span>
            _regulator<span class="token punctuation">.</span>regulatorAddress <span class="token operator">=</span> _regulatorAddress<span class="token punctuation">;</span>
            _regulator<span class="token punctuation">.</span>regulatorName <span class="token operator">=</span> _regulatorName<span class="token punctuation">;</span>
            _regulator<span class="token punctuation">.</span>userType <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            RegulatorID<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">emit</span> <span class="token function">UserRegistered</span><span class="token punctuation">(</span>_regulatorAddress<span class="token punctuation">,</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_regulator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _regulator <span class="token operator">=</span> RegulatorsMap<span class="token punctuation">[</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60001</span><span class="token punctuation">,</span>_regulator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">/**
     * @dev 企业上传资质
     * 
     */</span>
     <span class="token keyword">function</span> <span class="token function">uploadQualification</span><span class="token punctuation">(</span>
         <span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span>
         <span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationName<span class="token punctuation">,</span>
         <span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationContent<span class="token punctuation">,</span>
         <span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationLeader<span class="token punctuation">,</span>
         <span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationIndustry<span class="token punctuation">,</span>
         <span class="token builtin">string</span> <span class="token keyword">memory</span> _qualificationUserName
    <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">,</span>Qualification <span class="token keyword">memory</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// TODO: 后端查询当前的资质是否已经上传</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>qualificationId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60004</span><span class="token punctuation">,</span><span class="token string">&quot;当前的企业未注册&quot;</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        QualificationIDList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> _enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationId <span class="token operator">=</span> _enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationName <span class="token operator">=</span> _qualificationName<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationContent <span class="token operator">=</span> _qualificationContent<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationLeader <span class="token operator">=</span> _qualificationLeader<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationIndustry <span class="token operator">=</span> _qualificationIndustry<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationUserName <span class="token operator">=</span> _qualificationUserName<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationUploadTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">UploadQualification</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>_qualificationName<span class="token punctuation">,</span>_qualificationContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;上传成功&quot;</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    

    <span class="token comment">/**
     * @dev 监管机构审核企业资质
     * 
     */</span>    
    <span class="token keyword">function</span> <span class="token function">verifyQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> _regulatorAddress<span class="token punctuation">,</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token builtin">bool</span> _isApprove<span class="token punctuation">)</span> <span class="token keyword">public</span>  <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>Qualification <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Enterprise <span class="token keyword">storage</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Qualification <span class="token keyword">storage</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 判断是否为监管机构地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> _regulatorAddress <span class="token operator">||</span> _enterpriseAddress <span class="token operator">!=</span> _enterprise<span class="token punctuation">.</span>enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60002</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>enterpriseVerified<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60003</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_isApprove<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        _enterprise<span class="token punctuation">.</span>enterpriseVerified <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationVerifiedRegulator <span class="token operator">=</span> _regulatorAddress<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationAuditTime <span class="token operator">=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
        _qualification<span class="token punctuation">.</span>qualificationEmissionLimit <span class="token operator">+=</span> TOTAL_EMISSION<span class="token punctuation">;</span>
        <span class="token keyword">emit</span> <span class="token function">VerifyQualification</span><span class="token punctuation">(</span>_enterpriseAddress<span class="token punctuation">,</span>TOTAL_EMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @dev 签到领取积分
     * 
     */</span>
     <span class="token keyword">function</span> <span class="token function">signIn</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> _enterpriseAddress<span class="token punctuation">,</span><span class="token string">&quot;当前用户不是企业&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseCarbonCredits <span class="token operator">+=</span> SIGNIN_CREDIT<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span>SIGNIN_CREDIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
    
    
    <span class="token comment">/**
     * @dev 查询用户地址
     * 
     */</span>
    <span class="token keyword">function</span> <span class="token function">selectUserAddress</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _enterpriseID<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token builtin">address</span> _enterpriseAddress <span class="token operator">=</span> userIdQueryAddress<span class="token punctuation">[</span>EnterpriseID<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterpriseAddress <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60004</span><span class="token punctuation">,</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_enterpriseAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @dev 查询企业用户信息
     * 
     */</span>
     <span class="token keyword">function</span> <span class="token function">selectEnterpriseInfo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>Enterprise <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">require</span><span class="token punctuation">(</span>EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前用户未注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
    <span class="token comment">/**
     * @dev 查询企业的资质信息
     * 
     */</span>
     <span class="token keyword">function</span> <span class="token function">selectQualificationInfo</span><span class="token punctuation">(</span><span class="token builtin">address</span> _enterpriseAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span>Qualification <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token builtin">int</span> res_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         Enterprise <span class="token keyword">memory</span> _enterprise <span class="token operator">=</span> EnterprisesMap<span class="token punctuation">[</span>_enterpriseAddress<span class="token punctuation">]</span><span class="token punctuation">;</span>
         Qualification <span class="token keyword">memory</span> _qualification <span class="token operator">=</span> QualificationsMap<span class="token punctuation">[</span>_enterprise<span class="token punctuation">.</span>qualificationId<span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>_enterprise<span class="token punctuation">.</span>enterpriseAddress <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token keyword">return</span><span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">60004</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>res_code <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">,</span>_qualification<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
    <span class="token keyword">function</span> <span class="token function">updateBalance</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _amount<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前用户未注册&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EnterprisesMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">.</span>enterpriseBalance <span class="token operator">+=</span> _amount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>CarbonDataStorage合约：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.10</span><span class="token punctuation">;</span>

<span class="token comment">// 定义公共的数据结构</span>
<span class="token keyword">contract</span> <span class="token class-name">CarbonDataStorage</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个结构体来表示企业账户信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Enterprise</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> enterpriseId<span class="token punctuation">;</span>                   <span class="token comment">// 账户ID</span>
        <span class="token builtin">address</span> enterpriseAddress<span class="token punctuation">;</span>              <span class="token comment">// 账户地址</span>
        <span class="token builtin">string</span>  enterpriseName<span class="token punctuation">;</span>                 <span class="token comment">// 企业名称</span>
        <span class="token builtin">uint256</span> enterpriseBalance<span class="token punctuation">;</span>              <span class="token comment">// 账户余额</span>
        <span class="token builtin">uint256</span> enterpriseTotalEmission<span class="token punctuation">;</span>        <span class="token comment">// 总需排放的量</span>
        <span class="token builtin">uint256</span> enterpriseOverEmission<span class="token punctuation">;</span>         <span class="token comment">// 已完成的排放量</span>
        <span class="token builtin">uint256</span> enterpriseCarbonCredits<span class="token punctuation">;</span>        <span class="token comment">// 奖励积分</span>
        <span class="token builtin">bool</span> enterpriseVerified<span class="token punctuation">;</span>                <span class="token comment">// 是否通过审核</span>
        <span class="token builtin">uint8</span> userType<span class="token punctuation">;</span>                         <span class="token comment">// 账户角色</span>
        <span class="token builtin">uint256</span> qualificationId<span class="token punctuation">;</span>                <span class="token comment">// 资质信息Id</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义一个结构体来表示企业的资质信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Qualification</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> qualificationId<span class="token punctuation">;</span>                      <span class="token comment">// 资质ID</span>
        <span class="token builtin">string</span>  qualificationName<span class="token punctuation">;</span>                    <span class="token comment">// 企业名称</span>
        <span class="token builtin">string</span>  qualificationContent<span class="token punctuation">;</span>                 <span class="token comment">// 社会信用代码</span>
        <span class="token builtin">string</span>  qualificationLeader<span class="token punctuation">;</span>                  <span class="token comment">// 法定代表人</span>
        <span class="token builtin">string</span>  qualificationIndustry<span class="token punctuation">;</span>                <span class="token comment">// 所属的行业</span>
        <span class="token builtin">string</span>  qualificationUserName<span class="token punctuation">;</span>                <span class="token comment">// 联系人姓名</span>
        <span class="token builtin">uint256</span> qualificationUploadTime<span class="token punctuation">;</span>              <span class="token comment">// 上传时间</span>
        <span class="token builtin">uint256</span> qualificationAuditTime<span class="token punctuation">;</span>               <span class="token comment">// 审核时间</span>
        <span class="token builtin">address</span> qualificationVerifiedRegulator<span class="token punctuation">;</span>       <span class="token comment">// 审核的监管机构地址</span>
        <span class="token builtin">uint256</span> qualificationEmissionLimit<span class="token punctuation">;</span>           <span class="token comment">// 碳排放额度</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 定义一个结构体来表示监管部门账户信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Regulator</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> regulatorId<span class="token punctuation">;</span>            <span class="token comment">// 账户ID</span>
        <span class="token builtin">address</span> regulatorAddress<span class="token punctuation">;</span>       <span class="token comment">// 账户地址</span>
        <span class="token builtin">string</span>  regulatorName<span class="token punctuation">;</span>          <span class="token comment">// 部门名称</span>
        <span class="token builtin">uint8</span> userType<span class="token punctuation">;</span>                 <span class="token comment">// 账户类型</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 定义一个结构体来表示交易订单信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">Transaction</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> transactionId<span class="token punctuation">;</span>               <span class="token comment">// 订单的交易ID</span>
        <span class="token builtin">uint256</span> buyerId<span class="token punctuation">;</span>                     <span class="token comment">// 买家ID</span>
        <span class="token builtin">uint256</span> sellerId<span class="token punctuation">;</span>                    <span class="token comment">// 卖家的ID</span>
        <span class="token builtin">string</span>  transactionOrderName<span class="token punctuation">;</span>        <span class="token comment">// 订单的名字</span>
        <span class="token builtin">address</span> transactionBuyAddress<span class="token punctuation">;</span>       <span class="token comment">// 买家地址</span>
        <span class="token builtin">address</span> transactionSellAddress<span class="token punctuation">;</span>      <span class="token comment">// 卖家地址</span>
        <span class="token builtin">uint256</span> transactionTime<span class="token punctuation">;</span>             <span class="token comment">// 订单创建时间</span>
        <span class="token builtin">uint256</span> transactionQuantity<span class="token punctuation">;</span>         <span class="token comment">// 购买碳额度的数量</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 排放碳资源的结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">EmissionResource</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> emissionId<span class="token punctuation">;</span>          <span class="token comment">// 排放资源的ID </span>
        <span class="token builtin">uint256</span> enterpriseId<span class="token punctuation">;</span>        <span class="token comment">// 企业的ID</span>
        <span class="token builtin">address</span> enterpriseAddress<span class="token punctuation">;</span>   <span class="token comment">// 排放的企业</span>
        <span class="token builtin">uint256</span> emissions<span class="token punctuation">;</span>           <span class="token comment">// 排放的量</span>
        <span class="token builtin">string</span>  description<span class="token punctuation">;</span>         <span class="token comment">// 排放的资源描述</span>
        <span class="token builtin">string</span>  emissionWay<span class="token punctuation">;</span>         <span class="token comment">// 排放的方式</span>
        <span class="token builtin">bool</span>    isApprove<span class="token punctuation">;</span>           <span class="token comment">// 是否批准排放</span>
        <span class="token builtin">uint256</span> emissionTime<span class="token punctuation">;</span>        <span class="token comment">// 排放时间</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 企业出售碳资产的结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">EnterpriseAsset</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> assetId<span class="token punctuation">;</span>                   <span class="token comment">// 企业出售碳资产的列表Id</span>
        <span class="token builtin">uint256</span> enterpriseId<span class="token punctuation">;</span>           <span class="token comment">// 企业的ID</span>
        <span class="token builtin">address</span> enterpriseAddress<span class="token punctuation">;</span>      <span class="token comment">// 企业出售碳资产的账户地址</span>
        <span class="token builtin">uint256</span> assetQuantity<span class="token punctuation">;</span>          <span class="token comment">// 企业出售碳资产的数量 </span>
        <span class="token builtin">uint256</span> assetAmount<span class="token punctuation">;</span>            <span class="token comment">// 企业出售碳资产的价钱</span>
        <span class="token builtin">uint256</span> time<span class="token punctuation">;</span>                   <span class="token comment">// 企业出售碳资产的时间</span>
        <span class="token builtin">uint8</span>   status<span class="token punctuation">;</span>                 <span class="token comment">// 出售订单的状态</span>
    <span class="token punctuation">}</span>
    
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> EnterpriseID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> QualificationID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> RegulatorID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> TransactionID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> EmissionResourceID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> EnterpriseAssetID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> SIGNIN_CREDIT <span class="token operator">=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> <span class="token keyword">public</span> TOTAL_EMISSION <span class="token operator">=</span> <span class="token builtin">uint256</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 默认固定下发的额度</span>
    
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> EnterpriseIDList<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> RegulatorIDList<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> QualificationIDList<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> TransactionIDList<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> EmissionResourceIDList<span class="token punctuation">;</span>
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> EnterpriseAssetIDList<span class="token punctuation">;</span>
     
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> <span class="token builtin">address</span><span class="token punctuation">)</span> <span class="token keyword">public</span> userIdQueryAddress<span class="token punctuation">;</span> <span class="token comment">// 用户ID映射用户地址</span>
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> Enterprise<span class="token punctuation">)</span> <span class="token keyword">public</span> EnterprisesMap<span class="token punctuation">;</span>  <span class="token comment">// 企业ID映射企业信息</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> Qualification<span class="token punctuation">)</span> <span class="token keyword">public</span> QualificationsMap<span class="token punctuation">;</span>  <span class="token comment">// 资质ID映射资质信息</span>
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=&gt;</span> Regulator<span class="token punctuation">)</span> <span class="token keyword">public</span> RegulatorsMap<span class="token punctuation">;</span>  <span class="token comment">// 监管机构ID映射监管机构信息</span>

    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> Transaction<span class="token punctuation">)</span> <span class="token keyword">public</span> TransactionsMap<span class="token punctuation">;</span>  <span class="token comment">// 交易ID映射交易信息</span>
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> EmissionResource<span class="token punctuation">)</span> <span class="token keyword">public</span> EmissionResourcesMap<span class="token punctuation">;</span>  <span class="token comment">// 排放资源ID映射排放资源信息</span>
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> EnterpriseAsset<span class="token punctuation">)</span> <span class="token keyword">public</span> EnterpriseAssetsMap<span class="token punctuation">;</span>   <span class="token comment">// 企业出售额度ID映射企业出售详细订单</span>
    
    <span class="token comment">// 上传审核的事件</span>
    <span class="token keyword">event</span> <span class="token function">UploadQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _acount<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">indexed</span> _name<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">indexed</span> _content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 审批企业申请的事件</span>
    <span class="token keyword">event</span> <span class="token function">VerifyQualification</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 交易碳额度</span>
    <span class="token keyword">event</span> <span class="token function">TransferEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _from<span class="token punctuation">,</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _to<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 出售碳额度</span>
    <span class="token keyword">event</span> <span class="token function">SellEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimitCount<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新企业账户的余额</span>
    <span class="token keyword">event</span> <span class="token function">UpdateBalnce</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新企业账户的碳排放额度</span>
    <span class="token keyword">event</span> <span class="token function">UpdateEmissionLimit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 申请企业碳排放</span>
    <span class="token keyword">event</span> <span class="token function">UploadEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 监管机构审核企业碳排放</span>
    <span class="token keyword">event</span> <span class="token function">VerifyEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _form<span class="token punctuation">,</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _to<span class="token punctuation">,</span><span class="token builtin">bool</span> <span class="token keyword">indexed</span> _isAppore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 企业更新总需排放量</span>
    <span class="token keyword">event</span> <span class="token function">UpdateEnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _totalEmissions<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment">// 企业碳排放</span>
    <span class="token keyword">event</span> <span class="token function">EnterpriseEmission</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> _enterpriseAddr<span class="token punctuation">,</span><span class="token builtin">uint256</span> <span class="token keyword">indexed</span> _emissionEmission<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>SouvenirCard合约：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.6.10</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> experimental ABIEncoderV2<span class="token punctuation">;</span>

<span class="token comment">// 数字化纪念卡</span>
<span class="token keyword">contract</span> <span class="token class-name">SouvenirCard</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 纪念卡结构体</span>
    <span class="token keyword">struct</span> <span class="token class-name">CardInfo</span><span class="token punctuation">{</span>
        <span class="token builtin">uint256</span> cardId<span class="token punctuation">;</span>     <span class="token comment">// 纪念卡ID</span>
        <span class="token builtin">uint</span> level<span class="token punctuation">;</span>         <span class="token comment">// 纪念卡星级</span>
        <span class="token builtin">string</span> cardName<span class="token punctuation">;</span>    <span class="token comment">// 纪念卡名称</span>
        <span class="token builtin">string</span> cardDesc<span class="token punctuation">;</span>    <span class="token comment">// 纪念卡描述</span>
        <span class="token builtin">string</span> cardUrl<span class="token punctuation">;</span>     <span class="token comment">// 纪念卡的url</span>
        <span class="token builtin">string</span> category<span class="token punctuation">;</span>    <span class="token comment">// 纪念卡分类</span>
        <span class="token builtin">uint</span>   credit<span class="token punctuation">;</span>      <span class="token comment">// 需要积分的数量</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> <span class="token operator">=&gt;</span> CardInfo<span class="token punctuation">)</span> <span class="token keyword">public</span> CardInfoMap<span class="token punctuation">;</span>
    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token operator">=&gt;</span> <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">public</span> UserOfCardListMap<span class="token punctuation">;</span>
    
    <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> CardInfoList<span class="token punctuation">;</span>
    
    
    <span class="token comment">// 添加一个纪念卡</span>
    <span class="token keyword">function</span> <span class="token function">RegisterCard</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _cardId<span class="token punctuation">,</span><span class="token builtin">uint</span> _level<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardName<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardDesc<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardUrl<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _categoty<span class="token punctuation">,</span><span class="token builtin">uint</span> _credit<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsCardExist</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前的纪念卡已经存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       CardInfo <span class="token keyword">storage</span> _cardInfo <span class="token operator">=</span>  CardInfoMap<span class="token punctuation">[</span>_cardId<span class="token punctuation">]</span><span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardId <span class="token operator">=</span> _cardId<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardName <span class="token operator">=</span> _cardName<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardDesc <span class="token operator">=</span> _cardDesc<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardUrl <span class="token operator">=</span> _cardUrl<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>category <span class="token operator">=</span> _categoty<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>credit <span class="token operator">=</span> _credit<span class="token punctuation">;</span>
       
       CardInfoList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 判断一下该纪念卡是否已经存在</span>
    <span class="token keyword">function</span> <span class="token function">IsCardExist</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _cardId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>CardInfoMap<span class="token punctuation">[</span>_cardId<span class="token punctuation">]</span><span class="token punctuation">.</span>cardId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">// 查询当前的纪念卡是否已经存在</span>
    <span class="token keyword">function</span> <span class="token function">QueryCardInfo</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> _cardId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>CardInfo <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IsCardExist</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前的纪念卡不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> CardInfoMap<span class="token punctuation">[</span>_cardId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 企业添加一个纪念卡</span>
    <span class="token keyword">function</span> <span class="token function">UserBindCard</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">,</span><span class="token builtin">uint256</span> _cardId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IsCardExist</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前的纪念卡不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        UserOfCardListMap<span class="token punctuation">[</span>_enterpriseName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查询企业的所有纪念卡</span>
    <span class="token keyword">function</span> <span class="token function">QueryEnterpriseCardList</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span>CardInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> cardList <span class="token operator">=</span> UserOfCardListMap<span class="token punctuation">[</span>_enterpriseName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        CardInfo<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> cardInfoList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CardInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>cardList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cardList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            cardInfoList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> CardInfoMap<span class="token punctuation">[</span>cardList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cardInfoList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查询该企业是否已经有纪念卡</span>
    <span class="token keyword">function</span> <span class="token function">QueryEnterpriseIsHasCard</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _enterpriseName<span class="token punctuation">,</span><span class="token builtin">uint256</span> _cardId<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token builtin">uint256</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> cardList <span class="token operator">=</span> UserOfCardListMap<span class="token punctuation">[</span>_enterpriseName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> cardList<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cardList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> _cardId<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 更新纪念卡的信息    </span>
    <span class="token keyword">function</span> <span class="token function">UpdateCardInfo</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _cardId<span class="token punctuation">,</span><span class="token builtin">uint</span> _level<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardName<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardDesc<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _cardUrl<span class="token punctuation">,</span><span class="token builtin">string</span> <span class="token keyword">memory</span> _categoty<span class="token punctuation">,</span><span class="token builtin">uint</span> _credit<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
       <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">IsCardExist</span><span class="token punctuation">(</span>_cardId<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;当前的纪念卡不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       CardInfo <span class="token keyword">storage</span> _cardInfo <span class="token operator">=</span>  CardInfoMap<span class="token punctuation">[</span>_cardId<span class="token punctuation">]</span><span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardName <span class="token operator">=</span> _cardName<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardDesc <span class="token operator">=</span> _cardDesc<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>cardUrl <span class="token operator">=</span> _cardUrl<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>category <span class="token operator">=</span> _categoty<span class="token punctuation">;</span>
       _cardInfo<span class="token punctuation">.</span>credit <span class="token operator">=</span> _credit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查询用户已拥有的纪念卡数量</span>
    <span class="token keyword">function</span> <span class="token function">QueryEnterpriseCardNumber</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> enterpriseName<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint256</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> UserOfCardListMap<span class="token punctuation">[</span>enterpriseName<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-编译部署合约"><a href="#_5-编译部署合约" class="header-anchor">#</a> 5.编译部署合约</h2> <p>这里我使用的是WeBASE部署编译合约。</p> <p>部署WeBASE的教程：</p> <ul><li>官网： https://webasedoc.readthedocs.io/zh_CN/latest/docs/WeBASE-Install/developer.html</li> <li>我的CSDN：https://blog.csdn.net/weixin_46532941/article/details/129888194?spm=1001.2014.3001.5502</li> <li>我的博客：https://iskcount.gitee.io/docs/zh/web3/fisco/01.%E6%90%AD%E5%BB%BAFisco%E7%9A%84%E8%81%94%E7%9B%9F%E9%93%BE(WeBase%E7%89%88).html</li></ul> <h3 id="_5-1-创建测试用户"><a href="#_5-1-创建测试用户" class="header-anchor">#</a> 5.1 创建测试用户</h3> <blockquote><p>注册和调用合约切换账户的时候，需要选择指定的用户地址。</p></blockquote> <p>创建一个regulator用户，作为监管部门，use1-user3是测试企业。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020233156.webp" alt="image-20230402023328942"></p> <h3 id="_5-2-部署合约"><a href="#_5-2-部署合约" class="header-anchor">#</a> 5.2 部署合约</h3> <p>使用Admin用户部署<code>CarbonAssetV2</code>合约即可，合约之间我使用了集成的方式，所有需要用到一些公用的方法或者变量。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020227118.webp" alt="image-20230402022715839"></p> <h3 id="_5-3-企业审核资质完整业务测试"><a href="#_5-3-企业审核资质完整业务测试" class="header-anchor">#</a> 5.3 企业审核资质完整业务测试</h3> <p>1.注册企业和监管部门，分别注册user1-user3这三个企业，regulator注册为监管部门。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020229567.webp" alt="image-20230402022927638"></p> <p>返回正确的交易回执。同样的方式注册user2-user3企业。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020229430.webp" alt="image-20230402022958543"></p> <p>2.注册监管部门，使用regulator用户。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020234418.webp" alt="image-20230402023411082"></p> <p>返回正确的交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020235208.webp" alt="image-20230402023520229"></p> <p>3.三个测试企业上传资质。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020237933.webp" alt="image-20230402023712802"></p> <p>返回正确的交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020237430.webp" alt="image-20230402023735361"></p> <p>4.分页查询所有企业，查看是否都为待审核资质，未认证状态。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020239143.webp" alt="image-20230402023949047"></p> <p>如下状态为未认证状态。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020240896.webp" alt="image-20230402024011779"></p> <p>5.监管机构进行审批企业的上传的资质。</p> <p>测试数据：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</span><span class="token punctuation">,</span>测试企业<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 AAAA<span class="token punctuation">,</span><span class="token number">1680374216290</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xD2BA8A504a844dfa5d08b99A728aFa41aea0CdF8</span><span class="token punctuation">,</span>测试企业<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 BBBB<span class="token punctuation">,</span><span class="token number">1680374280332</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x10bb01703e57B0644E80026E35fBd29564b1F9Ca</span><span class="token punctuation">,</span>测试企业<span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 CCCC<span class="token punctuation">,</span><span class="token number">1680374301184</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre></div><p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020243884.webp" alt="image-20230402024300758"></p> <p>正确的返回交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020243715.webp" alt="image-20230402024327851"></p> <p>6.查看所有已通过审批的企业。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020245206.webp" alt="image-20230402024528072"></p> <p>如上就是完整的企业上传资质，审核企业资质的业务流程。然后就可以对企业的信息进行更新。所有数据更新完毕可以申请碳排放量的申请。</p> <h3 id="_5-4-企业碳排放量审批完整业务测试"><a href="#_5-4-企业碳排放量审批完整业务测试" class="header-anchor">#</a> 5.4 企业碳排放量审批完整业务测试</h3> <p>这是我更新完企业的余额和总排放量的数据：</p> <p>余额分别是<code>500</code>和总排放量分别是<code>25000,18000,15000</code></p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</span><span class="token punctuation">,</span>测试企业<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">25000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 AAAA<span class="token punctuation">,</span><span class="token number">1680374216290</span><span class="token punctuation">,</span><span class="token number">1680374567774</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xD2BA8A504a844dfa5d08b99A728aFa41aea0CdF8</span><span class="token punctuation">,</span>测试企业<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">18000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 BBBB<span class="token punctuation">,</span><span class="token number">1680374280332</span><span class="token punctuation">,</span><span class="token number">1680374620494</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x10bb01703e57B0644E80026E35fBd29564b1F9Ca</span><span class="token punctuation">,</span>测试企业<span class="token number">3</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 CCCC<span class="token punctuation">,</span><span class="token number">1680374301184</span><span class="token punctuation">,</span><span class="token number">1680374633060</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">]</span>
</code></pre></div><p>1.企业申请单次排放量</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020253974.webp" alt="image-20230402025310939"></p> <p>正确的返回交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020253624.webp" alt="image-20230402025344828"></p> <p>2.监管机构审核进行审批。</p> <p>企业提交申请会推送到所有的审批订单中，可以进行分页查询</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020257923.webp" alt="image-20230402025717931"></p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020257166.webp" alt="image-20230402025738012"></p> <p>对需要审核的进行审批。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020255018.webp" alt="image-20230402025535943"></p> <p>正确的返回交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020256947.webp" alt="image-20230402025656053"></p> <p>查询到的数据，当前<code>0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</code>的企业已经审批，可以进行排放。</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">,</span>污水排放<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xD2BA8A504a844dfa5d08b99A728aFa41aea0CdF8</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">,</span>超市排放<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x10bb01703e57B0644E80026E35fBd29564b1F9Ca</span><span class="token punctuation">,</span><span class="token number">800</span><span class="token punctuation">,</span>工厂排放<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">0</span>
</code></pre></div><p>3.企业正式碳排放，选择<code>false</code>，不强制排放。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020300283.webp" alt="image-20230402030028305"></p> <p>正确的返回交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020301202.webp" alt="image-20230402030118242"></p> <p>可以看到数据订单1是<code>0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</code>企业的，订单已经排放减少了300</p> <h3 id="_5-5-企业交易碳额度完整业务测试"><a href="#_5-5-企业交易碳额度完整业务测试" class="header-anchor">#</a> 5.5 企业交易碳额度完整业务测试</h3> <p>企业交易需要保证自身已有额度，不能为0。</p> <p>1.user1的企业出售100个碳额度，单价为20。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020305276.webp" alt="image-20230402030539326"></p> <p>正确的返回交易回执。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020306357.webp" alt="image-20230402030602619"></p> <p>2.user2企业去购买企业1的碳额度，购买数量为2。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020307117.webp" alt="image-20230402030723049"></p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020307297.webp" alt="image-20230402030740143"></p> <p>3.查看当前user2和user1的交易信息。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020308609.webp" alt="image-20230402030857667"></p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020309443.webp" alt="image-20230402030917329"></p> <p>4.查看user1和user2企业的信息。</p> <p><img src="https://blog-1304715799.cos.ap-nanjing.myqcloud.com/imgs/202304020309020.webp" alt="image-20230402030957980"></p> <p>返回最终测试数据：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0x2139148946600b07fC1E15CAE7a6B9152e35C4a4</span><span class="token punctuation">,</span>测试企业<span class="token number">1</span><span class="token punctuation">,</span><span class="token number">540</span><span class="token punctuation">,</span><span class="token number">24500</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 AAAA<span class="token punctuation">,</span><span class="token number">1680374216290</span><span class="token punctuation">,</span><span class="token number">1680374567774</span><span class="token punctuation">,</span><span class="token number">400</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0xD2BA8A504a844dfa5d08b99A728aFa41aea0CdF8</span><span class="token punctuation">,</span>测试企业<span class="token number">2</span><span class="token punctuation">,</span><span class="token number">460</span><span class="token punctuation">,</span><span class="token number">18000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 BBBB<span class="token punctuation">,</span><span class="token number">1680374280332</span><span class="token punctuation">,</span><span class="token number">1680374620494</span><span class="token punctuation">,</span><span class="token number">1002</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0x10bb01703e57B0644E80026E35fBd29564b1F9Ca</span><span class="token punctuation">,</span>测试企业<span class="token number">3</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token number">15000</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>企业认证<span class="token punctuation">,</span>认证编码 CCCC<span class="token punctuation">,</span><span class="token number">1680374301184</span><span class="token punctuation">,</span><span class="token number">1680374633060</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">]</span>
</code></pre></div><p>以上就是完整的合约案例+测试流程。</p></div></div> <!----> <div class="page-edit"><!----> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/CodeVault/pages/cca1e9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">FISCO BCOS Max搭建</div></a> <a href="/CodeVault/pages/3f1596/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">慈善公益解决方案</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/CodeVault/pages/cca1e9/" class="prev">FISCO BCOS Max搭建</a></span> <span class="next"><a href="/CodeVault/pages/3f1596/">慈善公益解决方案</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/CodeVault/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/CodeVault/pages/c936ca/"><div>
            学习文档
            <!----></div></a> <span class="date">11-28</span></dt></dl><dl><dd>02</dd> <dt><a href="/CodeVault/pages/53f082/"><div>
            如何成为FISCO社区的MVP 总结篇
            <!----></div></a> <span class="date">11-28</span></dt></dl><dl><dd>03</dd> <dt><a href="/CodeVault/pages/3d3086/"><div>
            一文搞懂Truffle测试
            <!----></div></a> <span class="date">11-28</span></dt></dl> <dl><dd></dd> <dt><a href="/CodeVault/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>YYzop & Hior | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/CodeVault/assets/js/app.ef278985.js" defer></script><script src="/CodeVault/assets/js/2.f96441c8.js" defer></script><script src="/CodeVault/assets/js/224.6bed6414.js" defer></script>
  </body>
</html>
