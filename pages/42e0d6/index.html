<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Istio由浅入深 | CodeVault文档站</title>
    <meta name="generator" content="VuePress 1.9.2">
    <link rel="icon" href="/CodeVault/img/Aj.svg">
    <meta name="description" content="CodeVault一个记录云计算、云原生、Java开发的文档站。">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/CodeVault/assets/css/0.styles.bcdd6f38.css" as="style"><link rel="preload" href="/CodeVault/assets/js/app.ef278985.js" as="script"><link rel="preload" href="/CodeVault/assets/js/2.f96441c8.js" as="script"><link rel="preload" href="/CodeVault/assets/js/129.67eabc56.js" as="script"><link rel="prefetch" href="/CodeVault/assets/js/10.0b981dbd.js"><link rel="prefetch" href="/CodeVault/assets/js/100.5c06c78f.js"><link rel="prefetch" href="/CodeVault/assets/js/101.88d67c9c.js"><link rel="prefetch" href="/CodeVault/assets/js/102.70928850.js"><link rel="prefetch" href="/CodeVault/assets/js/103.ef636770.js"><link rel="prefetch" href="/CodeVault/assets/js/104.c1927b63.js"><link rel="prefetch" href="/CodeVault/assets/js/105.85c8a7cd.js"><link rel="prefetch" href="/CodeVault/assets/js/106.fb2e66ea.js"><link rel="prefetch" href="/CodeVault/assets/js/107.0f35bf63.js"><link rel="prefetch" href="/CodeVault/assets/js/108.fccb735c.js"><link rel="prefetch" href="/CodeVault/assets/js/109.682036f0.js"><link rel="prefetch" href="/CodeVault/assets/js/11.ac4d24fe.js"><link rel="prefetch" href="/CodeVault/assets/js/110.b7f8edea.js"><link rel="prefetch" href="/CodeVault/assets/js/111.fd94666b.js"><link rel="prefetch" href="/CodeVault/assets/js/112.a07708f0.js"><link rel="prefetch" href="/CodeVault/assets/js/113.63efff87.js"><link rel="prefetch" href="/CodeVault/assets/js/114.ab1099fa.js"><link rel="prefetch" href="/CodeVault/assets/js/115.f5fe6b28.js"><link rel="prefetch" href="/CodeVault/assets/js/116.6ce08e8e.js"><link rel="prefetch" href="/CodeVault/assets/js/117.48dbb04e.js"><link rel="prefetch" href="/CodeVault/assets/js/118.5b909be0.js"><link rel="prefetch" href="/CodeVault/assets/js/119.8f6e0bf7.js"><link rel="prefetch" href="/CodeVault/assets/js/12.c1e5feb4.js"><link rel="prefetch" href="/CodeVault/assets/js/120.21cc7ba5.js"><link rel="prefetch" href="/CodeVault/assets/js/121.04134de2.js"><link rel="prefetch" href="/CodeVault/assets/js/122.31567951.js"><link rel="prefetch" href="/CodeVault/assets/js/123.002f9bee.js"><link rel="prefetch" href="/CodeVault/assets/js/124.e99e860a.js"><link rel="prefetch" href="/CodeVault/assets/js/125.72c926b3.js"><link rel="prefetch" href="/CodeVault/assets/js/126.01a5e87f.js"><link rel="prefetch" href="/CodeVault/assets/js/127.1956ebe6.js"><link rel="prefetch" href="/CodeVault/assets/js/128.d65996f5.js"><link rel="prefetch" href="/CodeVault/assets/js/13.13f84e24.js"><link rel="prefetch" href="/CodeVault/assets/js/130.634c4ce3.js"><link rel="prefetch" href="/CodeVault/assets/js/131.a418f195.js"><link rel="prefetch" href="/CodeVault/assets/js/132.ea662f19.js"><link rel="prefetch" href="/CodeVault/assets/js/133.63b2b38b.js"><link rel="prefetch" href="/CodeVault/assets/js/134.0cd9f3da.js"><link rel="prefetch" href="/CodeVault/assets/js/135.4e8913a1.js"><link rel="prefetch" href="/CodeVault/assets/js/136.53ad8182.js"><link rel="prefetch" href="/CodeVault/assets/js/137.8d8f6ff4.js"><link rel="prefetch" href="/CodeVault/assets/js/138.1e5627de.js"><link rel="prefetch" href="/CodeVault/assets/js/139.4c335178.js"><link rel="prefetch" href="/CodeVault/assets/js/14.92742bc3.js"><link rel="prefetch" href="/CodeVault/assets/js/140.ad32a483.js"><link rel="prefetch" href="/CodeVault/assets/js/141.509650db.js"><link rel="prefetch" href="/CodeVault/assets/js/142.8a4692a4.js"><link rel="prefetch" href="/CodeVault/assets/js/143.4226943d.js"><link rel="prefetch" href="/CodeVault/assets/js/144.a04016d3.js"><link rel="prefetch" href="/CodeVault/assets/js/145.55b32ea3.js"><link rel="prefetch" href="/CodeVault/assets/js/146.d78a1fa5.js"><link rel="prefetch" href="/CodeVault/assets/js/147.c48fa78d.js"><link rel="prefetch" href="/CodeVault/assets/js/148.24a7cd95.js"><link rel="prefetch" href="/CodeVault/assets/js/149.a74e35f1.js"><link rel="prefetch" href="/CodeVault/assets/js/15.6953f44b.js"><link rel="prefetch" href="/CodeVault/assets/js/150.7f27817b.js"><link rel="prefetch" href="/CodeVault/assets/js/151.6445d326.js"><link rel="prefetch" href="/CodeVault/assets/js/152.eadc171d.js"><link rel="prefetch" href="/CodeVault/assets/js/153.2da9c7f8.js"><link rel="prefetch" href="/CodeVault/assets/js/154.a3546076.js"><link rel="prefetch" href="/CodeVault/assets/js/155.351a616f.js"><link rel="prefetch" href="/CodeVault/assets/js/156.e6bbf3b3.js"><link rel="prefetch" href="/CodeVault/assets/js/157.ee152deb.js"><link rel="prefetch" href="/CodeVault/assets/js/158.076e0f8c.js"><link rel="prefetch" href="/CodeVault/assets/js/159.9ad1744e.js"><link rel="prefetch" href="/CodeVault/assets/js/16.df859e45.js"><link rel="prefetch" href="/CodeVault/assets/js/160.c5beea39.js"><link rel="prefetch" href="/CodeVault/assets/js/161.0cf956e1.js"><link rel="prefetch" href="/CodeVault/assets/js/162.c58e81e1.js"><link rel="prefetch" href="/CodeVault/assets/js/163.63d65593.js"><link rel="prefetch" href="/CodeVault/assets/js/164.9626ab8a.js"><link rel="prefetch" href="/CodeVault/assets/js/165.fc09035b.js"><link rel="prefetch" href="/CodeVault/assets/js/166.b38be38b.js"><link rel="prefetch" href="/CodeVault/assets/js/167.8f5417ed.js"><link rel="prefetch" href="/CodeVault/assets/js/168.d636e649.js"><link rel="prefetch" href="/CodeVault/assets/js/169.dd84c459.js"><link rel="prefetch" href="/CodeVault/assets/js/17.a2971fe6.js"><link rel="prefetch" href="/CodeVault/assets/js/170.a488616f.js"><link rel="prefetch" href="/CodeVault/assets/js/171.a7896a98.js"><link rel="prefetch" href="/CodeVault/assets/js/172.90b58f0e.js"><link rel="prefetch" href="/CodeVault/assets/js/173.ce66d68a.js"><link rel="prefetch" href="/CodeVault/assets/js/174.d0a94b6a.js"><link rel="prefetch" href="/CodeVault/assets/js/175.87ea7df7.js"><link rel="prefetch" href="/CodeVault/assets/js/176.67abf34b.js"><link rel="prefetch" href="/CodeVault/assets/js/177.3b2acda5.js"><link rel="prefetch" href="/CodeVault/assets/js/178.5fe697a5.js"><link rel="prefetch" href="/CodeVault/assets/js/179.57349e36.js"><link rel="prefetch" href="/CodeVault/assets/js/18.45b06c71.js"><link rel="prefetch" href="/CodeVault/assets/js/180.a8b6136e.js"><link rel="prefetch" href="/CodeVault/assets/js/181.c96cb1ac.js"><link rel="prefetch" href="/CodeVault/assets/js/182.e13a2ed6.js"><link rel="prefetch" href="/CodeVault/assets/js/183.4982d955.js"><link rel="prefetch" href="/CodeVault/assets/js/184.123e3912.js"><link rel="prefetch" href="/CodeVault/assets/js/185.c1db2bfa.js"><link rel="prefetch" href="/CodeVault/assets/js/186.bff6dc40.js"><link rel="prefetch" href="/CodeVault/assets/js/187.3e10e06d.js"><link rel="prefetch" href="/CodeVault/assets/js/188.53f01570.js"><link rel="prefetch" href="/CodeVault/assets/js/189.53c9b973.js"><link rel="prefetch" href="/CodeVault/assets/js/19.21381c2f.js"><link rel="prefetch" href="/CodeVault/assets/js/190.f9e298a3.js"><link rel="prefetch" href="/CodeVault/assets/js/191.7055ec43.js"><link rel="prefetch" href="/CodeVault/assets/js/192.6083d608.js"><link rel="prefetch" href="/CodeVault/assets/js/193.72e5d099.js"><link rel="prefetch" href="/CodeVault/assets/js/194.cb4c2f87.js"><link rel="prefetch" href="/CodeVault/assets/js/195.add61432.js"><link rel="prefetch" href="/CodeVault/assets/js/196.cafb716f.js"><link rel="prefetch" href="/CodeVault/assets/js/197.29ad1cb1.js"><link rel="prefetch" href="/CodeVault/assets/js/198.1ca9886c.js"><link rel="prefetch" href="/CodeVault/assets/js/199.28f7095d.js"><link rel="prefetch" href="/CodeVault/assets/js/20.fe478246.js"><link rel="prefetch" href="/CodeVault/assets/js/200.cdd91d66.js"><link rel="prefetch" href="/CodeVault/assets/js/201.568571d0.js"><link rel="prefetch" href="/CodeVault/assets/js/202.0b55d1cd.js"><link rel="prefetch" href="/CodeVault/assets/js/203.c9d7036e.js"><link rel="prefetch" href="/CodeVault/assets/js/204.f877fa44.js"><link rel="prefetch" href="/CodeVault/assets/js/205.f7dcea25.js"><link rel="prefetch" href="/CodeVault/assets/js/206.266f6bb0.js"><link rel="prefetch" href="/CodeVault/assets/js/207.962cdf0e.js"><link rel="prefetch" href="/CodeVault/assets/js/208.dcbb7fb9.js"><link rel="prefetch" href="/CodeVault/assets/js/209.89cb12fb.js"><link rel="prefetch" href="/CodeVault/assets/js/21.1a17ddc5.js"><link rel="prefetch" href="/CodeVault/assets/js/210.442ced55.js"><link rel="prefetch" href="/CodeVault/assets/js/211.6d14fe33.js"><link rel="prefetch" href="/CodeVault/assets/js/212.65a1883d.js"><link rel="prefetch" href="/CodeVault/assets/js/213.21351702.js"><link rel="prefetch" href="/CodeVault/assets/js/214.bd781706.js"><link rel="prefetch" href="/CodeVault/assets/js/215.f30b644c.js"><link rel="prefetch" href="/CodeVault/assets/js/216.587501ff.js"><link rel="prefetch" href="/CodeVault/assets/js/217.8db2123f.js"><link rel="prefetch" href="/CodeVault/assets/js/218.aa6b1af6.js"><link rel="prefetch" href="/CodeVault/assets/js/219.2b27640b.js"><link rel="prefetch" href="/CodeVault/assets/js/22.7652d0d6.js"><link rel="prefetch" href="/CodeVault/assets/js/220.eafe6218.js"><link rel="prefetch" href="/CodeVault/assets/js/221.ab153f73.js"><link rel="prefetch" href="/CodeVault/assets/js/222.4f7df33b.js"><link rel="prefetch" href="/CodeVault/assets/js/223.6f5b1e03.js"><link rel="prefetch" href="/CodeVault/assets/js/224.6bed6414.js"><link rel="prefetch" href="/CodeVault/assets/js/225.03a64323.js"><link rel="prefetch" href="/CodeVault/assets/js/226.2db9dc4b.js"><link rel="prefetch" href="/CodeVault/assets/js/227.6e01bc51.js"><link rel="prefetch" href="/CodeVault/assets/js/228.d06cad32.js"><link rel="prefetch" href="/CodeVault/assets/js/229.3f46b203.js"><link rel="prefetch" href="/CodeVault/assets/js/23.8a5bbf3f.js"><link rel="prefetch" href="/CodeVault/assets/js/230.b84fd605.js"><link rel="prefetch" href="/CodeVault/assets/js/231.ca2e1834.js"><link rel="prefetch" href="/CodeVault/assets/js/232.e572f662.js"><link rel="prefetch" href="/CodeVault/assets/js/233.0a7e6deb.js"><link rel="prefetch" href="/CodeVault/assets/js/234.9dddbcb6.js"><link rel="prefetch" href="/CodeVault/assets/js/235.b4ed574b.js"><link rel="prefetch" href="/CodeVault/assets/js/236.252b1f69.js"><link rel="prefetch" href="/CodeVault/assets/js/237.c529d9c4.js"><link rel="prefetch" href="/CodeVault/assets/js/238.16da920c.js"><link rel="prefetch" href="/CodeVault/assets/js/239.14f7892d.js"><link rel="prefetch" href="/CodeVault/assets/js/24.1ca1bd80.js"><link rel="prefetch" href="/CodeVault/assets/js/240.d00a46df.js"><link rel="prefetch" href="/CodeVault/assets/js/25.43c779a1.js"><link rel="prefetch" href="/CodeVault/assets/js/26.bdfe293e.js"><link rel="prefetch" href="/CodeVault/assets/js/27.330c11f5.js"><link rel="prefetch" href="/CodeVault/assets/js/28.46dfe7f4.js"><link rel="prefetch" href="/CodeVault/assets/js/29.4fc19b1e.js"><link rel="prefetch" href="/CodeVault/assets/js/3.44fcbdc8.js"><link rel="prefetch" href="/CodeVault/assets/js/30.da1d9fd7.js"><link rel="prefetch" href="/CodeVault/assets/js/31.df871787.js"><link rel="prefetch" href="/CodeVault/assets/js/32.e62268d4.js"><link rel="prefetch" href="/CodeVault/assets/js/33.b2c675b0.js"><link rel="prefetch" href="/CodeVault/assets/js/34.461e2f23.js"><link rel="prefetch" href="/CodeVault/assets/js/35.2666157f.js"><link rel="prefetch" href="/CodeVault/assets/js/36.b55a4b34.js"><link rel="prefetch" href="/CodeVault/assets/js/37.556ba5c1.js"><link rel="prefetch" href="/CodeVault/assets/js/38.8c982590.js"><link rel="prefetch" href="/CodeVault/assets/js/39.a7850266.js"><link rel="prefetch" href="/CodeVault/assets/js/4.8a0557a7.js"><link rel="prefetch" href="/CodeVault/assets/js/40.9a11a440.js"><link rel="prefetch" href="/CodeVault/assets/js/41.c3a71e10.js"><link rel="prefetch" href="/CodeVault/assets/js/42.7e9779c1.js"><link rel="prefetch" href="/CodeVault/assets/js/43.e017fec5.js"><link rel="prefetch" href="/CodeVault/assets/js/44.22c5aef3.js"><link rel="prefetch" href="/CodeVault/assets/js/45.dfe95d23.js"><link rel="prefetch" href="/CodeVault/assets/js/46.10af373d.js"><link rel="prefetch" href="/CodeVault/assets/js/47.a1e4779a.js"><link rel="prefetch" href="/CodeVault/assets/js/48.3142bf91.js"><link rel="prefetch" href="/CodeVault/assets/js/49.08546fe2.js"><link rel="prefetch" href="/CodeVault/assets/js/5.1bad1047.js"><link rel="prefetch" href="/CodeVault/assets/js/50.75c37eaf.js"><link rel="prefetch" href="/CodeVault/assets/js/51.b2f39f65.js"><link rel="prefetch" href="/CodeVault/assets/js/52.97fc3d07.js"><link rel="prefetch" href="/CodeVault/assets/js/53.1a2a51df.js"><link rel="prefetch" href="/CodeVault/assets/js/54.09f7dfd6.js"><link rel="prefetch" href="/CodeVault/assets/js/55.d112e5e2.js"><link rel="prefetch" href="/CodeVault/assets/js/56.b7b00837.js"><link rel="prefetch" href="/CodeVault/assets/js/57.5beac805.js"><link rel="prefetch" href="/CodeVault/assets/js/58.04f116f1.js"><link rel="prefetch" href="/CodeVault/assets/js/59.d660a6b3.js"><link rel="prefetch" href="/CodeVault/assets/js/6.7220274d.js"><link rel="prefetch" href="/CodeVault/assets/js/60.54783427.js"><link rel="prefetch" href="/CodeVault/assets/js/61.6e520517.js"><link rel="prefetch" href="/CodeVault/assets/js/62.78b5acff.js"><link rel="prefetch" href="/CodeVault/assets/js/63.0492d6b3.js"><link rel="prefetch" href="/CodeVault/assets/js/64.bd2a8518.js"><link rel="prefetch" href="/CodeVault/assets/js/65.8acc8c15.js"><link rel="prefetch" href="/CodeVault/assets/js/66.c2dc1d15.js"><link rel="prefetch" href="/CodeVault/assets/js/67.d584fc60.js"><link rel="prefetch" href="/CodeVault/assets/js/68.7221e725.js"><link rel="prefetch" href="/CodeVault/assets/js/69.f1a4c42c.js"><link rel="prefetch" href="/CodeVault/assets/js/7.ee190d28.js"><link rel="prefetch" href="/CodeVault/assets/js/70.8fb27ce3.js"><link rel="prefetch" href="/CodeVault/assets/js/71.2011297a.js"><link rel="prefetch" href="/CodeVault/assets/js/72.81904f20.js"><link rel="prefetch" href="/CodeVault/assets/js/73.cae4a206.js"><link rel="prefetch" href="/CodeVault/assets/js/74.41ca332e.js"><link rel="prefetch" href="/CodeVault/assets/js/75.ae7006ef.js"><link rel="prefetch" href="/CodeVault/assets/js/76.8477b765.js"><link rel="prefetch" href="/CodeVault/assets/js/77.ae764f14.js"><link rel="prefetch" href="/CodeVault/assets/js/78.b47518b4.js"><link rel="prefetch" href="/CodeVault/assets/js/79.bde0466f.js"><link rel="prefetch" href="/CodeVault/assets/js/8.e3ab8186.js"><link rel="prefetch" href="/CodeVault/assets/js/80.94af34f8.js"><link rel="prefetch" href="/CodeVault/assets/js/81.f1ba0edc.js"><link rel="prefetch" href="/CodeVault/assets/js/82.4485e21e.js"><link rel="prefetch" href="/CodeVault/assets/js/83.940dbcc3.js"><link rel="prefetch" href="/CodeVault/assets/js/84.6be8c64a.js"><link rel="prefetch" href="/CodeVault/assets/js/85.aa147bd8.js"><link rel="prefetch" href="/CodeVault/assets/js/86.0259d757.js"><link rel="prefetch" href="/CodeVault/assets/js/87.c88b420b.js"><link rel="prefetch" href="/CodeVault/assets/js/88.38f98c94.js"><link rel="prefetch" href="/CodeVault/assets/js/89.421840d7.js"><link rel="prefetch" href="/CodeVault/assets/js/9.cb249ed0.js"><link rel="prefetch" href="/CodeVault/assets/js/90.cd9b70c8.js"><link rel="prefetch" href="/CodeVault/assets/js/91.0c040f15.js"><link rel="prefetch" href="/CodeVault/assets/js/92.1ea436cf.js"><link rel="prefetch" href="/CodeVault/assets/js/93.7de38599.js"><link rel="prefetch" href="/CodeVault/assets/js/94.f2ad5a97.js"><link rel="prefetch" href="/CodeVault/assets/js/95.22f940d7.js"><link rel="prefetch" href="/CodeVault/assets/js/96.6a991248.js"><link rel="prefetch" href="/CodeVault/assets/js/97.aeccee85.js"><link rel="prefetch" href="/CodeVault/assets/js/98.79db6c16.js"><link rel="prefetch" href="/CodeVault/assets/js/99.aa13c9cb.js">
    <link rel="stylesheet" href="/CodeVault/assets/css/0.styles.bcdd6f38.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/CodeVault/" class="home-link router-link-active"><img src="/CodeVault/img/huli.svg" alt="CodeVault文档站" class="logo"> <span class="site-name can-hide">CodeVault文档站</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/CodeVault/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈开发" class="dropdown-title"><a href="/CodeVault/pages/d1eaf8/" class="link-title">全栈开发</a> <span class="title" style="display:none;">全栈开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云计算运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/d1eaf8/" class="nav-link">云计算</a></li></ul></li><li class="dropdown-item"><h4>容器开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/e820a7/" class="nav-link">容器</a></li></ul></li><li class="dropdown-item"><h4>K8S虚拟化</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/da2470/" class="nav-link">容器虚拟化</a></li></ul></li><li class="dropdown-item"><h4>运维高级篇</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/ce761d/" class="nav-link">高可用</a></li></ul></li><li class="dropdown-item"><h4>前端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">前端常用</a></li></ul></li><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">后端常用</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源" class="dropdown-title"><a href="/CodeVault/pages/e4db9d/" class="link-title">资源</a> <span class="title" style="display:none;">资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/e4db9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/c936ca/" class="nav-link">学习文档资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习路线" class="dropdown-title"><a href="/CodeVault/pages/f24c41/" class="link-title">学习路线</a> <span class="title" style="display:none;">学习路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f24c41/" class="nav-link">后端学习路线</a></li></ul></li><li class="dropdown-item"><h4>Web3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1583d1/" class="nav-link">区块链学习路线</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/CodeVault/pages/6ffa63/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML5+CSS3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/6ffa63/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/b23e0c/" class="nav-link">CSS3</a></li></ul></li><li class="dropdown-item"><h4>JavaScript</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/0e8324/" class="nav-link">JavaScript开篇</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/4d9ec9/" class="nav-link">JavaScript面向对象</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0505ad/" class="nav-link">JavaScript DOM</a></li></ul></li><li class="dropdown-item"><h4>API</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/845076/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9c8e93/" class="nav-link">Ajax</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Axios</a></li></ul></li><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/a1209f/" class="nav-link">Vuejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/CodeVault/pages/5e1c7d/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/5e1c7d/" class="nav-link">Java进阶</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9b262c/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3e651a/" class="nav-link">SpringBoot</a></li></ul></li><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/135518/" class="nav-link">Beego</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gin</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gorm</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/CodeVault/pages/7ef2c7/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/7ef2c7/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/516f71/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1eaa9a/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1ac9b2/" class="nav-link">Ceph</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/719244/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/6ec6ec/" class="nav-link">Istio</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/30e340/" class="nav-link">Prometheus</a></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/32fd53/" class="nav-link">Docker</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8S" class="dropdown-title"><a href="/CodeVault/pages/46159d/" class="link-title">K8S</a> <span class="title" style="display:none;">K8S</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/46159d/" class="nav-link">Kubernetes</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f87a46/" class="nav-link">CKS认证</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/2d432e/" class="nav-link">Operator</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/f6f110/" class="nav-link">CI/CD</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><a href="/CodeVault/pages/f9fa7a/" class="link-title">Linux</a> <span class="title" style="display:none;">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f9fa7a/" class="nav-link">基础服务</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/314d26/" class="nav-link">Kvm</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/44e450/" class="nav-link">Ansible</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/8292d8/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><a href="/CodeVault/pages/f3ea9f/" class="link-title">区块链</a> <span class="title" style="display:none;">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>FISCO BCOS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f3ea9f/" class="nav-link">WeBASE搭建</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛上</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/685f1f/" class="nav-link">碳排放解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3f1596/" class="nav-link">慈善公益解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cc43be/" class="nav-link">构造交易传入AppID</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/75ddc8/" class="nav-link">合约时间触发器</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9bcc7c/" class="nav-link">一键部署环境脚本</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a93fcf/" class="nav-link">合约调用机制与并行合约</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛下</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1fdb40/" class="nav-link">DDCMS后端容器化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/795b78/" class="nav-link">DDCMS第三方登录</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a99040/" class="nav-link">DDCMS智能合约设计</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cb310d/" class="nav-link">DDCMS部署和运维</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0b1c5a/" class="nav-link">DDCMS接口报错</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/99df38/" class="nav-link">合约大小限制优化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f8a343/" class="nav-link">并行合约最佳实践</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3d3086/" class="nav-link">一文搞懂Truffle测试</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/e3d908/" class="nav-link">记录</a></div> <a href="https://github.com/CN-ZHANGYH/CodeVault" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/CodeVault/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="全栈开发" class="dropdown-title"><a href="/CodeVault/pages/d1eaf8/" class="link-title">全栈开发</a> <span class="title" style="display:none;">全栈开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云计算运维</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/d1eaf8/" class="nav-link">云计算</a></li></ul></li><li class="dropdown-item"><h4>容器开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/e820a7/" class="nav-link">容器</a></li></ul></li><li class="dropdown-item"><h4>K8S虚拟化</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/da2470/" class="nav-link">容器虚拟化</a></li></ul></li><li class="dropdown-item"><h4>运维高级篇</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/ce761d/" class="nav-link">高可用</a></li></ul></li><li class="dropdown-item"><h4>前端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">前端常用</a></li></ul></li><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">后端常用</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="资源" class="dropdown-title"><a href="/CodeVault/pages/e4db9d/" class="link-title">资源</a> <span class="title" style="display:none;">资源</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/e4db9d/" class="nav-link">资源</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/c936ca/" class="nav-link">学习文档资源</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习路线" class="dropdown-title"><a href="/CodeVault/pages/f24c41/" class="link-title">学习路线</a> <span class="title" style="display:none;">学习路线</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>后端开发</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f24c41/" class="nav-link">后端学习路线</a></li></ul></li><li class="dropdown-item"><h4>Web3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1583d1/" class="nav-link">区块链学习路线</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><a href="/CodeVault/pages/6ffa63/" class="link-title">前端</a> <span class="title" style="display:none;">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>HTML5+CSS3</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/6ffa63/" class="nav-link">HTML5</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/b23e0c/" class="nav-link">CSS3</a></li></ul></li><li class="dropdown-item"><h4>JavaScript</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/0e8324/" class="nav-link">JavaScript开篇</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/4d9ec9/" class="nav-link">JavaScript面向对象</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0505ad/" class="nav-link">JavaScript DOM</a></li></ul></li><li class="dropdown-item"><h4>API</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/845076/" class="nav-link">JQuery</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9c8e93/" class="nav-link">Ajax</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Axios</a></li></ul></li><li class="dropdown-item"><h4>Vue</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/a1209f/" class="nav-link">Vuejs</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/CodeVault/pages/5e1c7d/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/5e1c7d/" class="nav-link">Java进阶</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9b262c/" class="nav-link">Spring</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3e651a/" class="nav-link">SpringBoot</a></li></ul></li><li class="dropdown-item"><h4>Golang</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/135518/" class="nav-link">Beego</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gin</a></li><li class="dropdown-subitem"><a href="/CodeVault/" class="nav-link">Gorm</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/CodeVault/pages/7ef2c7/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/CodeVault/pages/7ef2c7/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/516f71/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1eaa9a/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/1ac9b2/" class="nav-link">Ceph</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/719244/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/6ec6ec/" class="nav-link">Istio</a></li><li class="dropdown-item"><!----> <a href="/CodeVault/pages/30e340/" class="nav-link">Prometheus</a></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/32fd53/" class="nav-link">Docker</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8S" class="dropdown-title"><a href="/CodeVault/pages/46159d/" class="link-title">K8S</a> <span class="title" style="display:none;">K8S</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/46159d/" class="nav-link">Kubernetes</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f87a46/" class="nav-link">CKS认证</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/2d432e/" class="nav-link">Operator</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/f6f110/" class="nav-link">CI/CD</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><a href="/CodeVault/pages/f9fa7a/" class="link-title">Linux</a> <span class="title" style="display:none;">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Linux</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f9fa7a/" class="nav-link">基础服务</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/314d26/" class="nav-link">Kvm</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/44e450/" class="nav-link">Ansible</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/8292d8/" class="nav-link">Git</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><a href="/CodeVault/pages/f3ea9f/" class="link-title">区块链</a> <span class="title" style="display:none;">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>FISCO BCOS</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/f3ea9f/" class="nav-link">WeBASE搭建</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛上</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/685f1f/" class="nav-link">碳排放解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3f1596/" class="nav-link">慈善公益解决方案</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cc43be/" class="nav-link">构造交易传入AppID</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/75ddc8/" class="nav-link">合约时间触发器</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/9bcc7c/" class="nav-link">一键部署环境脚本</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a93fcf/" class="nav-link">合约调用机制与并行合约</a></li></ul></li><li class="dropdown-item"><h4>2023年TASK挑战赛下</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/CodeVault/pages/1fdb40/" class="nav-link">DDCMS后端容器化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/795b78/" class="nav-link">DDCMS第三方登录</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/a99040/" class="nav-link">DDCMS智能合约设计</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/cb310d/" class="nav-link">DDCMS部署和运维</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/0b1c5a/" class="nav-link">DDCMS接口报错</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/99df38/" class="nav-link">合约大小限制优化</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/f8a343/" class="nav-link">并行合约最佳实践</a></li><li class="dropdown-subitem"><a href="/CodeVault/pages/3d3086/" class="nav-link">一文搞懂Truffle测试</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/CodeVault/pages/e3d908/" class="nav-link">记录</a></div> <a href="https://github.com/CN-ZHANGYH/CodeVault" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>MySQL</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>基础教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/7ef2c7/" class="sidebar-link">MySQL安装</a></li><li><a href="/CodeVault/pages/b1d838/" class="sidebar-link">MySQL概述</a></li><li><a href="/CodeVault/pages/fbb36b/" class="sidebar-link">MySQL的SQL详解</a></li><li><a href="/CodeVault/pages/a1d62a/" class="sidebar-link">MySQL的函数</a></li><li><a href="/CodeVault/pages/d89c01/" class="sidebar-link">MySQL的约束</a></li><li><a href="/CodeVault/pages/b6194d/" class="sidebar-link">MySQL多表查询</a></li><li><a href="/CodeVault/pages/ec27a2/" class="sidebar-link">MySQL的事务</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>进阶教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/b4b939/" class="sidebar-link">MySQL的存储引擎和索引</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>MySQL日常</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/20a0c8/" class="sidebar-link">Ubuntu20.04 MySQL8远程登录</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/516f71/" class="sidebar-link">Redis详解</a></li><li><a href="/CodeVault/pages/2d9f22/" class="sidebar-link">SpringBoot整合Redis</a></li><li><a href="/CodeVault/pages/b090ab/" class="sidebar-link">Redis事务和锁机制</a></li><li><a href="/CodeVault/pages/30c858/" class="sidebar-link">Redis应用问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Nginx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/1eaa9a/" class="sidebar-link">Nginx相关概念</a></li><li><a href="/CodeVault/pages/ed04cf/" class="sidebar-link">Nginx反向代理</a></li><li><a href="/CodeVault/pages/e62533/" class="sidebar-link">Nginx负载均衡</a></li><li><a href="/CodeVault/pages/77a980/" class="sidebar-link">Nginx动静分离</a></li><li><a href="/CodeVault/pages/61acb1/" class="sidebar-link">Nginx高可用</a></li><li><a href="/CodeVault/pages/d3565a/" class="sidebar-link">Nginx的虚拟主机和域名解析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Ceph</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/1ac9b2/" class="sidebar-link">Ceph部署(14.2.0 nautilus版)</a></li><li><a href="/CodeVault/pages/4d7a5e/" class="sidebar-link">基于Rook构建Ceph云原生存储</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Elasticsearch</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/719244/" class="sidebar-link">Elasticsearch教程</a></li><li><a href="/CodeVault/pages/218cd6/" class="sidebar-link">SpringBoot整合ES</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Istio</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/6ec6ec/" class="sidebar-link">Istio概述</a></li><li><a href="/CodeVault/pages/824f20/" class="sidebar-link">Istio安装</a></li><li><a href="/CodeVault/pages/42e0d6/" aria-current="page" class="active sidebar-link">Istio由浅入深</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#istio简介" class="sidebar-link">Istio简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是istio" class="sidebar-link">什么是Istio?</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是服务网格-serivce-mesh" class="sidebar-link">什么是服务网格（serivce mesh）？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#为什么使用istio" class="sidebar-link">为什么使用Istio？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#核心功能" class="sidebar-link">核心功能</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#流量管理" class="sidebar-link">流量管理</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#安全" class="sidebar-link">安全</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#可观察性-observability" class="sidebar-link">可观察性(Observability)</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#平台支持" class="sidebar-link">平台支持</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#集成和自定义" class="sidebar-link">集成和自定义</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#架构" class="sidebar-link">架构</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#envoy" class="sidebar-link">Envoy</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#mixer" class="sidebar-link">Mixer</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#pilot" class="sidebar-link">Pilot</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#citadel" class="sidebar-link">Citadel</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#galley" class="sidebar-link">Galley</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#istio的安装" class="sidebar-link">Istio的安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/42e0d6/#使用-istioctl-安装" class="sidebar-link">使用 Istioctl 安装</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_1-拉取istio的安装包" class="sidebar-link">1.拉取Istio的安装包</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_2-复制istioctl工具" class="sidebar-link">2.复制istioctl工具</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_3-使用默认配置文件安装-istio" class="sidebar-link">3.使用默认配置文件安装 Istio</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_4-安装不同的配置文件" class="sidebar-link">4.安装不同的配置文件</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_5-检查安装了什么" class="sidebar-link">5.检查安装了什么</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_6-注入默认变量" class="sidebar-link">6.注入默认变量</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#_7-卸载-istio" class="sidebar-link">7.卸载 Istio</a></li><li class="sidebar-sub-header level3"><a href="/CodeVault/pages/42e0d6/#测试一个实例" class="sidebar-link">测试一个实例</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#bookinfo" class="sidebar-link">Bookinfo</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#使用istio部署应用程序🚀" class="sidebar-link">使用Istio部署应用程序🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#启动应用服务🚀" class="sidebar-link">启动应用服务🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#查看所有服务🚀" class="sidebar-link">查看所有服务🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#通过curl请求测试🚀" class="sidebar-link">通过Curl请求测试🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#确定入口ip和端口🚀" class="sidebar-link">确定入口IP和端口🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#应用默认目标规则🚀" class="sidebar-link">应用默认目标规则🚀</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理🚀" class="sidebar-link">清理🚀</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#介绍istio流量管理" class="sidebar-link">介绍Istio流量管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#首先是istio如何在网格种引导流量的" class="sidebar-link">首先是Istio如何在网格种引导流量的？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#在kubernetes中如何使用istio" class="sidebar-link">在Kubernetes中如何使用istio？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#在istio中能学到什么" class="sidebar-link">在istio中能学到什么？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是虚拟服务" class="sidebar-link">什么是虚拟服务？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#为什么要使用虚拟服务" class="sidebar-link">为什么要使用虚拟服务？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#虚拟服务实例" class="sidebar-link">虚拟服务实例</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#主机字段" class="sidebar-link">主机字段</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#路由规则" class="sidebar-link">路由规则</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#目的地" class="sidebar-link">目的地</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#路由规则优先级" class="sidebar-link">路由规则优先级</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#有关路由的更多信息" class="sidebar-link">有关路由的更多信息</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#目的地规则" class="sidebar-link">目的地规则</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#负载平衡选项" class="sidebar-link">负载平衡选项</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#目标规则示例" class="sidebar-link">目标规则示例</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#网关" class="sidebar-link">网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#网关示例" class="sidebar-link">网关示例</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#服务条目" class="sidebar-link">服务条目</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#服务入口示例" class="sidebar-link">服务入口示例</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#边车" class="sidebar-link">边车</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#网络弹性和测试" class="sidebar-link">网络弹性和测试</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#超时" class="sidebar-link">超时</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#重试" class="sidebar-link">重试</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#熔断" class="sidebar-link">熔断</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#故障注入" class="sidebar-link">故障注入</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#sidecar注入" class="sidebar-link">Sidecar注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#对工作负载的一些要求" class="sidebar-link">对工作负载的一些要求</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#手工注入" class="sidebar-link">手工注入</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#请求路由" class="sidebar-link">请求路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#应用虚拟服务" class="sidebar-link">应用虚拟服务</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#测试新的路由配置" class="sidebar-link">测试新的路由配置</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#基于用户身份的路由" class="sidebar-link">基于用户身份的路由</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#故障注入-2" class="sidebar-link">故障注入</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-2" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#注入http延迟错误" class="sidebar-link">注入HTTP延迟错误</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#测试延迟配置" class="sidebar-link">测试延迟配置</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#修复错误" class="sidebar-link">修复错误</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#注入http中止错误" class="sidebar-link">注入HTTP中止错误</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#测试中止配置" class="sidebar-link">测试中止配置</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-2" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#流量转移" class="sidebar-link">流量转移</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是流量转移" class="sidebar-link">什么是流量转移？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-3" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#应用基于权重的路由" class="sidebar-link">应用基于权重的路由</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-3" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#tcp-流量转移" class="sidebar-link">TCP 流量转移</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是tcp流量转移" class="sidebar-link">什么是TCP流量转移？</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#基础环境" class="sidebar-link">基础环境</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#应用基于权重的tcp路由" class="sidebar-link">应用基于权重的TCP路由</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-4" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#请求超时" class="sidebar-link">请求超时</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-4" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#请求超时-2" class="sidebar-link">请求超时</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-5" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#熔断-2" class="sidebar-link">熔断</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#熔断的方式" class="sidebar-link">熔断的方式</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-5" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#配置断路器" class="sidebar-link">配置断路器</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#添加客户端" class="sidebar-link">添加客户端</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#使断路器跳闸" class="sidebar-link">使断路器跳闸</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-6" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#镜像" class="sidebar-link">镜像</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#流量镜像" class="sidebar-link">流量镜像</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#基础环境-2" class="sidebar-link">基础环境</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#创建默认路由策略" class="sidebar-link">创建默认路由策略</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#将流量镜像到v2" class="sidebar-link">将流量镜像到v2</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#发送流量" class="sidebar-link">发送流量</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-7" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#入口网关" class="sidebar-link">入口网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#入口网关简要" class="sidebar-link">入口网关简要</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-6" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#确定入口ip和端口" class="sidebar-link">确定入口IP和端口</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#添加环境说明" class="sidebar-link">添加环境说明</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#使用istio网关配置入口" class="sidebar-link">使用Istio网关配置入口</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#使用浏览器访问入口服务" class="sidebar-link">使用浏览器访问入口服务</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-8" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#安全网关" class="sidebar-link">安全网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#安全网关的作用" class="sidebar-link">安全网关的作用</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-7" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#生成证书和密钥" class="sidebar-link">生成证书和密钥</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#为单个主机配置tls入口网关" class="sidebar-link">为单个主机配置TLS入口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#为多个主机配置tls入口网关" class="sidebar-link">为多个主机配置TLS入口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#密钥格式" class="sidebar-link">密钥格式</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-9" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#出口tls发起" class="sidebar-link">出口TLS发起</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是tls发起" class="sidebar-link">什么是TLS发起</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#环境准备-8" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#配置对外部服务的访问" class="sidebar-link">配置对外部服务的访问</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#出口流量的tls发起" class="sidebar-link">出口流量的TLS发起</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理-10" class="sidebar-link">清理</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/CodeVault/pages/42e0d6/#出口网关" class="sidebar-link">出口网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#什么是出口网关" class="sidebar-link">什么是出口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#基础环境-3" class="sidebar-link">基础环境</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#部署istio出口网关" class="sidebar-link">部署Istio出口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#http流量的出口网关" class="sidebar-link">HTTP流量的出口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理http网关" class="sidebar-link">清理HTTP网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#https流量的出口网关" class="sidebar-link">HTTPS流量的出口网关</a></li><li class="sidebar-sub-header level4"><a href="/CodeVault/pages/42e0d6/#清理https网关" class="sidebar-link">清理HTTPS网关</a></li></ul></li></ul></li><li><a href="/CodeVault/pages/14e323/" class="sidebar-link">Istio练习题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Prometheuse</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/CodeVault/pages/30e340/" class="sidebar-link">Prometheus + Grafana监控</a></li><li><a href="/CodeVault/pages/5bec87/" class="sidebar-link">Prometheus+Grafana+Docker</a></li><li><a href="/CodeVault/pages/ae94b7/" class="sidebar-link">Prometheus+Grafana+Kubernetes</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/CodeVault/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>中间件</span></li><li data-v-06225672><span data-v-06225672>Istio</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/CN-ZHANGYH" target="_blank" title="作者" class="beLink" data-v-06225672>Yyzop</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-04-01</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Istio由浅入深<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="istio由浅入深"><a href="#istio由浅入深" class="header-anchor">#</a> Istio由浅入深</h1> <h2 id="istio简介"><a href="#istio简介" class="header-anchor">#</a> Istio简介</h2> <h4 id="什么是istio"><a href="#什么是istio" class="header-anchor">#</a> 什么是Istio?</h4> <p>在企业普遍都做云平台的时代背景下，云平台架构带来的诸多好处，但是，不可否认的是，采用云技术架构会对DevOps团队造成很大的压力。 开发人员也必须使用微服务来构建可移植性，同时各大运营商正在管理超大型混合和多云部署。而Istio使得您可以连接，安全，控制和监控这些服务。</p> <p>从更高的维度来看，Istio有助于降低部署的复杂性，减轻开发团队的负担。<code>Istio是一个完全开源的服务网格（service mesh），可以透明地分层到现有的分布式应用程序上。同时，它也是一个平台，通过其提供的API，可将其集成到任何日志平台，telemetry或策略系统中。</code></p> <p>Istio的多样化功能集使您能够高效地运行分布式微服务架构，并提供统一的方式来保护，连接和监视微服务。</p> <h4 id="什么是服务网格-serivce-mesh"><a href="#什么是服务网格-serivce-mesh" class="header-anchor">#</a> 什么是服务网格（serivce mesh）？</h4> <p>当整体应用程序向分布式微服务架构过渡时，Istio解决了开发人员和运营商面临的挑战。</p> <p><code>服务网格</code>术语用于描述组成此类应用程序的微服务网络及其之间的交互。随着服务网格的大小和复杂性的增长，它变得越来越难以理解和管理。它的要求可以包括发现，负载平衡，故障恢复，指标和监控。服务网格通常还具有更复杂的操作要求，例如A/B测试，金丝雀，网速限制，访问控制和端到端的身份验证。</p> <p>Istio提供了整个服务网格上的行为洞察力和操作控制，从而提供了完整的解决方案来满足微服务应用程序的各种需求。</p> <h4 id="为什么使用istio"><a href="#为什么使用istio" class="header-anchor">#</a> 为什么使用Istio？</h4> <p>Istio可以轻松在已部署服务网络上创建带有负载平衡，服务到服务的身份验证，监控等功能，并且服务代码中的代码无需变动（或变动很少）。通过在整个环境中部署一个特殊的sidecar代理来拦截微服务之间的所有网络通信，然后使用其平台控制功能配置和管理Istio，包括：</p> <ul><li>自动为HTTP，gRPC，WebSocket和TCP流量负载平衡。</li> <li>通过丰富的路由规则，重试，故障转移和故障注入对流量行为进行细粒度控制。</li> <li>可插拔的策略层和配置API，支持访问控制，速率限制和配额。</li> <li>集群内所有流量的自动度量，日志和跟踪，包括集群的入口和出口。</li> <li>通过强大的基于身份的身份验证和授权，在集群中进行安全的服务之间通信。</li></ul> <p>Istio专为可扩展性而设计，可满足多种部署需求。</p> <h4 id="核心功能"><a href="#核心功能" class="header-anchor">#</a> 核心功能</h4> <p>Istio在服务网络中统一提供了许多关键功能：</p> <h4 id="流量管理"><a href="#流量管理" class="header-anchor">#</a> 流量管理</h4> <p>Istio规则配置和流量路由使您可以很容易的控制服务之间的流量和API调用的流量。Istio简化了诸如断路器，超时和重试之类的服务级别属性的配置，并使其轻而易举地设置重要任务，如A/B测试，金丝雀部署和基于百分比的流量拆分。</p> <p>借助对流量的更好可见性和开箱即用的故障恢复功能，无论遇到什么情况，您都可以在问题引起故障之前及时发现问题，使得调用更加可靠，网络也更加强大。</p> <h4 id="安全"><a href="#安全" class="header-anchor">#</a> 安全</h4> <p>Istio的安全功能使开发人员可以将精力集中在应用程序级别。Istio提供基础安全通信通道，并大规模管理服务通信的身份验证，授权和加密。 借助Istio，默认情况下可以保护服务通信的安全，从而使您能够在各种协议和运行时之间一致地执行策略 - 所有这些操作几乎不需要更改应用程序。</p> <p>虽然Istio是独立于平台的，但将其与Kubernetes（或基础架构）网络策略配合使用，则好处更大，包括能够在网络和应用程序层保护Pod到Pod或服务到服务的通信的能力。</p> <h4 id="可观察性-observability"><a href="#可观察性-observability" class="header-anchor">#</a> 可观察性(Observability)</h4> <p>Istio强大的跟踪，监控和日志记录功能使您可以深入了解服务网格部署。借助Istio的监视功能，您可以真正了解服务性能如何影响上游和下游事物，而其自定义dashboards（仪表盘）则可以提供对所有服务性能的可视性，并让您了解该性能如何影响您的其他的程序的。</p> <p>Istio的Mixer组件负责策略控制和遥测(telemetry)采集。它提供了后端抽象和中介，使Istio的其余部分与各个基础架构后端的实现细节隔离开来，并为操作员提供了对网格和基础架构后端之间所有交互的精细控制。</p> <p>所有这些功能使您可以更有效地设置，监控和执行服务上的SLO。当然，最重要的是您可以快速有效地检测和修复故障。</p> <h4 id="平台支持"><a href="#平台支持" class="header-anchor">#</a> 平台支持</h4> <p>Istio是独立于平台的，旨在在多种环境中运行，包括跨Cloud，本地，Kubernetes，Mesos等的环境。您可以在Kubernetes或Consul的Nomad上部署Istio。Istio当前支持：</p> <ul><li>Kubernetes上部署Service</li> <li>向Consul注册Services</li> <li>在单个虚拟机上运行Services</li></ul> <h4 id="集成和自定义"><a href="#集成和自定义" class="header-anchor">#</a> 集成和自定义</h4> <p>Istio的策略执行组件可以扩展和自定义，以与现有的ACL，日志记录，监视，配额，审核等集成。</p> <h4 id="架构"><a href="#架构" class="header-anchor">#</a> 架构</h4> <p>Istio服务网格在逻辑上分为数据平面和控制平面。</p> <ul><li>数据plane由部署为sidecar的一组智能代理（Envoy）组成。这些代理中介和控制微服务与Mixer、通用策略和遥测集线器之间的所有网络通信。</li> <li>控制平面管理并将代理配置为路由流量。另外，控制平面配置Mixers来执行策略和采集遥测数据。</li></ul> <p>下图显示了组成每个平面的不同组件:</p> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062326606.jpeg" alt="screenshot"></p> <h4 id="envoy"><a href="#envoy" class="header-anchor">#</a> Envoy</h4> <p>Istio使用Envoy代理的扩展版本。Envoy是使用<code>C++</code>开发的高性能代理，可为服务网格中的所有服务调解所有入站和出站流量。Istio利用Envoy的许多内置功能，如：</p> <ul><li>动态服务发现</li> <li>负载均衡</li> <li>TLS termination</li> <li>HTTP/2和gRPC代理</li> <li>熔断（Circuit breakers）</li> <li>健康检查</li> <li>分阶段推出，按百分比分配流量</li> <li>故障注入</li> <li>丰富的指标</li></ul> <p>Sidecar代理模型还允许你将Istio功能添加到现有部署中，而无需重新构造或重写代码。你可以阅读更多关于为什么我们在设计目标中选择这种方法的信息。</p> <h4 id="mixer"><a href="#mixer" class="header-anchor">#</a> Mixer</h4> <p>Mixer是一个与平台无关的组件。Mixer跨服务网格实施访问控制和使用策略，并从Envoy代理和其他服务收集遥测数据。 代理提取请求级别属性，并将其发送到Mixer进行评估。您可以在我们的“Mixer配置”文档中找到有关此属性提取和策略评估的更多信息。</p> <p>Mixer包含一个灵活的插件模型。该模型使Istio可以与各种主机环境和基础架构后端交互。因此，Istio从这些细节中抽象了Envoy代理和Istio管理的服务。</p> <h4 id="pilot"><a href="#pilot" class="header-anchor">#</a> Pilot</h4> <p>Pilot提供了Envoy sidecar的服务发现，智能路由的流量管理功能（例如 A/B测试，金丝雀等）和弹性（超时，重试，断路器等）。</p> <p>Pilot将控制流量行为的高级路由规则转换为Envoy特定的配置，并在运行时将其传送到sidecar。Pilot提取了特定于平台的服务发现机制，并将它们合成为标准格式，任何符合Envoy数据平面API的Sidecar都可以使用。这种松散的耦合使得Istio可以在Kubernetes，Consul或Nomad等多种环境中运行，同时为流量管理保留相同的操作员界面。</p> <h4 id="citadel"><a href="#citadel" class="header-anchor">#</a> Citadel</h4> <p>Citadel通过内置的身份和凭据管理实现了强大的服务到服务和终端用户的身份验证。可以使用Citadel来升级服务网格中的未加密流量。使用Citadel，运营商可以基于服务身份而不是相对不稳定的3层或4层网络识别码来实施策略。从版本0.5开始，您可以使用Istio的授权功能来控制谁可以访问您的服务。</p> <h4 id="galley"><a href="#galley" class="header-anchor">#</a> Galley</h4> <p>Galley是Istio的配置验证，提取，处理和分发组件。它负责将其余Istio组件与从底层平台（例如Kubernetes）获取用户配置的细节隔离开来。</p> <ul><li><code>最大化透明度</code>：要采用Istio，要求操作员或开发人员进行尽可能少的工作，以从系统中获得真正的价值。为此，Istio可以自动将其自身插入服务之间的所有网络路径中。Istio使用Sidecar代理来捕获流量，并在可能的情况下自动对网络层进行编程，以通过这些代理路由流量，而无需更改已部署的应用程序代码。 在Kubernetes中，代理被注入到Pod中，并通过对iptables规则进行编程来捕获流量。 一旦注入了sidecar代理并且对流量路由进行了编程，Istio就可以调解所有流量。此原则也适用于性能。将Istio应用于部署时，运营商会发现所提供功能的资源成本增加最小。组件和API必须在设计时充分考虑性能和规模。</li> <li><code>可扩展性</code>：随着运营商和开发人员越来越依赖Istio提供的功能，系统也必须随着他们的需求而增长。在我们继续添加新功能的同时，最大的需求是扩展策略系统，与其他策略和控制源集成以及将有关网格行为的信号传送到的其他系统以进行分析。策略运行时支持插入其他服务的标准扩展机制。此外，它还允许扩展其词汇表，从而可以根据网格生成的新信号来实施策略。</li> <li><code>可移植性</code>：使用Istio的生态系统在许多方面都不同。Istio必须能在任何云端或本地环境中运行，只需最少的努力。将基于Istio的服务移植到新环境的任务必须很简单。使用Istio，您可以操作部署到多个环境中的单个服务。例如，可以在多个云上部署以实现冗余。</li> <li><code>策略统一性</code>：将策略应用于服务之间的API调用提供了对网格行为的大量控制。但是，将策略应用于不一定在API级别表达的资源也同样重要。例如，对ML训练任务消耗的CPU数量应用quota比对启动wrok的调用应用quota更有用。为此，Istio将策略系统作为具有其自己的API的独特服务来维护，而不是将策略系统烘焙到代理Sidecar中，从而使得服务根据需要直接与其集成。</li></ul> <h2 id="istio的安装"><a href="#istio的安装" class="header-anchor">#</a> Istio的安装</h2> <h3 id="使用-istioctl-安装"><a href="#使用-istioctl-安装" class="header-anchor">#</a> 使用 Istioctl 安装</h3> <h4 id="_1-拉取istio的安装包"><a href="#_1-拉取istio的安装包" class="header-anchor">#</a> 1.拉取Istio的安装包</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-O</span> http://192.168.1.110/file/istio-1.9.5-linux-amd64.tar.gz

$ <span class="token function">ls</span> 
istio-1.9.5-linux-amd64.tar.gz
$ <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> istio-1.9.5-linux-amd64.tar.gz
</code></pre></div><h4 id="_2-复制istioctl工具"><a href="#_2-复制istioctl工具" class="header-anchor">#</a> 2.复制istioctl工具</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">cd</span> istio-1.9.5/
$ <span class="token function">cp</span> bin/istioctl  /usr/local/bin/
</code></pre></div><h4 id="_3-使用默认配置文件安装-istio"><a href="#_3-使用默认配置文件安装-istio" class="header-anchor">#</a> 3.使用默认配置文件安装 Istio</h4> <p>最简单的选择是 使用以下命令安装<code>default</code>Istio <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">配置文件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ istioctl <span class="token function">install</span>
</code></pre></div><h4 id="_4-安装不同的配置文件"><a href="#_4-安装不同的配置文件" class="header-anchor">#</a> 4.安装不同的配置文件</h4> <p>通过在命令行上传递配置文件名称，可以将其他 Istio 配置文件安装到集群中。例如，以下命令可用于安装<code>demo</code>配置文件：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl  create  ns istio-system
$ istioctl <span class="token function">install</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">profile</span><span class="token operator">=</span>demo <span class="token parameter variable">-y</span>
✔ Istio core installed                                                   
✔ Istiod installed                                                  
✔ Egress gateways installed                                                        
✔ Ingress gateways installed                                                        
✔ Installation complete     
</code></pre></div><h4 id="_5-检查安装了什么"><a href="#_5-检查安装了什么" class="header-anchor">#</a> 5.检查安装了什么</h4> <p>该<code>istioctl</code>命令将<code>IstioOperator</code>用于安装 Istio的CR保存在名为<code>installed-state</code>. 而不是检查 Istio 安装的部署、pod、服务和其他资源，例如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system get deploy
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-egressgateway    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           25s
istio-ingressgateway   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s
istiod                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           20s
</code></pre></div><h4 id="_6-注入默认变量"><a href="#_6-注入默认变量" class="header-anchor">#</a> 6.注入默认变量</h4> <p>将目录更改为 Istio 安装的根目录。</p> <p>默认的 Istio 安装使用<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。标记将托管应用程序的命名空间<code>istio-injection=enabled</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl label namespace default istio-injection<span class="token operator">=</span>enabled 
</code></pre></div><h4 id="_7-卸载-istio"><a href="#_7-卸载-istio" class="header-anchor">#</a> 7.卸载 Istio</h4> <p>要从集群中完全卸载 Istio，请运行以下命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ istioctl x uninstall <span class="token parameter variable">--purge</span>
</code></pre></div><p>可选<code>--purge</code>标志将删除所有 Istio 资源，包括可能与其他 Istio 控制平面共享的集群范围的资源。</p> <h3 id="测试一个实例"><a href="#测试一个实例" class="header-anchor">#</a> 测试一个实例</h3> <h4 id="bookinfo"><a href="#bookinfo" class="header-anchor">#</a> Bookinfo</h4> <p><strong>Bookinfo 应用程序分为四个独立的微服务：</strong></p> <ul><li><code>productpage</code>. 该<code>productpage</code>微服务调用<code>details</code>和<code>reviews</code>微服务来填充页面。</li> <li><code>details</code>. 该<code>details</code>微服务包含图书信息。</li> <li><code>reviews</code>. 该<code>reviews</code>微服务包含了书评。它还调用<code>ratings</code>微服务。</li> <li><code>ratings</code>. 该<code>ratings</code>微服务包含预定伴随书评排名信息。</li></ul> <p><strong><code>reviews</code>微服务有 3 个版本：</strong></p> <ul><li>版本 v1 不调用该<code>ratings</code>服务。</li> <li>版本 v2 调用该<code>ratings</code>服务，并将每个评级显示为 1 到 5 颗黑星。</li> <li>版本 v3 调用该<code>ratings</code>服务，并将每个评级显示为 1 到 5 颗红星。</li></ul> <p>该应用程序的端到端架构如下所示。</p> <img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062326474.png" alt="image-20211214154321190" style="zoom:80%;"> <h4 id="使用istio部署应用程序🚀"><a href="#使用istio部署应用程序🚀" class="header-anchor">#</a> 使用Istio部署应用程序🚀</h4> <p>使用 Istio 运行示例不需要更改应用程序本身。相反，您只需要在支持 Istio 的环境中配置和运行服务，并在每个服务旁边注入 Envoy sidecar。生成的部署将如下所示：</p> <img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062326222.png" alt="image-20211214154410424" style="zoom:80%;"> <h4 id="启动应用服务🚀"><a href="#启动应用服务🚀" class="header-anchor">#</a> 启动应用服务🚀</h4> <p>使用以下<code>kubectl</code>命令部署您的应用程序：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div><h4 id="查看所有服务🚀"><a href="#查看所有服务🚀" class="header-anchor">#</a> 查看所有服务🚀</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc </span>
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
details       ClusterIP   <span class="token number">10.104</span>.17.202    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
kubernetes    ClusterIP   <span class="token number">10.96</span>.0.1        <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP    41m
productpage   ClusterIP   <span class="token number">10.110</span>.235.179   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
ratings       ClusterIP   <span class="token number">10.104</span>.53.51     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m
reviews       ClusterIP   <span class="token number">10.101</span>.21.63     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9080</span>/TCP   21m

<span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get pods </span>
NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-gwhkf       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
productpage-v1-6b746f74dc-6dtg8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
ratings-v1-b6994bb9-9h2wn         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v1-545db77b95-6cmmv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v2-7bf8c9648f-m2k9d       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
reviews-v3-84779c7bbc-vd86b       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          21m
</code></pre></div><h4 id="通过curl请求测试🚀"><a href="#通过curl请求测试🚀" class="header-anchor">#</a> 通过Curl请求测试🚀</h4> <p>要确认 Bookinfo 应用程序正在运行，请通过<code>curl</code>来自某个 pod的命令向其发送请求，例如来自<code>ratings</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')&quot; -c ratings -- curl -sS productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
</code></pre></div><h4 id="确定入口ip和端口🚀"><a href="#确定入口ip和端口🚀" class="header-anchor">#</a> 确定入口IP和端口🚀</h4> <p>现在 Bookinfo 服务已启动并运行，您需要使应用程序可从 Kubernetes 集群外部访问，例如从浏览器访问。一个<a href="https://istio.io/latest/docs/concepts/traffic-management/#gateways" target="_blank" rel="noopener noreferrer">Istio网关<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 用于此目的。</p> <ol><li><strong><code>为应用定义入口网关</code></strong></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml </span>
gateway.networking.istio.io/bookinfo-gateway created
virtualservice.networking.istio.io/bookinfo created
</code></pre></div><ol start="2"><li><strong><code>确认网关已创建</code></strong></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get gateway </span>
NAME               AGE
bookinfo-gateway   61s
</code></pre></div><ol start="3"><li><strong><code>改为NodePort</code></strong></li></ol> <p>此处我们并没有外部负载，所以要将svc修改成NodePort的方式。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system </span>
NAME                   TYPE         CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                      AGE
istio-egressgateway    ClusterIP    <span class="token number">10.102</span>.197.30   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP,443/TCP,15443/TCP                                                     89m
istio-ingressgateway   LoadBalancer <span class="token number">10.109</span>.71.35    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:31964/TCP,80:31467/TCP,443:31845/TCP,31400:31077/TCP,15443:30757/TCP   89m
istiod                 ClusterIP    <span class="token number">10.111</span>.156.86   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15010</span>/TCP,15012/TCP,443/TCP,15014/TCP                                        90m

<span class="token comment">#访问masterIP+80端口对应暴露的31962</span>
</code></pre></div><blockquote><p><code>注意： 如果 EXTERNAL-IP 设置了该值，则要求您的环境具有可用于 Ingress 网关的外部负载均衡器。如果 EXTERNAL-IP 值是 &lt;none&gt;（或一直是 &lt;pending&gt; ），则说明可能您的环境不支持为 ingress 网关提供外部负载均衡器的功能。在这种情况下，您可以使用 Service 的 node port 方式访问网关。</code></p></blockquote> <p>使用 kubectl patch 更新 istio-ingressgateway 服务网关类型</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl patch service istio-ingressgateway -n istio-system -p '{&quot;spec&quot;:{&quot;type&quot;:&quot;NodePort&quot;}}'</span>
</code></pre></div><p>设置入口端口</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}'</span><span class="token variable">)</span></span>
</code></pre></div><p>获取ingress ip地址</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get po <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>ingressgateway <span class="token parameter variable">-n</span> istio-system <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.items[0].status.hostIP}'</span><span class="token variable">)</span></span>
</code></pre></div><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327570.png" alt="image-20211214170233622"> <h4 id="应用默认目标规则🚀"><a href="#应用默认目标规则🚀" class="header-anchor">#</a> 应用默认目标规则🚀</h4> <p>在使用 Istio 控制 Bookinfo 版本路由之前，您需要在<a href="https://istio.io/latest/docs/concepts/traffic-management/#destination-rules" target="_blank" rel="noopener noreferrer">目标规则中<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义可用版本，称为子集。</p> <p>运行以下命令为 Bookinfo 服务创建默认目标规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/destination-rule-all.yaml
</code></pre></div><blockquote><p>在<code>default</code>与<code>demo</code> <a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener noreferrer">配置轮廓<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>具有<a href="https://istio.io/latest/docs/tasks/security/authentication/authn-policy/#auto-mutual-tls" target="_blank" rel="noopener noreferrer">自动相互TLS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>启用默认情况下。要强制实施双向 TLS，请使用<code>samples/bookinfo/networking/destination-rule-all-mtls.yaml</code>.</p></blockquote> <h4 id="清理🚀"><a href="#清理🚀" class="header-anchor">#</a> 清理🚀</h4> <p>当您完成 Bookinfo 示例的试验后，请按照以下说明卸载并清理它：</p> <p>删除路由规则并终止应用程序 Pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ samples/bookinfo/platform/kube/cleanup.sh
</code></pre></div><p>确认关机</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get virtualservices   <span class="token comment">#-- there should be no virtual services</span>
$ kubectl get destinationrules  <span class="token comment">#-- there should be no destination rules</span>
$ kubectl get gateway           <span class="token comment">#-- there should be no gateway</span>
$ kubectl get pods              <span class="token comment">#-- the Bookinfo pods should be deleted</span>
</code></pre></div><h2 id="介绍istio流量管理"><a href="#介绍istio流量管理" class="header-anchor">#</a> 介绍Istio流量管理</h2> <h4 id="首先是istio如何在网格种引导流量的"><a href="#首先是istio如何在网格种引导流量的" class="header-anchor">#</a> 首先是Istio如何在网格种引导流量的？</h4> <ol><li>首先要知道所在的端点在哪里？</li> <li>以及它们属于哪些服务？</li> <li>填充自己的服务注册（就是内部的注册表，用来生成一些Envoy配置）连接到服务发现系统。</li> <li>在Kubernetes中安装Istio，那么Istio会自动检测集群中的服务和端点。</li></ol> <h4 id="在kubernetes中如何使用istio"><a href="#在kubernetes中如何使用istio" class="header-anchor">#</a> 在Kubernetes中如何使用istio？</h4> <p>1.通过Kubernetes安装istio之后对<code>K8S使用CRD扩展， 也就是Kubernetes的 API扩展</code>，istio也能像其他 的resouces一样使用。
2.通过使用Kubrenetes API的扩展，可以使用资源有 虚拟服务、目的规则、网关、服务条目、边车。</p> <h4 id="在istio中能学到什么"><a href="#在istio中能学到什么" class="header-anchor">#</a> 在istio中能学到什么？</h4> <p>1.可以学习到流量的管理、入口出口流量管理。</p> <ul><li><code>请求路由</code></li> <li><code>故障注入</code></li> <li><code>交通转移</code></li> <li><code>TCP流量转移</code></li> <li><code>请求超时</code></li> <li><code>熔断</code></li> <li><code>镜像</code></li> <li><code>局部负载均衡</code></li> <li><code>入口的网关</code></li> <li><code>出口的访问外部服务</code></li></ul> <h4 id="什么是虚拟服务"><a href="#什么是虚拟服务" class="header-anchor">#</a> 什么是虚拟服务？</h4> <p>虚拟服务以及目标规则是Istio流量路由功能的关键构建块。虚拟服务允许您配置如何将请求的路由到Istio的服务网格中的服务。 建立在Istio和您的平台提供基本的连接和发现之上。每一个虚拟服务都包含了一组按顺序评估的路由规则，让Istio将每一个给定的虚拟服务请求匹配到网格中特定真实的目的地。</p> <h4 id="为什么要使用虚拟服务"><a href="#为什么要使用虚拟服务" class="header-anchor">#</a> 为什么要使用虚拟服务？</h4> <p>1.通过将客户端从实际实现它们的目标工作负载发送请求的位置强解耦来做到这一点。虚拟服务还提供一种丰富的方式来指定不同的流量路由规则，以将流量发送到这些工作负载。</p> <p>2.为什么说这很有用？ Envoy在所有服务实例之间使用循环负载平衡来分配流量，对此进行了改进，可以针对百分比进行特定的流量引导。</p> <p>3.可以一个或者多个指定主机名指定流量行为。 在虚拟服务中，使用路由规则来告诉Envoy如何将虚拟服务的流量发送到合适的地方。</p> <p>4.还可以将单个虚拟服务处理多个应用程序。 结合网关的流量规则，控制流量进出。</p> <h4 id="虚拟服务实例"><a href="#虚拟服务实例" class="header-anchor">#</a> 虚拟服务实例</h4> <p>以下的虚拟服务根据请求是否来自特定的用户，将请求路由到不同版本的服务。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre></div><h4 id="主机字段"><a href="#主机字段" class="header-anchor">#</a> 主机字段</h4> <p>1.<code>hosts字段</code>列出了虚拟服务的主机，这些路由规则适用的用户可以寻址目的或目的地。这是客户端在向 服务发送请求时使用的地址。
2.主机名可以是<code>IP地址</code>，也可以是<code>DNS名称</code>以及解析的。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> reviews
</code></pre></div><h4 id="路由规则"><a href="#路由规则" class="header-anchor">#</a> 路由规则</h4> <p>1.该http部分包含虚拟服务的路由规则，描述了将<code>HTTP/1.1 HTTP2和gRPC流量</code>路由到hosts字段中指定的 目标的匹配条件和操作。
2.匹配条件（示例中的第一个路由有一个条件，因此以match字段开头。在这种情况下，您希望此路由适 用于来自用户‘jason’的所有请求，因此您使用headers、end-user和exact字段来选择适当的请求。）</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
       <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
         <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
</code></pre></div><h4 id="目的地"><a href="#目的地" class="header-anchor">#</a> 目的地</h4> <p>路由部分<code>destination字段</code>指定符合条件的流量实际目的地。 与虚拟主机不同，目标主机必须存在于istio服务注册表中真实目标，否则Envoy将不知道将流量发送到何处。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>route：
<span class="token punctuation">-</span> <span class="token key atrule">destintion</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
    <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
</code></pre></div><h4 id="路由规则优先级"><a href="#路由规则优先级" class="header-anchor">#</a> 路由规则优先级</h4> <p>路由规则按照上到下的顺序进行评估，<code>虚拟服务定义中的第一个规则被赋予最高优先级。</code> 在这种情况下 ，您希望任何第一条路由规则不匹配的东西都转到第二条规则中指定默认的目的地。 因此，第二条规则 没有匹配条件，只是将流量定向到v3子集。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v3
</code></pre></div><h4 id="有关路由的更多信息"><a href="#有关路由的更多信息" class="header-anchor">#</a> 有关路由的更多信息</h4> <p>路由规则是将特定流量子集路由到特定目的地的强大工具。<code>您可以对流量端口、标头字段、URL等设置匹 配条件</code>，例如：此虚拟服务允许用户将流量发送到两个单独的服务，评分和评论，就好像它们是更大的虚拟服务的一部分一样。虚拟服务规则根据请求的URL匹配流量，并将流量请求定向到合适的服务。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> bookinfo.com
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /reviews
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /ratings
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
</code></pre></div><p>除了使用匹配条件外，您还可以按&quot;权重&quot;百分比分配流量。这对于A/B测试和金丝雀发布很有用。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> route
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">75</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
      <span class="token key atrule">subnet</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">25</span>
</code></pre></div><p>您还可以使用路由规则对流量执行一些操作，例如：</p> <ul><li><code>附加或删除标题</code></li> <li><code>重写网址</code></li> <li><code>为对该目的地的调用设置重试策略</code></li></ul> <h4 id="目的地规则"><a href="#目的地规则" class="header-anchor">#</a> 目的地规则</h4> <p>1.目标规则是Istio流量路由功能的关键部分。可以将虚拟服务视为流量将路由给定目 的地的方式，目标规则在评估虚拟服务路由规则后应用，因此它们适用于流量的&quot;真实&quot;目标。
2.特别是，您使用目标规则来指定命名的服务子集，例如按版本对所有给定服务的实例进行分组。然后，您可以在虚拟服务的路由规则中使用这些服务子集来控制到不同服务实例的流量。
3.目标规则还允许您在调用整个目标服务或特定服务子集时自定义 Envoy 的流量策略，例如您首选的负 载平衡模型、TLS 安全模式或断路器设置。</p> <h4 id="负载平衡选项"><a href="#负载平衡选项" class="header-anchor">#</a> 负载平衡选项</h4> <p>默认情况下，Istio 使用循环负载均衡策略，实例池中的每个服务实例依次收到请求。Istio 还支持以下模型，您可以在目标规则中为对特定服务或服务子集的请求指定这些模型。</p> <ul><li><code>随机：</code>请求随机转发到池中的实例。</li> <li><code>加权：</code>根据特定百分比将请求转发到池中的实例。</li> <li><code>最少请求：</code>请求被转发到请求数量最少的实例。</li></ul> <h4 id="目标规则示例"><a href="#目标规则示例" class="header-anchor">#</a> 目标规则示例</h4> <p>以下示例目标规则为my-svc目标服务配置了三个不同的子集，具有不同的负载平衡策略：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>destination<span class="token punctuation">-</span>rule
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>svc
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3
</code></pre></div><p>每个子集都是基于一个或多个定义的labels，在Kubernetes中，它们是附加到Pod等对象的键/值对。这些标签应用于Kubernetes服务的部署，metadata以识别不同的版本。</p> <p>除了定义子集之外，此目标规则还具有针对此目标中所有子集的默认流量策略和仅针对该子集覆盖它的子集特定策略。在该字段上方定义的默认策略为和子集subsets 设置简单的随机负载均衡器。在 策略中， 在相应子集的字段中指定了循环负载均衡器。v1v3v2</p> <h4 id="网关"><a href="#网关" class="header-anchor">#</a> 网关</h4> <p>1.您使用网关来管理网格的入站和出站流量，让您<code>指定要进入或离开网格的流量</code>。网关配置应用于在网格边缘运行的独立 Envoy 代理，而不是与服务工作负载一起运行的 Sidecar Envoy 代理。
2.与控制进入系统的流量的其他机制（例如 Kubernetes Ingress API）不同，<code>Istio 网关让您可以使用 Istio 流量路由的全部功能和灵活性</code>。您可以这样做，因为 Istio 的网关资源只允许您配置 4-6 层负载平衡属性，例如要公开的端口、TLS 设置等。然后，您无需将应用层流量路由 (L7) 添加到同一 API 资 源，而是将常规 Istio虚拟服务绑定到网关。这使您可以像管理 Istio 网格中的任何其他数据平面流量 一样管理网关流量。
3.<code>网关主要用于管理入口流量，但您也可以配置出口网关</code>。例如，出口网关允许您为离开网格的流量配置专用出口节点，让您限制哪些服务可以或应该访问外部网络，或者启用 对出口流量的安全控制 以增加网格的安全性。您还可以使用网关来配置纯内部代理。
4.Istio 提供了一些您可以使用的预配置网关代理部署 (istio-ingressgateway和istio-egressgateway)如果您使用我们的演示安装，则会部署两者，而仅使用我们的默认配置文件部署入口网关 。您可以将自 己的网关配置应用于这些部署，或者部署和配置自己的网关代理。</p> <h4 id="网关示例"><a href="#网关示例" class="header-anchor">#</a> 网关示例</h4> <p>以下示例显示了外部 HTTPS 入口流量的可能网关配置：
此网关配置<code>允许 HTTPS 流量</code>从<code>ext-host.example.com端口 443 进入网格</code>，但没有为流量指定任何路由。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>controller
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>cert
</code></pre></div><p>要指定路由并使网关按预期工作，您还必须将网关绑定到虚拟服务。您可以使用虚拟服务的gateways字 段执行此操作，如以下示例所示：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> virtual<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>host<span class="token punctuation">-</span>gwy
</code></pre></div><p>然后，您可以使用外部流量的路由规则配置虚拟服务。</p> <h4 id="服务条目"><a href="#服务条目" class="header-anchor">#</a> 服务条目</h4> <p>您可以使用服务条目向Istio内部维护的服务注册表添加一个条目。添加服务条目之后，Envoy代理可以将流量发送到服务，就好像它是网格中的服务一样。配置服务条目允许您管理在网格之外允许的服务流量，包括以下任务：</p> <ul><li><code>重定向和转发外部目的地的流量</code>，例如从web使用的API，或到旧基础设施中的服务流量。</li> <li><code>为外部目标定义重试、超时和故障注入策略。</code></li> <li><code>通过虚拟机添加网格中，在虚拟机中允许网格服务。</code></li></ul> <p>您无需希望网格服务使用的每个外部服务添加服务条目，默认情况下，Istio将Envoy代理设置为将请求传递给未知服务。但是，您不能使用Istio功能来控制到未来在网格中注册的目的地流量。</p> <h4 id="服务入口示例"><a href="#服务入口示例" class="header-anchor">#</a> 服务入口示例</h4> <p>以下示例网格外部服务条目<code>将ext-svc.example.com 外部依赖项添加到 Istio 的服务注册表</code>：
您使用该hosts字段指定外部资源。您可以完全限定它或使用通配符前缀的域名。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> svc<span class="token punctuation">-</span>entry
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
</code></pre></div><p>您可以配置虚拟服务和目标规则，以更精细的方式控制服务条目的流量，就像为网格中的任何其他服务配置流量一样。例如，以下目标规则将流量路由配置为使用<code>双向 TLS 来保护与 ext-svc.example.com我们 使用服务条目配置的外部服务的连接</code>：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>res<span class="token punctuation">-</span>dr
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> ext<span class="token punctuation">-</span>svc.example.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem
      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client_private_key.pem
      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem
</code></pre></div><h4 id="边车"><a href="#边车" class="header-anchor">#</a> 边车</h4> <p>默认情况下，Istio将每个Envo代理配置为接受其相关工作负载的所有端口上的流量，并在转发流量时到 达网格中的每个工作负载。您可以使用sidecar配置执行以下操作：</p> <ul><li><code>微调Envoy代理接受的端口和协议集</code></li> <li><code>限制Envoy代理可以访问的服务集</code></li></ul> <p>您可能希望在大型的应用程序像这样限制sidecar的可访问性，其中将每个代理配置为访问网格中的所有 其他服务可能会由于高内存的使用率而影响网格的性能。</p> <p>您可以指定希望将 sidecar 配置应用于特定命名空间中的所有工作负载，或者使用 workloadSelector. 例如，以下 sidecar 配置将命名空间中的所有服务配置bookinfo为仅访问在同一命名空间和 Istio 控制平面中运行的服务（Istio 的出口和遥测功能需要）：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Sidecar
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> default
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> bookinfo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;./*&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;istio-system/*&quot;</span>
</code></pre></div><h4 id="网络弹性和测试"><a href="#网络弹性和测试" class="header-anchor">#</a> 网络弹性和测试</h4> <p>除了帮助您引导网格周围的流量外，Istio 还提供了可选的故障恢复和故障注入功能，您可以在运行时动态配置这些功能。使用这些功能可以帮助您的应用程序可靠地运行，确保服务网格可以容忍故障节点并防止局部故障级联到其他节点。</p> <h4 id="超时"><a href="#超时" class="header-anchor">#</a> 超时</h4> <p><code>超时是 Envoy 代理应该等待来自给定服务的回复的时间量，确保服务不会无限期地等待回复，并且调用 在可预测的时间范围内成功或失败。</code>默认情况下，Istio 中禁用了 HTTP 请求的 Envoy 超时.</p> <p>对于某些应用程序和服务，Istio 的默认超时可能不合适。例如，过长的超时可能会导致等待来自失败服务的回复的延迟过长，而过短的超时可能会导致调用在等待涉及多个服务的操作返回时不必要地失败。为了找到并使用您的最佳超时设置，Istio 允许您使用虚拟服务轻松地在每个服务的基础上动态调整超时，而无需编辑您的服务代码。下面是一个虚拟服务，它为调用 rating 服务的 v1 子集指定了 10 秒的超时时间：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
</code></pre></div><h4 id="重试"><a href="#重试" class="header-anchor">#</a> 重试</h4> <p><code>重试设置指定 Envoy 代理在初始调用失败时尝试连接服务的最大次数。</code>重试可以通过确保调用不会因为 临时性问题（例如临时过载的服务或网络）而永久失败，从而提高服务可用性和应用程序性能。重试间隔（25ms+）是可变的，由 Istio 自动确定，防止被调用的服务被请求淹没。HTTP 请求的默认重试行为是 在返回错误之前重试两次。</p> <p>与超时一样，Istio 的默认重试行为可能不适合您的应用程序在延迟（失败的服务重试次数过多可能会减慢速度）或可用性方面的需求。也像超时一样，您可以在虚拟服务中基于每个服务调整重试设置，而无需接触您的服务代码。您还可以通过添加每次重试超时来进一步优化您的重试行为，指定您希望等待每次重试尝试成功连接到服务的时间量。以下示例在初始调用失败后配置最多 3 次重试以连接到此服务子集， 每次重试时间为 2 秒。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">retries</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s
</code></pre></div><h4 id="熔断"><a href="#熔断" class="header-anchor">#</a> 熔断</h4> <p><code>熔断是 Istio 提供的另一种有用的机制，用于创建基于微服务的弹性应用程序。</code>在断路器中，您可以 设置对服务中各个主机的调用限制，例如并发连接数或对该主机的调用失败的次数。一旦达到该限制，断路器就会“跳闸”并停止与该主机的进一步连接。使用断路器模式可以实现快速故障，而不是客户端尝试连接到过载或故障主机。</p> <p>由于断路器适用于负载平衡池中的“真实”网格目标，您可以在目标规则中配置断路器阈值 ，并将设置应 用于服务中的每个单独的主机。以下示例reviews将 v1 子集的服务工作负载的并发连接数限制为 100：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
        <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
          <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>
</code></pre></div><h4 id="故障注入"><a href="#故障注入" class="header-anchor">#</a> 故障注入</h4> <p><code>配置好网络（包括故障恢复策略）后，您可以使用 Istio 的故障注入机制来测试整个应用程序的故障恢复能力。</code>故障注入是一种将错误引入系统以确保系统能够承受并从错误条件中恢复的测试方法。使用故障注入对于确保您的故障恢复策略不会不兼容或限制过多，可能会导致关键服务不可用特别有用。</p> <p>与其他引入错误的机制（例如延迟数据包或在网络层杀死 pod）不同，Istio 允许您在应用程序层注入故障。这使您可以注入更多相关故障，例如 HTTP 错误代码，以获得更多相关结果。</p> <p>您可以注入两种类型的故障，均使用 虚拟服务进行配置：</p> <ul><li><code>延迟：</code>延迟是计时失败。它们模仿增加的网络延迟或过载的上游服务。</li> <li><code>中止：</code>中止是崩溃失败。它们模仿上游服务中的故障。中止通常以 HTTP 错误代码或 TCP 连接失败的 形式出现。</li></ul> <p>例如，此虚拟服务对ratings服务的每 1000 个请求中的 1 个引入了 5 秒的延迟。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre></div><h2 id="sidecar注入"><a href="#sidecar注入" class="header-anchor">#</a> Sidecar注入</h2> <h4 id="对工作负载的一些要求"><a href="#对工作负载的一些要求" class="header-anchor">#</a> 对工作负载的一些要求</h4> <p>支持的工作负载类型：</p> <ul><li><code>Job</code></li> <li><code>DaemonSet</code></li> <li><code>ReplicaSet</code></li> <li><code>Pod</code></li> <li><code>Deployment</code></li></ul> <p>等，对这些工作负载的要求如下：</p> <ul><li>要正确命名服务端口：
<ul><li><code>Service</code> 对象中的 <code>Port</code> 部分必须以 &quot;协议名&quot; 为前缀，目前支持的协议名包括 <code>http</code>，<code>http2</code>，<code>mongo</code>，<code>redis</code> 与 <code>grpc</code>；</li> <li>istio 会命名来确定为端口提供什么样的服务，不符合命名规范的端口会被当做 TCP 服务器，其功能支持范围会大幅缩小。</li></ul></li> <li>工作负载的 Pod 必须有关联的 Service：
<ul><li>为满足服务发现的需要，所有 Pod 都必须有关联的服务；</li> <li>官方建议为 Pod 模板加入两个标签：<code>app</code> 与 <code>version</code>，分别标注应用名称与版本，虽仅是个建议，但 istio 很多默认策略会引用这两个标签，如果没有会引发很多不必要的麻烦。</li></ul></li></ul> <h4 id="手工注入"><a href="#手工注入" class="header-anchor">#</a> 手工注入</h4> <p>创建一个deployment做nginx的pod控制器，副本维持在2个。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># cat deploymen.yaml  </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> test
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        
<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deploymen.yaml  </span>
deployment.apps/test created
</code></pre></div><p>istioctl kube-inject 会将 istio 相关容器注入应用，&quot;-o&quot; 参数将注入结果生成 yaml 文件 ，方便观察使用此命令与 &quot;kubectl apply -f&quot; 的区别；</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject -f deployment.yaml -o deployment-inject.yaml  </span>
</code></pre></div><p>新的 yaml 文件中多出了 &quot;Sidecar&quot; 容器， 并且出现了1个初始化容器 (initContainers) &quot;istio-init&quot; ，初始化容器即用来劫持应用通信到 &quot;Sidecar&quot; 容器的工具；</p> <p>可直接 &quot;kubectl apply -f&quot; 生成的 yaml 文件，<code>注入后 Nginx 应用 与 Istio-Proxy 共享网络命名空间</code> 。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># istioctl kube-inject  -f /root/deploymen.yaml | kubectl apply -f - -n test </span>
deployment.apps/test configured
<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n test </span>
NAME                    READY   STATUS    RESTARTS   AGE
test-67b6d4d78c-jzzml   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s
test-67b6d4d78c-sfxk8   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          20s

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  -n test test-67b6d4d78c-jzzml -c istio-proxy -- netstat -ntlp</span>
Active Internet connections <span class="token punctuation">(</span>only servers<span class="token punctuation">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15021           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:80              <span class="token number">0.0</span>.0.0:*               LISTEN      -                   
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15090           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15000         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15001           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">127.0</span>.0.1:15004         <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">1</span>/pilot-agent       
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:15006           <span class="token number">0.0</span>.0.0:*               LISTEN      <span class="token number">16</span>/envoy            
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::15020                :::*                    LISTEN      <span class="token number">1</span>/pilot-agent       
tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::80                   :::*                    LISTEN      -                   
</code></pre></div><h2 id="请求路由"><a href="#请求路由" class="header-anchor">#</a> 请求路由</h2> <h4 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h4> <ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序。</li> <li>了解了流量管理的基础概念，以及专业语术。</li></ul> <blockquote><p>注意：</p> <p>Istio <a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例由四个独立的微服务组成，每个微服务都有多个版本。其中一个微服务的三个不同版本<code>reviews</code>已部署并同时运行。为了说明这导致的问题，请<code>/productpage</code>在浏览器中访问 Bookinfo 应用程序并刷新几次。您会注意到，有时书评输出包含星级，有时则不包含。这是因为如果没有明确的默认服务版本来路由，Istio 会以循环方式将请求路由到所有可用版本。</p></blockquote> <h4 id="应用虚拟服务"><a href="#应用虚拟服务" class="header-anchor">#</a> 应用虚拟服务</h4> <p>要仅路由到一个版本，您可以应用为微服务设置默认版本的虚拟服务。在这种情况下，虚拟服务会将所有流量路由到<code>v1</code>每个微服务。</p> <ol><li>运行以下命令以应用虚拟服务：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><p>因为配置传播最终是一致的，所以等待几秒钟让虚拟服务生效。</p> <ol start="2"><li>使用以下命令显示定义的路由：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat istio<span class="token punctuation">-</span>1.9.5/samples/bookinfo/networking/virtual<span class="token punctuation">-</span>service<span class="token punctuation">-</span>all<span class="token punctuation">-</span>v1.yaml 
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> productpage
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> details
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> details
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> details
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre></div><ol start="3"><li>您还可以<code>subset</code>使用以下命令显示相应的定义：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get destinationrules <span class="token parameter variable">-o</span> yaml
</code></pre></div><p>您已将 Istio 配置为路由到<code>v1</code>Bookinfo 微服务的版本，最重要的是<code>reviews</code>服务版本 1。</p> <h4 id="测试新的路由配置"><a href="#测试新的路由配置" class="header-anchor">#</a> 测试新的路由配置</h4> <p>您可以通过再次刷新<code>/productpage</code> Bookinfo 应用程序轻松测试新配置。</p> <ol><li><p>在浏览器中打开 Bookinfo 站点。URL 是<code>http://$GATEWAY_URL/productpage</code>，其中<code>$GATEWAY_URL</code>是入口的外部 IP 地址，如<a href="https://istio.io/latest/docs/examples/bookinfo/#determine-the-ingress-ip-and-port" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文档中所述。</p> <p>请注意，无论您刷新多少次，页面的评论部分都不会显示评分星。这是因为您将 Istio 配置为将评论服务的所有流量路由到该版本<code>reviews:v1</code>，并且该版本的服务不访问星级评分服务。</p></li></ol> <p>您已成功完成此任务的第一部分：将流量路由到服务的一个版本</p> <h4 id="基于用户身份的路由"><a href="#基于用户身份的路由" class="header-anchor">#</a> 基于用户身份的路由</h4> <p>接下来，您将更改路由配置，以便将来自特定用户的所有流量路由到特定服务版本。在这种情况下，来自名为 Jason 的用户的所有流量都将路由到服务<code>reviews:v2</code>。</p> <p>该示例的启用是因为该<code>productpage</code>服务将自定义<code>end-user</code>标头添加到所有到评论服务的出站 HTTP 请求。</p> <p>Istio 还支持在入口网关上基于强认证 JWT 的路由，有关更多详细信息，请参阅 <a href="https://istio.io/latest/docs/tasks/security/authentication/jwt-route" target="_blank" rel="noopener noreferrer">基于 JWT 声明的路由<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>请记住，<code>reviews:v2</code>是包含星级评分功能的版本。</p> <ol><li>运行以下命令以启用基于用户的路由：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre></div><ol start="2"><li>确认规则已创建：</li></ol> <p>创建规则允许用户jasone</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-test-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre></div><ol start="3"><li><p>在<code>/productpage</code>Bookinfo 应用程序上，以 user 身份登录<code>jason</code>。刷新浏览器。你看到了什么？星级评分显示在每条评论旁边。</p></li> <li><p>以其他用户身份登录（选择您想要的任何名称）。刷新浏览器。现在星星不见了。这是因为流量被路由到<code>reviews:v1</code>除了 Jason 之外的所有用户。您已成功配置 Istio 以根据用户身份路由流量。</p></li></ol> <h4 id="清理"><a href="#清理" class="header-anchor">#</a> 清理</h4> <p>删除应用程序路由规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><h2 id="故障注入-2"><a href="#故障注入-2" class="header-anchor">#</a> 故障注入</h2> <h4 id="环境准备-2"><a href="#环境准备-2" class="header-anchor">#</a> 环境准备</h4> <ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序，应用目标规则。</li> <li>了解了流量管理的基础概念，以及专业语术。</li></ul> <blockquote><p>通过执行 <a href="https://istio.io/latest/docs/tasks/traffic-management/request-routing/" target="_blank" rel="noopener noreferrer">请求路由<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>任务或运行以下命令来应用应用程序版本路由：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre></div></blockquote> <h4 id="注入http延迟错误"><a href="#注入http延迟错误" class="header-anchor">#</a> 注入HTTP延迟错误</h4> <p>要测试 Bookinfo 应用程序微服务的弹性，请在user<code>reviews:v2</code>和微服务之间注入 7s 延迟。此测试将发现一个有意引入 Bookinfo 应用程序的错误。<code>ratings jason</code></p> <p>请注意，该<code>reviews:v2</code>服务对服务的调用有 10 秒的硬编码连接超时<code>ratings</code>。即使您引入了 7 秒延迟，您仍然希望端到端流程继续进行而不会出现任何错误。</p> <ol><li>创建故障注入规则以延迟来自测试用户的流量 <code>jason</code>。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml
</code></pre></div><ol start="2"><li>确认规则已创建：
<ul><li><code>创建规则通过jason用户登录</code></li> <li><code>在微服务之间注入7s的延迟</code></li></ul></li></ol> <blockquote><p><code>参数详解：</code></p> <p><strong>fault:</strong>							# 要应用于客户端HTTP流量的故障注入策略。
<strong>delay:</strong>						# 延迟
<strong>percentage:</strong>			# 百分率
<strong>value: 100.0</strong>		 # 键值为百分之一百
<strong>fixedDelay: 7s</strong>		# 固定时间为7s</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-delay.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>					
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>				
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>			
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 7s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre></div><p>等待几秒钟，让新规则传播到所有 pod。</p> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327994.png" alt="image-20220316153536186"></p> <h4 id="测试延迟配置"><a href="#测试延迟配置" class="header-anchor">#</a> 测试延迟配置</h4> <ol><li><p>在浏览器中打开<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web 应用程序。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>在<code>/productpage</code>网页上，以 user 身份登录<code>jason</code>。</p> <p>您希望 Bookinfo 主页在大约 7 秒内加载而不会出现错误。但是，有一个问题：Reviews 部分显示一条错误消息：</p> <p><code>Sorry, product reviews are currently unavailable for this book.</code></p></li> <li><p>查看网页响应时间：</p> <ol><li>在 Web 浏览器中打开<em>开发者工具</em>菜单。</li> <li>打开网络选项卡</li> <li>重新加载<code>/productpage</code>网页。您将看到页面实际加载大约需要 6 秒。</li></ol></li></ol> <h4 id="修复错误"><a href="#修复错误" class="header-anchor">#</a> 修复错误</h4> <p>您通常会通过以下方式解决问题：</p> <ol><li>增加服务超时或减少<code>productpage</code>服务超时<code>reviews reviews ratings</code></li> <li>停止和重启固定的微服务</li> <li>确认<code>/productpage</code>网页返回其响应没有任何错误。</li></ol> <p>但是，您已经在<code>reviews</code>服务的 v3 中运行了一个修复程序。该<code>reviews:v3</code>服务将超时时间从 10s 减少<code>reviews</code>到2.5s，以便与下游请求<code>ratings</code>的超时时间兼容（小于） <code>productpage</code>。</p> <p>如果您按照<a href="https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/" target="_blank" rel="noopener noreferrer">流量转移<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>reviews:v3</code>任务中的描述 将所有流量迁移到，您可以尝试将延迟规则更改为小于 2.5s 的任意量，例如 2s，并确认端到端流程继续没有任何错误。</p> <h4 id="注入http中止错误"><a href="#注入http中止错误" class="header-anchor">#</a> 注入HTTP中止错误</h4> <p>测试微服务弹性的另一种方法是引入 HTTP 中止故障。<code>ratings</code>在此任务中，您将为测试用户的微服务引入 HTTP 中止<code>jason</code>。</p> <p>在这种情况下，您希望页面立即加载并显示<code>Ratings service is currently unavailable</code>消息。</p> <ol><li>创建一个故障注入规则，为用户发送 HTTP 中止<code>jason</code>：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml
</code></pre></div><ol start="2"><li>确认规则已创建：
<ul><li><code>创建规则通过jason用户流量</code></li> <li><code>在微服务之间中止jason用户，httpstatus是500状态，百分率设置为100</code></li></ul></li></ol> <blockquote><p><code>参数详解：</code></p> <p><strong>fault:</strong>							# 要应用于客户端HTTP流量的故障注入策略。
<strong>abort:</strong>						# 中止策略
<strong>percentage:</strong>			# 百分率
<strong>value: 100.0</strong>		 # 键值为百分之一百
<strong>httpStatus: 500</strong>	  # httpstatus设置为500报错</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-ratings-test-abort.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>
          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason
    <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">abort</span><span class="token punctuation">:</span>
        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>
          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre></div><h4 id="测试中止配置"><a href="#测试中止配置" class="header-anchor">#</a> 测试中止配置</h4> <ol><li><p>在浏览器中打开<a href="https://istio.io/latest/docs/examples/bookinfo" target="_blank" rel="noopener noreferrer">Bookinfo Web 应用程序。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>在 上<code>/productpage</code>，以用户身份登录<code>jason</code>。</p> <p>如果规则成功传播到所有 pod，页面会立即加载并显示<code>Ratings service is currently unavailable</code>消息。</p></li> <li><p>如果您从用户注销<code>jason</code>或在匿名窗口（或其他浏览器）中打开 Bookinfo 应用程序，您 将<code>/productpage</code>看到除了. 因此，您不会看到任何错误消息。<code>reviews:v1 ratings jason</code></p></li></ol> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327813.png" alt="image-20220316155324788"></p> <h4 id="清理-2"><a href="#清理-2" class="header-anchor">#</a> 清理</h4> <p>删除应用程序路由规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><h2 id="流量转移"><a href="#流量转移" class="header-anchor">#</a> 流量转移</h2> <h4 id="什么是流量转移"><a href="#什么是流量转移" class="header-anchor">#</a> 什么是流量转移？</h4> <p>此任务向您展示如何将流量从一个微服务版本转移到另一个版本。</p> <p>一个常见的用例是将流量从旧版本的微服务逐渐迁移到新版本。在 Istio 中，您可以通过配置一系列路由规则来实现这一目标，这些规则将一定比例的流量从一个目的地重定向到另一个目的地。</p> <p>在此任务中，您将使用将 50% 的流量发送到<code>reviews:v1</code>和 50% 到<code>reviews:v3</code>。然后，您将通过将 100% 的流量发送到 来完成迁移<code>reviews:v3</code>。</p> <h4 id="环境准备-3"><a href="#环境准备-3" class="header-anchor">#</a> 环境准备</h4> <ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序，应用目标规则。</li> <li>了解了流量管理的基础概念，以及专业语术。</li></ul> <blockquote><p>首先，运行此命令将所有流量路由到<code>v1</code>每个微服务的版本。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div></blockquote> <h4 id="应用基于权重的路由"><a href="#应用基于权重的路由" class="header-anchor">#</a> 应用基于权重的路由</h4> <ol><li><code>reviews:v1</code>使用<code>reviews:v3</code>以下命令传输 50% 的流量：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre></div><ol start="2"><li>确认规则已被替换：
<ul><li><code>创建v1版本的权重为50</code></li> <li><code>创建v3版本的权重为50</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-50-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre></div><ol start="3"><li>在您的浏览器中刷新<code>/productpage</code>，您现在大约有 50% 的时间会看到<code>红色</code>的星级。这是因为<code>v3</code>版本<code>reviews</code>访问了星级服务，而<code>v1</code>版本没有。</li></ol> <blockquote><p>注意：</p> <p>使用当前的 Envoy sidecar 实现，您可能需要 <code>/productpage</code>多次刷新（可能 15 次或更多）才能看到正确的分布。您可以修改规则以将 90% 的流量路由到<code>v3</code>更频繁地看到红星。</p></blockquote> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327265.png" alt="image-20220316160723199"></p> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327027.png" alt="image-20220316160736887"></p> <ol start="4"><li>假设您确定<code>reviews:v3</code>微服务是稳定的，您可以<code>reviews:v3</code>通过应用此虚拟服务将 100% 的流量路由到：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 networking<span class="token punctuation">]</span><span class="token comment"># cat virtual-service-reviews-v3.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3
</code></pre></div><p>现在，当您刷新时，<code>/productpage</code>您总是会看到每条评论带有<code>红色</code>星级的书评。</p> <h4 id="清理-3"><a href="#清理-3" class="header-anchor">#</a> 清理</h4> <p>删除应用程序路由规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><h2 id="tcp-流量转移"><a href="#tcp-流量转移" class="header-anchor">#</a> TCP 流量转移</h2> <h4 id="什么是tcp流量转移"><a href="#什么是tcp流量转移" class="header-anchor">#</a> 什么是TCP流量转移？</h4> <p>将 TCP 流量从一个微服务版本转移到另一个版本。</p> <p>一个常见的用例是将 TCP 流量从旧版本的微服务逐渐迁移到新版本。在 Istio 中，您可以通过配置一系列路由规则来实现这一目标，这些规则将一定百分比的 TCP 流量从一个目的地重定向到另一个目的地。在此任务中，您将 100% 的 TCP 流量发送到<code>tcp-echo:v1</code>. 然后，您将<code>tcp-echo:v2</code>使用 Istio 的加权路由功能路由 20% 的 TCP 流量。</p> <h4 id="基础环境"><a href="#基础环境" class="header-anchor">#</a> 基础环境</h4> <blockquote><ol><li>首先，创建一个用于测试 TCP 流量转移的命名空间并将其标记为启用自动边车注入。</li> <li>部署<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序以用作发送请求的测试源。</li> <li>部署微服务的<code>v1</code>和<code>v2</code>版本<code>tcp-echo</code>。</li> <li>按照 <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports" target="_blank" rel="noopener noreferrer">确定入口 IP 和端口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>TCP_INGRESS_PORT</code>中 的说明定义<code>INGRESS_HOST</code>环境变量。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create namespace istio-io-tcp-traffic-shifting
$ kubectl label namespace istio-io-tcp-traffic-shifting istio-injection<span class="token operator">=</span>enabled
$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl apply <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
</code></pre></div></blockquote> <h4 id="应用基于权重的tcp路由"><a href="#应用基于权重的tcp路由" class="header-anchor">#</a> 应用基于权重的TCP路由</h4> <ol><li>将所有 TCP 流量路由到微服务的<code>v1</code>版本<code>tcp-echo</code>。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-all-v1.yaml -n istio-io-tcp-traffic-shifting</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 samples<span class="token punctuation">]</span><span class="token comment"># cat tcp-echo/tcp-echo-all-v1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">31400</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>destination
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>				<span class="token comment"># 这里修改成使用端口的方式</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>		 <span class="token comment"># 端口号是9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1            <span class="token comment"># 版本使用V1版本</span>
</code></pre></div><ol start="2"><li><code>tcp-echo</code>通过从客户端发送一些 TCP 流量来确认服务已启动并正在运行<code>sleep</code>。</li></ol> <blockquote><p>下面的 <code>$INGRESS_HOST</code> 变量是 ingress 的外部 IP 地址，<code>$TCP_INGRESS_PORT</code>是ingress的端口</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_HOST</span><span class="token operator">=</span>worker-node-address
</code></pre></div></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 samples<span class="token punctuation">]</span><span class="token comment"># for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:24:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:07 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:10 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:12 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:15 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:17 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:25:19 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre></div><p>您应该注意到所有时间戳的前缀都是<em>one</em>，这意味着所有流量都被路由到服务的<code>v1</code>版本<code>tcp-echo</code>。</p> <ol start="3"><li><code>tcp-echo:v1</code>使用<code>tcp-echo:v2</code>以下命令传输 20% 的流量：</li></ol> <blockquote><p>通过修改<code>weight的值</code>来确定流量的分布控制。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f samples/tcp-echo/tcp-echo-20-v2.yaml</span>

<span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span>node1 istio<span class="token punctuation">-</span>1.9.5<span class="token punctuation">]</span><span class="token comment"># cat samples/tcp-echo/tcp-echo-20-v2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> tcp<span class="token punctuation">-</span>echo<span class="token punctuation">-</span>gateway
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">31400</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>echo
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9000</span>
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
</code></pre></div><ol start="4"><li><p>向微服务发送更多 TCP 流量<code>tcp-echo</code>。</p> <p>您现在应该注意到大约 20% 的时间戳具有前缀<em>2</em>，这意味着 80% 的 TCP 流量被路由到服务<code>v1</code>版本<code>tcp-echo</code>，而 20% 被路由到<code>v2</code>.</p></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment">#  for i in {1..20}; do \</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c</span> <span class="token function">sleep</span> <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;(date; sleep 1) | nc <span class="token variable">$INGRESS_HOST</span> <span class="token variable">$TCP_INGRESS_PORT</span>&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
<span class="token keyword">done</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:45 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:47 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:50 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:52 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:55 UTC <span class="token number">2018</span>
two Mon Nov <span class="token number">12</span> <span class="token number">23</span>:38:57 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:00 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:02 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:05 UTC <span class="token number">2018</span>
one Mon Nov <span class="token number">12</span> <span class="token number">23</span>:39:07 UTC <span class="token number">2018</span>
<span class="token punctuation">..</span>.
</code></pre></div><h4 id="清理-4"><a href="#清理-4" class="header-anchor">#</a> 清理</h4> <p>删除<code>sleep</code>示例、<code>tcp-echo</code>应用程序和路由规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-all-v1.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/tcp-echo/tcp-echo-services.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml <span class="token parameter variable">-n</span> istio-io-tcp-traffic-shifting
$ kubectl delete namespace istio-io-tcp-traffic-shifting
</code></pre></div><h2 id="请求超时"><a href="#请求超时" class="header-anchor">#</a> 请求超时</h2> <h4 id="环境准备-4"><a href="#环境准备-4" class="header-anchor">#</a> 环境准备</h4> <ul><li>部署<a href="https://istio.io/latest/docs/examples/bookinfo/" target="_blank" rel="noopener noreferrer">Bookinfo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序，应用目标规则。</li> <li>了解了流量管理的基础概念，以及专业语术。</li></ul> <blockquote><p>首先，运行此命令将所有流量路由到<code>v1</code>每个微服务的版本。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div></blockquote> <h4 id="请求超时-2"><a href="#请求超时-2" class="header-anchor">#</a> 请求超时</h4> <p>可以使用<a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#HTTPRoute" target="_blank" rel="noopener noreferrer">路由规则的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><em>timeout</em>字段指定 HTTP 请求的超时时间。默认情况下，请求超时被禁用，但在此任务中，您将服务超时覆盖为 1 秒。但是，要查看其效果，您还可以在调用服务时人为地引入 2 秒延迟。</p> <ol><li>将请求路由到<code>reviews</code>服务的 v2，即调用<code>ratings</code>服务的版本：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
EOF
</code></pre></div><ol start="2"><li>对服务的调用添加 2 秒延迟<code>ratings</code>：
<ul><li><code>使用http规则配置目的地版本为v1主机是ratings</code></li> <li><code>配置百分比为100的2秒固定时间延迟</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ratings
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>
      <span class="token key atrule">delay</span><span class="token punctuation">:</span>
        <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 2s
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
EOF
</code></pre></div><ol start="3"><li><code>http://$GATEWAY_URL/productpage</code>在浏览器中打开 Bookinfo URL 。</li></ol> <p>您应该会看到 Bookinfo 应用程序正常工作（显示评级星），但是每当您刷新页面时都会有 2 秒的延迟。</p> <ol start="4"><li>现在为对服务的调用添加半秒请求超时<code>reviews</code>：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reviews
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 0.5s
EOF
</code></pre></div><ol start="5"><li>刷新 Bookinfo 网页。</li></ol> <p>您现在应该看到它在大约 1 秒内返回，而不是 2 秒，并且评论不可用。</p> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062327037.png" alt="image-20220318111010285"></p> <blockquote><p>注意：</p> <p>响应需要1秒的原因，即使超时配置为半秒，也是因为服务中有硬编码的重试，所以它在返回之前调用了两次<code>productpage</code>超时服务。<code>reviews</code></p></blockquote> <h4 id="清理-5"><a href="#清理-5" class="header-anchor">#</a> 清理</h4> <p>删除应用程序路由规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete <span class="token parameter variable">-f</span> samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre></div><h2 id="熔断-2"><a href="#熔断-2" class="header-anchor">#</a> 熔断</h2> <h4 id="熔断的方式"><a href="#熔断的方式" class="header-anchor">#</a> 熔断的方式</h4> <p>此任务向您展示如何为连接、请求和异常值检测配置断路。</p> <p>断路是创建弹性微服务应用程序的重要模式。断路允许您编写限制故障、延迟峰值和网络特性的其他不良影响的影响的应用程序。</p> <p>在此任务中，您将配置断路器规则，然后通过有意“跳闸”断路器来测试配置。</p> <h4 id="环境准备-5"><a href="#环境准备-5" class="header-anchor">#</a> 环境准备</h4> <p>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例。</p> <p>如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请部署该<code>httpbin</code>服务：</p> <p>否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre></div><h4 id="配置断路器"><a href="#配置断路器" class="header-anchor">#</a> 配置断路器</h4> <ol><li>创建<a href="https://istio.io/latest/docs/reference/config/networking/destination-rule/" target="_blank" rel="noopener noreferrer">目标规则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>以在调用服务时应用断路设置<code>httpbin</code>：
<ul><li><code>配置交通政策的连接池和异常检测</code></li> <li><code>配置连接池的tcp规则到目标主机的最大HTTP1/TCP连接数为 1</code></li> <li><code>配置连接池的http规则对目标的最大挂起HTTP请求数为 1</code></li> <li><code>配置连接池的http规则每个后端连接的最大请求数为 1</code></li> <li><code>配置异常检测从连接池中弹出主机之前的5xx错误数为 1</code></li> <li><code>配置异常检测弹射扫描分析之间的时间间隔为 1秒</code></li> <li><code>配置异常检测最短弹射时间为 3分钟</code></li> <li><code>配置异常检测最大弹射百分比为 100</code></li></ul></li></ol> <blockquote><p>如果您安装/配置了启用双向 TLS 身份验证的 Istio，则必须在应用之前添加 TLS 流量<code>mode: ISTIO_MUTUAL</code>策略<code>DestinationRule</code>。否则请求将产生 503 错误，如此<a href="https://istio.io/latest/docs/ops/common-problems/network-issues/#503-errors-after-setting-destination-rule" target="_blank" rel="noopener noreferrer">处<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>所述。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s
      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre></div><ol start="2"><li>验证目标规则是否已正确创建：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl get destinationrules</span>
NAME                   HOST          AGE
details                details       4h41m
httpbin                httpbin       64m
</code></pre></div><h4 id="添加客户端"><a href="#添加客户端" class="header-anchor">#</a> 添加客户端</h4> <p>创建客户端以将流量发送到<code>httpbin</code>服务。<a href="https://github.com/istio/fortio" target="_blank" rel="noopener noreferrer">该客户端是一个名为fortio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的简单负载测试客户端。Fortio 允许您控制传出 HTTP 调用的连接数、并发性和延迟。您将使用此客户端“跳闸”您在<code>DestinationRule</code>.</p> <ol><li>使用 Istio sidecar 代理注入客户端，以便网络交互由 Istio 管理。如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请部署该<code>fortio</code>服务：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml
</code></pre></div><p>否则，您必须在部署应用程序之前手动注入 sidecar <code>fortio</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/sample-client/fortio-deploy.yaml<span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>登录客户端pod，使用fortio工具调用<code>httpbin</code>. 传入<code>curl</code>表示你只想打一个电话：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">FORTIO_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>fortio <span class="token parameter variable">-o</span> <span class="token string">'jsonpath={.items[0].metadata.name}'</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$FORTIO_POD</span>&quot;</span> <span class="token parameter variable">-c</span> fortio -- /usr/bin/fortio <span class="token function">curl</span> <span class="token parameter variable">-quiet</span> http://httpbin:8000/get
HTTP/1.1 <span class="token number">200</span> OK
server: envoy
date: Tue, <span class="token number">25</span> Feb <span class="token number">2020</span> <span class="token number">20</span>:25:52 GMT
content-type: application/json
content-length: <span class="token number">586</span>
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
x-envoy-upstream-service-time: <span class="token number">36</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;args&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;fortio.org/fortio-1.3.1&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;8fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;071d7f06bc94943c&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;86a929a0e76cda378fc453fb1dec2c22&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/httpbin;Hash=68bbaedefe01ef4cb99e17358ff63e92d04a4ce831a35ab9a31d3c8e06adb038;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;origin&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;127.0.0.1&quot;</span>,
  <span class="token string">&quot;url&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;http://httpbin:8000/get&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="使断路器跳闸"><a href="#使断路器跳闸" class="header-anchor">#</a> 使断路器跳闸</h4> <p>在<code>DestinationRule</code>设置中，您指定了<code>maxConnections: 1</code>和 <code>http1MaxPendingRequests: 1</code>。这些规则表明，如果您超过一个连接并同时请求，则当 <code>istio-proxy</code>打开更多请求和连接的电路时，您应该会看到一些失败。</p> <ol><li>使用两个并发连接 ( <code>-c 2</code>) 调用服务并发送 20 个请求 ( <code>-n 20</code>)：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:42:53 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">2</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">10</span> per thread + <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:42:53 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">90</span>.508623ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">220.97</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0081634006</span> +/- <span class="token number">0.006652</span> min <span class="token number">0.000929244</span> max <span class="token number">0.027135759</span> <span class="token function">sum</span> <span class="token number">0.163268012</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000929244</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000964622</span> , <span class="token number">5.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">25.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">30.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.005</span> <span class="token operator">&lt;=</span> <span class="token number">0.006</span> , <span class="token number">0.0055</span> , <span class="token number">40.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.006</span> <span class="token operator">&lt;=</span> <span class="token number">0.007</span> , <span class="token number">0.0065</span> , <span class="token number">50.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.007</span> <span class="token operator">&lt;=</span> <span class="token number">0.008</span> , <span class="token number">0.0075</span> , <span class="token number">60.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">65.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.009</span> <span class="token operator">&lt;=</span> <span class="token number">0.01</span> , <span class="token number">0.0095</span> , <span class="token number">80.00</span>, <span class="token number">3</span>
<span class="token operator">&gt;</span> <span class="token number">0.014</span> <span class="token operator">&lt;=</span> <span class="token number">0.016</span> , <span class="token number">0.015</span> , <span class="token number">85.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.018</span> <span class="token operator">&lt;=</span> <span class="token number">0.02</span> , <span class="token number">0.019</span> , <span class="token number">95.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.025</span> <span class="token operator">&lt;=</span> <span class="token number">0.0271358</span> , <span class="token number">0.0260679</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.007</span>
<span class="token comment"># target 75% 0.00966667</span>
<span class="token comment"># target 90% 0.019</span>
<span class="token comment"># target 99% 0.0267086</span>
<span class="token comment"># target 99.9% 0.027093</span>
Sockets used: <span class="token number">8</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">2</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">14</span> <span class="token punctuation">(</span><span class="token number">70.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">6</span> <span class="token punctuation">(</span><span class="token number">30.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">161.15</span> +/- <span class="token number">105.5</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">3223</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">649.25</span> +/- <span class="token number">267.3</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">12985</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">8.163</span> ms avg, <span class="token number">221.0</span> qps
</code></pre></div><p>有趣的是，几乎所有请求都通过了！<code>istio-proxy</code> 确实留有余地。</p> <div class="language- extra-class"><pre class="language-text"><code>Code 200 : 14 (70.0 %)
Code 503 : 6 (30.0 %)
</code></pre></div><ol start="2"><li>将并发连接数增加到 3：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 3 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get</span>
<span class="token number">15</span>:44:49 I logger.go:12<span class="token operator"><span class="token file-descriptor important">7</span>&gt;</span> Log level is now <span class="token number">3</span> Warning <span class="token punctuation">(</span>was <span class="token number">2</span> Info<span class="token punctuation">)</span>
Fortio <span class="token number">1.17</span>.1 running at <span class="token number">0</span> queries per second, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span> procs, <span class="token keyword">for</span> <span class="token number">20</span> calls: http://httpbin:8000/get
Starting at max qps with <span class="token number">3</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">for</span> exactly <span class="token number">20</span> calls <span class="token punctuation">(</span><span class="token number">6</span> per thread + <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
<span class="token number">15</span>:44:49 W http_client.go:80<span class="token operator"><span class="token file-descriptor important">6</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Non ok http code <span class="token number">503</span> <span class="token punctuation">(</span>HTTP/1.1 <span class="token number">503</span><span class="token punctuation">)</span>
Ended after <span class="token number">32</span>.522699ms <span class="token builtin class-name">:</span> <span class="token number">20</span> calls. <span class="token assign-left variable">qps</span><span class="token operator">=</span><span class="token number">614.96</span>
Aggregated Function Time <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">0.0029114787</span> +/- <span class="token number">0.003681</span> min <span class="token number">0.000447652</span> max <span class="token number">0.016532305</span> <span class="token function">sum</span> <span class="token number">0.058229575</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000447652</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000723826</span> , <span class="token number">30.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.002</span> , <span class="token number">0.0015</span> , <span class="token number">60.00</span>, <span class="token number">6</span>
<span class="token operator">&gt;</span> <span class="token number">0.002</span> <span class="token operator">&lt;=</span> <span class="token number">0.003</span> , <span class="token number">0.0025</span> , <span class="token number">70.00</span>, <span class="token number">2</span>
<span class="token operator">&gt;</span> <span class="token number">0.004</span> <span class="token operator">&lt;=</span> <span class="token number">0.005</span> , <span class="token number">0.0045</span> , <span class="token number">90.00</span>, <span class="token number">4</span>
<span class="token operator">&gt;</span> <span class="token number">0.008</span> <span class="token operator">&lt;=</span> <span class="token number">0.009</span> , <span class="token number">0.0085</span> , <span class="token number">95.00</span>, <span class="token number">1</span>
<span class="token operator">&gt;</span> <span class="token number">0.016</span> <span class="token operator">&lt;=</span> <span class="token number">0.0165323</span> , <span class="token number">0.0162662</span> , <span class="token number">100.00</span>, <span class="token number">1</span>
<span class="token comment"># target 50% 0.00166667</span>
<span class="token comment"># target 75% 0.00425</span>
<span class="token comment"># target 90% 0.005</span>
<span class="token comment"># target 99% 0.0164258</span>
<span class="token comment"># target 99.9% 0.0165217</span>
Sockets used: <span class="token number">16</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">3</span><span class="token punctuation">)</span>
Jitter: <span class="token boolean">false</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">5</span> <span class="token punctuation">(</span><span class="token number">25.0</span> %<span class="token punctuation">)</span>
Code <span class="token number">503</span> <span class="token builtin class-name">:</span> <span class="token number">15</span> <span class="token punctuation">(</span><span class="token number">75.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">57.55</span> +/- <span class="token number">99.68</span> min <span class="token number">0</span> max <span class="token number">231</span> <span class="token function">sum</span> <span class="token number">1151</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">20</span> avg <span class="token number">386.8</span> +/- <span class="token number">252.5</span> min <span class="token number">241</span> max <span class="token number">825</span> <span class="token function">sum</span> <span class="token number">7736</span>
All <span class="token keyword">done</span> <span class="token number">20</span> calls <span class="token punctuation">(</span>plus <span class="token number">0</span> warmup<span class="token punctuation">)</span> <span class="token number">2.911</span> ms avg, <span class="token number">615.0</span> qps
</code></pre></div><p>现在您开始看到预期的断路行为。只有 36.7% 的请求成功，其余的则被熔断机制困住：</p> <div class="language- extra-class"><pre class="language-text"><code>Code 200 : 5 (25.0 %)
Code 503 : 15 (75.0 %)
</code></pre></div><ol start="3"><li><p>查询<code>istio-proxy</code>统计信息以查看更多信息：</p> <p>您可以查看<code>21</code>该<code>upstream_rq_pending_overflow</code>值，这意味着<code>21</code> 到目前为止的调用已被标记为断路。</p></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-1.9.5<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;$FORTIO_POD&quot; -c istio-proxy -- pilot-agent request GET stats | grep httpbin | grep pending</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.remaining_pending: <span class="token number">1</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.default.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.circuit_breakers.high.rq_pending_open: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_active: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_failure_eject: <span class="token number">0</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_overflow: <span class="token number">40</span>
cluster.outbound<span class="token operator">|</span><span class="token number">8000</span><span class="token operator">||</span>httpbin.default.svc.cluster.local.upstream_rq_pending_total: <span class="token number">41</span>
</code></pre></div><h4 id="清理-6"><a href="#清理-6" class="header-anchor">#</a> 清理</h4> <p>删除规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete destinationrule httpbin
</code></pre></div><p>关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务和客户端：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete deploy httpbin fortio-deploy
$ kubectl delete svc httpbin fortio
</code></pre></div><h2 id="镜像"><a href="#镜像" class="header-anchor">#</a> 镜像</h2> <h4 id="流量镜像"><a href="#流量镜像" class="header-anchor">#</a> 流量镜像</h4> <p>此任务演示了 Istio 的流量镜像功能。</p> <p>流量镜像，也称为阴影，是一个强大的概念，它允许功能团队以尽可能小的风险将更改带入生产环境。镜像将实时流量的副本发送到镜像服务。镜像流量发生在主服务的关键请求路径的带外。</p> <p>在此任务中，您将首先强制所有流量流向<code>v1</code>测试服务。然后，您将应用规则将一部分流量镜像到<code>v2</code>.</p> <h4 id="基础环境-2"><a href="#基础环境-2" class="header-anchor">#</a> 基础环境</h4> <p>首先部署两个启用了访问日志记录的<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin服务版本：<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>httpbin-v1：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.io/kennethreitz/httpbin
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;gunicorn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--access-logfile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0.0.0.0:80&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;httpbin:app&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
EOF
</code></pre></div><p><strong>httpbin-v2：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> istioctl kube-inject <span class="token parameter variable">-f</span> - <span class="token operator">|</span> kubectl create <span class="token parameter variable">-f</span> -</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpbin-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: httpbin
      version: v2
  template:
    metadata:
      labels:
        app: httpbin
        version: v2
    spec:
      containers:
      - image: docker.io/kennethreitz/httpbin
        imagePullPolicy: IfNotPresent
        name: httpbin
        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]
        ports:
        - containerPort: 80
EOF</span>
</code></pre></div><p><strong>httpbin Kubernetes 服务：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre></div><p>启动<code>sleep</code>服务，以便您可以使用它<code>curl</code>来提供负载：</p> <p><strong>睡眠服务：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> istioctl kube<span class="token punctuation">-</span>inject <span class="token punctuation">-</span>f <span class="token punctuation">-</span> <span class="token punctuation">|</span> kubectl create <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> sleep
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sleep
        <span class="token key atrule">image</span><span class="token punctuation">:</span> curlimages/curl
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sleep&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;3650d&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
EOF
</code></pre></div><h4 id="创建默认路由策略"><a href="#创建默认路由策略" class="header-anchor">#</a> 创建默认路由策略</h4> <p>默认情况下，Kubernetes 会在<code>httpbin</code>服务的两个版本之间进行负载平衡。在此步骤中，您将更改该行为，以便所有流量都转到<code>v1</code>.</p> <ol><li>创建默认路由规则以将所有流量路由到<code>v1</code>服务，现在所有流量都流向<code>httpbin:v1</code>服务。：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
EOF
</code></pre></div><ol start="2"><li>向服务发送一些流量：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SLEEP_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SLEEP_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sS</span> http://httpbin:8000/headers
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Content-Length&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.35.0&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;3289ae7257c3f159&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;b56eebd279a76f0b57784f8bff90ae0b&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=20afebed6da091c850264cc751b8c9306abac02993f80bdb76282237422bd098;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>检查pod<code>v1</code>的日志<code>v2</code>。<code>httpbin</code>您应该看到以下的访问日志条目，<code>v1</code>并且没有<code>v2</code>：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V1_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v1 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V1_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">V2_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>httpbin,version<span class="token operator">=</span>v2 <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
$ kubectl logs <span class="token string">&quot;<span class="token variable">$V2_POD</span>&quot;</span> <span class="token parameter variable">-c</span> httpbin
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
</code></pre></div><h4 id="将流量镜像到v2"><a href="#将流量镜像到v2" class="header-anchor">#</a> 将流量镜像到v2</h4> <p><strong>更改路由规则以将流量镜像到 v2：</strong></p> <p>此路由规则将 100% 的流量发送到<code>v1</code>. 最后一节指定您希望将 100% 的相同流量镜像（即，也发送）到 <code>httpbin:v2</code>服务。</p> <p>当流量被镜像时，请求被发送到镜像服务，其 Host/Authority 标头附加<code>-shadow</code>. 例如，<code>cluster-1</code>变成<code>cluster-1-shadow</code>。</p> <p>此外，重要的是要注意这些请求被镜像为“即发即弃”，这意味着响应被丢弃。您可以使用该<code>value</code>字段下的<code>mirrorPercentage</code>字段来镜像一部分流量，而不是镜像所有请求。如果没有这个字段，所有的流量都会被镜像。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">mirrorPercentage</span><span class="token punctuation">:</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100.0</span>
EOF
</code></pre></div><h4 id="发送流量"><a href="#发送流量" class="header-anchor">#</a> 发送流量</h4> <p>通过发送流量再次进行测试，情况如下：</p> <ul><li><code>v1</code>现在，您应该会看到和的访问记录</li> <li><code>v2</code>中创建的访问日志<code>v2</code>是实际将要访问的镜像请求<code>v1</code>。</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl exec &quot;${SLEEP_POD}&quot; -c sleep -- curl -sS http://httpbin:8000/headers</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;headers&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;Accept&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;*/*&quot;</span>,
    <span class="token string">&quot;Host&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;httpbin:8000&quot;</span>,
    <span class="token string">&quot;User-Agent&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>,
    <span class="token string">&quot;X-B3-Parentspanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;a422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-B3-Sampled&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-B3-Spanid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;acd7163f70c9aa89&quot;</span>,
    <span class="token string">&quot;X-B3-Traceid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;f7ca9fb1e0581d6ba422ba4aefe02440&quot;</span>,
    <span class="token string">&quot;X-Envoy-Attempt-Count&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;1&quot;</span>,
    <span class="token string">&quot;X-Forwarded-Client-Cert&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;By=spiffe://cluster.local/ns/default/sa/default;Hash=ab53dec650eb79f2aa9dc051ed27a2b4b698ee40ffd557cd885495105916a139;Subject=<span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span>;URI=spiffe://cluster.local/ns/default/sa/default&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V1_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:47 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">9</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:30:43 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">529</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>


<span class="token punctuation">[</span>root@k8s-master-node1 istio-work<span class="token punctuation">]</span><span class="token comment"># kubectl logs &quot;$V2_POD&quot; -c httpbin</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Starting gunicorn <span class="token number">19.9</span>.0
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Listening at: http://0.0.0.0:80 <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Using worker: <span class="token function">sync</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-18 <span class="token number">16</span>:20:53 +0000<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Booting worker with pid: <span class="token number">10</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:03 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:48 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:33:52 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
<span class="token number">127.0</span>.0.6 - - <span class="token punctuation">[</span><span class="token number">18</span>/Mar/2022:16:34:05 +0000<span class="token punctuation">]</span> <span class="token string">&quot;GET /headers HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">569</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span>
</code></pre></div><h4 id="清理-7"><a href="#清理-7" class="header-anchor">#</a> 清理</h4> <p>删除规则：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete virtualservice httpbin
$ kubectl delete destinationrule httpbin
</code></pre></div><p>关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务和客户端：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete deploy httpbin-v1 httpbin-v2 <span class="token function">sleep</span>
$ kubectl delete svc httpbin
</code></pre></div><h2 id="入口网关"><a href="#入口网关" class="header-anchor">#</a> 入口网关</h2> <h4 id="入口网关简要"><a href="#入口网关简要" class="header-anchor">#</a> 入口网关简要</h4> <p>除了支持 Kubernetes <a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/kubernetes-ingress/" target="_blank" rel="noopener noreferrer">Ingress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，Istio 还提供了另一种配置模型，<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">即 Istio Gateway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。A<code>Gateway</code>提供了比 更广泛的自定义和灵活性<code>Ingress</code>，并允许将监控和路由规则等 Istio 功能应用于进入集群的流量。</p> <p>此任务描述了如何配置 Istio 以使用 Istio 在服务网格之外公开服务<code>Gateway</code>。</p> <h4 id="环境准备-6"><a href="#环境准备-6" class="header-anchor">#</a> 环境准备</h4> <ul><li>确保您的当前目录是该<code>istio</code>目录。</li> <li>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例。</li></ul> <p>​		如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请部署该<code>httpbin</code>服务：</p> <p>​		否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre></div><h4 id="确定入口ip和端口"><a href="#确定入口ip和端口" class="header-anchor">#</a> 确定入口IP和端口</h4> <p>执行以下命令来确定您的 Kubernetes 集群是否在支持外部负载均衡器的环境中运行（<code>这里没有负载均衡器改为NodePort模式</code>）：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n istio-system istio-ingressgateway</span>
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                    AGE
istio-ingressgateway   NodePort   <span class="token number">10.96</span>.88.217   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15021</span>:28214/TCP,80:27007/TCP,443:9673/TCP,31400:3938/TCP,15443:41053/TCP   4d2h
</code></pre></div><p>如果<code>EXTERNAL-IP</code>设置了该值，则您的环境具有可用于入口网关的外部负载均衡器。如果<code>EXTERNAL-IP</code>值为<code>&lt;none&gt;</code>或永久<code>&lt;pending&gt;</code>，则您的环境不为入口网关提供外部负载均衡器。<a href="https://kubernetes.io/docs/concepts/services-networking/service/#nodeport" target="_blank" rel="noopener noreferrer">在这种情况下，您可以使用服务的节点端口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>访问网关。</p> <h4 id="添加环境说明"><a href="#添加环境说明" class="header-anchor">#</a> 添加环境说明</h4> <p>如果您确定您的环境没有外部负载均衡器，请按照这些说明进行操作，因此您需要改用节点端口。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SECURE_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}'</span><span class="token variable">)</span></span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">TCP_INGRESS_PORT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl <span class="token parameter variable">-n</span> istio-system get <span class="token function">service</span> istio-ingressgateway <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.spec.ports[?(@.name==&quot;tcp&quot;)].nodePort}'</span><span class="token variable">)</span></span>
</code></pre></div><p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062328622.png" alt="image-20220318172145022"></p> <h4 id="使用istio网关配置入口"><a href="#使用istio网关配置入口" class="header-anchor">#</a> 使用Istio网关配置入口</h4> <p>入口<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">网关<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>描述了在网格边缘运行的负载均衡器，用于接收传入的 HTTP/TCP 连接。它配置暴露的端口、协议等，但与<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/" target="_blank" rel="noopener noreferrer">Kubernetes Ingress Resources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>不同，它不包括任何流量路由配置。入口流量的流量路由是使用 Istio 路由规则配置的，与内部服务请求的方式完全相同。</p> <p>让我们看看如何<code>Gateway</code>为 HTTP 流量配置端口 80。</p> <ol><li>创建一个 Istio <code>Gateway</code>：
<ul><li><code>使用默认的ingressgateway网关</code></li> <li><code>创建一个服务器规范列表，分别是主机和端口</code></li> <li><code>配置http服务的80端口以及主机httpbin.example.com</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
EOF
</code></pre></div><ol start="2"><li>为通过以下方式进入的流量配置路由<code>Gateway</code>：
<ul><li><code>配置虚拟服务允许主机httpbin.example.com</code></li> <li><code>配追http的规则为两个uri的两个允许路径、分别是status和delay</code></li> <li><code>配置目的地规则为主机是httpbin端口为8080的</code></li> <li><code>网关列表指定只允许通过您的请求httpbin-gateway。所有其他外部请求都将被 404 响应拒绝。</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre></div><blockquote><p>注意：</p> <p>网格中其他服务的内部请求不受这些规则的约束，而是默认使用循环路由。要将这些规则也应用于内部调用，您可以将特殊值添加<code>mesh</code>到<code>gateways</code>. 由于服务的内部主机名可能与外部主机名不同（例如，<code>httpbin.default.svc.cluster.local</code>），因此您还需要将其添加到<code>hosts</code>列表中。</p></blockquote> <ol start="3"><li><em>使用curl</em>访问<em>httpbin</em>服务：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/status/200&quot;</span>
HTTP/1.1 <span class="token number">200</span> OK
server: istio-envoy
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:05:09 GMT
content-type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
access-control-allow-origin: *
access-control-allow-credentials: <span class="token boolean">true</span>
content-length: <span class="token number">0</span>
x-envoy-upstream-service-time: <span class="token number">24</span>
</code></pre></div><p>请注意，您使用该<code>-H</code>标志将<em>Host</em> HTTP 标头设置为“httpbin.example.com”。这是必需的，因为您的入口<code>Gateway</code>配置为处理“httpbin.example.com”，但在您的测试环境中，您没有该主机的 DNS 绑定，只是将您的请求发送到入口 IP。</p> <ol start="4"><li>访问尚未明确公开的任何其他 URL。您应该会看到 HTTP 404 错误：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># curl -s -I -HHost:httpbin.example.com &quot;http://$INGRESS_HOST:$INGRESS_PORT/headers&quot;</span>
HTTP/1.1 <span class="token number">404</span> Not Found
date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">14</span>:29:26 GMT
server: istio-envoy
transfer-encoding: chunked
</code></pre></div><h4 id="使用浏览器访问入口服务"><a href="#使用浏览器访问入口服务" class="header-anchor">#</a> 使用浏览器访问入口服务</h4> <p>在浏览器中输入<code>httpbin</code>服务 URL 将不起作用，因为您无法将<em>Host</em>标头传递给浏览器，就像使用<code>curl</code>. 在现实世界的情况下，这不是问题，因为您正确配置了请求的主机并且 DNS 可解析。因此，您在 URL 中使用主机的域名，例如<code>https://httpbin.example.com/status/200</code>.</p> <p>要为简单的测试和演示解决此问题，请在 和配置<code>*</code>中为主机使用通配符值。例如，如果您将入口配置更改为以下内容：<code>Gateway VirtualService</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use Istio default gateway implementation</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> httpbin<span class="token punctuation">-</span>gateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /headers
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre></div><p>在本机的hosts<code>配置192.168.1.6:44526/headers httpbin.example.com</code>映射，然后通过浏览器访问。</p> <p><img src="https://raw.githubusercontent.com/cn-zhangyh/image/main/img/202205062328976.png" alt="image-20220320230630481"></p> <h4 id="清理-8"><a href="#清理-8" class="header-anchor">#</a> 清理</h4> <p>删除<code>Gateway</code>and<code>VirtualService</code>配置，关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete gateway httpbin-gateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
</code></pre></div><h2 id="安全网关"><a href="#安全网关" class="header-anchor">#</a> 安全网关</h2> <h4 id="安全网关的作用"><a href="#安全网关的作用" class="header-anchor">#</a> 安全网关的作用</h4> <p>控制入口<a href="https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control" target="_blank" rel="noopener noreferrer">流量任务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 描述了如何配置入口网关以将 HTTP 服务公开给外部流量。此任务显示如何使用简单或双向 TLS 公开安全的 HTTPS 服务。</p> <h4 id="环境准备-7"><a href="#环境准备-7" class="header-anchor">#</a> 环境准备</h4> <ul><li>确保您的当前目录是该<code>istio</code>目录。</li> <li>启动<a href="https://github.com/istio/istio/tree/release-1.13/samples/httpbin" target="_blank" rel="noopener noreferrer">httpbin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例。</li></ul> <p>​		如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请部署该<code>httpbin</code>服务：</p> <p>​		否则，您必须在部署应用程序之前手动注入 sidecar <code>httpbin</code>：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/httpbin/httpbin.yaml<span class="token punctuation">)</span>
</code></pre></div><h4 id="生成证书和密钥"><a href="#生成证书和密钥" class="header-anchor">#</a> 生成证书和密钥</h4> <p>对于此任务，您可以使用您喜欢的工具来生成证书和密钥。下面的命令使用 <a href="https://man.openbsd.org/openssl.1" target="_blank" rel="noopener noreferrer">openssl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li>创建根证书和私钥来为您的服务签署证书：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">'/O=example Inc./CN=example.com'</span> <span class="token parameter variable">-keyout</span> example.com.key <span class="token parameter variable">-out</span> example.com.crt
</code></pre></div><ol start="2"><li>创建证书和私钥<code>httpbin.example.com</code>：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ openssl req <span class="token parameter variable">-out</span> httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> httpbin.example.com.csr <span class="token parameter variable">-out</span> httpbin.example.com.crt
</code></pre></div><h4 id="为单个主机配置tls入口网关"><a href="#为单个主机配置tls入口网关" class="header-anchor">#</a> 为单个主机配置TLS入口网关</h4> <ol><li>为入口网关创建一个密钥：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre></div><ol start="2"><li>使用端口 443的部分定义网关<code>servers:</code>，并指定 <code>credentialName</code>to be的值<code>httpbin-credential</code>。这些值与密钥的名称相同。TLS 模式的值应为<code>SIMPLE</code>.</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential <span class="token comment"># must be the same as secret</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
EOF
</code></pre></div><ol start="3"><li>配置网关的入口流量路由。定义相应的虚拟服务。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> httpbin
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;httpbin.example.com&quot;</span>
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /status
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /delay
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> httpbin
EOF
</code></pre></div><ol start="4"><li>发送 HTTPS 请求以<code>httpbin</code>通过 HTTPS 访问服务，该<code>httpbin</code>服务将返回 <a href="https://tools.ietf.org/html/rfc7168#section-2.3.3" target="_blank" rel="noopener noreferrer">418 I'm a Teapot<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>代码。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Sun, <span class="token number">20</span> Mar <span class="token number">2022</span> <span class="token number">15</span>:41:25 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">23</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .'  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre></div><ol start="5"><li>删除网关的密码并创建一个新密码以更改入口网关的凭据。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ <span class="token function">mkdir</span> new_certificates
$ openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-subj</span> <span class="token string">'/O=example Inc./CN=example.com'</span> <span class="token parameter variable">-keyout</span> new_certificates/example.com.key <span class="token parameter variable">-out</span> new_certificates/example.com.crt
$ openssl req <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> new_certificates/httpbin.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=httpbin.example.com/O=httpbin organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> new_certificates/example.com.crt <span class="token parameter variable">-CAkey</span> new_certificates/example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">0</span> <span class="token parameter variable">-in</span> new_certificates/httpbin.example.com.csr <span class="token parameter variable">-out</span> new_certificates/httpbin.example.com.crt
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>new_certificates/httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>new_certificates/httpbin.example.com.crt
</code></pre></div><ol start="6"><li>使用新的证书链访问<code>httpbin</code>服务：<code>curl</code></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> new_certificates/example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">418</span>
<span class="token punctuation">..</span>.
    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .'  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
        
</code></pre></div><ol start="7"><li>如果您尝试使用<code>httpbin</code>以前的证书链进行访问，则现在尝试失败。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
<span class="token punctuation">..</span>.
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS handshake, Client hello <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>IN<span class="token punctuation">)</span>, TLS handshake, Certificate <span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>:
* TLSv1.2 <span class="token punctuation">(</span>OUT<span class="token punctuation">)</span>, TLS alert, Server hello <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>:
* curl: <span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> error:04FFF06A:rsa routines:CRYPTO_internal:block <span class="token builtin class-name">type</span> is not 01
</code></pre></div><h4 id="为多个主机配置tls入口网关"><a href="#为多个主机配置tls入口网关" class="header-anchor">#</a> 为多个主机配置TLS入口网关</h4> <p>您可以为多个主机配置一个入口网关 <code>httpbin.example.com</code>，<code>helloworld-v1.example.com</code>例如。入口网关检索与特定<code>credentialName</code>.</p> <ol><li>要恢复 的凭据<code>httpbin</code>，请删除其密钥并重新创建。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token parameter variable">-n</span> istio-system delete secret httpbin-credential
$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls httpbin-credential <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span><span class="token operator">=</span>httpbin.example.com.key <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span><span class="token operator">=</span>httpbin.example.com.crt
</code></pre></div><ol start="2"><li>启动<code>helloworld-v1</code>示例</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld
        <span class="token key atrule">image</span><span class="token punctuation">:</span> istio/examples<span class="token punctuation">-</span>helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;100m&quot;</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#Always</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre></div><ol start="3"><li>生成证书和私钥<code>helloworld-v1.example.com</code>：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ openssl req <span class="token parameter variable">-out</span> helloworld-v1.example.com.csr <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-keyout</span> helloworld-v1.example.com.key <span class="token parameter variable">-subj</span> <span class="token string">&quot;/CN=helloworld-v1.example.com/O=helloworld organization&quot;</span>
$ openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-CA</span> example.com.crt <span class="token parameter variable">-CAkey</span> example.com.key <span class="token parameter variable">-set_serial</span> <span class="token number">1</span> <span class="token parameter variable">-in</span> helloworld-v1.example.com.csr <span class="token parameter variable">-out</span> helloworld-v1.example.com.crt
</code></pre></div><ol start="4"><li>创建<code>helloworld-credential</code>密钥：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl create <span class="token parameter variable">-n</span> istio-system secret tls helloworld-credential <span class="token parameter variable">--key</span><span class="token operator">=</span>helloworld-v1.example.com.key <span class="token parameter variable">--cert</span><span class="token operator">=</span>helloworld-v1.example.com.crt
</code></pre></div><ol start="5"><li>为端口 443 定义一个具有两个服务器部分的网关。将 <code>credentialName</code>每个端口上的值分别设置为<code>httpbin-credential</code>和<code>helloworld-credential</code> 。
<ul><li>将 TLS 模式设置为<code>SIMPLE</code>是单向TLS入口网关.</li> <li>将 TLS 模式设置为<code>MUTUAL</code>是双向TLS入口网关</li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mygateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment"># use istio default ingress gateway</span>
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>httpbin
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> httpbin<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> httpbin.example.com
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>helloworld
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE
      <span class="token key atrule">credentialName</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>credential
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
EOF
</code></pre></div><ol start="6"><li>配置网关的流量路由。定义相应的虚拟服务。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> helloworld<span class="token punctuation">-</span>v1.example.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mygateway
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /hello
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> helloworld<span class="token punctuation">-</span>v1
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">5000</span>
EOF
</code></pre></div><ol start="7"><li>发送 HTTPS 请求到<code>helloworld-v1.example.com</code>：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 00:58:24 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">2</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .'  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre></div><ol start="8"><li>发送一个 HTTPS 请求<code>httpbin.example.com</code>并仍然得到一个茶壶作为回报：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-HHost:httpbin.example.com</span> <span class="token parameter variable">--resolve</span> <span class="token string">&quot;httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>:<span class="token variable">$INGRESS_HOST</span>&quot;</span> <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> <span class="token parameter variable">--cacert</span> example.com.crt <span class="token string">&quot;https://httpbin.example.com:<span class="token variable">$SECURE_INGRESS_PORT</span>/status/418&quot;</span>
* Added httpbin.example.com:7339:192.168.1.6 to DNS cache
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to httpbin.example.com port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying <span class="token number">192.168</span>.1.6<span class="token punctuation">..</span>.
* Connected to httpbin.example.com <span class="token punctuation">(</span><span class="token number">192.168</span>.1.6<span class="token punctuation">)</span> port <span class="token number">7339</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Initializing NSS with certpath: sql:/etc/pki/nssdb
*   CAfile: example.com.crt
  CApath: none
* SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
* Server certificate:
*       subject: <span class="token assign-left variable">O</span><span class="token operator">=</span>httpbin organization,CN<span class="token operator">=</span>httpbin.example.com
*       start date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2022</span> GMT
*       expire date: Mar <span class="token number">20</span> <span class="token number">15</span>:18:42 <span class="token number">2023</span> GMT
*       common name: httpbin.example.com
*       issuer: <span class="token assign-left variable">CN</span><span class="token operator">=</span>example.com,O<span class="token operator">=</span>example Inc.
<span class="token operator">&gt;</span> GET /status/418 HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> Host:httpbin.example.com
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">418</span> Unknown
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> date: Mon, <span class="token number">21</span> Mar <span class="token number">2022</span> 01:13:48 GMT
<span class="token operator">&lt;</span> x-more-info: http://tools.ietf.org/html/rfc2324
<span class="token operator">&lt;</span> access-control-allow-origin: *
<span class="token operator">&lt;</span> access-control-allow-credentials: <span class="token boolean">true</span>
<span class="token operator">&lt;</span> content-length: <span class="token number">135</span>
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">3</span>
<span class="token operator">&lt;</span>

    -<span class="token operator">=</span><span class="token punctuation">[</span> teapot <span class="token punctuation">]</span><span class="token operator">=</span>-

       _<span class="token punctuation">..</span><span class="token punctuation">..</span>_
     .'  _ _ <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>
    <span class="token operator">|</span> .&quot;<span class="token variable">`</span></span> ^ <span class="token variable"><span class="token variable">`</span>&quot;. _,
    <span class="token punctuation">\</span>_<span class="token punctuation">;</span><span class="token variable">`</span></span><span class="token string">&quot;---&quot;</span><span class="token variable"><span class="token variable">`</span><span class="token operator">|</span>//
      <span class="token operator">|</span>       <span class="token punctuation">;</span>/
      <span class="token punctuation">\</span>_     _/
        <span class="token variable">`</span></span><span class="token string">&quot;&quot;</span>&quot;`
* Connection <span class="token comment">#0 to host httpbin.example.com left intact</span>
</code></pre></div><h4 id="密钥格式"><a href="#密钥格式" class="header-anchor">#</a> 密钥格式</h4> <p>Istio 支持读取几种不同的 Secret 格式，以支持与各种工具的集成，例如<a href="https://istio.io/latest/docs/ops/integrations/certmanager/" target="_blank" rel="noopener noreferrer">cert-manager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <ul><li>一个 TLS 密钥，带有<code>tls.key</code>和<code>tls.crt</code>，如上所述。对于双向 TLS，<code>ca.crt</code>可以使用密钥。</li> <li>带有键的通用 Secret<code>key</code>和<code>cert</code>. 对于双向 TLS，<code>cacert</code>可以使用密钥。</li> <li>带有键的通用 Secret<code>key</code>和<code>cert</code>. 对于双向 TLS，一个名为 的单独通用 Secret<code>&lt;secret&gt;-cacert</code>带有一个<code>cacert</code>密钥。例如，<code>httpbin-credential</code>有<code>key</code>和<code>cert</code>，并且<code>httpbin-credential-cacert</code>有<code>cacert</code>。</li> <li><code>cacert</code>键值可以是一个 CA 捆绑包，由串联的各个 CA 证书组成。</li></ul> <h4 id="清理-9"><a href="#清理-9" class="header-anchor">#</a> 清理</h4> <p>删除网关配置、虚拟服务定义和机密：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete gateway mygateway
$ kubectl delete virtualservice httpbin
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true <span class="token parameter variable">-n</span> istio-system secret httpbin-credential <span class="token punctuation">\</span>
helloworld-credential
$ kubectl delete --ignore-not-found<span class="token operator">=</span>true virtualservice helloworld-v1
</code></pre></div><p>删除证书和密钥：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> example.com.crt example.com.key httpbin.example.com.crt httpbin.example.com.key httpbin.example.com.csr helloworld-v1.example.com.crt helloworld-v1.example.com.key helloworld-v1.example.com.csr client.example.com.crt client.example.com.csr client.example.com.key ./new_certificates
</code></pre></div><p>关闭<code>httpbin</code>和<code>helloworld-v1</code>服务：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete deployment --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
$ kubectl delete <span class="token function">service</span> --ignore-not-found<span class="token operator">=</span>true httpbin helloworld-v1
</code></pre></div><h2 id="出口tls发起"><a href="#出口tls发起" class="header-anchor">#</a> 出口TLS发起</h2> <h4 id="什么是tls发起"><a href="#什么是tls发起" class="header-anchor">#</a> 什么是TLS发起</h4> <p>用于配置 Istio 以受控方式访问外部服务。这个例子展示了如何配置 Istio 来执行<a href="https://istio.io/latest/docs/reference/config/networking/service-entry/" target="_blank" rel="noopener noreferrer"><code>ServiceEntry</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>TLS 发起 用于到外部服务的流量。当原始流量为 HTTP 时，Istio 将打开与外部服务的 HTTPS 连接。</p> <p>考虑一个对外部站点执行 HTTP 调用的遗留应用程序。假设运行应用程序的组织收到一个新要求，要求所有外部流量都必须加密。使用 Istio，只需配置即可实现此要求，无需更改应用程序中的任何代码。应用程序可以发送未加密的 HTTP 请求，然后 Istio 将为应用程序加密它们。</p> <p>从源发送未加密的 HTTP 请求并让 Istio 执行 TLS 升级的另一个好处是 Istio 可以生成更好的遥测数据并为未加密的请求提供更多的路由控制。</p> <h4 id="环境准备-8"><a href="#环境准备-8" class="header-anchor">#</a> 环境准备</h4> <p>启动将用作外部调用测试源的<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">睡眠样本。<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果您启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动边车注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，请部署<code>sleep</code>应用程序：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre></div><p>请注意，您可以<code>exec</code>和<code>curl</code>来自的任何 pod 都将执行以下过程。</p> <p>创建一个 shell 变量来保存用于向外部服务发送请求的源 pod 的名称。如果您使用了<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例，请运行：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre></div><h4 id="配置对外部服务的访问"><a href="#配置对外部服务的访问" class="header-anchor">#</a> 配置对外部服务的访问</h4> <p>首先使用<a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control" target="_blank" rel="noopener noreferrer">访问外部服务<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>任务<code>edition.cnn.com</code>中显示的相同技术配置对外部服务的访问。但是，这一次使用单个来启用对服务的 HTTP 和 HTTPS 访问。<code>ServiceEntry</code></p> <ol><li>创建一个<code>ServiceEntry</code>以启用对<code>edition.cnn.com</code>：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre></div><ol start="2"><li>向外部 HTTP 服务发出请求：</li></ol> <blockquote><p>注意 curl 的<em>标志</em><code>-L</code>，它指示<em>curl</em>遵循重定向。在这种情况下，服务器为 HTTP 请求返回了重定向响应（<a href="https://tools.ietf.org/html/rfc2616#section-10.3.2" target="_blank" rel="noopener noreferrer">301 Moved Permanently<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ） 。重定向响应指示客户端发送一个额外的请求，这次使用 HTTPS，到. 对于第二个请求，服务器返回请求的内容和<em>200 OK</em>状态码。<code>http://edition.cnn.com/politics``https://edition.cnn.com/politics</code></p> <p>尽管<em>curl</em>命令透明地处理了重定向，但这里有两个问题。第一个问题是冗余请求，它使获取<code>http://edition.cnn.com/politics</code>. 第二个问题是 URL 的路径，在这种情况下是<em>政治</em>，是以明文形式发送的。如果有攻击者嗅探你的应用程序和 之间的通信<code>edition.cnn.com</code>，攻击者就会知道<code>edition.cnn.com</code>应用程序获取了哪些特定主题。出于隐私原因，您可能希望阻止此类披露。</p> <p><strong>这两个问题都可以通过配置 Istio 来执行 TLS 发起来解决。</strong></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre></div><h4 id="出口流量的tls发起"><a href="#出口流量的tls发起" class="header-anchor">#</a> 出口流量的TLS发起</h4> <ol><li>重新定义<code>ServiceEntry</code>上一节中的将 HTTP 请求重定向到端口 443 并添加一个<code>DestinationRule</code>以执行 TLS 发起：
<ul><li><code>配置服务入口的http重定向到443端口</code></li> <li><code>配置交通策略针对80端口使用模式为SIMPLE的tls</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> edition<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>com
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">tls</span><span class="token punctuation">:</span>
        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE <span class="token comment"># initiates HTTPS when accessing edition.cnn.com</span>
EOF
</code></pre></div><p>以上<code>DestinationRule</code>将为端口 80 上的 HTTP 请求执行 TLS 发起，<code>ServiceEntry</code> 然后将端口 80 上的请求重定向到目标端口 443。</p> <ol start="2"><li>向 发送 HTTP 请求<code>http://edition.cnn.com/politics</code>，如上一节所述：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
HTTP/1.1 <span class="token number">200</span> OK
<span class="token punctuation">..</span>.
</code></pre></div><p>这次您收到<em>200 OK</em>作为第一个也是唯一的响应。Istio 为<em>curl</em>执行 TLS 发起，因此原始 HTTP 请求被转发<code>edition.cnn.com</code>为 HTTPS。服务器直接返回内容，无需重定向。您消除了客户端和服务器之间的双重往返，并且请求使网格加密，而没有披露您的应用程序<em>获取</em>.<code>edition.cnn.com</code></p> <p>请注意，您使用了与上一节中相同的命令。对于以编程方式访问外部服务的应用程序，无需更改代码。您可以通过配置 Istio 获得 TLS 发起的好处，而无需更改一行代码。</p> <ol start="3"><li>请注意，使用 HTTPS 访问外部服务的应用程序继续像以前一样工作：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">${SOURCE_POD}</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
HTTP/2 <span class="token number">200</span>
<span class="token punctuation">..</span>.
</code></pre></div><h4 id="清理-10"><a href="#清理-10" class="header-anchor">#</a> 清理</h4> <p>删除您创建的 Istio 配置项、关闭<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">睡眠<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete serviceentry edition-cnn-com
$ kubectl delete destinationrule edition-cnn-com
$ kubectl delete <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
</code></pre></div><h2 id="出口网关"><a href="#出口网关" class="header-anchor">#</a> 出口网关</h2> <h4 id="什么是出口网关"><a href="#什么是出口网关" class="header-anchor">#</a> 什么是出口网关</h4> <p>Istio 使用<a href="https://istio.io/latest/docs/reference/config/networking/gateway/" target="_blank" rel="noopener noreferrer">入口和出口网关<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来配置在服务网格边缘执行的负载均衡器。入口网关允许您定义所有传入流量流过的网格的入口点。出口网关是一个对称的概念；它定义了网格的出口点。出口网关允许您将 Istio 功能（例如监控和路由规则）应用于退出网格的流量。</p> <p>考虑一个具有严格安全要求的组织，即所有离开服务网格的流量都必须流经一组专用节点。这些节点将在专用机器上运行，与集群中运行应用程序的其余节点分开。这些特殊节点将用于对出口流量执行策略，并且将比其他节点更彻底地监控。</p> <p>另一个用例是应用程序节点没有公共 IP 的集群，因此在它们上运行的网内服务无法访问 Internet。定义一个出口网关，引导所有出口流量通过它，并将公共 IP 分配给出口网关节点，允许应用程序节点以受控方式访问外部服务。</p> <h4 id="基础环境-3"><a href="#基础环境-3" class="header-anchor">#</a> 基础环境</h4> <p>部署<a href="https://github.com/istio/istio/tree/release-1.13/samples/sleep" target="_blank" rel="noopener noreferrer">sleep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例应用程序以用作发送请求的测试源。如果您 启用了<a href="https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection" target="_blank" rel="noopener noreferrer">自动 Sidecar 注入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，请运行以下命令来部署示例应用程序：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml
$ kubectl apply <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject <span class="token parameter variable">-f</span> samples/sleep/sleep.yaml<span class="token punctuation">)</span>
</code></pre></div><p>将<code>SOURCE_POD</code>环境变量设置为源 pod 的名称：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">SOURCE_POD</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>sleep <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token punctuation">{</span>.items<span class="token punctuation">..</span>metadata.name<span class="token punctuation">}</span><span class="token variable">)</span></span>
</code></pre></div><h4 id="部署istio出口网关"><a href="#部署istio出口网关" class="header-anchor">#</a> 部署Istio出口网关</h4> <ol><li>检查是否部署了 Istio 出口网关：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">istio</span><span class="token operator">=</span>egressgateway <span class="token parameter variable">-n</span> istio-system
</code></pre></div><p>如果没有返回 pod，请执行以下步骤部署 Istio 出口网关。</p> <ol start="2"><li>如果您使用<code>IstioOperator</code>CR 安装 Istio，请将以下字段添加到您的配置中：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">components</span><span class="token punctuation">:</span>
    <span class="token key atrule">egressGateways</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>否则，将等效设置添加到您的原始<code>istioctl install</code>命令，例如：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ istioctl <span class="token function">install</span> <span class="token operator">&lt;</span>flags-you-used-to-install-Istio<span class="token operator">&gt;</span> <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.name<span class="token operator">=</span>istio-egressgateway <span class="token punctuation">\</span>
                   <span class="token parameter variable">--set</span> components.egressGateways<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.enabled<span class="token operator">=</span>true
</code></pre></div><h4 id="http流量的出口网关"><a href="#http流量的出口网关" class="header-anchor">#</a> HTTP流量的出口网关</h4> <p>首先创建一个<code>ServiceEntry</code>允许直接流量到外部服务。</p> <ol><li><code>ServiceEntry</code>为定义一个<code>edition.cnn.com</code>。
<ul><li><code>配置主机为edition.cnn.com</code></li> <li><code>配置主机发现模式为DNS</code></li> <li><code>配置HTTP和HTTPS两个协议</code></li></ul></li></ol> <blockquote><p><code>DNS</code>必须在下面的服务条目中使用分辨率。如果分辨率为<code>NONE</code>，网关将在无限循环中将流量定向到自身。这是因为网关接收到一个请求，其原始目标 IP 地址等于网关的服务 IP（因为请求是由 Sidecar 代理定向到网关的）。通过<code>DNS</code>解析，网关执行 DNS 查询以获取外部服务的 IP 地址并将流量定向到该 IP 地址。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre></div><ol start="2"><li><p><a href="http://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">通过向http://edition.cnn.com/politics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>ServiceEntry</code>发送 HTTP 请求来验证您的应用是否正确。</p> <p>输出应与 <a href="https://istio.io/latest/docs/tasks/traffic-management/egress/egress-tls-origination/" target="_blank" rel="noopener noreferrer">TLS Origination for Egress Traffic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例中的相同，但没有 TLS 发起。</p></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre></div><ol start="3"><li><code>Gateway</code>为<em>edition.cnn.com</em>创建一个出口，端口 80，并为定向到出口网关的流量创建一个目标规则。
<ul><li><code>配置出口网关为egressgateway</code></li> <li><code>配置主机edition.cnn.com规范为允许80端口</code></li> <li><code>创建路由规则主机使用 istio-egressgateway.istio-system.svc.cluster.local</code></li> <li><code>路由规则下的子集使用cnn</code></li></ul></li></ol> <blockquote><p>要通过出口网关引导多个主机，您可以<code>*</code>在<code>Gateway</code>. 应将 中的<code>subset</code>字段重新用于其他主机。<code>DestinationRule</code></p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
EOF
</code></pre></div><ol start="4"><li>定义 <code>VirtualService</code>以将流量从 sidecar 引导到 egress 网关，并从 egress 网关引导到外部服务：
<ul><li><code>定义主机地址为edition.cnn.com</code></li> <li><code>配置虚拟服务使用两个网关 istio-egressgateway和mesh</code></li> <li><code>配置http规则分别使用两个网关都是允许80端口</code></li> <li><code>配置mesh的路由规则允许主机 istio-egressgateway.istio-system.svc.cluster.local 、子集为cnn、端口是80 、权重分配为100</code></li> <li><code>配置istio-egressgateway的路由规则允许主机为edition.cnn.com、端口是80、权重分配也是100</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token punctuation">-</span> mesh
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre></div><ol start="5"><li>将 HTTP 请求重新发送到<a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">http://edition.cnn.com/politics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - http://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/1.1 <span class="token number">301</span> Moved Permanently
<span class="token punctuation">..</span>.
location: https://edition.cnn.com/politics
<span class="token punctuation">..</span>.

HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre></div><ol start="6"><li><p>检查<code>istio-egressgateway</code>pod 的日志中是否有与我们的请求相对应的行。如果 Istio 部署在<code>istio-system</code>命名空间中，打印日志的命令是：</p> <p>请注意，您仅将流量从端口 80 重定向到出口网关。到端口 443 的 HTTPS 流量直接转到<em>edition.cnn.com</em>。</p></li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -c istio-proxy -n istio-system | tail</span>
<span class="token number">2022</span>-03-21T09:42:18.336211Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:14:36.196020Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T10:47:07.424114Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:15:16.460832Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T11:42:49.235363Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:20.947Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> UF,URX - - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">15</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.65.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com - <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33384 edition.cnn.com -
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
</code></pre></div><h4 id="清理http网关"><a href="#清理http网关" class="header-anchor">#</a> 清理HTTP网关</h4> <p>在继续下一步之前删除以前的定义：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete gateway istio-egressgateway
$ kubectl delete serviceentry cnn
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre></div><h4 id="https流量的出口网关"><a href="#https流量的出口网关" class="header-anchor">#</a> HTTPS流量的出口网关</h4> <p>在本节中，您将通过出口网关引导 HTTPS 流量（由应用程序发起的 TLS）。您需要<code>TLS</code>在一个对应<code>ServiceEntry</code>的、一个出口<code>Gateway</code>和一个<code>VirtualService</code>.</p> <ol><li><code>ServiceEntry</code>为定义一个<code>edition.cnn.com</code>：
<ul><li><code>配置服务入口的主机列表为 edition.cnn.com</code></li> <li><code>配置ports规则为TLS模式以及443端口</code></li> <li><code>配置主机发现模式为DNS</code></li></ul></li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS
EOF
</code></pre></div><ol start="2"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">通过向https://edition.cnn.com/politics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><code>ServiceEntry</code>发送 HTTPS 请求来验证您的应用是否正确。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre></div><ol start="3"><li><code>Gateway</code>为<em>edition.cnn.com</em>创建一个出口、一个目标规则和一个虚拟服务，以引导流量通过出口网关并从出口网关到外部服务。
<ul><li><code>创建服务网关和目标规则以及虚拟服务</code></li> <li><code>配置Gateway使用egressgateway的出口网关,服务规则为允许443端口使用TLS</code></li> <li><code>Gateway允许的主机为 edition.cnn.com tls的模式使用PASSTHROUGH</code></li> <li><code>配置目标规则允许的主机列表istio-egressgateway.istio-system.svc.cluster.local 子集为cnn</code></li> <li><code>配置虚拟服务允许主机列表为edition.cnn.com</code></li> <li><code>配置虚拟服务使用出口网关istio-egressgateway和mesh</code></li> <li><code>配置虚拟服务的mesh网关要匹配的SNI（服务器名称指示器）edition.cnn.com 允许443端口</code></li> <li><code>配置虚拟服务的mesh网关目标规则允许主机列表istio-egressgateway.istio-system.svc.cluster.local并且允许443端口</code></li> <li><code>配置虚拟服务的istio-egressgateway网关要匹配的SNI（服务器名称指示器）edition.cnn.com 允许443端口</code></li> <li><code>配置虚拟服务的istio-egressgateway网关目标规则允许主机列表edition.cnn.com并且允许443端口、权重为100</code></li></ul></li></ol> <blockquote><p>要通过出口网关引导多个主机，您可以<code>*</code>在<code>Gateway</code>. 应将 中的<code>subset</code>字段重新用于其他主机。<code>DestinationRule</code></p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code>$ kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span> &lt;&lt;EOF
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> tls
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">tls</span><span class="token punctuation">:</span>
      <span class="token key atrule">mode</span><span class="token punctuation">:</span> PASSTHROUGH
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> egressgateway<span class="token punctuation">-</span>for<span class="token punctuation">-</span>cnn
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cnn
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> direct<span class="token punctuation">-</span>cnn<span class="token punctuation">-</span>through<span class="token punctuation">-</span>egress<span class="token punctuation">-</span>gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> edition.cnn.com
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mesh
  <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mesh
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway.istio<span class="token punctuation">-</span>system.svc.cluster.local
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> cnn
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> istio<span class="token punctuation">-</span>egressgateway
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">sniHosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> edition.cnn.com
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> edition.cnn.com
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
EOF
</code></pre></div><ol start="4"><li><a href="https://edition.cnn.com/politics" target="_blank" rel="noopener noreferrer">向https://edition.cnn.com/politics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>发送 HTTPS 请求。输出应该和以前一样。</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl <span class="token builtin class-name">exec</span> <span class="token string">&quot;<span class="token variable">$SOURCE_POD</span>&quot;</span> <span class="token parameter variable">-c</span> <span class="token function">sleep</span> -- <span class="token function">curl</span> <span class="token parameter variable">-sSL</span> <span class="token parameter variable">-o</span> /dev/null <span class="token parameter variable">-D</span> - https://edition.cnn.com/politics
<span class="token punctuation">..</span>.
HTTP/2 <span class="token number">200</span>
Content-Type: text/html<span class="token punctuation">;</span> <span class="token assign-left variable">charset</span><span class="token operator">=</span>utf-8
<span class="token punctuation">..</span>.
</code></pre></div><ol start="5"><li>查看出口网关代理的日志。如果 Istio 部署在<code>istio-system</code>命名空间中，打印日志的命令是：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">[</span>root@k8s-master-node1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -l istio=egressgateway -n istio-system</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T11:52:28.733Z<span class="token punctuation">]</span> <span class="token string">&quot;- - -&quot;</span> <span class="token number">0</span> - - - <span class="token string">&quot;-&quot;</span> <span class="token number">910</span> <span class="token number">1262165</span> <span class="token number">45829</span> - <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;151.101.193.67:443&quot;</span> outbound<span class="token operator">|</span><span class="token number">443</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:49136 <span class="token number">10.244</span>.1.4:8443 <span class="token number">10.244</span>.1.20:33440 edition.cnn.com -
<span class="token number">2022</span>-03-21T12:15:16.256967Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T12:45:27.104242Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token punctuation">[</span><span class="token number">2022</span>-03-21T13:06:35.033Z<span class="token punctuation">]</span> <span class="token string">&quot;GET /politics HTTP/2&quot;</span> <span class="token number">301</span> - via_upstream - <span class="token string">&quot;-&quot;</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">356</span> <span class="token number">356</span> <span class="token string">&quot;10.244.1.20&quot;</span> <span class="token string">&quot;curl/7.81.0-DEV&quot;</span> <span class="token string">&quot;82a2b1d1-70f0-9907-bfc3-1a86cfd91721&quot;</span> <span class="token string">&quot;edition.cnn.com&quot;</span> <span class="token string">&quot;151.101.129.67:80&quot;</span> outbound<span class="token operator">|</span><span class="token number">80</span><span class="token operator">||</span>edition.cnn.com <span class="token number">10.244</span>.1.4:47896 <span class="token number">10.244</span>.1.4:8080 <span class="token number">10.244</span>.1.20:42962 - -
<span class="token number">2022</span>-03-21T13:15:59.020699Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T13:40:14.303559Z     info    ads     XDS: Incremental Pushing:0 ConnectedEndpoints:2 Version:
<span class="token number">2022</span>-03-21T13:40:14.597921Z     info    cache   generated new workload certificate   <span class="token assign-left variable">latency</span><span class="token operator">=</span><span class="token number">294</span>.218007ms <span class="token assign-left variable">ttl</span><span class="token operator">=</span>23h59m59.402089572s
<span class="token number">2022</span>-03-21T13:40:14.598006Z     info    ads     SDS: PUSH <span class="token keyword">for</span> node:istio-egressgateway-7f4864f59c-q5cdv.istio-system resources:1 size:4.0kB resource:default
<span class="token number">2022</span>-03-21T13:47:00.985263Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
<span class="token number">2022</span>-03-21T14:18:49.713637Z     info    xdsproxy        connected to upstream XDS server: istiod.istio-system.svc:15012
</code></pre></div><h4 id="清理https网关"><a href="#清理https网关" class="header-anchor">#</a> 清理HTTPS网关</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl delete serviceentry cnn
$ kubectl delete gateway istio-egressgateway
$ kubectl delete virtualservice direct-cnn-through-egress-gateway
$ kubectl delete destinationrule egressgateway-for-cnn
</code></pre></div></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/11/28, 22:03:59</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/CodeVault/pages/824f20/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Istio安装</div></a> <a href="/CodeVault/pages/14e323/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Istio练习题</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/CodeVault/pages/824f20/" class="prev">Istio安装</a></span> <span class="next"><a href="/CodeVault/pages/14e323/">Istio练习题</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/CodeVault/archives" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/CodeVault/pages/c936ca/"><div>
            学习文档
            <!----></div></a> <span class="date">11-28</span></dt></dl><dl><dd>02</dd> <dt><a href="/CodeVault/pages/53f082/"><div>
            如何成为FISCO社区的MVP 总结篇
            <!----></div></a> <span class="date">11-28</span></dt></dl><dl><dd>03</dd> <dt><a href="/CodeVault/pages/3d3086/"><div>
            一文搞懂Truffle测试
            <!----></div></a> <span class="date">11-28</span></dt></dl> <dl><dd></dd> <dt><a href="/CodeVault/archives" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>YYzop & Hior | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/CodeVault/assets/js/app.ef278985.js" defer></script><script src="/CodeVault/assets/js/2.f96441c8.js" defer></script><script src="/CodeVault/assets/js/129.67eabc56.js" defer></script>
  </body>
</html>
